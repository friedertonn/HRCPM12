Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   1
BIOS    ASM

    1                   ; ***********************************************************
    2                   ; *                                                         *
    3                   ; *  HRCPM12-BIOS fuer den AC1      Version vom 03.01.2024  *
    4                   ; *                                                         *
    5                   ; *                                                  V.140  *
    6                   ; *                                                         *
    7                   ; ***********************************************************
    8                   ;
    9                   ; Korrekturen/Fehlerbehebungen:
   10                   ; - alle nicht genutzten Programmteile (HRDOS12) entfernt
   11                   ; - (Turbo-)LOAD entfernt
   12                   ; - BWS(Farb)Init geaendert
   13                   ; - ^G BEEP + PUNCH:=V24out + LIST:=V24out hinzugefuegt
   14                   ; - keine Pruefsumme, kein Vergleichslesen der RAM-Disk (entfernt)
   15                   ; - fehlerhafte Maskierung USER in WBOOT entfernt
   16                   ; - Kursorblinken im Texteditor
   17                   ; - Consolenkommandos Kursor-ON / Kursor-OFF
   18                   ; - RAM-Disk mit 64 REC/TRK, Systemspur auf 8K reduziert
   19                   ; - GIDE-Laufwerke (C:, D:, E:) auf 8MB, da nicht alle BDOS'se mit mehr
   20                   ;   als 16 Bit fuer REC-NR. zurechtkommen.
   21                   ; - Formatierung RAM-Disk: letzter Sektor wurde nicht formatiert
   22                   ; - falsche I/O-Adresse von Modul1
   23                   ; - ISR angepasst, damit HRCPM12 mit JKCEMU V0.9.8.3 funktioniert
   24                   ;
   25                   ; Neu hinzugekommen:
   26                   ; - EXIT loescht CCPPUFLEN (V.132)
   27                   ; - WBOOT loescht CCPPUFLEN, weil in Systemspur "aktiver Befehl" (V.133)
   28                   ; - Eintragen von NMI auf 066h in BOOT1 entfernt (CPM Page-Zero) (V.133)
   29                   ; - Tastaturpuffer von FFD0h -> FF00h , "d"-Befehl ueberschrieben (V.134)
   30                   ; - nicht benutzte "Arbeitszellen" am Ende auskommentiert (V.135)
   31                   ; - automatische Erkennung der RAM-Disk 256k/512k/1024k/2048k (V.136)
   32                   ;
   33                   ;
   34                           .CREF
   35                           .Z80
   36                   ;
   37                           .PHASE 0E600H
   38                   ;
   39                   ;
   40         07F1      OUTHL   EQU  07F1H
   41         01A5      RSA     EQU  01A5H        ;CPU-Register nach RSA - nicht Monitor 11 !
   42         05CE      REGIST  EQU  05CEH        ;Registeranzeige - nicht Monitor 11 !
   43         0DF9      MV24A   EQU  0DF9H        ;MO-UP V24-Out
   44                   ;
   45                   ;
   46         1800      CUPOS   EQU  1800H
   47         1818      BREAK   EQU  1818H        ;NMI Sprungziel
   48         181F      CBWSB   EQU  181FH        ;Merkzelle fuer das Farbbyte im AC1-Monitor 
   49                   ;                         ;0=kein Color-BWS, sonst der eingestellte Farbwert
   50         185B      ARG1    EQU  185BH
   51         185D      ARG2    EQU  185DH
   52                   ;
   53                   ;
   54         0000      WARMBT  EQU  0000H        ;WBOOT der Grundseite
   55         0005      BDOSF   EQU  0005H        ;BDOS-Aufruf + TPA-MAX
   56         0038      RST38   EQU  0038H        ;CP/M-Break
   57         0066      NMI     EQU  0066H
   58                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   2
BIOS    ASM

   59                   ;
   60         0003      IOBYTE  EQU  0003H
   61         0004      LWBYTE  EQU  0004H        ;LW (Bit0-3) + USER Nr.(Bit4-7)
   62                   ;
   63         FF00      ZEIPUF  EQU  0FF00H       ;1 + 32 Byte Puffer fuer Tastatur
   64                   ;                          --> war urspruenlich auf 0FFD0H
   65                   ;                          --> ueberschreibt den "d"-Befehl
   66                   ;
   67         D806      BDOS    EQU  0D806H       ;BDOS-EinsprungAdresse
   68         E603      WBOOTB  EQU  0E603H       ;BIOS-Eisprung WBOOT
   69                   ;
   70                   ;
   71         C000      HPRDSK  EQU  0C000H       ;Hilfsprogramm: Format RAM-Disk
   72         D000      CCP     EQU  0D000H       ;Start CCP
   73         D007      COMLEN  EQU  CCP+07       ;CCP-Kommandopuffer-Laenge
   74                   ;
   75         00E0      PE0     EQU  0E0H         ;Grundadresse der RAM-Disk
   76         00F0      PF0     EQU  0F0H         ;BWS-CPLD-(Steuer)Port
   77                   ;
   78         0040      CFDC    EQU  40H          ;Hauptstatusregister FDC
   79         0041      DFDC    EQU  41H          ;Datenport FDC
   80         0043      WAIT    EQU  43H          ;IO-Adr. /WAIT Monoflop
   81         0045      LATCH   EQU  45H          ;IO-Adr. Latch 74LS175
   82                   ;
   83         000F      CUZEI   EQU  0FH          ;KursorSymbol
   84                   ;
   85                   ;============================================================================
   86                   ;
   87 E600  C3 E878             JP   BOOT
   88 E603  C3 E94F             JP   WBOOT
   89 E606  C3 EA68             JP   CONST
   90 E609  C3 EA70             JP   CONIN
   91 E60C  C3 EAE8             JP   CONOUT
   92 E60F  C3 EABF             JP   LIST
   93 E612  C3 EADB             JP   PUNCH
   94 E615  C3 EA70             JP   CONIN        ;eigentlich JP READER
   95 E618  C3 EE1D             JP   HOME
   96 E61B  C3 EDFE             JP   SELDSK
   97 E61E  C3 EE20             JP   SETTRK
   98 E621  C3 EE25             JP   SETSEC
   99 E624  C3 EE2A             JP   SETDMA
  100 E627  C3 EE3B             JP   READ
  101 E62A  C3 EE40             JP   WRITE
  102 E62D  C3 EDFB             JP   LISTST
  103 E630  C3 EE2F             JP   SECTRN
  104                   ;
  105 E633  43 38 35 41         DEFM 'C85AC'      ;fuer PC/BC Progr.
  106 E638  C3 E9D7             JP   EXIT         ;User-Kommando EXIT
  107 E63B  C3 F00C             JP   LOAD         ;User-Kommando LOAD
  108 E63E  C3 0000             JP   0000H
  109                   ;
  110 E641  07          NDISK:  DEFB 7            ;Anzahl der LW = 7
  111                   ;
  112 E642  E644        DPHX:   DEFW DPHY         ;Zeiger auf den 1. Block?
  113 E644  E652        DPHY:   DEFW DPH0         ;DPH von LW A:
  114 E646  E662                DEFW DPH1         ;DPH von LW B:
  115 E648  E672                DEFW DPH2         ;DPH von LW C:
  116 E64A  E682                DEFW DPH3         ;DPH von LW D:
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   3
BIOS    ASM

  117 E64C  E692                DEFW DPH4         ;DPH von LW E:
  118 E64E  E6A2                DEFW DPH5         ;DPH von LW F:
  119 E650  E6B2                DEFW DPH6         ;DPH von LW G:
  120                   ;
  121 E652  0000        DPH0:   DEFW 0            ;RAM-Disk A:
  122 E654  0000                DEFW 0
  123 E656  0000                DEFW 0
  124 E658  0000                DEFW 0
  125 E65A  F865                DEFW DIRBF
  126 E65C  E6C4                DEFW DPB0
  127 E65E  0000                DEFW 0            ;weil nichtwechselbares Medium
  128 E660  F8E5                DEFW ALL00
  129                   ;
  130 E662  0000        DPH1:   DEFW 0            ;Floppy B:
  131 E664  0000                DEFW 0
  132 E666  0000                DEFW 0
  133 E668  0000                DEFW 0
  134 E66A  F865                DEFW DIRBF
  135 E66C  E6D5                DEFW DPB1
  136 E66E  FDF3                DEFW CHK01
  137 E670  F965                DEFW ALL01
  138                   ;
  139 E672  0000        DPH2:   DEFW 0            ;GIDE C:
  140 E674  0000                DEFW 0
  141 E676  0000                DEFW 0
  142 E678  0000                DEFW 0
  143 E67A  F865                DEFW DIRBF
  144 E67C  E6F1                DEFW DPB2
  145 E67E  0000                DEFW 0            ;weil nichtwechselbares Medium
  146 E680  F997                DEFW ALL02
  147                   ;
  148 E682  0000        DPH3:   DEFW 0            ;GIDE D:
  149 E684  0000                DEFW 0
  150 E686  0000                DEFW 0
  151 E688  0000                DEFW 0
  152 E68A  F865                DEFW DIRBF
  153 E68C  E70D                DEFW DPB3
  154 E68E  0000                DEFW 0            ;weil nichtwechselbares Medium
  155 E690  FB8F                DEFW ALL03
  156                   ;
  157 E692  0000        DPH4:   DEFW 0            ;GIDE E:
  158 E694  0000                DEFW 0
  159 E696  0000                DEFW 0
  160 E698  0000                DEFW 0
  161 E69A  F865                DEFW DIRBF
  162 E69C  E729                DEFW DPB4
  163 E69E  0000                DEFW 0            ;weil nichtwechselbares Medium
  164 E6A0  FC8F                DEFW ALL04
  165                   ;
  166 E6A2  0000        DPH5:   DEFW 0            ;Floppy F:
  167 E6A4  0000                DEFW 0
  168 E6A6  0000                DEFW 0
  169 E6A8  0000                DEFW 0
  170 E6AA  F865                DEFW DIRBF
  171 E6AC  E745                DEFW DPB5
  172 E6AE  FE13                DEFW CHK05
  173 E6B0  FD8F                DEFW ALL05
  174                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   4
BIOS    ASM

  175 E6B2  0000        DPH6:   DEFW 0            ;Floppy G:
  176 E6B4  0000                DEFW 0
  177 E6B6  0000                DEFW 0
  178 E6B8  0000                DEFW 0
  179 E6BA  F865                DEFW DIRBF
  180 E6BC  E761                DEFW DPB6
  181 E6BE  FE33                DEFW CHK06
  182 E6C0  FDC1                DEFW ALL06
  183                   ;
  184                   ; https://hc-ddr.hucki.net/wiki/doku.php/cpm/write_a_bios/teil_1
  185                   ;
  186                   ;RAM-Disk 256 KByte  LW A:
  187                   ;
  188 E6C2  EE67                DEFW RWRDSK       ;Routine zum Lesen/Schreiben der RAM-Disk
  189                   ;
  190 E6C4  0040        DPB0:   DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  191 E6C6  03                  DEFB 3            ;Blockgroesse = 1 Kbyte
  192 E6C7  07                  DEFB 7
  193 E6C8  00                  DEFB 0            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  194 E6C9  00F7                DEFW 247          ;248 * 1 Kbyte-Bloecke  -> 256k-8k(System)=248k(CP/M) ( - 2k(DIR) -> 246k (NETTO f. Daten))
  195 E6CB  003F                DEFW 63           ;64 DIR - Eintaege
  196 E6CD  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  197 E6CF  0000                DEFW 0            ;weil nichtwechselbares Medium
  198 E6D1  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  199                   ;
  200                   ;Floppy 780 KByte  LW B:
  201                   ;
  202 E6D3  F02C                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  203                   ;
  204 E6D5  0050        DPB1:   DEFW 80           ;80 Sectoren/Track
  205 E6D7  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  206 E6D8  0F                  DEFB 15
  207 E6D9  00                  DEFB 0
  208 E6DA  0185                DEFW 389          ;390 * 2 Kbyte - Bloecke
  209 E6DC  007F                DEFW 127          ;128 DIR - Eintraege
  210 E6DE  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  211 E6E0  0020                DEFW 32
  212 E6E2  0002                DEFW 2            ;20 Kbyte System
  213                   ;
  214 E6E4  03 07 05 25         DEFB 3,7,5,25H
  215 E6E8  50 00 43 FF         DEFB 50H,0,43H,0FFH
  216 E6EC  E1 33 FF            DEFB 0E1H,33H,0FFH
  217                   ;
  218                   ;GIDE 8 MByte  LW C:
  219                   ;
  220 E6EF  F028                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  221                   ;
  222 E6F1  0800        DPB2:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  223 E6F3  05                  DEFB 5
  224 E6F4  1F                  DEFB 31           ;4k Bloecke
  225 E6F5  01                  DEFB 1            ;16-Bit Blockadressen im FCB/DIR
  226 E6F6  07BF                DEFW 1983         ;1984 * 4k-Bloecke = 7936k
  227 E6F8  07FF                DEFW 2047         ;2048 DIR-Eintraege
  228 E6FA  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke = 64 k
  229 E6FC  0000                DEFW 0            ;weil nichtwechselbares Medium
  230 E6FE  0001                DEFW 1            ;1 Trk = 256k System
  231                   ;
  232 E700  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   5
BIOS    ASM

  233 E703  000A                DEFW 000AH        ;10 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  234 E705  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  235 E707  03D8                DEFW 03D8H        ;984 Zylinder HDD
  236 E709  10                  DEFB 10H          ;16 Koepfe HDD
  237 E70A  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  238                   ;
  239                   ;GIDE 8 MByte  LW D:
  240                   ;
  241 E70B  F028                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  242                   ;
  243 E70D  0800        DPB3:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  244 E70F  06                  DEFB 6
  245 E710  3F                  DEFB 63           ;8k Bloecke
  246 E711  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  247 E712  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  248 E714  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  249 E716  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  250 E718  0000                DEFW 0            ;weil nichtwechselbares Medium
  251 E71A  0000                DEFW 0            ;kein System-Track
  252                   ;
  253 E71C  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  254 E71F  0096                DEFW 0096H        ;150 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  255 E721  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  256 E723  03D8                DEFW 03D8H        ;984 Zylinder HDD
  257 E725  10                  DEFB 10H          ;16 Koepfe HDD
  258 E726  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  259                   ;
  260                   ;GIDE 8 MByte  LW E:
  261                   ;
  262 E727  F028                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  263                   ;
  264 E729  0800        DPB4:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  265 E72B  06                  DEFB 6
  266 E72C  3F                  DEFB 63           ;8k Bloecke
  267 E72D  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  268 E72E  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  269 E730  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  270 E732  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  271 E734  0000                DEFW 0            ;weil nichtwechselbares Medium
  272 E736  0000                DEFW 0            ;kein System-Track
  273                   ;
  274 E738  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  275 E73B  012C                DEFW 012CH        ;300 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  276 E73D  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  277 E73F  03D8                DEFW 03D8H        ;984 Zylinder HDD
  278 E741  10                  DEFB 10H          ;16 Koepfe HDD
  279 E742  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  280                   ;
  281                   ;Floppy 640 KByte  LW F:
  282                   ;
  283 E743  F02C                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  284                   ;
  285 E745  0040        DPB5:   DEFW 64           ;64 Sectoren/Track
  286 E747  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  287 E748  0F                  DEFB 15
  288 E749  00                  DEFB 0
  289 E74A  013F                DEFW 319          ;320 * 2 Kbyte - Bloecke
  290 E74C  007F                DEFW 127          ;128 DIR - Eintraege
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   6
BIOS    ASM

  291 E74E  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  292 E750  0020                DEFW 32
  293 E752  0000                DEFW 0            ;kein System-Track
  294                   ;
  295 E754  01 01 10 14         DEFB 1,1,10H,14H
  296 E758  50 00 43 FF         DEFB 50H,0,43H,0FFH
  297 E75C  E1 33 FF            DEFB 0E1H,33H,0FFH
  298                   ;
  299                   ;Floppy 800 KByte  LW G:
  300                   ;
  301 E75F  F02C                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  302                   ;
  303 E761  0050        DPB6:   DEFW 80           ;80 Sectoren/Track
  304 E763  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  305 E764  0F                  DEFB 15
  306 E765  00                  DEFB 0
  307 E766  018F                DEFW 399          ;400 * 2 Kbyte - Bloecke
  308 E768  007F                DEFW 127          ;128 DIR - Eintraege
  309 E76A  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  310 E76C  0020                DEFW 32
  311 E76E  0000                DEFW 0            ;kein System-Track
  312                   ;
  313 E770  03 07 05 25         DEFB 3,7,5,25H
  314 E774  50 01 43 FF         DEFB 50H,1,43H,0FFH
  315 E778  E1 33 FF            DEFB 0E1H,33H,0FFH
  316                   ;
  317                   ;RAM-Disk 512 KByte  LW A:
  318 E77B  0040        DP512:  DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  319 E77D  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  320 E77E  0F                  DEFB 15
  321 E77F  01                  DEFB 1            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  322 E780  00FB                DEFW 251          ;252 * 2 Kbyte-Bloecke  -> 512k-8k(System)=504k(CP/M) ( - 2k(DIR) -> 502k (NETTO f. Daten))
  323 E782  003F                DEFW 63           ;64 DIR - Eintaege
  324 E784  0080                DEFW 080H         ;1 DIR-Block
  325 E786  0000                DEFW 0            ;weil nichtwechselbares Medium
  326 E788  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  327                   ;
  328                   ;RAM-Disk 1024 KByte  LW A:
  329 E78A  0040        DP1024: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  330 E78C  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  331 E78D  0F                  DEFB 15
  332 E78E  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  333 E78F  01FB                DEFW 507          ;508 * 2 Kbyte-Bloecke  -> 1024k-8k(System)=1016k(CP/M) ( - 4k(DIR) -> 1012k (NETTO f. Daten))
  334 E791  007F                DEFW 127          ;128 DIR - Eintraege -> bei 64 DIR-Eintraegen bekommt man die RAM-Disk nicht voll
  335 E793  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  336 E795  0000                DEFW 0            ;weil nichtwechselbares Medium
  337 E797  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  338                   ;
  339                   ;RAM-Disk 2048 KByte  LW A:
  340 E799  0040        DP2048: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  341 E79B  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  342 E79C  0F                  DEFB 15
  343 E79D  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  344 E79E  03FB                DEFW 1019         ;1020 * 2 Kbyte-Bloecke  -> 2048k-8k(System)=2040k(CP/M) ( - 8k(DIR) -> 2032k (NETTO f. Daten))
  345 E7A0  00FF                DEFW 255          ;256 DIR - Eintraege
  346 E7A2  00F0                DEFW 0F0H         ;4 DIR-Bloecke
  347 E7A4  0000                DEFW 0            ;weil nichtwechselbares Medium
  348 E7A6  0001                DEFW 1            ;8 Kbyte System / Track-Offset
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   7
BIOS    ASM

  349                   ;
  350 E7A8  0C          TXT01:  DEFB 0CH
  351 E7A9  48 52 43 50         DEFM "HRCPM AC1 V1.2 CPA "
  352 E7BC  31 31 2E 30         DEFM "11.01.89 FA-MODE "
  353 E7CD  76 6F 6D 20         DEFM "vom 03.01.2024 V.140"
  354 E7E1  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  355 E7E5  47 49 44 45         DEFM "GIDE(80H) C0:8MB,"
  356 E7F6  20 20 20 44         DEFM "   D0: 8MB   E0: 8MB"
  357 E80A  0D 0A               DEFB 0DH,0AH
  358 E80C  46 44 43 20         DEFM "FDC (45H) B0:5*1024"   ;B0 --> Floppy-Drive 0,
  359 E81F  20 46 30 3A         DEFM " F0:16*256 G1:5*1024"  ;F0 --> Floppy-Drive 0, G1 --> Floppy-Drive 1
  360 E833  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  361 E837  52 46 4C 20         DEFM "RFL Praeci.Port E0H"
  362 E84A  20 41 3A 20         DEFM " A: "
  363 E84E  00                  DEFB 0
  364 E84F  32 35 36 6B TXT01A: DEFM "256k"
  365 E853  00                  DEFB 0
  366 E854  35 31 32 6B TXT01B: DEFM "512k"
  367 E858  00                  DEFB 0
  368 E859  31 30 32 34 TXT01C: DEFM "1024k"
  369 E85E  00                  DEFB 0
  370 E85F  32 30 34 38 TXT01D: DEFM "2048k"
  371 E864  00                  DEFB 0
  372 E865  20 2D 2D 3E TXT02:  DEFM " --> Format A:(J)?"
  373 E877  00                  DEFB 0
  374                   ;
  375                   ;******************************   BOOT   *******************************
  376                   ;
  377 E878  F3          BOOT:   DI
  378 E879  31 F41D             LD   SP,CPMSTK
  379 E87C  AF                  XOR  A
  380 E87D  D3 1E               OUT  (P1E),A      ;zwingend AC1-Mode !!
  381 E87F  32 F440             LD   (LATPU),A    ;FDC-Latch zuruecksetzen
  382 E882  CD EDC5             CALL BWSINI
  383 E885  DB 05               IN   A,(P05)
  384 E887  CB 9F               RES  3,A          ;BildInvers (PIO1B) Bit3 aus
  385 E889  D3 05               OUT  (P05),A
  386 E88B  2A 1818             LD   HL,(BREAK)   ;Sprungtabelle NMI MONITOR
  387 E88E  22 F42C             LD   (OLDNMI),HL  ;sichern
  388 E891  21 E603             LD   HL,WBOOTB    ;CP/M-Warmstart-Einsprungadresse
  389 E894  22 1818             LD   (BREAK),HL
  390 E897  CD E9CC             CALL CPMMOD
  391 E89A  AF                  XOR  A
  392 E89B  32 F460             LD   (DF51A),A
  393 E89E  32 0003             LD   (IOBYTE),A
  394 E8A1  32 0004             LD   (LWBYTE),A
  395 E8A4  32 FF00             LD   (ZEIPUF),A   ;Init. Tastaturpuffer
  396 E8A7  CD E9A8             CALL BOOT1        ;CP/M "Grundseite" INIT
  397                   ;
  398 E8AA  3E 03               LD   A,03H        ;CTC init. + Interrupt abgeschaltet
  399 E8AC  D3 00               OUT  (P00),A
  400 E8AE  D3 01               OUT  (P01),A
  401 E8B0  D3 02               OUT  (P02),A
  402 E8B2  D3 03               OUT  (P03),A
  403 E8B4  3E FF               LD   A,0FFH       ;HWT vom Interruptvektor 0FF80h ff.
  404 E8B6  ED 47               LD   I,A
  405 E8B8  ED 5E               IM   2            ;Interrupt freigeben
  406 E8BA  21 F318             LD   HL,INTEND    ;Adresse Einsprungpunkt fuer nicht verwendete Interrupts
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   8
BIOS    ASM

  407 E8BD  22 FF80             LD   (DFF80),HL   ;Prog. Einsprung IV fuer CTC-Kanal 0
  408 E8C0  22 FF82             LD   (DFF82),HL   ;Prog. Einsprung IV fuer CTC-Kanal 1
  409 E8C3  22 FF84             LD   (DFF84),HL   ;Prog. Einsprung IV fuer CTC-Kanal 2
  410 E8C6  21 F2FD             LD   HL,ISRCTC    ;Einsprungpunkt CTC-Interrupt - Steuerung Nachlauf Floppy-LW
  411 E8C9  22 FF86             LD   (DFF86),HL   ;Prog. Einsprung IV fuer CTC-Kanal 3
  412 E8CC  3E 80               LD   A,80H
  413 E8CE  D3 00               OUT  (P00),A      ;CTC-Interruptadresse NWT (= 80h) eintragen
  414 E8D0  3E FF               LD   A,0FFH
  415 E8D2  32 F43F             LD   (CTCCNT),A   ;Init. CTC-Counter = 255 --> Zusatzzaehler fuer CTC-Interrupt
  416 E8D5  3E A7               LD   A,0A7H
  417 E8D7  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 als Zeitgeber mit Interrupt, Vorteiler 256
  418 E8D9  AF                  XOR  A
  419 E8DA  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 - Hauptteiler = 256
  420                                             ;d.h. bei 2 MHz CPU-Takt wird alle 33ms ein CTC-Interrupt ausgeloest
  421                   ;
  422 E8DC  21 E9FE             LD   HL,ISRTAS    ;1. Einsprungpunkt PIO-Interrupt --> Taste in Tastaturpuffer schreiben
  423 E8DF  22 FF88             LD   (DFF88),HL   ;auf 0FF88h eintragen
  424 E8E2  01 0506             LD   BC,0506H     ;5 Bytes auf Controlkanal PIO1 A
  425 E8E5  21 EA53             LD   HL,PIOTAB
  426 E8E8  ED B3               OTIR              ;PIO1_A Init. fuer 1. Einsprungpunkt
  427                   ;
  428 E8EA  21 E7A8             LD   HL,TXT01     ;Begruessungstext
  429 E8ED  CD EA58             CALL OUTTXT
  430                   ;
  431 E8F0  CD EEC2             CALL RDTEST       ;Kapazitaet der RAM-Disk bestimmen
  432 E8F3  21 EF22             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
  433 E8F6  7E                  LD   A,(HL)
  434 E8F7  21 E799             LD   HL,DP2048    ;DPB 2048K RAM-Disk
  435 E8FA  FE 03               CP   3
  436 E8FC  28 10               JR   Z,BOOT2
  437 E8FE  21 E78A             LD   HL,DP1024    ;DPB 1024K RAM-Disk
  438 E901  FE 02               CP   2
  439 E903  28 09               JR   Z,BOOT2
  440 E905  21 E77B             LD   HL,DP512     ;DPB 512K RAM-Disk
  441 E908  FE 01               CP   1
  442 E90A  28 02               JR   Z,BOOT2
  443 E90C  18 08               JR   BOOT3        ;256K RAM-Disk, nichts kopieren
  444                   ;        
  445 E90E  11 E6C4     BOOT2:  LD   DE,DPB0
  446 E911  01 000F             LD   BC,15
  447 E914  ED B0               LDIR
  448 E916  21 E85F     BOOT3:  LD   HL,TXT01D    ;2048k
  449 E919  FE 03               CP   3
  450 E91B  28 11               JR   Z,BOOT4
  451 E91D  21 E859             LD   HL,TXT01C    ;1024k
  452 E920  FE 02               CP   2
  453 E922  28 0A               JR   Z,BOOT4
  454 E924  21 E854             LD   HL,TXT01B    ;512k
  455 E927  FE 01               CP   1
  456 E929  28 03               JR   Z,BOOT4
  457 E92B  21 E84F             LD   HL,TXT01A    ;256k
  458 E92E  CD EA58     BOOT4:  CALL OUTTXT
  459 E931  21 E865             LD   HL,TXT02     ;Formatieren? (J)
  460 E934  CD EA58             CALL OUTTXT
  461 E937  FB                  EI
  462 E938  CD EA70             CALL CONIN
  463 E93B  CB AF               RES  5,A          ;Upcase
  464 E93D  FE 4A               CP   4AH          ;J --> RAM-Disk formatieren
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   9
BIOS    ASM

  465 E93F  CC EF23             CALL Z,RDFORM
  466 E942  21 8000             LD   HL,8000H     ;POWER.COM nach 100h kopieren
  467 E945  11 0100             LD   DE,0100H
  468 E948  01 4000             LD   BC,4000H
  469 E94B  ED B0               LDIR
  470 E94D  18 22               JR   WBOOT1
  471                   ;
  472                   ;*******************************   WBOOT   *****************************
  473                   ;
  474 E94F  31 F41D     WBOOT:  LD   SP,CPMSTK
  475 E952  CD E9CC             CALL CPMMOD
  476 E955  3A F461             LD   A,(DF51B)
  477 E958  B7                  OR   A
  478 E959  C4 F0E1             CALL NZ,LF0CE
  479 E95C  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
  480 E95E  21 EE3B             LD   HL,READ
  481 E961  22 EFB4             LD   (WRCCP2),HL
  482 E964  CD EF9A             CALL WRCCP        ;wirklich READCCP !
  483 E967  21 EE40             LD   HL,WRITE
  484 E96A  22 EFB4             LD   (WRCCP2),HL
  485 E96D  AF                  XOR  A
  486 E96E  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  487                   ;
  488 E971  CD E9A8     WBOOT1: CALL BOOT1        ;CP/M "Grundseite" INIT
  489 E974  3E 01               LD   A,01H        ;Kursor einschalten
  490 E976  32 F423             LD   (CUFLAG),A
  491 E979  3A F420             LD   A,(COLO2)
  492 E97C  32 F41E             LD   (COLOR),A    ;Arbeitszelle Farbbyte
  493 E97F  E6 77               AND  77H          ;Intensivdarstellung maskieren
  494 E981  32 F41F             LD   (COLO1),A    ;Arbeitszelle "Normaldarstellung"
  495 E984  3A 0004             LD   A,(LWBYTE)
  496 E987  4F                  LD   C,A
  497 E988  CD EDFE             CALL SELDSK
  498 E98B  C3 D000             JP   CCP          ;JP CCP
  499                   ;
  500                   ;
  501 E98E  F5          CPMERR: PUSH AF           ;CP/M-Fehler - zurueck z. MONITOR
  502 E98F  E5                  PUSH HL
  503 E990  CD E9DB             CALL EXIT1
  504 E993  DF                  RST  18H
  505 E994  20 43 50            DEFM " CP"
  506 E997  CD                  DEFB 4DH+80H      ;"M+80H
  507 E998  E1                  POP  HL
  508 E999  F1                  POP  AF
  509 E99A  CD 01A5             CALL RSA
  510 E99D  E1                  POP  HL
  511 E99E  2B                  DEC  HL
  512 E99F  CD 07F1             CALL OUTHL
  513 E9A2  DF                  RST  18H
  514 E9A3  8D                  DEFB 0DH+80H
  515 E9A4  CD 05CE             CALL REGIST       ;MONI - Registeranzeige - nicht Monitor 11 !
  516 E9A7  FF                  RST  38H          ;zurueck zum MONI
  517                   ;
  518                   ;
  519 E9A8  3E C3       BOOT1:  LD   A,0C3H       ;CP/M "Grundseite" INIT
  520 E9AA  32 0000             LD   (WARMBT),A
  521 E9AD  32 0005             LD   (BDOSF),A
  522 E9B0  32 0038             LD   (RST38),A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  10
BIOS    ASM

  523 E9B3  21 E603             LD   HL,WBOOTB
  524 E9B6  22 0001             LD   (WARMBT+1),HL
  525 E9B9  21 D806             LD   HL,BDOS
  526 E9BC  22 0006             LD   (BDOSF+1),HL
  527 E9BF  21 E98E             LD   HL,CPMERR
  528 E9C2  22 0039             LD   (RST38+1),HL
  529 E9C5  21 0080             LD   HL,0080H
  530 E9C8  22 F447             LD   (DMA),HL
  531 E9CB  C9                  RET
  532                   ;
  533                   ;+++++++++++++++++++++++++++++++++   Ende BOOT / WBOOT   +++++++++++++++++
  534                   ;
  535 E9CC  F5          CPMMOD: PUSH AF           ;CP/M EIN
  536 E9CD  3E 01               LD   A,01H
  537 E9CF  18 02               JR   MOD1
  538                   ;
  539 E9D1  F5          AC1MOD: PUSH AF           ;CP/M AUS (AC1-Mode)
  540 E9D2  AF                  XOR  A
  541 E9D3  D3 1E       MOD1:   OUT  (P1E),A
  542 E9D5  F1                  POP  AF
  543 E9D6  C9                  RET
  544                   ;
  545                   ;--------------------------------------------------------------------------
  546                   ;
  547                   ;EXIT - Routine
  548                   ;
  549 E9D7  21 0000     EXIT:   LD   HL,0000H     ;Ruecksprungadresse fuer RET
  550 E9DA  E5                  PUSH HL
  551 E9DB  AF          EXIT1:  XOR  A
  552 E9DC  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  553 E9DF  D3 1E               OUT  (P1E),A      ;AC1-Mode
  554 E9E1  D3 14               OUT  (P14),A      ;Modul_1 - ggf. EPROMs ausblenden
  555 E9E3  2A F42C             LD   HL,(OLDNMI)
  556 E9E6  22 1818             LD   (BREAK),HL   ;alten NMI wiederherstellen
  557 E9E9  3E 03               LD   A,03H
  558 E9EB  D3 00               OUT  (P00),A      ;CTC: Interrupts ausschalten
  559 E9ED  D3 01               OUT  (P01),A
  560 E9EF  D3 02               OUT  (P02),A
  561 E9F1  D3 03               OUT  (P03),A
  562 E9F3  D3 06               OUT  (P06),A      ;PIO1 A: Interrupt auschalten
  563 E9F5  3E CF               LD   A,0CFH
  564 E9F7  D3 06               OUT  (P06),A      ;PIO1 A: "Mode 3" + "Set Mode"
  565 E9F9  3E FF               LD   A,0FFH
  566 E9FB  D3 06               OUT  (P06),A      ;PIO1 A: PA0 bis PA7 sind Eingaenge
  567 E9FD  C9                  RET               ;zurueck zum MONITOR, normal
  568                   ;
  569                   ;
  570                   ;Interrupt-Einsprung fuer die Tastatur
  571                   ;
  572 E9FE  F3          ISRTAS: DI
  573 E9FF  F5                  PUSH AF
  574 EA00  C5                  PUSH BC
  575 EA01  E5                  PUSH HL
  576 EA02  DB 04               IN   A,(P04)      ;PIO_A abfragen
  577 EA04  CB 7F               BIT  7,A          ;Taste gedrueckt?
  578 EA06  28 45               JR   Z,ISREND     ;nein, ISR beenden
  579 EA08  4F                  LD   C,A
  580                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  11
BIOS    ASM

  581 EA09  06 1E               LD   B,1EH        ;Tastaturentprellung
  582 EA0B  DB 04       PRELL1: IN   A,(P04)
  583 EA0D  B9                  CP   C
  584 EA0E  20 3D               JR   NZ,ISREND
  585 EA10  10 F9               DJNZ PRELL1       ;30 Durchlaeufe
  586                   ;
  587 EA12  FE 80               CP   80H
  588 EA14  28 37               JR   Z,ISREND     ;das war eine NULL-Eingabe
  589                   ;
  590 EA16  4F                  LD   C,A
  591 EA17  21 FF00             LD   HL,ZEIPUF
  592 EA1A  7E                  LD   A,(HL)       ;Fuellstand Zeichenpuffer
  593 EA1B  3C                  INC  A
  594 EA1C  FE 1F               CP   1FH          ;Puffer voll?
  595 EA1E  28 2D               JR   Z,ISREND
  596 EA20  77                  LD   (HL),A       ;Anzahl der Zeichen rueckschreiben
  597 EA21  C5                  PUSH BC
  598 EA22  06 00               LD   B,0
  599 EA24  4F                  LD   C,A
  600 EA25  09                  ADD  HL,BC        ;HL = Position im Zeichenpuffer
  601 EA26  C1                  POP  BC
  602 EA27  CB B9               RES  7,C          ;7. Bit loeschen und
  603 EA29  71                  LD   (HL),C       ;Taste in Zeichenpuffer eintragen
  604                   ;
  605                   ;       LD   BC,8034H     ;Initialisierung Tastenpiep --> 2 MHz
  606 EA2A  01 8068             LD   BC,8068H     ;Initialisierung Tastenpiep --> 4 MHz
  607 EA2D  79          BEEP1:  LD   A,C
  608 EA2E  3D          BEEP2:  DEC  A
  609 EA2F  20 FD               JR   NZ,BEEP2
  610 EA31  DB 05               IN   A,(P05)      ;PIO_B-Daten
  611 EA33  EE 01               XOR  01H          ;Tastenpiep
  612 EA35  D3 05               OUT  (P05),A
  613 EA37  10 F4               DJNZ BEEP1
  614 EA39  E6 FE               AND  0FEH
  615 EA3B  D3 05               OUT  (P05),A
  616                   ;
  617 EA3D  01 0200             LD   BC,0200H     ;Tastaturentprellung
  618 EA40  0B          PRELL2: DEC  BC
  619 EA41  78                  LD   A,B
  620 EA42  B1                  OR   C
  621 EA43  20 FB               JR   NZ,PRELL2
  622                   ;
  623 EA45  3E B7               LD   A,0B7H       ;weitere Interrupts loeschen
  624 EA47  D3 06               OUT  (P06),A
  625 EA49  3E 7F               LD   A,7FH
  626 EA4B  D3 06               OUT  (P06),A
  627                   ;
  628 EA4D  E1          ISREND: POP  HL
  629 EA4E  C1                  POP  BC
  630 EA4F  F1                  POP  AF
  631 EA50  FB                  EI
  632 EA51  ED 4D               RETI
  633                   ;
  634 EA53  88 CF FF B7 PIOTAB: DEFB 88H,0CFH,0FFH,0B7H,7FH  ;PIO 1A: Init.-Tabelle
  635                   ;  88H --> NWT Interruptvektor --> 0FF88H
  636                   ; 0CFH --> "Mode 3" + "Set Mode" (kein Handshaking, next Byte = I/O-Zuordnung)
  637                   ; 0FFH --> PA0 bis PA7 sind Eingaenge
  638                   ; 0B7H --> Setting Interrupt Control Word --> mit nachfolgender Maskierung
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  12
BIOS    ASM

  639                   ;  7FH --> Bit7=L --> nur PA7 erzeugt Interrupts
  640                   ;
  641 EA58  C5          OUTTXT: PUSH BC
  642 EA59  F5                  PUSH AF
  643 EA5A  4E          TEXT1:  LD   C,(HL)
  644 EA5B  79                  LD   A,C
  645 EA5C  B7                  OR   A
  646 EA5D  28 06               JR   Z,TEXT2
  647 EA5F  CD EAE8             CALL CONOUT
  648 EA62  23                  INC  HL
  649 EA63  18 F5               JR   TEXT1
  650 EA65  F1          TEXT2:  POP  AF
  651 EA66  C1                  POP  BC
  652 EA67  C9                  RET
  653                   ;
  654                   ;************************   CONST   *************************
  655                   ;
  656 EA68  3A FF00     CONST:  LD   A,(ZEIPUF)
  657 EA6B  B7                  OR   A
  658 EA6C  C8                  RET  Z
  659 EA6D  3E FF               LD   A,0FFH
  660 EA6F  C9                  RET
  661                   ;
  662                   ;***************************   CONIN   ***********************
  663                   ;
  664 EA70  F3          CONIN:  DI
  665 EA71  ED 73 F428          LD   (SPCIN),SP
  666 EA75  31 F3CE             LD   SP,CINSP
  667 EA78  C5                  PUSH BC
  668 EA79  D5                  PUSH DE
  669 EA7A  E5                  PUSH HL
  670 EA7B  01 017F             LD   BC,017FH     ;Kursor-Blinker ruecksetzen
  671 EA7E  AF          CONIN1: XOR  A
  672 EA7F  F3                  DI
  673 EA80  2A FF00             LD   HL,(ZEIPUF)  ;L = Anz. der Zeichen, H = 1. Zeichen
  674 EA83  B5                  OR   L
  675 EA84  20 20               JR   NZ,CONIN3    ;Zeichen im Tastaturpuffer vorhanden
  676 EA86  FB                  EI
  677 EA87  10 F5               DJNZ CONIN1       ;256*LOOP: warte auf ein Zeichen
  678 EA89  3A F423             LD   A,(CUFLAG)
  679 EA8C  B7                  OR   A
  680 EA8D  28 EF               JR   Z,CONIN1     ;kein "Kursor-Blinken"
  681 EA8F  F3                  DI
  682 EA90  CD E9D1             CALL AC1MOD       ;AC1 Mode
  683 EA93  2A 1800             LD   HL,(CUPOS)
  684 EA96  0C                  INC  C
  685 EA97  CB 79               BIT  7,C          ;hier wird die Cursor-Blinkfrequenz festgelegt
  686 EA99  3A F427             LD   A,(CHAR)     ;bisheriges Zeichen auf der Kursorposition
  687 EA9C  28 02               JR   Z,CONIN2
  688 EA9E  3E 0F               LD   A,CUZEI      ;Kursor = 0FH
  689 EAA0  77          CONIN2: LD   (HL),A       ;"Kursor-Blinken" - Bildschirm-Ausgabe
  690 EAA1  CD E9CC             CALL CPMMOD       ;CP/M Mode
  691 EAA4  18 D8               JR   CONIN1
  692                   ;
  693 EAA6  3D          CONIN3: DEC  A            ;DEC Anzahl_der_Zeichen_im_Tastaturpuffer
  694 EAA7  32 FF00             LD   (ZEIPUF),A
  695 EAAA  7C                  LD   A,H          ;1. Zeichen aus dem Tastaturpuffer --> A
  696 EAAB  21 FF02             LD   HL,ZEIPUF+2
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  13
BIOS    ASM

  697 EAAE  11 FF01             LD   DE,ZEIPUF+1
  698 EAB1  01 001F             LD   BC,001FH
  699 EAB4  ED B0               LDIR              ;alle Zeichen im Puffer ruecken 1 Pos. n. links
  700 EAB6  E1                  POP  HL
  701 EAB7  D1                  POP  DE
  702 EAB8  C1                  POP  BC
  703 EAB9  ED 7B F428          LD   SP,(SPCIN)
  704 EABD  FB                  EI
  705 EABE  C9                  RET
  706                   ;
  707                   ;***************************   LIST   ************************
  708                   ;
  709 EABF  F3          LIST:   DI
  710 EAC0  CD E9D1             CALL AC1MOD
  711 EAC3  F5                  PUSH AF      
  712 EAC4  79                  LD   A,C
  713 EAC5  FE 0A               CP   0AH  
  714 EAC7  28 0C               JR   Z,LIST1  
  715 EAC9  CD 0DF9             CALL MV24A        ;MONI V24 Ausgabe Akku
  716 EACC  FE 0D               CP   0DH     
  717 EACE  20 05               JR   NZ,LIST1 
  718 EAD0  3E 0A               LD   A,0AH   
  719 EAD2  CD 0DF9             CALL MV24A        ;MONI V24 Ausgabe Akku
  720 EAD5  F1          LIST1:  POP  AF      
  721 EAD6  CD E9CC             CALL CPMMOD
  722 EAD9  FB                  EI
  723 EADA  C9                  RET
  724                   ;
  725                   ;***************************   PUNCH   ***********************
  726                   ;
  727 EADB  F3          PUNCH:  DI                ;Ausgabe C nach V24
  728 EADC  79                  LD   A,C
  729 EADD  CD E9D1             CALL AC1MOD
  730 EAE0  CD 0DF9             CALL MV24A        ;MONI V24 Ausgabe Akku
  731 EAE3  CD E9CC             CALL CPMMOD
  732 EAE6  FB                  EI
  733 EAE7  C9                  RET
  734                   ;
  735                   ;******************************* CONOUT  *********************
  736                   ;
  737                   ;       Ausgabe eines Zeichens,   IN: Zeichen in C
  738                   ;
  739 EAE8  F3          CONOUT: DI
  740 EAE9  ED 73 F42A          LD   (SPCOUT),SP  ;Stack bei MON-Aufruf retten
  741 EAED  31 F3F4             LD   SP,COUTSP
  742 EAF0  F5                  PUSH AF
  743 EAF1  C5                  PUSH BC
  744 EAF2  D5                  PUSH DE
  745 EAF3  E5                  PUSH HL
  746 EAF4  CD E9D1             CALL AC1MOD
  747 EAF7  E5                  PUSH HL
  748 EAF8  2A 1800             LD   HL,(CUPOS)   ;Cursorposition
  749 EAFB  3A F427             LD   A,(CHAR)
  750 EAFE  77                  LD   (HL),A       ;altes Zeichen auf Position
  751 EAFF  3A F424             LD   A,(STZ00)    ;Durchlauf bei Steuerzeichen?
  752 EB02  A7                  AND  A
  753 EB03  C2 ED33             JP   NZ,KONV10    ;NZ= Steuerzeichen 2. oder 3. Durchlauf
  754 EB06  79                  LD   A,C          ;Byte
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  14
BIOS    ASM

  755 EB07  FE 20               CP   20H          ;kleinstes Zeichen
  756 EB09  38 26               JR   C,KONVTB
  757 EB0B  FE 7F               CP   7FH          ;groesstes Zeichen
  758 EB0D  30 22               JR   NC,KONVTB
  759 EB0F  2A 1800             LD   HL,(CUPOS)
  760 EB12  C3 EC70             JP   CCHAR        ;Ausgabe einzelnes Zeichen
  761                   ;
  762 EB15  2A 1800     KONVT9: LD   HL,(CUPOS)
  763 EB18  7E                  LD   A,(HL)
  764 EB19  32 F427             LD   (CHAR),A
  765 EB1C  3A F423             LD   A,(CUFLAG)
  766 EB1F  B7                  OR   A
  767 EB20  28 02               JR   Z,COEN1      ;Kursor nicht darstellen
  768 EB22  36 0F               LD   (HL),CUZEI
  769 EB24  CD E9CC     COEN1:  CALL CPMMOD
  770 EB27  E1                  POP  HL
  771 EB28  D1                  POP  DE
  772 EB29  C1                  POP  BC
  773 EB2A  F1                  POP  AF
  774 EB2B  ED 7B F42A          LD   SP,(SPCOUT)
  775 EB2F  FB                  EI
  776 EB30  C9                  RET
  777                   ;
  778                   ;Verzweigung bei Steuerzeichen
  779                   ;INPUT:  A=Zeichen
  780                   ;
  781 EB31  FE 1B       KONVTB: CP   1BH          ;ESC ?
  782 EB33  20 07               JR   NZ,KONVT1
  783 EB35  3E 02               LD   A,02H        ;wenn ja
  784 EB37  32 F424             LD   (STZ00),A    ;Zeiger auf 2
  785 EB3A  18 D9               JR   KONVT9       ;nichts ausgeben
  786                   ;
  787 EB3C  2A 1800     KONVT1: LD   HL,(CUPOS)
  788 EB3F  FE 01               CP   01H          ;^A Cursor home                      
  789 EB41  28 5B               JR   Z,CHOME                                             
  790 EB43  FE 07               CP   07H          ;^G akustisches Signal                                                 
  791 EB45  CA ECC2             JP   Z,MBEEP                                              
  792 EB48  FE 08               CP   08H          ;^H Cursor links                     
  793 EB4A  CA EBC6             JP   Z,CLEFT                                             
  794 EB4D  FE 0A               CP   0AH          ;^J Zeilenvorschub                   
  795 EB4F  CA EBCA             JP   Z,CLF                                               
  796 EB52  FE 0C               CP   0CH          ;^L CLS                              
  797 EB54  28 51               JR   Z,BCLS                                              
  798 EB56  FE 0D               CP   0DH          ;^M Wagenruecklauf                   
  799 EB58  CA EBE2             JP   Z,CCRET                                             
  800 EB5B  FE 14               CP   14H          ;^T BS ab Cursor loeschen            
  801 EB5D  CA EBE9             JP   Z,CBLOE                                             
  802 EB60  FE 15               CP   15H          ;^U Cursor nach rechts               
  803 EB62  CA EC0C             JP   Z,CRIGH                                             
  804 EB65  FE 16               CP   16H          ;^V Zeile ab Cursor loeschen         
  805 EB67  CA EC10             JP   Z,CZLOE                                             
  806 EB6A  FE 18               CP   18H          ;^X Zeile ab Cursor loeschen + CR    
  807 EB6C  CA EC37             JP   Z,CZLCR                                             
  808 EB6F  FE 1A               CP   1AH          ;^Z Cursor hoch                      
  809 EB71  CA EC60             JP   Z,CHOCH                                             
  810 EB74  FE 82               CP   82H          ;Kursor ein
  811 EB76  CA ED24             JP   Z,CUON
  812 EB79  FE 83               CP   83H          ;Kursor aus
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  15
BIOS    ASM

  813 EB7B  CA ED2C             JP   Z,CUOFF
  814                   ;
  815 EB7E  47                  LD   B,A          ;Zeichen merken                      
  816 EB7F  3A F41E             LD   A,(COLOR)                                         
  817 EB82  A7                  AND  A            ;Test auf Color-BWS                  
  818 EB83  CA EB15             JP   Z,KONVT9     ;Z = monochrom  
  819 EB86  78                  LD   A,B                                                 
  820                   ;
  821 EB87  FE 84               CP   84H          ;normale Darstellung
  822 EB89  CA ECE9             JP   Z,BNORM
  823 EB8C  FE 85               CP   85H          ;invers
  824 EB8E  CA ECF7             JP   Z,BINVN
  825 EB91  FE 86               CP   86H          ;intensiv - HihgLight
  826 EB93  CA ED06             JP   Z,BINTE
  827 EB96  FE 87               CP   87H          ;intensiv + invers
  828 EB98  CA ED13             JP   Z,BIVIN
  829 EB9B  C3 EB15             JP   KONVT9
  830                   ;
  831 EB9E  21 17FF     CHOME:  LD   HL,17FFH
  832 EBA1  22 1800             LD   (CUPOS),HL
  833 EBA4  C3 EB15             JP   KONVT9
  834                   ;
  835 EBA7  3E 20       BCLS:   LD   A,20H        ;0Ch  Bildschirm loeschen
  836 EBA9  CD EBD3             CALL BCL1         ;Loeschroutine
  837 EBAC  22 1800             LD   (CUPOS),HL   ;Cursorposition
  838 EBAF  3A F41E             LD   A,(COLOR)    ;Farbbyte
  839 EBB2  E6 77               AND  77H          ;Farb-BWS vorhanden?
  840 EBB4  CA EB15             JP   Z,KONVT9     ;Z = nein, dann Ende
  841 EBB7  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  842 EBBA  3A F41E             LD   A,(COLOR)
  843 EBBD  CD EBD3             CALL BCL1
  844 EBC0  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  845 EBC3  C3 EB15             JP   KONVT9
  846                   ;
  847 EBC6  23          CLEFT:  INC  HL           ;08h  Cursor links
  848 EBC7  C3 EC64             JP   CHOLI
  849                   ;
  850 EBCA  11 0040     CLF:    LD   DE,0040H     ;0Ah  Zeilenvorschub
  851 EBCD  A7                  AND  A
  852 EBCE  ED 52               SBC  HL,DE
  853 EBD0  C3 EC81             JP   SCROL
  854                   ;
  855 EBD3  21 1000     BCL1:   LD   HL,1000H     ;Anfang BWS
  856 EBD6  77                  LD   (HL),A
  857 EBD7  54                  LD   D,H
  858 EBD8  5D                  LD   E,L
  859 EBD9  1C                  INC  E
  860 EBDA  C5                  PUSH BC
  861 EBDB  01 07FF             LD   BC,07FFH     ;Laenge BWS
  862 EBDE  ED B0               LDIR
  863 EBE0  C1                  POP  BC
  864 EBE1  C9                  RET
  865                   ;
  866 EBE2  7D          CCRET:  LD   A,L          ;0Dh  Wagenruecklauf
  867 EBE3  F6 3F               OR   3FH
  868 EBE5  6F                  LD   L,A
  869 EBE6  C3 EC81             JP   SCROL
  870                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  16
BIOS    ASM

  871 EBE9  E5          CBLOE:  PUSH HL
  872 EBEA  3E 0F               LD   A,CUZEI      ;14h  BS ab Cursor loeschen
  873 EBEC  36 20       CBLO1:  LD   (HL),20H
  874 EBEE  2B                  DEC  HL
  875 EBEF  BC                  CP   H
  876 EBF0  20 FA               JR   NZ,CBLO1
  877 EBF2  E1                  POP  HL
  878 EBF3  3A F41E             LD   A,(COLOR)
  879 EBF6  47                  LD   B,A
  880 EBF7  E6 77               AND  77H
  881 EBF9  CA EB15             JP   Z,KONVT9
  882 EBFC  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  883 EBFF  3E 0F               LD   A,CUZEI
  884 EC01  70          CBLO2:  LD   (HL),B
  885 EC02  2B                  DEC  HL
  886 EC03  BC                  CP   H
  887 EC04  20 FB               JR   NZ,CBLO2
  888 EC06  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  889 EC09  C3 EB15             JP   KONVT9
  890                   ;
  891 EC0C  2B          CRIGH:  DEC  HL           ;15h  Cursor nach rechts
  892 EC0D  C3 EC81             JP   SCROL
  893                   ;
  894 EC10  E5          CZLOE:  PUSH HL           ;16h  Zeile ab Cursor loeschen
  895 EC11  7D                  LD   A,L
  896 EC12  E6 3F               AND  3FH
  897 EC14  47                  LD   B,A
  898 EC15  04                  INC  B
  899 EC16  36 20       CZLO1:  LD   (HL),20H
  900 EC18  2B                  DEC  HL
  901 EC19  10 FB               DJNZ CZLO1
  902 EC1B  E1                  POP  HL
  903 EC1C  3A F41E             LD   A,(COLOR)
  904 EC1F  4F                  LD   C,A
  905 EC20  E6 77               AND  77H
  906 EC22  CA EB15             JP   Z,KONVT9
  907 EC25  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  908 EC28  7D                  LD   A,L
  909 EC29  E6 3F               AND  3FH
  910 EC2B  47                  LD   B,A
  911 EC2C  04                  INC  B
  912 EC2D  71          CZLO2:  LD   (HL),C
  913 EC2E  2B                  DEC  HL
  914 EC2F  10 FC               DJNZ CZLO2
  915 EC31  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  916 EC34  C3 EB15             JP   KONVT9
  917                   ;
  918 EC37  E5          CZLCR:  PUSH HL           ;18h  Zeile ab Cursor loeschen + CR
  919 EC38  7D                  LD   A,L
  920 EC39  F6 3F               OR   3FH
  921 EC3B  6F                  LD   L,A
  922 EC3C  22 1800             LD   (CUPOS),HL
  923 EC3F  E5                  PUSH HL
  924 EC40  06 40               LD   B,40H        ;Zeilenlaenge
  925 EC42  36 20       CZLC1:  LD   (HL),20H
  926 EC44  2B                  DEC  HL
  927 EC45  10 FB               DJNZ CZLC1
  928 EC47  E1                  POP  HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  17
BIOS    ASM

  929 EC48  3A F41E             LD   A,(COLOR)
  930 EC4B  4F                  LD   C,A
  931 EC4C  E6 77               AND  77H
  932 EC4E  CA EB15             JP   Z,KONVT9
  933 EC51  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  934 EC54  06 40               LD   B,40H
  935 EC56  71          CZLC2:  LD   (HL),C
  936 EC57  2B                  DEC  HL
  937 EC58  10 FC               DJNZ CZLC2
  938 EC5A  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  939 EC5D  C3 EB15             JP   KONVT9
  940                   ;
  941 EC60  11 0040     CHOCH:  LD   DE,0040H     ;1Ah     Cursor hoch
  942 EC63  19                  ADD  HL,DE
  943                   ;
  944 EC64  3E 18       CHOLI:  LD   A,18H        ;Begrenzung Cursor hoch und links
  945 EC66  BC                  CP   H
  946 EC67  CA EB15             JP   Z,KONVT9
  947 EC6A  22 1800             LD   (CUPOS),HL
  948 EC6D  C3 EB15             JP   KONVT9
  949                   ;
  950 EC70  77          CCHAR:  LD   (HL),A
  951 EC71  3A F41E             LD   A,(COLOR)
  952 EC74  4F                  LD   C,A
  953 EC75  E6 77               AND  77H
  954 EC77  28 07               JR   Z,CCHA1
  955 EC79  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  956 EC7C  71                  LD   (HL),C
  957 EC7D  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  958 EC80  2B          CCHA1:  DEC  HL
  959                   ;
  960 EC81  22 1800     SCROL:  LD   (CUPOS),HL
  961 EC84  EB                  EX   DE,HL        ;Test ob Scrollen noetig
  962 EC85  21 0FFF             LD   HL,0FFFH
  963 EC88  A7                  AND  A
  964 EC89  ED 52               SBC  HL,DE        ;DE = akt. Cursorpos.
  965 EC8B  EB                  EX   DE,HL
  966 EC8C  DA EB15             JP   C,KONVT9     ;CY = nicht scrollen
  967 EC8F  3E 20               LD   A,20H        ;Leerzeichen
  968 EC91  CD ECAB             CALL SCR11        ;Scrollen
  969 EC94  3A F41E             LD   A,(COLOR)
  970 EC97  E6 77               AND  77H
  971 EC99  CA EB15             JP   Z,KONVT9     ;Z = kein Farbspeicher
  972 EC9C  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  973 EC9F  3A F41E             LD   A,(COLOR)    ;Farbbyte
  974 ECA2  CD ECAB             CALL SCR11
  975 ECA5  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  976 ECA8  C3 EB15             JP   KONVT9
  977                   ;
  978 ECAB  21 17BF     SCR11:  LD   HL,17BFH     ;Umladeroutine Scrollen
  979 ECAE  11 17FF             LD   DE,17FFH
  980 ECB1  01 07C0             LD   BC,07C0H
  981 ECB4  ED B8               LDDR
  982 ECB6  EB                  EX   DE,HL
  983 ECB7  22 1800             LD   (CUPOS),HL
  984 ECBA  23                  INC  HL
  985 ECBB  06 40               LD   B,40H        ;eine Zeilenlaenge
  986 ECBD  2D          SCR12:  DEC  L
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  18
BIOS    ASM

  987 ECBE  77                  LD   (HL),A       ;Leerzeile schreiben
  988 ECBF  10 FC               DJNZ SCR12
  989 ECC1  C9                  RET
  990                   ;
  991                   ;
  992                   ;UP 'MBEEP' (Monitor-Beep)
  993                   ;
  994 ECC2  C5          MBEEP:  PUSH BC 
  995 ECC3  06 02               LD   B,02H        ;2 Wiederholungen
  996 ECC5  C5          MBEEP1: PUSH BC 
  997                   ;       LD   BC,0040H     ;--> fuer 2 MHz
  998 ECC6  01 0080             LD   BC,0080H     ;--> fuer 4 MHz
  999 ECC9  CD ECD9             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1000                   ;       LD   BC,0F032H    ;--> fuer 2 MHz
 1001 ECCC  01 F064             LD   BC,0F064H    ;--> fuer 4 MHz
 1002 ECCF  CD ECD9             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1003 ECD2  C1                  POP  BC 
 1004 ECD3  10 F0               DJNZ MBEEP1 
 1005 ECD5  C1                  POP  BC 
 1006 ECD6  C3 EB24             JP   COEN1 
 1007                   ;
 1008                   ;
 1009                   ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1010                   ;
 1011 ECD9  F5          UPTON:  PUSH AF 
 1012 ECDA  DB 05       UPTON1: IN   A,(P05) 
 1013 ECDC  1F                  RRA 
 1014 ECDD  3F                  CCF 
 1015 ECDE  17                  RLA 
 1016 ECDF  D3 05               OUT  (P05),A 
 1017 ECE1  79                  LD   A,C 
 1018 ECE2  3D          UPTON2: DEC  A 
 1019 ECE3  20 FD               JR   NZ,UPTON2 
 1020 ECE5  10 F3               DJNZ UPTON1 
 1021 ECE7  F1                  POP  AF 
 1022 ECE8  C9                  RET 
 1023                   ;
 1024                   ;
 1025 ECE9  3A F41F     BNORM:  LD   A,(COLO1)    ;84h  normale Darstellung
 1026 ECEC  E6 77               AND  77H
 1027 ECEE  32 F41E             LD   (COLOR),A
 1028 ECF1  32 F41F             LD   (COLO1),A
 1029 ECF4  C3 EB15             JP   KONVT9
 1030                   ;
 1031 ECF7  3A F41F     BINVN:  LD   A,(COLO1)    ;85h  invers EIN
 1032 ECFA  E6 77               AND  77H
 1033 ECFC  0F                  RRCA
 1034 ECFD  0F                  RRCA
 1035 ECFE  0F                  RRCA
 1036 ECFF  0F                  RRCA
 1037 ED00  32 F41E             LD   (COLOR),A
 1038 ED03  C3 EB15             JP   KONVT9
 1039                   ;
 1040 ED06  3A F41F     BINTE:  LD   A,(COLO1)    ;86h  intensiv EIN
 1041 ED09  E6 77               AND  77H
 1042 ED0B  F6 08               OR   08H
 1043 ED0D  32 F41E             LD   (COLOR),A
 1044 ED10  C3 EB15             JP   KONVT9
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  19
BIOS    ASM

 1045                   ;
 1046 ED13  3A F41E     BIVIN:  LD   A,(COLOR)    ;87h  intensiv + invers
 1047 ED16  E6 77               AND  77H
 1048 ED18  F6 08               OR   08H
 1049 ED1A  0F                  RRCA
 1050 ED1B  0F                  RRCA
 1051 ED1C  0F                  RRCA
 1052 ED1D  0F                  RRCA
 1053 ED1E  32 F41E             LD   (COLOR),A
 1054 ED21  C3 EB15             JP   KONVT9
 1055                   ;
 1056 ED24  3E 01       CUON:   LD   A,01H        ;82h Cursor EIN
 1057 ED26  32 F423             LD   (CUFLAG),A
 1058 ED29  C3 EB15             JP   KONVT9
 1059                   ;
 1060 ED2C  AF          CUOFF:  XOR  A            ;83h Cursor AUS
 1061 ED2D  32 F423             LD   (CUFLAG),A
 1062 ED30  C3 EB15             JP   KONVT9
 1063                   ;
 1064                   ; Behandlung ESC-Sequenzen
 1065                   ;
 1066                   ; Input: ESC + 2 Steuerzeichen
 1067                   ; wenn 1. Zeichen > 80h dann Cursorposition
 1068                   ; sonst Auswertung Farbe / Grafikzeichen
 1069                   ; (stz00) = Zaehler fuer Zeichenanzahl
 1070                   ;
 1071 ED33  3A F424     KONV10: LD   A,(STZ00)
 1072 ED36  FE 02               CP   02H          ;2 = 1. Steuerzeichen (Zeile)
 1073 ED38  20 0C               JR   NZ,KONV20    ;sonst 3. Durchlauf (Spalte)
 1074 ED3A  79                  LD   A,C
 1075 ED3B  32 F425             LD   (STZ01),A    ;erstes Zeichen merken
 1076 ED3E  3E 01               LD   A,01H        ;Zeiger fuer 3. Durchlauf
 1077 ED40  32 F424             LD   (STZ00),A
 1078 ED43  C3 EB15             JP   KONVT9       ;nichts ausgeben
 1079                   ;
 1080                   ; Verzweigung Cursorposition / weitere Funktionen
 1081                   ;
 1082 ED46  79          KONV20: LD   A,C
 1083 ED47  32 F426             LD   (STZ02),A    ;zweites Zeichen merken
 1084 ED4A  AF                  XOR  A
 1085 ED4B  32 F424             LD   (STZ00),A    ;Durchlaufzaehler ruecksetzen
 1086 ED4E  21 F425             LD   HL,STZ01
 1087 ED51  7E                  LD   A,(HL)
 1088 ED52  CB 7F               BIT  7,A          ;welche Funktion? NZ = Cursor
 1089 ED54  28 2F               JR   Z,KONV22     ;Z = weitere Funktionen
 1090                   
 1091                   ; Berechnung direkte Cursorposition
 1092                   ; OUT:    HL = BWS-Adresse
 1093                   ;
 1094 ED56  F5                  PUSH AF
 1095 ED57  79                  LD   A,C
 1096 ED58  E6 3F               AND  3FH          ;max. Spaltenzahl
 1097 ED5A  6F                  LD   L,A
 1098 ED5B  F1                  POP  AF
 1099 ED5C  E6 1F               AND  1FH          ;max. Zeilenzahl
 1100 ED5E  16 00               LD   D,00H
 1101 ED60  62                  LD   H,D
 1102 ED61  5F                  LD   E,A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  20
BIOS    ASM

 1103 ED62  06 06               LD   B,06H
 1104 ED64  CB 23       KONV21: SLA  E
 1105 ED66  CB 12               RL   D
 1106 ED68  10 FA               DJNZ KONV21
 1107 ED6A  19                  ADD  HL,DE
 1108 ED6B  EB                  EX   DE,HL
 1109 ED6C  21 17FF             LD   HL,17FFH     ;Ende BWS-RAM
 1110 ED6F  A7                  AND  A
 1111 ED70  ED 52               SBC  HL,DE
 1112                   ;
 1113                   ; Cursor direkt positionieren
 1114                   ; IN:    HL = Adresse Cursor
 1115                   ;
 1116 ED72  E5                  PUSH HL
 1117 ED73  2A 1800             LD   HL,(CUPOS)	  ;alte Position
 1118 ED76  3A F427             LD   A,(CHAR)	  ;Zeichen holen
 1119 ED79  77                  LD   (HL),A	      ;auf BS schreiben
 1120 ED7A  E1                  POP  HL
 1121 ED7B  22 1800             LD   (CUPOS),HL   ;neue Position setzen
 1122 ED7E  7E                  LD   A,(HL)       ;neues Zeichen holen
 1123 ED7F  32 F427             LD   (CHAR),A     ;und merken
 1124 ED82  C3 EB15             JP   KONVT9
 1125                   ;
 1126                   ; Auswertung weiterer ESC-Funktionen
 1127                   ; IN:      A = 1. Steuerzeichen
 1128                   ;
 1129                   ; Ausgabe Grafikzeichen aus AC1-ZG ( > 80h )
 1130                   ;
 1131 ED85  FE 5F       KONV22: CP   5FH          ;Grafikzeichen?
 1132 ED87  20 08               JR   NZ,KONV24    ;NZ = nein
 1133 ED89  23                  INC  HL
 1134 ED8A  7E                  LD   A,(HL)       ;2. Zeichen holen
 1135 ED8B  2A 1800             LD   HL,(CUPOS)
 1136 ED8E  C3 EC70             JP   CCHAR        ;Zeichen ausgeben
 1137                   ;
 1138                   ; Einstellen der Farbe (nur Color-BWS)
 1139                   ;
 1140 ED91  FE 5D       KONV24: CP   5DH          ;Farbe?
 1141 ED93  C2 EB15             JP   NZ,KONVT9    ;NZ = nein
 1142 ED96  3A F41E             LD   A,(COLOR)    ;Color-BWS?
 1143 ED99  A7                  AND  A
 1144 ED9A  CA EB15             JP   Z,KONVT9     ;Z = nein
 1145 ED9D  23                  INC  HL
 1146 ED9E  7E                  LD   A,(HL)       ;2. Zeichen holen
 1147 ED9F  E6 77               AND  77H          ;intensiv maskieren
 1148 EDA1  47                  LD   B,A
 1149 EDA2  0F                  RRCA
 1150 EDA3  0F                  RRCA
 1151 EDA4  0F                  RRCA
 1152 EDA5  0F                  RRCA
 1153 EDA6  B8                  CP   B            ;Zeichen- und HG-Farbe gleich?
 1154 EDA7  CA EB15             JP   Z,KONVT9     ;Z = Ja, dann ignorieren
 1155 EDAA  78                  LD   A,B
 1156 EDAB  32 F41E             LD   (COLOR),A    ;Farbe setzen
 1157 EDAE  E6 77               AND  77H          ;intensiv maskieren
 1158 EDB0  32 F41F             LD   (COLO1),A    ;Backup
 1159 EDB3  C3 EB15             JP   KONVT9
 1160                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  21
BIOS    ASM

 1161 EDB6  DB F0       BWSCOL: IN   A,(PF0)      ;bwsport
 1162 EDB8  CB D7               SET  2,A          ;Farbspeicher ein
 1163 EDBA  18 04               JR   BWSZ1
 1164                   ;
 1165 EDBC  DB F0       BWSZEI: IN   A,(PF0)      ;bwsport
 1166 EDBE  CB 97               RES  2,A          ;Farbspeicher aus
 1167 EDC0  E6 07       BWSZ1:  AND  07H
 1168 EDC2  D3 F0               OUT  (PF0),A
 1169 EDC4  C9                  RET
 1170                   ;
 1171 EDC5  AF          BWSINI: XOR  A            ;Farbbyte auf Monochrom setzen
 1172 EDC6  32 F41E             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1173 EDC9  32 F420             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1174 EDCC  0E F0               LD   C,0F0H       ;I/O-Adresse COLOR-BWS
 1175 EDCE  ED 40               IN   B,(C)        ;Konfigbyte COLOR-BWS lesen
 1176 EDD0  04                  INC  B            ;fuer COLOR-BWS muss B<255 sein
 1177 EDD1  C8                  RET  Z            ;kein COLOR-BWS vorhanden --> Ende
 1178                           ;hier wird die Routine verlassen, wenn kein CPLD vorh. ist
 1179 EDD2  05                  DEC  B            ;Konfigbyte COLOR-BWS: Farb-RAM aus
 1180 EDD3  50                  LD   D,B
 1181 EDD4  CB D2               SET  2,D          ;Konfigbyte COLOR-BWS: Farb-RAM ein
 1182 EDD6  21 1000             LD   HL,1000H
 1183 EDD9  5E                  LD   E,(HL)       ;Zeichen aus 1000h
 1184 EDDA  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1185 EDDC  3A 181F             LD   A,(CBWSB)    ;Farbbyte aus dem AC1-Monitor
 1186 EDDF  77                  LD   (HL),A       ;Farbe auf 1000h setzen
 1187 EDE0  BE                  CP   (HL)         ;ist Farb-RAM gesteckt?
 1188 EDE1  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1189 EDE3  73                  LD   (HL),E       ;Zeichen auf 1000h zurueckschreiben
 1190 EDE4  C0                  RET  NZ           ;Farbe hat nicht geklappt --> Ende
 1191                           ;hier wird die Routine verlassen, wenn kein Farb-RAM steckt
 1192 EDE5  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1193 EDE7  C5                  PUSH BC
 1194 EDE8  11 1001             LD   DE,1001H
 1195 EDEB  01 07FF             LD   BC,07FFH
 1196 EDEE  ED B0               LDIR              ;Farb-RAM initialisieren
 1197 EDF0  7E                  LD   A,(HL)       ;Farbe aus 17FFh ruecklesen
 1198 EDF1  C1                  POP  BC
 1199 EDF2  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1200 EDF4  32 F41E             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1201 EDF7  32 F420             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1202 EDFA  C9                  RET
 1203                   ;
 1204                   ;+++++++++++++++++++++++++++++   Ende CONOUT  ++++++++++++++++
 1205                   ;
 1206 EDFB  AF          LISTST: XOR  A
 1207 EDFC  3D                  DEC  A
 1208 EDFD  C9                  RET
 1209                   ;
 1210                   ;--------------------------------------------------------------------------
 1211                   ;
 1212 EDFE  21 E641     SELDSK: LD   HL,NDISK     ;max. Anzahl der LW
 1213 EE01  79                  LD   A,C          ;C = akt. LW
 1214 EE02  BE                  CP   (HL)
 1215 EE03  21 0000             LD   HL,0000H     ;HL=0 --> kein LW
 1216 EE06  D0                  RET  NC           ;akt. LW >= NDISK!!!
 1217 EE07  2A E642             LD   HL,(DPHX)    ;AnfangsADR DPH(y)-Tabelle
 1218 EE0A  06 00               LD   B,00H        ;BC = akt. LW
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  22
BIOS    ASM

 1219 EE0C  09                  ADD  HL,BC
 1220 EE0D  09                  ADD  HL,BC        ;HL = DPHY + (2 * LW)
 1221 EE0E  5E                  LD   E,(HL)
 1222 EE0F  23                  INC  HL
 1223 EE10  56                  LD   D,(HL)       ;DE = (DPHY + (2 * LW))
 1224 EE11  EB                  EX   DE,HL        ;HL = DPH-ADR vom akt. LW
 1225 EE12  7C                  LD   A,H
 1226 EE13  B5                  OR   L
 1227 EE14  C8                  RET  Z            ;HL=0 --> kein DPB
 1228 EE15  79                  LD   A,C
 1229 EE16  32 F442             LD   (DRIVE),A    ;aktives LW --> A
 1230 EE19  22 F449             LD   (DPH),HL     ;zugeordneter DPH --> HL
 1231 EE1C  C9                  RET
 1232                   ;
 1233                   ;--------------------------------------------------------------------------
 1234                   ;
 1235 EE1D  01 0000     HOME:   LD   BC,0000H
 1236 EE20  ED 43 F443  SETTRK: LD   (TRACK),BC
 1237 EE24  C9                  RET
 1238                   ;
 1239 EE25  ED 43 F445  SETSEC: LD   (SECTOR),BC
 1240 EE29  C9                  RET
 1241                   ;
 1242 EE2A  ED 43 F447  SETDMA: LD   (DMA),BC
 1243 EE2E  C9                  RET
 1244                   ;
 1245 EE2F  60          SECTRN: LD   H,B
 1246 EE30  69                  LD   L,C
 1247 EE31  7A                  LD   A,D
 1248 EE32  B3                  OR   E
 1249 EE33  C8                  RET  Z
 1250 EE34  EB                  EX   DE,HL
 1251 EE35  06 00               LD   B,00H
 1252 EE37  09                  ADD  HL,BC
 1253 EE38  6E                  LD   L,(HL)
 1254 EE39  62                  LD   H,D
 1255 EE3A  C9                  RET
 1256                   ;
 1257                   ;--------------------------------------------------------------------------
 1258                   ;
 1259 EE3B  0E 02       READ:   LD   C,02H
 1260 EE3D  3E 04               LD   A,04H
 1261 EE3F  21                  DEFB 21H          ;LD HL,063EH mit nxt. Befehl!!!
 1262 EE40  3E 06       WRITE:  LD   A,06H        ;DUMMY fuer READ
 1263 EE42  32 F441             LD   (RWBYTE),A   ;RWBYTE: 04 = Lesen; 06 = Schreiben
 1264 EE45  79                  LD   A,C
 1265 EE46  32 F464             LD   (DF51E),A
 1266 EE49  21 EE62             LD   HL,RWEND
 1267 EE4C  E5                  PUSH HL
 1268 EE4D  2A F449             LD   HL,(DPH)
 1269 EE50  11 000A             LD   DE,000AH
 1270 EE53  19                  ADD  HL,DE
 1271 EE54  7E                  LD   A,(HL)       ;NWT vom DPB
 1272 EE55  23                  INC  HL
 1273 EE56  66                  LD   H,(HL)       ;HWT vom DPB
 1274 EE57  6F                  LD   L,A
 1275 EE58  2B                  DEC  HL
 1276 EE59  7E                  LD   A,(HL)       ;HWT der R/W-Funktion
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  23
BIOS    ASM

 1277 EE5A  2B                  DEC  HL
 1278 EE5B  6E                  LD   L,(HL)       ;NWT der R/W-Funktion
 1279 EE5C  67                  LD   H,A
 1280 EE5D  E5                  PUSH HL           ;Adresse der R/W-Funktion
 1281 EE5E  21 F441             LD   HL,RWBYTE    ;HL -> R/W-Byte
 1282 EE61  C9                  RET               ;JP R/W-Funktion
 1283                   ;
 1284 EE62  B7          RWEND:  OR   A
 1285 EE63  C8                  RET  Z
 1286 EE64  3E 01               LD   A,01H        ;Fehler
 1287 EE66  C9                  RET
 1288                   ;
 1289                   ;************************  RAM-Disk   ******************************
 1290                   ;
 1291 EE67  4E          RWRDSK: LD   C,(HL)       ;RWBYTE: 04 = Lesen; 06 = Schreiben 
 1292 EE68  23                  INC  HL           ;DRIVE wird uebersprungen
 1293 EE69  23                  INC  HL
 1294 EE6A  7E                  LD   A,(HL)       ;TRACK NWT
 1295 EE6B  32 F421             LD   (RAFTRK),A
 1296 EE6E  23                  INC  HL
 1297 EE6F  7E                  LD   A,(HL)       ;TRACK HWT
 1298 EE70  A7                  AND  A
 1299 EE71  20 32               JR   NZ,RDERR     ;muss 0 sein
 1300 EE73  23                  INC  HL
 1301 EE74  7E                  LD   A,(HL)       ;SEKTOR NWT
 1302 EE75  32 F422             LD   (RAFSEC),A
 1303 EE78  CB 7F               BIT  7,A
 1304 EE7A  20 29               JR   NZ,RDERR     ;Bit 7 muss 0 sein
 1305 EE7C  CB 77               BIT  6,A
 1306 EE7E  20 25               JR   NZ,RDERR     ;Bit 6 muss 0 sein
 1307 EE80  23                  INC  HL
 1308 EE81  7E                  LD   A,(HL)       ;SEKTOR HWT
 1309 EE82  A7                  AND  A
 1310 EE83  20 20               JR   NZ,RDERR     ;muss 0 sein
 1311 EE85  23                  INC  HL
 1312 EE86  23                  INC  HL           ;DMA wird uebersprungen
 1313 EE87  79                  LD   A,C
 1314 EE88  01 0080             LD   BC,0080H
 1315 EE8B  FE 06               CP   06H
 1316 EE8D  28 08               JR   Z,RDSKWR     ;C = 06 --> RDSK Schreiben
 1317 EE8F  CD EFD2             CALL ADRRAF
 1318 EE92  ED B2               INIR
 1319 EE94  00                  NOP
 1320 EE95  AF                  XOR  A            ;in Ordnung
 1321 EE96  C9                  RET
 1322                   ;
 1323 EE97  21 0080     RDSKWR: LD   HL,0080H     ;RAM-Disk schreiben 
 1324 EE9A  ED 5B F447          LD   DE,(DMA)
 1325 EE9E  CD EFD2             CALL ADRRAF
 1326 EEA1  ED B3               OTIR
 1327 EEA3  AF                  XOR  A            ;in Ordnung
 1328 EEA4  C9                  RET
 1329                   ;
 1330 EEA5  3E FF       RDERR:  LD   A,0FFH       ;Fehler
 1331 EEA7  C9                  RET
 1332                   ;
 1333 EEA8  20 3D 3E 49 TXTRDI: DEFM " =>INIT.."
 1334 EEB1  00                  DEFB 0
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  24
BIOS    ASM

 1335                   ;
 1336 EEB2  4F 4B       TXTRDO: DEFM "OK"
 1337 EEB4  00                  DEFB 0
 1338                   ;
 1339 EEB5  52 46 4C 20 TXTRDE: DEFM "RFL ERROR!"
 1340 EEBF  0D 0A               DEFB 0DH,0AH
 1341 EEC1  00                  DEFB 0
 1342                   ;
 1343 EEC2  AF          RDTEST: XOR  A            ;Kapazitaet der RAM-Disk testen
 1344 EEC3  D3 E6               OUT  (PE0+6),A    ;H-Adresse ruecksetzen
 1345 EEC5  0E E0               LD   C,PE0        ;Test erfolgt in der 1. RAM-Bank
 1346                   ;
 1347                   ; Inhalte der 4 RAM-Testzellen sichern
 1348                   ;
 1349 EEC7  21 EF1E             LD   HL,RDMERK    ;Merkzellen im RAM
 1350 EECA  06 04               LD   B,4          ;4 Durchlaeufe
 1351 EECC  16 04               LD   D,4          ;Startwert Extended-Adresse
 1352 EECE  AF          RDTST1: XOR  A
 1353 EECF  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1354 EED1  7A                  LD   A,D
 1355 EED2  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1356 EED4  ED 78               IN   A,(C)
 1357 EED6  77                  LD   (HL),A       ;Daten aus der RAM-Disk sichern
 1358 EED7  23                  INC  HL           ;Merkzelle++
 1359 EED8  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1360 EEDA  10 F2               DJNZ RDTST1
 1361                   ;
 1362                   ; 4 Testwerte in die RAM-Disk schreiben
 1363                   ;
 1364 EEDC  06 04               LD   B,4          ;4 Durchlaeufe
 1365 EEDE  16 04               LD   D,4          ;Startwert Extended-Adresse
 1366 EEE0  AF          RDTST2: XOR  A
 1367 EEE1  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1368 EEE3  7A                  LD   A,D
 1369 EEE4  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1370 EEE6  ED 79               OUT  (C),A        ;Testwert in die RAM-Disk schreiben
 1371 EEE8  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1372 EEEA  10 F4               DJNZ RDTST2
 1373                   ;
 1374                   ;Tabelle der Test-Werte (mit *...* sind die zu testenden Werte):
 1375                   ;
 1376                   ;           RAM-Disk-Size =   256K   512K  1024K  2048K
 1377                   ;Extended-Adresse=00000100B    0      0      0     *4*
 1378                   ;Extended-Adresse=00000010B    0      0     *2*     2
 1379                   ;Extended-Adresse=00000001B    0     *1*     1      1
 1380                   ;Extended-Adresse=00000000B   *0*     0      0      0
 1381                   ;
 1382                   ; Groesse der RAM-Disk bestimmen
 1383                   ;
 1384 EEEC  06 04               LD   B,4          ;4 Durchlaeufe
 1385 EEEE  16 04               LD   D,4          ;Startwert Extended-Adresse
 1386 EEF0  AF          RDTST3: XOR  A
 1387 EEF1  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1388 EEF3  7A                  LD   A,D
 1389 EEF4  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1390 EEF6  ED 78               IN   A,(C)
 1391 EEF8  BA                  CP   D
 1392 EEF9  28 07               JR   Z,RDTST4     ;2048(B=4),1024(B=3),512(B=2),256(B=1)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  25
BIOS    ASM

 1393 EEFB  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1394 EEFD  10 F1               DJNZ RDTST3
 1395 EEFF  C3 EFC9             JP   RDERRO       ;Fehler: hier stimmt was nicht!
 1396                   ;
 1397 EF02  21 EF22     RDTST4: LD   HL,RDSIZE
 1398 EF05  05                  DEC  B
 1399 EF06  70                  LD   (HL),B       ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1400                   ;
 1401                   ; gesicherte Daten in die RAM-Disk zurueckschreiben
 1402                   ; 
 1403 EF07  21 EF21             LD   HL,RDMERK+3  ;Merkzellen RAM (letzter Eintrag)
 1404 EF0A  04                  INC  B            ;1 bis 4 Durchlaeufe, je nach RDSIZE
 1405 EF0B  16 01               LD   D,1          ;Startwert Ext.-Adr. (1 Bit n. rechts)
 1406 EF0D  AF          RDTST5: XOR  A
 1407 EF0E  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1408 EF10  7A                  LD   A,D
 1409 EF11  CB 3F               SRL  A            ;0 --> A7 --> A0 --> CY
 1410 EF13  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1411 EF15  7E                  LD   A,(HL)
 1412 EF16  ED 79               OUT  (C),A        ;urspruengliche Daten zurueckschreiben
 1413 EF18  2B                  DEC  HL
 1414 EF19  CB 22               SLA  D            ;CY <-- D7 <-- D0 <-- 0
 1415 EF1B  10 F0               DJNZ RDTST5       ;WICHTIG: nicht mehr als notwendig
 1416 EF1D  C9                  RET               ;in die RAM-Disk zurueckschreiben!
 1417                   ;
 1418 EF1E  00 00 00 00 RDMERK: DEFS 4,0          ;4 Merkzellen fuer den RAM
 1419 EF22  00          RDSIZE: DEFB 0            ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1420                   ;
 1421 EF23  21 EEA8     RDFORM: LD   HL,TXTRDI    ;Formatierungstext...
 1422 EF26  CD EA58             CALL OUTTXT
 1423 EF29  21 C002             LD   HL,0C002H    ;Hilfsprogramm von 0C000H bis 0C800H
 1424 EF2C  54                  LD   D,H
 1425 EF2D  5D                  LD   E,L
 1426 EF2E  2B                  DEC  HL
 1427 EF2F  36 E0               LD   (HL),PE0     ;0C001H = Grundadresse der RAM-Disk
 1428 EF31  2B                  DEC  HL
 1429 EF32  36 D3               LD   (HL),0D3H    ;0C000H = 0D3H --> OUT n
 1430 EF34  01 0200             LD   BC,0200H
 1431 EF37  ED B0               LDIR              ;0D3H,0E0H von 0C000H bis 0C1FFH
 1432 EF39  23                  INC  HL
 1433 EF3A  36 E1               LD   (HL),PE0+1
 1434 EF3C  2B                  DEC  HL
 1435 EF3D  01 0200             LD   BC,0200H
 1436 EF40  ED B0               LDIR              ;0D3H,0E1H von 0C200H bis 0C3FFH
 1437 EF42  23                  INC  HL
 1438 EF43  36 E2               LD   (HL),PE0+2
 1439 EF45  2B                  DEC  HL
 1440 EF46  01 0200             LD   BC,0200H
 1441 EF49  ED B0               LDIR              ;0D3H,0E2H von 0C400H bis 0C5FFH
 1442 EF4B  23                  INC  HL
 1443 EF4C  36 E3               LD   (HL),PE0+3
 1444 EF4E  2B                  DEC  HL
 1445 EF4F  01 0200             LD   BC,0200H
 1446 EF52  ED B0               LDIR              ;0D3H,0E3H von 0C600H bis 0C7FFH
 1447 EF54  36 C9               LD   (HL),0C9H    ;RET auf 0C800H
 1448                   ;
 1449 EF56  21 EF22             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1450 EF59  7E                  LD   A,(HL)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  26
BIOS    ASM

 1451 EF5A  FE 00               CP   0
 1452 EF5C  28 0A               JR   Z,RDFOR1     ;RD 256K
 1453 EF5E  FE 01               CP   1
 1454 EF60  28 06               JR   Z,RDFOR1     ;RD 512K
 1455 EF62  3D                  DEC  A
 1456 EF63  CB 27               SLA  A            ;A *= 2
 1457 EF65  CB 27               SLA  A            ;A *= 2
 1458 EF67  3D                  DEC  A
 1459 EF68  57          RDFOR1: LD   D,A
 1460 EF69  14                  INC  D            ;D ==> 1=256K 2=512K 4=1024K 8=2048K
 1461 EF6A  AF                  XOR  A
 1462 EF6B  D3 E7               OUT  (PE0+7),A    ;L-Adresse setzen
 1463 EF6D  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1464 EF6F  1E 00               LD   E,0          ;Merker fuer Extended-Adresse
 1465 EF71  06 00               LD   B,0          ;256 Durchlaeufe
 1466 EF73  0E E6               LD   C,PE0+6
 1467 EF75  ED 41       RDFOR2: OUT  (C),B        ;H-Adresse setzen
 1468 EF77  3E E5               LD   A,0E5H       ;RD wird mit 0E5H formatiert
 1469 EF79  CD C000             CALL HPRDSK       ;Hilfsprog. Format RAM-Disk auf C000H
 1470 EF7C  10 F7               DJNZ RDFOR2       ;fuer alle H-Adressen (256 Durchl.)
 1471 EF7E  1C                  INC  E
 1472 EF7F  7B                  LD   A,E
 1473 EF80  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1474 EF82  15                  DEC  D
 1475 EF83  20 F0               JR   NZ,RDFOR2        
 1476                   ;
 1477 EF85  21 D000             LD   HL,CCP
 1478 EF88  22 F447             LD   (DMA),HL
 1479 EF8B  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
 1480 EF8D  CD EF9A             CALL WRCCP
 1481 EF90  C2 E98E             JP   NZ,CPMERR
 1482 EF93  21 EEB2             LD   HL,TXTRDO    ;"OK"
 1483 EF96  CD EA58             CALL OUTTXT
 1484 EF99  C9                  RET
 1485                   ;
 1486 EF9A  C5          WRCCP:  PUSH BC           ;CCP+BDOS in Systemtrack schreiben
 1487 EF9B  0E 00               LD   C,0          ;LW A:
 1488 EF9D  CD EDFE             CALL SELDSK
 1489 EFA0  C1                  POP  BC
 1490 EFA1  21 0000             LD   HL,0000H
 1491 EFA4  22 F443             LD   (TRACK),HL   ;Track 0
 1492 EFA7  EB                  EX   DE,HL
 1493 EFA8  21 D000             LD   HL,CCP
 1494 EFAB  ED 53 F445  WRCCP1: LD   (SECTOR),DE  ;Sektor 0 ff.
 1495 EFAF  22 F447             LD   (DMA),HL
 1496 EFB2  C5                  PUSH BC
 1497 EFB3  CD                  DEFB 0CDH         ;CALL WRITE -> CD ED CA
 1498 EFB4  EE40        WRCCP2: DEFW WRITE        ;kannn durch READ (EDC5) ersetzt werden
 1499 EFB6  C1                  POP  BC
 1500 EFB7  20 10               JR   NZ,RDERRO
 1501 EFB9  2A F447             LD   HL,(DMA)
 1502 EFBC  11 0080             LD   DE,0080H
 1503 EFBF  19                  ADD  HL,DE
 1504 EFC0  ED 5B F445          LD   DE,(SECTOR)
 1505 EFC4  13                  INC  DE
 1506 EFC5  10 E4               DJNZ WRCCP1
 1507 EFC7  AF                  XOR  A
 1508 EFC8  C9                  RET
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  27
BIOS    ASM

 1509                   ;
 1510 EFC9  21 EEB5     RDERRO: LD   HL,TXTRDE
 1511 EFCC  CD EA58             CALL OUTTXT
 1512 EFCF  AF                  XOR  A
 1513 EFD0  3D                  DEC  A
 1514 EFD1  C9                  RET
 1515                   ;
 1516                   ;Adressarithmetik RAF: L=RADR 0-7 , H=RADR 8-15 , A=RADR 16-19
 1517                   ;
 1518 EFD2  AF          ADRRAF: XOR  A            ;CY = 0
 1519 EFD3  6F                  LD   L,A 
 1520 EFD4  3A F422             LD   A,(RAFSEC)   ;8 bit
 1521 EFD7  67                  LD   H,A          ;H=Sektor (max. 64 = Bit 0-5)
 1522 EFD8  CB 1C               RR   H
 1523 EFDA  CB 1D               RR   L            ;H0 -> L7 ...... H5 -> H4
 1524 EFDC  3A F421             LD   A,(RAFTRK)   ;8 bit , A=Track (max. 128 bei 1M = Bit 0-6)
 1525 EFDF  CB 1F               RR   A            ;A0 -> CY
 1526 EFE1  30 02               JR   NC,ADRAF1
 1527 EFE3  CB EC               SET  5,H          ;H5 = A0 (RADR13)
 1528 EFE5  CB 1F       ADRAF1: RR   A            ;A1 -> CY
 1529 EFE7  30 02               JR   NC,ADRAF2
 1530 EFE9  CB F4               SET  6,H          ;H6 = A1 (RADR14)
 1531 EFEB  CB 1F       ADRAF2: RR   A            ;A2 -> CY
 1532 EFED  30 02               JR   NC,ADRAF3
 1533 EFEF  CB FC               SET  7,H          ;H7 = A2 (RADR15)
 1534 EFF1  F5          ADRAF3: PUSH AF
 1535 EFF2  E6 03               AND  03H
 1536 EFF4  F6 E0               OR   PE0          ;Grundadresse der RAM-Disk
 1537 EFF6  4F                  LD   C,A
 1538 EFF7  7D                  LD   A,L
 1539 EFF8  D3 E7               OUT  (PE0+7),A    ;L-Adresse
 1540 EFFA  7C                  LD   A,H
 1541 EFFB  D3 E6               OUT  (PE0+6),A    ;H-Adresse
 1542 EFFD  F1                  POP  AF
 1543 EFFE  CB 1F               RR   A            ;Rotiere A rechts durch Carry
 1544 F000  CB 1F               RR   A
 1545 F002  E6 07               AND  07H          ;max. 2048K RAM-Disk
 1546 F004  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1547 F006  06 80               LD   B,80H
 1548 F008  2A F447             LD   HL,(DMA)
 1549 F00B  C9                  RET
 1550                   ;
 1551                   ;**********************  Ende  RAM-Disk  *********************
 1552                   ;
 1553                   ;*************************  LOAD-Befehl  *********************
 1554                   ;
 1555 F00C  C9          LOAD:   RET
 1556                   ;
 1557                   ;******************************   Ende LOAD  *****************
 1558                   ;
 1559 F00D  2A F449     LEFFA:  LD   HL,(DPH)     ;zugeordneter DPH --> HL
 1560 F010  22 F45B             LD   (DPH3M),HL   ;Merkzelle DPH
 1561 F013  2E 0F       LF000:  LD   L,0FH
 1562 F015  D5          LF002:  PUSH DE
 1563 F016  11 000A             LD   DE,000AH
 1564 F019  62                  LD   H,D
 1565 F01A  E5                  PUSH HL
 1566 F01B  2A F45B             LD   HL,(DPH3M)   ;Merkzelle DPH
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  28
BIOS    ASM

 1567 F01E  19                  ADD  HL,DE
 1568 F01F  5E                  LD   E,(HL)
 1569 F020  23                  INC  HL
 1570 F021  56                  LD   D,(HL)
 1571 F022  E1                  POP  HL
 1572 F023  19                  ADD  HL,DE
 1573 F024  D1                  POP  DE
 1574 F025  7E                  LD   A,(HL)
 1575 F026  B7                  OR   A
 1576 F027  C9                  RET
 1577                   ;
 1578                   ;
 1579                   ;       READ/WRITE Routinen GIDE + Floppy-Disk
 1580                   ;       --------------------------------------
 1581                   ;
 1582 F028  23          RWGIDE: INC  HL
 1583 F029  CB FE               SET  7,(HL)
 1584 F02B  2B                  DEC  HL
 1585 F02C  AF          RWFLO:  XOR  A
 1586 F02D  32 F462             LD   (DF51C),A
 1587 F030  CD F037             CALL LF024
 1588 F033  3A F462             LD   A,(DF51C)
 1589 F036  C9                  RET
 1590                   ;
 1591 F037  4E          LF024:  LD   C,(HL)
 1592 F038  CD F00D             CALL LEFFA
 1593 F03B  CA F0F4             JP   Z,LF0E1
 1594 F03E  79                  LD   A,C
 1595 F03F  FE 06               CP   06H
 1596 F041  3E 01               LD   A,01H
 1597 F043  20 01               JR   NZ,LF033
 1598 F045  AF                  XOR  A
 1599 F046  32 F463     LF033:  LD   (DF51D),A
 1600 F049  CD F013             CALL LF000
 1601 F04C  47                  LD   B,A
 1602 F04D  2A F445             LD   HL,(SECTOR)
 1603 F050  CB 3C       LF03D:  SRL  H
 1604 F052  CB 1D               RR   L
 1605 F054  10 FA               DJNZ LF03D
 1606 F056  22 F45E             LD   (DF518),HL
 1607 F059  21 F460             LD   HL,DF51A
 1608 F05C  7E                  LD   A,(HL)
 1609 F05D  36 01               LD   (HL),01H
 1610 F05F  B7                  OR   A
 1611 F060  28 26               JR   Z,LF075
 1612 F062  3A F442             LD   A,(DRIVE)
 1613 F065  21 F44B             LD   HL,DRV2
 1614 F068  BE                  CP   (HL)
 1615 F069  20 16               JR   NZ,LF06E
 1616 F06B  2A F44C             LD   HL,(TRK2)
 1617 F06E  ED 5B F443          LD   DE,(TRACK)
 1618 F072  ED 52               SBC  HL,DE
 1619 F074  20 0B               JR   NZ,LF06E
 1620 F076  2A F44E             LD   HL,(SEC2)
 1621 F079  ED 5B F45E          LD   DE,(DF518)
 1622 F07D  ED 52               SBC  HL,DE
 1623 F07F  28 1F               JR   Z,LF08D
 1624 F081  3A F461     LF06E:  LD   A,(DF51B)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  29
BIOS    ASM

 1625 F084  B7                  OR   A
 1626 F085  C4 F0E1             CALL NZ,LF0CE
 1627 F088  21 F442     LF075:  LD   HL,DRIVE
 1628 F08B  11 F44B             LD   DE,DRV2
 1629 F08E  01 0009             LD   BC,9         ;9 Bytes kopieren
 1630 F091  ED B0               LDIR
 1631 F093  2A F45E             LD   HL,(DF518)
 1632 F096  22 F44E             LD   (SEC2),HL
 1633 F099  CD F0E4             CALL LF0D1
 1634 F09C  AF                  XOR  A
 1635 F09D  32 F461             LD   (DF51B),A
 1636 F0A0  CD F013     LF08D:  CALL LF000
 1637 F0A3  23                  INC  HL
 1638 F0A4  3A F445             LD   A,(SECTOR)
 1639 F0A7  A6                  AND  (HL)
 1640 F0A8  1F                  RRA
 1641 F0A9  67                  LD   H,A
 1642 F0AA  3E 00               LD   A,00H
 1643 F0AC  1F                  RRA
 1644 F0AD  6F                  LD   L,A
 1645 F0AE  11 F465             LD   DE,DISKP
 1646 F0B1  19                  ADD  HL,DE
 1647 F0B2  ED 5B F447          LD   DE,(DMA)
 1648 F0B6  3A F463             LD   A,(DF51D)
 1649 F0B9  B7                  OR   A
 1650 F0BA  20 05               JR   NZ,LF0AE
 1651 F0BC  3C                  INC  A
 1652 F0BD  32 F461             LD   (DF51B),A
 1653 F0C0  EB                  EX   DE,HL
 1654 F0C1  01 0080     LF0AE:  LD   BC,0080H
 1655 F0C4  ED B0               LDIR
 1656 F0C6  3A F462             LD   A,(DF51C)
 1657 F0C9  B7                  OR   A
 1658 F0CA  20 10               JR   NZ,LF0C9
 1659 F0CC  3A F464             LD   A,(DF51E)
 1660 F0CF  3D                  DEC  A
 1661 F0D0  C0                  RET  NZ
 1662 F0D1  32 F461             LD   (DF51B),A
 1663 F0D4  CD F0E1             CALL LF0CE
 1664 F0D7  3A F462             LD   A,(DF51C)
 1665 F0DA  B7                  OR   A
 1666 F0DB  C8                  RET  Z
 1667 F0DC  AF          LF0C9:  XOR  A
 1668 F0DD  32 F460             LD   (DF51A),A
 1669 F0E0  C9                  RET
 1670                   ;
 1671 F0E1  3E 06       LF0CE:  LD   A,06H
 1672 F0E3  21                  DEFB 21H          ;LD HL,043EH -> 21 3E 04
 1673 F0E4  3E 04       LF0D1:  LD   A,04H  
 1674 F0E6  32 F45D             LD   (MERKRW),A
 1675 F0E9  21 F465             LD   HL,DISKP
 1676 F0EC  22 F450             LD   (DMA2),HL
 1677 F0EF  21 F44B             LD   HL,DRV2
 1678 F0F2  18 09               JR   LF0EA
 1679                   ;
 1680 F0F4  3A F441     LF0E1:  LD   A,(RWBYTE)
 1681 F0F7  32 F45D             LD   (MERKRW),A
 1682 F0FA  21 F442             LD   HL,DRIVE
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  30
BIOS    ASM

 1683 F0FD  11 F454     LF0EA:  LD   DE,DRV3
 1684 F100  01 0009             LD   BC,9         ;9 Bytes kopieren
 1685 F103  ED B0               LDIR
 1686 F105  3A F454             LD   A,(DRV3)
 1687 F108  17                  RLA
 1688 F109  DA F31B             JP   C,GIDERW     ;GIDE
 1689 F10C  3A F456             LD   A,(TRK3+1)
 1690 F10F  21 F458             LD   HL,SEC3+1
 1691 F112  B6                  OR   (HL)
 1692 F113  C2 F1D4             JP   NZ,LF1C1
 1693 F116  CD F013             CALL LF000
 1694 F119  32 F434             LD   (DF4E8),A
 1695 F11C  B7                  OR   A
 1696 F11D  3E FF               LD   A,0FFH
 1697 F11F  28 02               JR   Z,LF110
 1698 F121  3E 80               LD   A,80H
 1699 F123  32 F437     LF110:  LD   (DF4EB),A
 1700 F126  23                  INC  HL
 1701 F127  23                  INC  HL
 1702 F128  7E                  LD   A,(HL)
 1703 F129  32 F435             LD   (DF4E9),A
 1704 F12C  3A F457             LD   A,(SEC3)
 1705 F12F  BE                  CP   (HL)
 1706 F130  38 04               JR   C,LF123
 1707 F132  96                  SUB  (HL)
 1708 F133  01 0104             LD   BC,0104H
 1709 F136  3C          LF123:  INC  A
 1710 F137  32 F433             LD   (DF4E7),A
 1711 F13A  23                  INC  HL
 1712 F13B  7E                  LD   A,(HL)
 1713 F13C  32 F436             LD   (DF4EA),A
 1714 F13F  23                  INC  HL
 1715 F140  3A F455             LD   A,(TRK3)
 1716 F143  BE                  CP   (HL)
 1717 F144  38 04               JR   C,LF137
 1718 F146  96                  SUB  (HL)
 1719 F147  01 0104             LD   BC,0104H
 1720 F14A  32 F431     LF137:  LD   (DF4E5),A
 1721 F14D  23                  INC  HL
 1722 F14E  7E                  LD   A,(HL)
 1723 F14F  B1                  OR   C
 1724 F150  32 F430             LD   (DF4E4),A
 1725 F153  78                  LD   A,B
 1726 F154  32 F432             LD   (DF4E6),A
 1727 F157  23                  INC  HL
 1728 F158  3A F45D             LD   A,(MERKRW)
 1729 F15B  16 05               LD   D,05H
 1730 F15D  FE 06               CP   06H
 1731 F15F  28 02               JR   Z,LF150
 1732 F161  16 06               LD   D,06H
 1733 F163  7E          LF150:  LD   A,(HL)
 1734 F164  E6 40               AND  40H
 1735 F166  B2                  OR   D
 1736 F167  32 F42E             LD   (DF4E2),A
 1737 F16A  11 F438             LD   DE,DF4EC
 1738 F16D  01 0004             LD   BC,0004H
 1739 F170  ED B0               LDIR
 1740 F172  0E 02               LD   C,02H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  31
BIOS    ASM

 1741 F174  06 02       LF161:  LD   B,02H
 1742 F176  C5          LF163:  PUSH BC
 1743 F177  CD F188             CALL LF175
 1744 F17A  C1                  POP  BC
 1745 F17B  B7                  OR   A
 1746 F17C  C8                  RET  Z
 1747 F17D  10 F7               DJNZ LF163
 1748 F17F  0D                  DEC  C
 1749 F180  C8                  RET  Z
 1750 F181  C5                  PUSH BC
 1751 F182  CD F1E8             CALL LF1D5
 1752 F185  C1                  POP  BC
 1753 F186  18 EC               JR   LF161
 1754                   ;
 1755 F188  3E 03       LF175:  LD   A,03H
 1756 F18A  06 02               LD   B,02H
 1757 F18C  21 F43A             LD   HL,CTAB      ;FDC Befehlsbyte
 1758 F18F  D3 41               OUT  (DFDC),A     ;Datenport FDC
 1759 F191  CD F243             CALL LF230
 1760 F194  CD F1FA             CALL LF1E7
 1761 F197  20 3B               JR   NZ,LF1C1
 1762 F199  21 0040             LD   HL,0040H
 1763 F19C  3A F434             LD   A,(DF4E8)
 1764 F19F  3C                  INC  A
 1765 F1A0  29          LF18D:  ADD  HL,HL
 1766 F1A1  3D                  DEC  A
 1767 F1A2  20 FC               JR   NZ,LF18D
 1768 F1A4  2B                  DEC  HL
 1769 F1A5  24                  INC  H
 1770 F1A6  2C                  INC  L
 1771 F1A7  E5                  PUSH HL
 1772 F1A8  2A F459             LD   HL,(DMA3)
 1773 F1AB  E5                  PUSH HL
 1774 F1AC  3A F42E             LD   A,(DF4E2)
 1775 F1AF  4F                  LD   C,A
 1776 F1B0  06 09               LD   B,09H
 1777 F1B2  0F                  RRCA
 1778 F1B3  3E 51               LD   A,51H
 1779 F1B5  8F                  ADC  A,A
 1780 F1B6  32 F282             LD   (MODE0),A    ;A2 --> INI
 1781 F1B9  32 F288             LD   (MODE1),A    ;A3 --> OUTI
 1782 F1BC  F3                  DI
 1783 F1BD  CD F23A             CALL LF227
 1784 F1C0  E1                  POP  HL
 1785 F1C1  D1                  POP  DE
 1786 F1C2  43                  LD   B,E
 1787 F1C3  0E 41               LD   C,DFDC       ;Datenport FDC
 1788 F1C5  CD F275             CALL RW           ;FDC RW-Routine
 1789 F1C8  FB                  EI
 1790 F1C9  CD F1DB             CALL LF1C8
 1791 F1CC  21 F43C             LD   HL,DF4F0
 1792 F1CF  7E                  LD   A,(HL)
 1793 F1D0  E6 C0               AND  0C0H
 1794 F1D2  28 02               JR   Z,LF1C3
 1795 F1D4  3E FF       LF1C1:  LD   A,0FFH
 1796 F1D6  32 F462     LF1C3:  LD   (DF51C),A
 1797 F1D9  B7                  OR   A
 1798 F1DA  C9                  RET
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  32
BIOS    ASM

 1799                   ;
 1800 F1DB  06 07       LF1C8:  LD   B,07H
 1801 F1DD  21 F43C             LD   HL,DF4F0
 1802 F1E0  CD F25E     LF1CD:  CALL RBYTE
 1803 F1E3  77                  LD   (HL),A
 1804 F1E4  23                  INC  HL
 1805 F1E5  10 F9               DJNZ LF1CD
 1806 F1E7  C9                  RET
 1807                   ;
 1808 F1E8  01 0207     LF1D5:  LD   BC,0207H     ;Spur 0 einstellen
 1809 F1EB  CD F23A             CALL LF227
 1810 F1EE  CD F21A             CALL SENSE
 1811 F1F1  C8                  RET  Z
 1812 F1F2  01 0207             LD   BC,0207H
 1813 F1F5  CD F23A             CALL LF227
 1814 F1F8  18 20               JR   SENSE
 1815                   ;
 1816 F1FA  3A F431     LF1E7:  LD   A,(DF4E5)
 1817 F1FD  32 F43D             LD   (DF4F7),A
 1818 F200  B7                  OR   A
 1819 F201  28 E5               JR   Z,LF1D5
 1820 F203  01 030F             LD   BC,030FH
 1821 F206  21 F438             LD   HL,DF4EC
 1822 F209  CB 66               BIT  4,(HL)
 1823 F20B  28 04               JR   Z,LF1FE
 1824 F20D  87                  ADD  A,A
 1825 F20E  32 F431             LD   (DF4E5),A
 1826 F211  CD F23A     LF1FE:  CALL LF227
 1827 F214  3A F43D             LD   A,(DF4F7)
 1828 F217  32 F431             LD   (DF4E5),A
 1829 F21A  01 0108     SENSE:  LD   BC,0108H
 1830 F21D  CD F23A             CALL LF227
 1831 F220  CD F25E             CALL RBYTE
 1832 F223  47                  LD   B,A
 1833 F224  32 F43C             LD   (DF4F0),A
 1834 F227  FE 80               CP   80H
 1835 F229  C4 F25E             CALL NZ,RBYTE     ;PCN holen
 1836 F22C  CB 68               BIT  5,B          ;SEEK Ende?
 1837 F22E  28 EA               JR   Z,SENSE
 1838 F230  78                  LD   A,B
 1839 F231  E6 F0               AND  0F0H
 1840 F233  FE C0               CP   0C0H
 1841 F235  28 E3               JR   Z,SENSE
 1842 F237  EE 20               XOR  20H
 1843 F239  C9                  RET
 1844                   ;
 1845 F23A  C5          LF227:  PUSH BC
 1846 F23B  CD F298             CALL LF285
 1847 F23E  C1                  POP  BC
 1848 F23F  21 F42F     LF22C:  LD   HL,DF4E3
 1849 F242  71                  LD   (HL),C
 1850 F243  0E 41       LF230:  LD   C,41H
 1851 F245  D5                  PUSH DE
 1852 F246  11 1FFF     LF233:  LD   DE,1FFFH
 1853 F249  7B          LF236:  LD   A,E
 1854 F24A  B2                  OR   D
 1855 F24B  28 0D               JR   Z,LF247      ;Abbruch nach 8192 Versuchen
 1856 F24D  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  33
BIOS    ASM

 1857 F24F  E6 C0               AND  0C0H
 1858 F251  FE 80               CP   80H          ;FDC bereit zum Schreiben?
 1859 F253  1B                  DEC  DE
 1860 F254  20 F3               JR   NZ,LF236     ;noch nicht bereit
 1861 F256  ED A3               OUTI              ;1 Byte --> FDC
 1862 F258  20 EC               JR   NZ,LF233     ;Wdhlg., bis B=0
 1863 F25A  06 00       LF247:  LD   B,00H
 1864 F25C  D1                  POP  DE
 1865 F25D  C9                  RET
 1866                   ;
 1867 F25E  E5          RBYTE:  PUSH HL           ;1 Byte lesen
 1868 F25F  21 1FFF             LD   HL,1FFFH
 1869 F262  7D          RBYTE1: LD   A,L
 1870 F263  B4                  OR   H
 1871 F264  3E C0               LD   A,0C0H
 1872 F266  28 0B               JR   Z,RBYTE2     ;Abbruch nach 8192 Versuchen
 1873 F268  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1874 F26A  E6 C0               AND  0C0H
 1875 F26C  FE C0               CP   0C0H         ;FDC bereit zum Lesen?
 1876 F26E  2B                  DEC  HL
 1877 F26F  20 F1               JR   NZ,RBYTE1    ;noch nicht bereit
 1878 F271  DB 41               IN   A,(DFDC)     ;1 Byte vom FDC lesen --> A
 1879 F273  E1          RBYTE2: POP  HL
 1880 F274  C9                  RET
 1881                   ;
 1882                   ;
 1883                   ;       FDC READ/WRITE Routine
 1884                   ;       ----------------------
 1885                   ;
 1886 F275  3A F440     RW:     LD   A,(LATPU)
 1887 F278  CB CF               SET  1,A
 1888 F27A  D3 45               OUT  (LATCH),A    ;WAIT-Freigabe
 1889 F27C  DB 40       RW01:   IN   A,(CFDC)     ;Lese Hauptstatusregister
 1890 F27E  07                  RLCA
 1891 F27F  30 FB               JR   NC,RW01      ;FDC noch nicht bereit
 1892 F281  ED                  DEFB 0EDH         ;ED A2 = INI
 1893 F282  A2          MODE0:  DEFB 0A2H         ;ED A3 = OUTI
 1894 F283  00                  NOP
 1895 F284  D3 43       RW02:   OUT  (WAIT),A     ;WAIT bis Interrupt FDC
 1896 F286  00                  NOP
 1897 F287  ED                  DEFB 0EDH         ;ED A2 = INI
 1898 F288  A2          MODE1:  DEFB 0A2H         ;ED A3 = OUTI
 1899 F289  C2 F284             JP   NZ,RW02
 1900 F28C  15                  DEC  D
 1901 F28D  C2 F284             JP   NZ,RW02
 1902 F290  3A F440             LD   A,(LATPU)
 1903 F293  CB E7               SET  4,A          ;Terminal Count
 1904 F295  D3 45               OUT  (LATCH),A    ;TC + WAIT-Sperrung
 1905 F297  C9                  RET
 1906                   ;
 1907 F298  21 F43E     LF285:  LD   HL,DF4F8
 1908 F29B  3A F430             LD   A,(DF4E4)
 1909 F29E  E6 03               AND  03H
 1910 F2A0  BE                  CP   (HL)
 1911 F2A1  77                  LD   (HL),A
 1912 F2A2  23                  INC  HL
 1913 F2A3  4E                  LD   C,(HL)
 1914 F2A4  36 48               LD   (HL),48H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  34
BIOS    ASM

 1915 F2A6  F5                  PUSH AF
 1916 F2A7  E5                  PUSH HL
 1917 F2A8  21 F440             LD   HL,LATPU
 1918 F2AB  3A F430             LD   A,(DF4E4)
 1919 F2AE  E6 03               AND  03H
 1920 F2B0  28 08               JR   Z,LF2A7
 1921 F2B2  FE 02               CP   02H
 1922 F2B4  28 04               JR   Z,LF2A7
 1923 F2B6  CB DE               SET  3,(HL)       ;Floppy-LW 1: Motor an
 1924 F2B8  18 02               JR   LF2A9
 1925                   ;
 1926 F2BA  CB C6       LF2A7:  SET  0,(HL)       ;Floppy-LW 0: Motor an
 1927 F2BC  7E          LF2A9:  LD   A,(HL)
 1928 F2BD  D3 45               OUT  (LATCH),A
 1929 F2BF  E1                  POP  HL
 1930 F2C0  F1                  POP  AF
 1931 F2C1  20 04               JR   NZ,LF2B4
 1932 F2C3  79                  LD   A,C
 1933 F2C4  A7                  AND  A
 1934 F2C5  20 09               JR   NZ,LF2BD
 1935 F2C7  3E 48       LF2B4:  LD   A,48H
 1936 F2C9  CB 3F               SRL  A
 1937 F2CB  CB 3F               SRL  A
 1938 F2CD  BE                  CP   (HL)
 1939 F2CE  38 F7               JR   C,LF2B4
 1940 F2D0  7E          LF2BD:  LD   A,(HL)
 1941 F2D1  A7                  AND  A
 1942 F2D2  20 08               JR   NZ,LF2C9
 1943 F2D4  E5                  PUSH HL
 1944 F2D5  21 F2F0             LD   HL,DISCTX
 1945 F2D8  CD EA58             CALL OUTTXT
 1946 F2DB  E1                  POP  HL
 1947 F2DC  C5          LF2C9:  PUSH BC
 1948 F2DD  E5                  PUSH HL
 1949 F2DE  01 0204             LD   BC,0204H
 1950 F2E1  CD F23F             CALL LF22C
 1951 F2E4  CD F25E             CALL RBYTE
 1952 F2E7  E1                  POP  HL
 1953 F2E8  C1                  POP  BC
 1954 F2E9  CB 6F               BIT  5,A
 1955 F2EB  28 E3               JR   Z,LF2BD
 1956 F2ED  36 90               LD   (HL),90H
 1957 F2EF  C9                  RET
 1958                   ;
 1959 F2F0  20 44 49 53 DISCTX: DEFM ' DISC?'
 1960 F2F6  08 08 08 08         DEFB 8,8,8,8,8,8
 1961 F2FC  00                  NOP
 1962                   ;
 1963                   ;
 1964                   ; Interrupteinsprung von CTC Kanal 3
 1965                   ;
 1966 F2FD  F3          ISRCTC: DI                ;DI hat gefehlt, wurde ergaenzt
 1967 F2FE  F5                  PUSH AF
 1968 F2FF  3A F43F             LD   A,(CTCCNT)   ;CTC-Zusatzzaehler lesen
 1969 F302  A7                  AND  A
 1970 F303  28 12               JR   Z,ISRCTE     ;bei "0", die Fkt. beenden
 1971                           ;Beim Start von HRCPM wird CNTCNT per Interrupt von 255 auf 0 heruntergezaehlt.
 1972                           ;--> verzoegerte Steuerung von LATPU und LATCH
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  35
BIOS    ASM

 1973 F305  3D                  DEC  A
 1974 F306  32 F43F             LD   (CTCCNT),A
 1975 F309  20 0C               JR   NZ,ISRCTE
 1976 F30B  E5                  PUSH HL           ;Bei 2 MHz CPU-Takt wird nach 8 Sekunden diese Stelle erreicht
 1977 F30C  21 F440             LD   HL,LATPU
 1978 F30F  CB 86               RES  0,(HL)       ;Floppy-LW 0: Motor aus
 1979 F311  CB 9E               RES  3,(HL)       ;Floppy-LW 1: Motor aus
 1980 F313  7E                  LD   A,(HL)
 1981 F314  D3 45               OUT  (LATCH),A    ;Latch auf dem Floppy-Controller ruecksetzen
 1982 F316  E1                  POP  HL
 1983 F317  F1          ISRCTE: POP  AF
 1984 F318  FB          INTEND: EI                ;ist zusaetzlich Einsprungpunkt fuer nicht genutzte Interrupts
 1985 F319  ED 4D               RETI
 1986                   ;
 1987                   ;-------------  R/W GIDE HW  -----------------------------------------------------------
 1988                   
 1989 F31B  DB 8F       GIDERW: IN   A,(P8F)      ;Command / Status
 1990 F31D  17                  RLA               ;Bit 0 = CY
 1991 F31E  38 FB               JR   C,GIDERW     ;wait for hard disk ready (non-busy)
 1992 F320  2E 19               LD   L,19H
 1993 F322  CD F015             CALL LF002
 1994 F325  4F                  LD   C,A
 1995 F326  2A F457             LD   HL,(SEC3)
 1996 F329  23                  INC  HL
 1997 F32A  AF                  XOR  A
 1998 F32B  47                  LD   B,A
 1999 F32C  3C          LF318:  INC  A
 2000 F32D  ED 42               SBC  HL,BC
 2001 F32F  28 02               JR   Z,LF31F
 2002 F331  30 F9               JR   NC,LF318
 2003 F333  09          LF31F:  ADD  HL,BC
 2004 F334  3D                  DEC  A
 2005 F335  57                  LD   D,A
 2006 F336  5D                  LD   E,L
 2007 F337  2E 11               LD   L,11H
 2008 F339  CD F015             CALL LF002
 2009 F33C  B2                  OR   D
 2010 F33D  D3 8E               OUT  (P8E),A      ;Drive and Head
 2011 F33F  7B                  LD   A,E
 2012 F340  D3 8B               OUT  (P8B),A      ;Sector Number
 2013 F342  23                  INC  HL
 2014 F343  5E                  LD   E,(HL)
 2015 F344  23                  INC  HL
 2016 F345  56                  LD   D,(HL)
 2017 F346  2A F455             LD   HL,(TRK3)
 2018 F349  19                  ADD  HL,DE
 2019 F34A  7D                  LD   A,L
 2020 F34B  D3 8C               OUT  (P8C),A      ;Cylinder Low
 2021 F34D  7C                  LD   A,H
 2022 F34E  D3 8D               OUT  (P8D),A      ;Cylinder High
 2023 F350  3E 01               LD   A,01H
 2024 F352  D3 8A               OUT  (P8A),A      ;Sector Count
 2025 F354  3A F45D             LD   A,(MERKRW)
 2026 F357  FE 06               CP   06H
 2027 F359  28 16               JR   Z,LF35D      ;6 = schreiben
 2028                   ;
 2029                   ;  GIDE lesen 1 Sektor = 512 Bytes nach Puffer
 2030                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  36
BIOS    ASM

 2031 F35B  3E 20               LD   A,20H        ;Read Sector
 2032 F35D  D3 8F               OUT  (P8F),A      ;Command / Status
 2033 F35F  DB 8F       LF34B:  IN   A,(P8F)      ;Command / Status
 2034 F361  CB 5F               BIT  3,A
 2035 F363  28 FA               JR   Z,LF34B      ;wait resp. DRQ active.
 2036 F365  2A F459             LD   HL,(DMA3)
 2037 F368  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2038 F36B  ED B2               INIR
 2039 F36D  ED B2               INIR              ;512 bytes gesamt lesen
 2040 F36F  18 19               JR   LF376
 2041                   ;
 2042                   ;  GIDE schreiben 1 Sektor = 512 Bytes von Puffer
 2043                   ;
 2044 F371  3E 30       LF35D:  LD   A,30H        ;Write Sector
 2045 F373  D3 8F               OUT  (P8F),A      ;Command / Status
 2046 F375  DB 8F       LF361:  IN   A,(P8F)      ;Command / Status
 2047 F377  17                  RLA               ;Bit 0 = CY
 2048 F378  38 FB               JR   C,LF361      ;wait for hard disk ready (non-busy)
 2049 F37A  DB 8F       LF366:  IN   A,(P8F)      ;Command / Status
 2050 F37C  CB 5F               BIT  3,A
 2051 F37E  28 FA               JR   Z,LF366      ;wait resp. DRQ active.
 2052 F380  2A F459             LD   HL,(DMA3)
 2053 F383  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2054 F386  ED B3               OTIR             
 2055 F388  ED B3               OTIR              ;512 bytes gesamt schreiben 
 2056                   ;        
 2057 F38A  DB 8F       LF376:  IN   A,(P8F)      ;Command / Status
 2058 F38C  17                  RLA               ;Bit 0 = CY
 2059 F38D  38 FB               JR   C,LF376      ;wait for hard disk ready (non-busy)
 2060 F38F  DB 8F               IN   A,(P8F)      ;Command / Status
 2061 F391  E6 89               AND  89H          ;10001001b - busy, DRQ, or error?
 2062 F393  C8                  RET  Z            ;no: all is fine, mit A=0
 2063 F394  3E FF               LD   A,0FFH
 2064 F396  32 F462             LD   (DF51C),A
 2065 F399  C9                  RET               ;on errors, return with A=FFh
 2066                   ;
 2067                   ;-----------------  ENDE GIDE HW  ------------------------------------------
 2068                   ;
 2069 F39A  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2070 F3B4  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2071 F3CE  43 4F 4E 4F CINSP:  DEFM "CONOUT-STACK_CONOUT-STACK_CONOUT-STACK"
 2072 F3F4  5A 42 49 4F COUTSP: DEFM "ZBIOS(C)ML-SOFT 2003 & AC1-BIOS(C)HR 2011"
 2073 F41D  00          CPMSTK: NOP
 2074                   ;
 2075                   ;****************  Ende CP/M StackBereich  *******************
 2076                   ;
 2077 F41E  00          COLOR:  DEFB 0            ;Merkzelle aktuelle BWS-Farbe (0=Monochrom)
 2078 F41F  00          COLO1:  DEFB 0            ;aktuelle Farbe ohne invers und intensiv
 2079 F420  00          COLO2:  DEFB 0            ;Farbe fuer Monitor und CP/M Warmstart
 2080                   ;
 2081 F421  00          RAFTRK: DEFB 0            ;RAFTRK EQU 0F4C2H
 2082 F422  00          RAFSEC: DEFB 0
 2083                   ;
 2084 F423  01          CUFLAG: DEFB 1            ;CUON/CUOFF  KursorFlag
 2085 F424  00          STZ00:  DEFB 0            ;Merkzelle Anz. BS-Steuerzeichen
 2086 F425  00          STZ01:  DEFB 0            ;Merkzelle fuer 1. ESC-Steuerzeichen
 2087 F426  00          STZ02:  DEFB 0            ;Merkzelle fuer 2. ESC-Steuerzeichen
 2088                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  37
BIOS    ASM

 2089 F427  00          CHAR:   DEFB 0            ;Merkzelle Zeichen <> Cursor
 2090                   ;
 2091 F428  0000        SPCIN:  DEFW 0            ;Merkzelle Stackpointer waehrend CONIN
 2092 F42A  0000        SPCOUT: DEFW 0            ;Merkzelle Stackpointer waehrend CONOUT
 2093 F42C  0000        OLDNMI: DEFW 0            ;2 Bytes fuer alten NMI
 2094                   ;
 2095 F42E  00          DF4E2:  NOP
 2096 F42F  00          DF4E3:  NOP               ;Merkzelle
 2097 F430  00          DF4E4:  NOP
 2098 F431  00          DF4E5:  NOP
 2099 F432  00          DF4E6:  NOP
 2100 F433  00          DF4E7:  NOP
 2101 F434  00          DF4E8:  NOP
 2102 F435  00          DF4E9:  NOP
 2103 F436  00          DF4EA:  NOP
 2104 F437  00          DF4EB:  NOP
 2105                   ;
 2106 F438  00          DF4EC:  NOP               ;4 Merkzellen  
 2107 F439  00                  NOP
 2108 F43A  00          CTAB:   NOP               ;FDC Befehlsbyte
 2109 F43B  00                  NOP               ;4 Merkzellen Ende
 2110                   ;
 2111 F43C  00          DF4F0:  NOP
 2112 F43D  00          DF4F7:  NOP
 2113 F43E  00          DF4F8:  NOP
 2114 F43F  00          CTCCNT: DEFB 0            ;CTC-Counter - Zusatzzaehler fuer CTC-Interrupt
 2115 F440  00          LATPU:  DEFB 0            ;Latch fuer den Floppy-Controler
 2116                   ;
 2117                   ;hier beginnt eine Bytefolge fuer Read/Write Operationen
 2118                   ;
 2119 F441  04          RWBYTE: DEFB 4            ;4 = READ, 6 = WRITE
 2120 F442  00          DRIVE:  DEFB 0            ;LW-Nr.
 2121 F443  0000        TRACK:  DEFW 0            ;akt. Track
 2122 F445  0000        SECTOR: DEFW 0            ;akt. Sektor
 2123 F447  0000        DMA:    DEFW 0            ;DMA-Adresse
 2124 F449  0000        DPH:    DEFW 0            ;akt. DPH
 2125                   ;
 2126 F44B  00          DRV2:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2127 F44C  0000        TRK2:   DEFW 0
 2128 F44E  0000        SEC2:   DEFW 0
 2129 F450  0000        DMA2:   DEFW 0            ;DMA-Adresse
 2130 F452  0000                DEFW 0
 2131                   ;
 2132 F454  00          DRV3:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2133 F455  0000        TRK3:   DEFW 0
 2134 F457  0000        SEC3:   DEFW 0
 2135 F459  0000        DMA3:   DEFW 0            ;DMA-Adresse
 2136 F45B  0000        DPH3M:  DEFW 0            ;Merkzelle akt. DPH
 2137                   ;
 2138 F45D  04          MERKRW: DEFB 4            ;Merkzelle: 4 = READ, 6 = WRITE
 2139 F45E  0000        DF518:  DEFW 0
 2140 F460  00          DF51A:  DEFB 0
 2141 F461  00          DF51B:  DEFB 0
 2142 F462  00          DF51C:  DEFB 0
 2143 F463  00          DF51D:  DEFB 0
 2144 F464  00          DF51E:  DEFB 0
 2145                   ;
 2146 F465  00 00 00 00 DISKP:  DEFS 1024,0       ;HW-Sektor Puffer aller LW (1k max. fuer FDD)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  38
BIOS    ASM

 2147 F865  00 00 00 00 DIRBF:  DEFS 128,0        ;1 REC Puffer fuer Direktory
 2148 F8E5  00 00 00 00 ALL00:  DEFS 128,0        ;2048k(max.) / 2k / 8 = 128
 2149 F965  00 00 00 00 ALL01:  DEFS 50,0         ;0F99FH
 2150 F997  00 00 00 00 ALL02:  DEFS 504,0        ;0F9D1H
 2151 FB8F  00 00 00 00 ALL03:  DEFS 256,0        ;0FBC9H
 2152 FC8F  00 00 00 00 ALL04:  DEFS 256,0        ;0FCC9H
 2153 FD8F  00 00 00 00 ALL05:  DEFS 50,0         ;0FDC9H
 2154 FDC1  00 00 00 00 ALL06:  DEFS 50,0         ;0FDFBH
 2155 FDF3  00 00 00 00 CHK01:  DEFS 32,0         ;0FE2DH
 2156 FE13  00 00 00 00 CHK05:  DEFS 32,0         ;0FE4DH
 2157 FE33  00 00 00 00 CHK06:  DEFS 32,0         ;0FE6DH
 2158                   ;
 2159 FE53  42 49 4F 53         DEFM "BIOS-Ende"  ;nur fuer Frieder zur Info
 2160                   ;
 2161                   ;
 2162         FF80      DFF80   EQU  0FF80H       ;Interrupt-Einsprungpunkt CTC Kanal 0
 2163         FF82      DFF82   EQU  0FF82H       ;Interrupt-Einsprungpunkt CTC Kanal 1
 2164         FF84      DFF84   EQU  0FF84H       ;Interrupt-Einsprungpunkt CTC Kanal 2
 2165         FF86      DFF86   EQU  0FF86H       ;Interrupt-Einsprungpunkt CTC Kanal 3
 2166         FF88      DFF88   EQU  0FF88H       ;Interrupt-Einsprungpunkt Nr.1 PIO1A
 2167         FF8A      DFF8A   EQU  0FF8AH       ;Interrupt-Einsprungpunkt Nr.2 PIO1A
 2168                   ;
 2169                   ;#############################   PortAdressen   ##############
 2170                   ;
 2171         0000      P00     EQU  00H          ;CTC Kanal 0
 2172         0001      P01     EQU  01H          ;CTC Kanal 1
 2173         0002      P02     EQU  02H          ;CTC Kanal 2
 2174         0003      P03     EQU  03H          ;CTC Kanal 3
 2175                   ;
 2176         0004      P04     EQU  04H          ;PIO_A-Daten
 2177         0005      P05     EQU  05H          ;PIO_B-Daten
 2178         0006      P06     EQU  06H          ;PIO_A-Control
 2179                   ;
 2180         0014      P14     EQU  14H          ;Modul_1 - ggf. EPROMs ausblenden
 2181                   ;
 2182         001E      P1E     EQU  1EH          ;CP/M - Umschalter
 2183                   ;
 2184         008A      P8A     EQU  8AH          ;GIDE Sector Count
 2185         008B      P8B     EQU  8BH          ;GIDE Sector Number
 2186         008C      P8C     EQU  8CH          ;GIDE Cylinder Low
 2187         008D      P8D     EQU  8DH          ;GIDE Cylinder High
 2188         008E      P8E     EQU  8EH          ;GIDE Drive and Head
 2189         008F      P8F     EQU  8FH          ;GIDE Command/Status
 2190                   ;
 2191                           .DEPHASE
 2192                           END
 0 Error(s) Detected.
 6236 Absolute Bytes. 322 Symbols Detected.
     0004      