Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   1
BIOS    ASM

    1                   ; ***********************************************************
    2                   ; *                                                         *
    3                   ; *  HRCPM12-BIOS fuer den AC1      Version vom 18.12.2023  *
    4                   ; *                                                         *
    5                   ; *                                                  V.139  *
    6                   ; *                                                         *
    7                   ; ***********************************************************
    8                   ;
    9                   ; Korrekturen/Fehlerbehebungen:
   10                   ; - alle nicht genutzten Programmteile (HRDOS12) entfernt
   11                   ; - (Turbo-)LOAD entfernt
   12                   ; - BWS(Farb)Init geaendert
   13                   ; - ^G BEEP + PUNCH:=V24out + LIST:=V24out hinzugefuegt
   14                   ; - keine Pruefsumme, kein Vergleichslesen der RAM-Disk (entfernt)
   15                   ; - fehlerhafte Maskierung USER in WBOOT entfernt
   16                   ; - Kursorblinken im Texteditor
   17                   ; - Consolenkommandos Kursor-ON / Kursor-OFF
   18                   ; - RAM-Disk mit 64 REC/TRK, Systemspur auf 8K reduziert
   19                   ; - GIDE-Laufwerke (C:, D:, E:) auf 8MB, da nicht alle BDOS'se mit mehr
   20                   ;   als 16 Bit fuer REC-NR. zurechtkommen.
   21                   ; - Formatierung RAM-Disk: letzter Sektor wurde nicht formatiert
   22                   ; - falsche I/O-Adresse von Modul1
   23                   ; - ISR angepasst, damit HRCPM12 mit JKCEMU V0.9.8.3 funktioniert
   24                   ;
   25                   ; Neu hinzugekommen:
   26                   ; - EXIT loescht CCPPUFLEN (V.132)
   27                   ; - WBOOT loescht CCPPUFLEN, weil in Systemspur "aktiver Befehl" (V.133)
   28                   ; - Eintragen von NMI auf 066h in BOOT1 entfernt (CPM Page-Zero) (V.133)
   29                   ; - Tastaturpuffer von FFD0h -> FF00h , "d"-Befehl ueberschrieben (V.134)
   30                   ; - nicht benutzte "Arbeitszellen" am Ende auskommentiert (V.135)
   31                   ; - automatische Erkennung der RAM-Disk 256k/512k/1024k/2048k (V.136)
   32                   ;
   33                   ;
   34                           .CREF
   35                           .Z80
   36                   ;
   37                           .PHASE 0E600H
   38                   ;
   39                   ;
   40         07F1      OUTHL   EQU  07F1H
   41         01A5      RSA     EQU  01A5H        ;CPU-Register nach RSA - nicht Monitor 11 !
   42         05CE      REGIST  EQU  05CEH        ;Registeranzeige - nicht Monitor 11 !
   43         0DF9      MV24A   EQU  0DF9H        ;MO-UP V24-Out
   44                   ;
   45                   ;
   46         1800      CUPOS   EQU  1800H
   47         1818      BREAK   EQU  1818H        ;NMI Sprungziel
   48         181F      CBWSB   EQU  181FH        ;Merkzelle fuer das Farbbyte im AC1-Monitor 
   49                   ;                         ;0=kein Color-BWS, sonst der eingestellte Farbwert
   50         185B      ARG1    EQU  185BH
   51         185D      ARG2    EQU  185DH
   52                   ;
   53                   ;
   54         0000      WARMBT  EQU  0000H        ;WBOOT der Grundseite
   55         0005      BDOSF   EQU  0005H        ;BDOS-Aufruf + TPA-MAX
   56         0038      RST38   EQU  0038H        ;CP/M-Break
   57         0066      NMI     EQU  0066H
   58                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   2
BIOS    ASM

   59                   ;
   60         0003      IOBYTE  EQU  0003H
   61         0004      LWBYTE  EQU  0004H        ;LW (Bit0-3) + USER Nr.(Bit4-7)
   62                   ;
   63         FF00      ZEIPUF  EQU  0FF00H       ;1 + 32 Byte Puffer fuer Tastatur
   64                   ;                          --> war urspruenlich auf 0FFD0H
   65                   ;                          --> ueberschreibt den "d"-Befehl
   66                   ;
   67         D806      BDOS    EQU  0D806H       ;BDOS-EinsprungAdresse
   68         E603      WBOOTB  EQU  0E603H       ;BIOS-Eisprung WBOOT
   69                   ;
   70                   ;
   71         C000      HPRDSK  EQU  0C000H       ;Hilfsprogramm: Format RAM-Disk
   72         D000      CCP     EQU  0D000H       ;Start CCP
   73         D007      COMLEN  EQU  CCP+07       ;CCP-Kommandopuffer-Laenge
   74                   ;
   75         00E0      PE0     EQU  0E0H         ;Grundadresse der RAM-Disk
   76         00F0      PF0     EQU  0F0H         ;BWS-CPLD-(Steuer)Port
   77                   ;
   78         0040      CFDC    EQU  40H          ;Hauptstatusregister FDC
   79         0041      DFDC    EQU  41H          ;Datenport FDC
   80         0043      WAIT    EQU  43H          ;IO-Adr. /WAIT Monoflop
   81         0045      LATCH   EQU  45H          ;IO-Adr. Latch 74LS175
   82                   ;
   83         000F      CUZEI   EQU  0FH          ;KursorSymbol
   84                   ;
   85                   ;============================================================================
   86                   ;
   87 E600  C3 E878             JP   BOOT
   88 E603  C3 E94F             JP   WBOOT
   89 E606  C3 EA68             JP   CONST
   90 E609  C3 EA70             JP   CONIN
   91 E60C  C3 EAE8             JP   CONOUT
   92 E60F  C3 EABF             JP   LIST
   93 E612  C3 EADB             JP   PUNCH
   94 E615  C3 EA70             JP   CONIN        ;eigentlich JP READER
   95 E618  C3 EE1D             JP   HOME
   96 E61B  C3 EDFE             JP   SELDSK
   97 E61E  C3 EE20             JP   SETTRK
   98 E621  C3 EE25             JP   SETSEC
   99 E624  C3 EE2A             JP   SETDMA
  100 E627  C3 EE3B             JP   READ
  101 E62A  C3 EE40             JP   WRITE
  102 E62D  C3 EDFB             JP   LISTST
  103 E630  C3 EE2F             JP   SECTRN
  104                   ;
  105 E633  43 38 35 41         DEFM 'C85AC'      ;fuer PC/BC Progr.
  106 E638  C3 E9D7             JP   EXIT         ;User-Kommando EXIT
  107 E63B  C3 F004             JP   LOAD         ;User-Kommando LOAD
  108 E63E  C3 0000             JP   0000H
  109                   ;
  110 E641  07          NDISK:  DEFB 7            ;Anzahl der LW = 7
  111                   ;
  112 E642  E644        DPHX:   DEFW DPHY         ;Zeiger auf den 1. Block?
  113 E644  E652        DPHY:   DEFW DPH0         ;DPH von LW A:
  114 E646  E662                DEFW DPH1         ;DPH von LW B:
  115 E648  E672                DEFW DPH2         ;DPH von LW C:
  116 E64A  E682                DEFW DPH3         ;DPH von LW D:
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   3
BIOS    ASM

  117 E64C  E692                DEFW DPH4         ;DPH von LW E:
  118 E64E  E6A2                DEFW DPH5         ;DPH von LW F:
  119 E650  E6B2                DEFW DPH6         ;DPH von LW G:
  120                   ;
  121 E652  0000        DPH0:   DEFW 0            ;RAM-Disk A:
  122 E654  0000                DEFW 0
  123 E656  0000                DEFW 0
  124 E658  0000                DEFW 0
  125 E65A  F85D                DEFW DIRBF
  126 E65C  E6C4                DEFW DPB0
  127 E65E  0000                DEFW 0            ;weil nichtwechselbares Medium
  128 E660  F8DD                DEFW ALL00
  129                   ;
  130 E662  0000        DPH1:   DEFW 0            ;Floppy B:
  131 E664  0000                DEFW 0
  132 E666  0000                DEFW 0
  133 E668  0000                DEFW 0
  134 E66A  F85D                DEFW DIRBF
  135 E66C  E6D5                DEFW DPB1
  136 E66E  FDEB                DEFW CHK01
  137 E670  F95D                DEFW ALL01
  138                   ;
  139 E672  0000        DPH2:   DEFW 0            ;GIDE C:
  140 E674  0000                DEFW 0
  141 E676  0000                DEFW 0
  142 E678  0000                DEFW 0
  143 E67A  F85D                DEFW DIRBF
  144 E67C  E6F1                DEFW DPB2
  145 E67E  0000                DEFW 0            ;weil nichtwechselbares Medium
  146 E680  F98F                DEFW ALL02
  147                   ;
  148 E682  0000        DPH3:   DEFW 0            ;GIDE D:
  149 E684  0000                DEFW 0
  150 E686  0000                DEFW 0
  151 E688  0000                DEFW 0
  152 E68A  F85D                DEFW DIRBF
  153 E68C  E70D                DEFW DPB3
  154 E68E  0000                DEFW 0            ;weil nichtwechselbares Medium
  155 E690  FB87                DEFW ALL03
  156                   ;
  157 E692  0000        DPH4:   DEFW 0            ;GIDE E:
  158 E694  0000                DEFW 0
  159 E696  0000                DEFW 0
  160 E698  0000                DEFW 0
  161 E69A  F85D                DEFW DIRBF
  162 E69C  E729                DEFW DPB4
  163 E69E  0000                DEFW 0            ;weil nichtwechselbares Medium
  164 E6A0  FC87                DEFW ALL04
  165                   ;
  166 E6A2  0000        DPH5:   DEFW 0            ;Floppy F:
  167 E6A4  0000                DEFW 0
  168 E6A6  0000                DEFW 0
  169 E6A8  0000                DEFW 0
  170 E6AA  F85D                DEFW DIRBF
  171 E6AC  E745                DEFW DPB5
  172 E6AE  FE0B                DEFW CHK05
  173 E6B0  FD87                DEFW ALL05
  174                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   4
BIOS    ASM

  175 E6B2  0000        DPH6:   DEFW 0            ;Floppy G:
  176 E6B4  0000                DEFW 0
  177 E6B6  0000                DEFW 0
  178 E6B8  0000                DEFW 0
  179 E6BA  F85D                DEFW DIRBF
  180 E6BC  E761                DEFW DPB6
  181 E6BE  FE2B                DEFW CHK06
  182 E6C0  FDB9                DEFW ALL06
  183                   ;
  184                   ; https://hc-ddr.hucki.net/wiki/doku.php/cpm/write_a_bios/teil_1
  185                   ;
  186 E6C2  EE67                DEFW RDSKRW       ;Routine zum Lesen/Schreiben der RAM-Disk
  187                   ;
  188                   ;RAM-Disk 256 KByte
  189 E6C4  0040        DPB0:   DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  190 E6C6  03                  DEFB 3            ;Blockgroesse = 1 Kbyte
  191 E6C7  07                  DEFB 7
  192 E6C8  00                  DEFB 0            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  193 E6C9  00F7                DEFW 247          ;248 * 1 Kbyte-Bloecke  -> 256k-8k(System)=248k(CP/M) ( - 2k(DIR) -> 246k (NETTO f. Daten))
  194 E6CB  003F                DEFW 63           ;64 DIR - Eintaege
  195 E6CD  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  196 E6CF  0000                DEFW 0            ;weil nichtwechselbares Medium
  197 E6D1  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  198                   ;
  199 E6D3  F024                DEFW LF019        ;? Blocking / Deblocking
  200                   ;
  201                   ;Floppy 780 KByte
  202 E6D5  0050        DPB1:   DEFW 80           ;80 Sectoren/Track
  203 E6D7  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  204 E6D8  0F                  DEFB 15
  205 E6D9  00                  DEFB 0
  206 E6DA  0185                DEFW 389          ;390 * 2 Kbyte - Bloecke
  207 E6DC  007F                DEFW 127          ;128 DIR - Eintraege
  208 E6DE  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  209 E6E0  0020                DEFW 32
  210 E6E2  0002                DEFW 2            ;20 Kbyte System
  211                   ;
  212 E6E4  03 07 05 25         DEFB 3,7,5,25H
  213 E6E8  50 00 43 FF         DEFB 50H,0,43H,0FFH
  214 E6EC  E1 33 FF            DEFB 0E1H,33H,0FFH
  215                   ;
  216 E6EF  F020                DEFW LF015        ;? Blocking / Deblocking
  217                   ;
  218                   ;GIDE 8 MByte
  219 E6F1  0800        DPB2:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  220 E6F3  05                  DEFB 5
  221 E6F4  1F                  DEFB 31           ;4k Bloecke
  222 E6F5  01                  DEFB 1            ;16-Bit Blockadressen im FCB/DIR
  223 E6F6  07BF                DEFW 1983         ;1984 * 4k-Bloecke = 7936k
  224 E6F8  07FF                DEFW 2047         ;2048 DIR-Eintraege
  225 E6FA  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke = 64 k
  226 E6FC  0000                DEFW 0            ;weil nichtwechselbares Medium
  227 E6FE  0001                DEFW 1            ;1 Trk = 256k System
  228                   ;
  229 E700  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  230 E703  000A                DEFW 000AH        ;10 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  231 E705  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  232 E707  03D8                DEFW 03D8H        ;984 Zylinder HDD
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   5
BIOS    ASM

  233 E709  10                  DEFB 10H          ;16 Koepfe HDD
  234 E70A  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  235                   ;
  236 E70B  F020                DEFW LF015        ;? Blocking / Deblocking
  237                   ;
  238                   ;GIDE 8 MByte
  239 E70D  0800        DPB3:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  240 E70F  06                  DEFB 6
  241 E710  3F                  DEFB 63           ;8k Bloecke
  242 E711  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  243 E712  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  244 E714  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  245 E716  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  246 E718  0000                DEFW 0            ;weil nichtwechselbares Medium
  247 E71A  0000                DEFW 0            ;kein System-Track
  248                   ;
  249 E71C  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  250 E71F  0096                DEFW 0096H        ;150 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  251 E721  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  252 E723  03D8                DEFW 03D8H        ;984 Zylinder HDD
  253 E725  10                  DEFB 10H          ;16 Koepfe HDD
  254 E726  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  255                   ;
  256 E727  F020                DEFW LF015        ;? Blocking / Deblocking
  257                   ;
  258                   ;GIDE 8 MByte
  259 E729  0800        DPB4:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  260 E72B  06                  DEFB 6
  261 E72C  3F                  DEFB 63           ;8k Bloecke
  262 E72D  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  263 E72E  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  264 E730  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  265 E732  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  266 E734  0000                DEFW 0            ;weil nichtwechselbares Medium
  267 E736  0000                DEFW 0            ;kein System-Track
  268                   ;
  269 E738  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  270 E73B  012C                DEFW 012CH        ;300 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  271 E73D  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  272 E73F  03D8                DEFW 03D8H        ;984 Zylinder HDD
  273 E741  10                  DEFB 10H          ;16 Koepfe HDD
  274 E742  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  275                   ;
  276 E743  F024                DEFW LF019        ;? Blocking / Deblocking
  277                   ;
  278                   ;Floppy 640 KByte
  279 E745  0040        DPB5:   DEFW 64           ;64 Sectoren/Track
  280 E747  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  281 E748  0F                  DEFB 15
  282 E749  00                  DEFB 0
  283 E74A  013F                DEFW 319          ;320 * 2 Kbyte - Bloecke
  284 E74C  007F                DEFW 127          ;128 DIR - Eintraege
  285 E74E  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  286 E750  0020                DEFW 32
  287 E752  0000                DEFW 0            ;kein System-Track
  288                   ;
  289 E754  01 01 10 14         DEFB 1,1,10H,14H
  290 E758  50 00 43 FF         DEFB 50H,0,43H,0FFH
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   6
BIOS    ASM

  291 E75C  E1 33 FF            DEFB 0E1H,33H,0FFH
  292                   ;
  293 E75F  F024                DEFW LF019        ;? Blocking / Deblocking
  294                   ;
  295                   ;Floppy 800 KByte
  296 E761  0050        DPB6:   DEFW 80           ;80 Sectoren/Track
  297 E763  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  298 E764  0F                  DEFB 15
  299 E765  00                  DEFB 0
  300 E766  018F                DEFW 399          ;400 * 2 Kbyte - Bloecke
  301 E768  007F                DEFW 127          ;128 DIR - Eintraege
  302 E76A  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  303 E76C  0020                DEFW 32
  304 E76E  0000                DEFW 0            ;kein System-Track
  305                   ;
  306 E770  03 07 05 25         DEFB 3,7,5,25H
  307 E774  50 01 43 FF         DEFB 50H,1,43H,0FFH
  308 E778  E1 33 FF            DEFB 0E1H,33H,0FFH
  309                   ;
  310                   ;RAM-Disk 512 KByte
  311 E77B  0040        DP512:  DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  312 E77D  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  313 E77E  0F                  DEFB 15
  314 E77F  01                  DEFB 1            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  315 E780  00FB                DEFW 251          ;252 * 2 Kbyte-Bloecke  -> 512k-8k(System)=504k(CP/M) ( - 2k(DIR) -> 502k (NETTO f. Daten))
  316 E782  003F                DEFW 63           ;64 DIR - Eintaege
  317 E784  0080                DEFW 080H         ;1 DIR-Block
  318 E786  0000                DEFW 0            ;weil nichtwechselbares Medium
  319 E788  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  320                   ;
  321                   ;RAM-Disk 1024 KByte
  322 E78A  0040        DP1024: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  323 E78C  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  324 E78D  0F                  DEFB 15
  325 E78E  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  326 E78F  01FB                DEFW 507          ;508 * 2 Kbyte-Bloecke  -> 1024k-8k(System)=1016k(CP/M) ( - 4k(DIR) -> 1012k (NETTO f. Daten))
  327 E791  007F                DEFW 127          ;128 DIR - Eintraege -> bei 64 DIR-Eintraegen bekommt man die RAM-Disk nicht voll
  328 E793  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  329 E795  0000                DEFW 0            ;weil nichtwechselbares Medium
  330 E797  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  331                   ;
  332                   ;RAM-Disk 2048 KByte
  333 E799  0040        DP2048: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  334 E79B  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  335 E79C  0F                  DEFB 15
  336 E79D  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  337 E79E  03FB                DEFW 1019         ;1020 * 2 Kbyte-Bloecke  -> 2048k-8k(System)=2040k(CP/M) ( - 8k(DIR) -> 2032k (NETTO f. Daten))
  338 E7A0  00FF                DEFW 255          ;256 DIR - Eintraege
  339 E7A2  00F0                DEFW 0F0H         ;4 DIR-Bloecke
  340 E7A4  0000                DEFW 0            ;weil nichtwechselbares Medium
  341 E7A6  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  342                   ;
  343 E7A8  0C          TXT01:  DEFB 0CH
  344 E7A9  48 52 43 50         DEFM "HRCPM AC1 V1.2 CPA "
  345 E7BC  31 31 2E 30         DEFM "11.01.89 FA-MODE "
  346 E7CD  76 6F 6D 20         DEFM "vom 18.12.2023 V.139"
  347 E7E1  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  348 E7E5  47 49 44 45         DEFM "GIDE(80H) C0:8MB,"
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   7
BIOS    ASM

  349 E7F6  20 20 20 44         DEFM "   D0: 8MB   E0: 8MB"
  350 E80A  0D 0A               DEFB 0DH,0AH
  351 E80C  46 44 43 20         DEFM "FDC (45H) B0:5*1024"   ;B0 --> Floppy-Drive 0,
  352 E81F  20 46 30 3A         DEFM " F0:16*256 G1:5*1024"  ;F0 --> Floppy-Drive 0, G1 --> Floppy-Drive 1
  353 E833  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  354 E837  52 46 4C 20         DEFM "RFL Praeci.Port E0H"
  355 E84A  20 41 3A 20         DEFM " A: "
  356 E84E  00                  DEFB 0
  357 E84F  32 35 36 6B TXT01A: DEFM "256k"
  358 E853  00                  DEFB 0
  359 E854  35 31 32 6B TXT01B: DEFM "512k"
  360 E858  00                  DEFB 0
  361 E859  31 30 32 34 TXT01C: DEFM "1024k"
  362 E85E  00                  DEFB 0
  363 E85F  32 30 34 38 TXT01D: DEFM "2048k"
  364 E864  00                  DEFB 0
  365 E865  20 2D 2D 3E TXT02:  DEFM " --> Format A:(J)?"
  366 E877  00                  DEFB 0
  367                   ;
  368                   ;******************************   BOOT   *******************************
  369                   ;
  370 E878  F3          BOOT:   DI
  371 E879  31 F415             LD   SP,CPMSTK
  372 E87C  AF                  XOR  A
  373 E87D  D3 1E               OUT  (P1E),A      ;zwingend AC1-Mode !!
  374 E87F  32 F438             LD   (LATPU),A    ;FDC-Latch zuruecksetzen
  375 E882  CD EDC5             CALL BWSINI
  376 E885  DB 05               IN   A,(P05)
  377 E887  CB 9F               RES  3,A          ;BildInvers (PIO1B) Bit3 aus
  378 E889  D3 05               OUT  (P05),A
  379 E88B  2A 1818             LD   HL,(BREAK)   ;Sprungtabelle NMI MONITOR
  380 E88E  22 F424             LD   (OLDNMI),HL  ;sichern
  381 E891  21 E603             LD   HL,WBOOTB    ;CP/M-Warmstart-Einsprungadresse
  382 E894  22 1818             LD   (BREAK),HL
  383 E897  CD E9CC             CALL CPMMOD
  384 E89A  AF                  XOR  A
  385 E89B  32 F458             LD   (DF51A),A
  386 E89E  32 0003             LD   (IOBYTE),A
  387 E8A1  32 0004             LD   (LWBYTE),A
  388 E8A4  32 FF00             LD   (ZEIPUF),A   ;Init. Tastaturpuffer
  389 E8A7  CD E9A8             CALL BOOT1        ;CP/M "Grundseite" INIT
  390                   ;
  391 E8AA  3E 03               LD   A,03H        ;CTC init. + Interrupt abgeschaltet
  392 E8AC  D3 00               OUT  (P00),A
  393 E8AE  D3 01               OUT  (P01),A
  394 E8B0  D3 02               OUT  (P02),A
  395 E8B2  D3 03               OUT  (P03),A
  396 E8B4  3E FF               LD   A,0FFH       ;HWT vom Interruptvektor 0FF80h ff.
  397 E8B6  ED 47               LD   I,A
  398 E8B8  ED 5E               IM   2            ;Interrupt freigeben
  399 E8BA  21 F310             LD   HL,INTEND    ;Adresse Einsprungpunkt fuer nicht verwendete Interrupts
  400 E8BD  22 FF80             LD   (DFF80),HL   ;Prog. Einsprung IV fuer CTC-Kanal 0
  401 E8C0  22 FF82             LD   (DFF82),HL   ;Prog. Einsprung IV fuer CTC-Kanal 1
  402 E8C3  22 FF84             LD   (DFF84),HL   ;Prog. Einsprung IV fuer CTC-Kanal 2
  403 E8C6  21 F2F5             LD   HL,ISRCTC    ;Einsprungpunkt CTC-Interrupt - Steuerung Nachlauf Floppy-LW
  404 E8C9  22 FF86             LD   (DFF86),HL   ;Prog. Einsprung IV fuer CTC-Kanal 3
  405 E8CC  3E 80               LD   A,80H
  406 E8CE  D3 00               OUT  (P00),A      ;CTC-Interruptadresse NWT (= 80h) eintragen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   8
BIOS    ASM

  407 E8D0  3E FF               LD   A,0FFH
  408 E8D2  32 F437             LD   (CTCCNT),A   ;Init. CTC-Counter = 255 --> Zusatzzaehler fuer CTC-Interrupt
  409 E8D5  3E A7               LD   A,0A7H
  410 E8D7  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 als Zeitgeber mit Interrupt, Vorteiler 256
  411 E8D9  AF                  XOR  A
  412 E8DA  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 - Hauptteiler = 256
  413                                             ;d.h. bei 2 MHz CPU-Takt wird alle 33ms ein CTC-Interrupt ausgeloest
  414                   ;
  415 E8DC  21 E9FE             LD   HL,ISRTAS    ;1. Einsprungpunkt PIO-Interrupt --> Taste in Tastaturpuffer schreiben
  416 E8DF  22 FF88             LD   (DFF88),HL   ;auf 0FF88h eintragen
  417 E8E2  01 0506             LD   BC,0506H     ;5 Bytes auf Controlkanal PIO1 A
  418 E8E5  21 EA53             LD   HL,PIOTAB
  419 E8E8  ED B3               OTIR              ;PIO1_A Init. fuer 1. Einsprungpunkt
  420                   ;
  421 E8EA  21 E7A8             LD   HL,TXT01     ;Begruessungstext
  422 E8ED  CD EA58             CALL OUTTXT
  423                   ;
  424 E8F0  CD EEC2             CALL RDTEST       ;Kapazitaet der RAM-Disk bestimmen
  425 E8F3  21 EF1A             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
  426 E8F6  7E                  LD   A,(HL)
  427 E8F7  21 E799             LD   HL,DP2048    ;DPB 2048K RAM-Disk
  428 E8FA  FE 03               CP   3
  429 E8FC  28 10               JR   Z,BOOT2
  430 E8FE  21 E78A             LD   HL,DP1024    ;DPB 1024K RAM-Disk
  431 E901  FE 02               CP   2
  432 E903  28 09               JR   Z,BOOT2
  433 E905  21 E77B             LD   HL,DP512     ;DPB 512K RAM-Disk
  434 E908  FE 01               CP   1
  435 E90A  28 02               JR   Z,BOOT2
  436 E90C  18 08               JR   BOOT3        ;256K RAM-Disk, nichts kopieren
  437                   ;        
  438 E90E  11 E6C4     BOOT2:  LD   DE,DPB0
  439 E911  01 000F             LD   BC,15
  440 E914  ED B0               LDIR
  441 E916  21 E85F     BOOT3:  LD   HL,TXT01D    ;2048k
  442 E919  FE 03               CP   3
  443 E91B  28 11               JR   Z,BOOT4
  444 E91D  21 E859             LD   HL,TXT01C    ;1024k
  445 E920  FE 02               CP   2
  446 E922  28 0A               JR   Z,BOOT4
  447 E924  21 E854             LD   HL,TXT01B    ;512k
  448 E927  FE 01               CP   1
  449 E929  28 03               JR   Z,BOOT4
  450 E92B  21 E84F             LD   HL,TXT01A    ;256k
  451 E92E  CD EA58     BOOT4:  CALL OUTTXT
  452 E931  21 E865             LD   HL,TXT02     ;Formatieren? (J)
  453 E934  CD EA58             CALL OUTTXT
  454 E937  FB                  EI
  455 E938  CD EA70             CALL CONIN
  456 E93B  CB AF               RES  5,A          ;Grossbuchstaben
  457 E93D  FE 4A               CP   4AH          ;J --> RAM-Disk formatieren
  458 E93F  CC EF1B             CALL Z,RDFORM
  459 E942  21 8000             LD   HL,8000H     ;POWER.COM nach 100h kopieren
  460 E945  11 0100             LD   DE,0100H
  461 E948  01 4000             LD   BC,4000H
  462 E94B  ED B0               LDIR
  463 E94D  18 22               JR   WBOOT1
  464                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   9
BIOS    ASM

  465                   ;*******************************   WBOOT   *****************************
  466                   ;
  467 E94F  31 F415     WBOOT:  LD   SP,CPMSTK
  468 E952  CD E9CC             CALL CPMMOD
  469 E955  3A F459             LD   A,(DF51B)
  470 E958  B7                  OR   A
  471 E959  C4 F0D9             CALL NZ,LF0CE
  472 E95C  06 2C               LD   B,2CH        ;44 Records CCP+BDOS
  473 E95E  21 EE3B             LD   HL,READ
  474 E961  22 EFAC             LD   (WRCCP2),HL
  475 E964  CD EF92             CALL WRCCP        ;wirklich READCCP !
  476 E967  21 EE40             LD   HL,WRITE
  477 E96A  22 EFAC             LD   (WRCCP2),HL
  478 E96D  AF                  XOR  A
  479 E96E  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  480                   ;
  481 E971  CD E9A8     WBOOT1: CALL BOOT1        ;CP/M "Grundseite" INIT
  482 E974  3E 01               LD   A,01H        ;Kursor einschalten
  483 E976  32 F41B             LD   (CUFLAG),A
  484 E979  3A F418             LD   A,(COLO2)
  485 E97C  32 F416             LD   (COLOR),A    ;Arbeitszelle Farbbyte
  486 E97F  E6 77               AND  77H          ;Intensivdarstellung maskieren
  487 E981  32 F417             LD   (COLO1),A    ;Arbeitszelle "Normaldarstellung"
  488 E984  3A 0004             LD   A,(LWBYTE)
  489 E987  4F                  LD   C,A
  490 E988  CD EDFE             CALL SELDSK
  491 E98B  C3 D000             JP   CCP          ;JP CCP
  492                   ;
  493                   ;
  494 E98E  F5          CPMERR: PUSH AF           ;CP/M-Fehler - zurueck z. MONITOR
  495 E98F  E5                  PUSH HL
  496 E990  CD E9DB             CALL EXIT1
  497 E993  DF                  RST  18H
  498 E994  20 43 50            DEFM " CP"
  499 E997  CD                  DEFB 4DH+80H      ;"M+80H
  500 E998  E1                  POP  HL
  501 E999  F1                  POP  AF
  502 E99A  CD 01A5             CALL RSA
  503 E99D  E1                  POP  HL
  504 E99E  2B                  DEC  HL
  505 E99F  CD 07F1             CALL OUTHL
  506 E9A2  DF                  RST  18H
  507 E9A3  8D                  DEFB 0DH+80H
  508 E9A4  CD 05CE             CALL REGIST       ;MONI - Registeranzeige - nicht Monitor 11 !
  509 E9A7  FF                  RST  38H          ;zurueck zum MONI
  510                   ;
  511                   ;
  512 E9A8  3E C3       BOOT1:  LD   A,0C3H       ;CP/M "Grundseite" INIT
  513 E9AA  32 0000             LD   (WARMBT),A
  514 E9AD  32 0005             LD   (BDOSF),A
  515 E9B0  32 0038             LD   (RST38),A
  516 E9B3  21 E603             LD   HL,WBOOTB
  517 E9B6  22 0001             LD   (WARMBT+1),HL
  518 E9B9  21 D806             LD   HL,BDOS
  519 E9BC  22 0006             LD   (BDOSF+1),HL
  520 E9BF  21 E98E             LD   HL,CPMERR
  521 E9C2  22 0039             LD   (RST38+1),HL
  522 E9C5  21 0080             LD   HL,0080H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  10
BIOS    ASM

  523 E9C8  22 F43F             LD   (DMA),HL
  524 E9CB  C9                  RET
  525                   ;
  526                   ;+++++++++++++++++++++++++++++++++   Ende BOOT / WBOOT   +++++++++++++++++
  527                   ;
  528 E9CC  F5          CPMMOD: PUSH AF           ;CP/M EIN
  529 E9CD  3E 01               LD   A,01H
  530 E9CF  18 02               JR   MOD1
  531                   ;
  532 E9D1  F5          AC1MOD: PUSH AF           ;CP/M AUS (AC1-Mode)
  533 E9D2  AF                  XOR  A
  534 E9D3  D3 1E       MOD1:   OUT  (P1E),A
  535 E9D5  F1                  POP  AF
  536 E9D6  C9                  RET
  537                   ;
  538                   ;--------------------------------------------------------------------------
  539                   ;
  540                   ;EXIT - Routine
  541                   ;
  542 E9D7  21 0000     EXIT:   LD   HL,0000H     ;Ruecksprungadresse fuer RET
  543 E9DA  E5                  PUSH HL
  544 E9DB  AF          EXIT1:  XOR  A
  545 E9DC  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  546 E9DF  D3 1E               OUT  (P1E),A      ;AC1-Mode
  547 E9E1  D3 14               OUT  (P14),A      ;Modul_1 - ggf. EPROMs ausblenden
  548 E9E3  2A F424             LD   HL,(OLDNMI)
  549 E9E6  22 1818             LD   (BREAK),HL   ;alten NMI wiederherstellen
  550 E9E9  3E 03               LD   A,03H
  551 E9EB  D3 00               OUT  (P00),A      ;CTC: Interrupts ausschalten
  552 E9ED  D3 01               OUT  (P01),A
  553 E9EF  D3 02               OUT  (P02),A
  554 E9F1  D3 03               OUT  (P03),A
  555 E9F3  D3 06               OUT  (P06),A      ;PIO1 A: Interrupt auschalten
  556 E9F5  3E CF               LD   A,0CFH
  557 E9F7  D3 06               OUT  (P06),A      ;PIO1 A: "Mode 3" + "Set Mode"
  558 E9F9  3E FF               LD   A,0FFH
  559 E9FB  D3 06               OUT  (P06),A      ;PIO1 A: PA0 bis PA7 sind Eingaenge
  560 E9FD  C9                  RET               ;zurueck zum MONITOR, normal
  561                   ;
  562                   ;
  563                   ;Interrupt-Einsprung fuer die Tastatur
  564                   ;
  565 E9FE  F3          ISRTAS: DI
  566 E9FF  F5                  PUSH AF
  567 EA00  C5                  PUSH BC
  568 EA01  E5                  PUSH HL
  569 EA02  DB 04               IN   A,(P04)      ;PIO_A abfragen
  570 EA04  CB 7F               BIT  7,A          ;Taste gedrueckt?
  571 EA06  28 45               JR   Z,ISREND     ;nein, ISR beenden
  572 EA08  4F                  LD   C,A
  573                   ;
  574 EA09  06 1E               LD   B,1EH        ;Tastaturentprellung
  575 EA0B  DB 04       PRELL1: IN   A,(P04)
  576 EA0D  B9                  CP   C
  577 EA0E  20 3D               JR   NZ,ISREND
  578 EA10  10 F9               DJNZ PRELL1       ;30 Durchlaeufe
  579                   ;
  580 EA12  FE 80               CP   80H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  11
BIOS    ASM

  581 EA14  28 37               JR   Z,ISREND     ;das war eine NULL-Eingabe
  582                   ;
  583 EA16  4F                  LD   C,A
  584 EA17  21 FF00             LD   HL,ZEIPUF
  585 EA1A  7E                  LD   A,(HL)       ;Fuellstand Zeichenpuffer
  586 EA1B  3C                  INC  A
  587 EA1C  FE 1F               CP   1FH          ;Puffer voll?
  588 EA1E  28 2D               JR   Z,ISREND
  589 EA20  77                  LD   (HL),A       ;Anzahl der Zeichen rueckschreiben
  590 EA21  C5                  PUSH BC
  591 EA22  06 00               LD   B,0
  592 EA24  4F                  LD   C,A
  593 EA25  09                  ADD  HL,BC        ;HL = Position im Zeichenpuffer
  594 EA26  C1                  POP  BC
  595 EA27  CB B9               RES  7,C          ;7. Bit loeschen und
  596 EA29  71                  LD   (HL),C       ;Taste in Zeichenpuffer eintragen
  597                   ;
  598                   ;       LD   BC,8034H     ;Initialisierung Tastenpiep --> 2 MHz
  599 EA2A  01 8068             LD   BC,8068H     ;Initialisierung Tastenpiep --> 4 MHz
  600 EA2D  79          BEEP1:  LD   A,C
  601 EA2E  3D          BEEP2:  DEC  A
  602 EA2F  20 FD               JR   NZ,BEEP2
  603 EA31  DB 05               IN   A,(P05)      ;PIO_B-Daten
  604 EA33  EE 01               XOR  01H          ;Tastenpiep
  605 EA35  D3 05               OUT  (P05),A
  606 EA37  10 F4               DJNZ BEEP1
  607 EA39  E6 FE               AND  0FEH
  608 EA3B  D3 05               OUT  (P05),A
  609                   ;
  610 EA3D  01 0200             LD   BC,0200H     ;Tastaturentprellung
  611 EA40  0B          PRELL2: DEC  BC
  612 EA41  78                  LD   A,B
  613 EA42  B1                  OR   C
  614 EA43  20 FB               JR   NZ,PRELL2
  615                   ;
  616 EA45  3E B7               LD   A,0B7H       ;weitere Interrupts loeschen
  617 EA47  D3 06               OUT  (P06),A
  618 EA49  3E 7F               LD   A,7FH
  619 EA4B  D3 06               OUT  (P06),A
  620                   ;
  621 EA4D  E1          ISREND: POP  HL
  622 EA4E  C1                  POP  BC
  623 EA4F  F1                  POP  AF
  624 EA50  FB                  EI
  625 EA51  ED 4D               RETI
  626                   ;
  627 EA53  88 CF FF B7 PIOTAB: DEFB 88H,0CFH,0FFH,0B7H,7FH  ;PIO 1A: Init.-Tabelle
  628                   ;  88H --> NWT Interruptvektor --> 0FF88H
  629                   ; 0CFH --> "Mode 3" + "Set Mode" (kein Handshaking, next Byte = I/O-Zuordnung)
  630                   ; 0FFH --> PA0 bis PA7 sind Eingaenge
  631                   ; 0B7H --> Setting Interrupt Control Word --> mit nachfolgender Maskierung
  632                   ;  7FH --> Bit7=L --> nur PA7 erzeugt Interrupts
  633                   ;
  634 EA58  C5          OUTTXT: PUSH BC
  635 EA59  F5                  PUSH AF
  636 EA5A  4E          TEXT1:  LD   C,(HL)
  637 EA5B  79                  LD   A,C
  638 EA5C  B7                  OR   A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  12
BIOS    ASM

  639 EA5D  28 06               JR   Z,TEXT2
  640 EA5F  CD EAE8             CALL CONOUT
  641 EA62  23                  INC  HL
  642 EA63  18 F5               JR   TEXT1
  643 EA65  F1          TEXT2:  POP  AF
  644 EA66  C1                  POP  BC
  645 EA67  C9                  RET
  646                   ;
  647                   ;************************   CONST   *************************
  648                   ;
  649 EA68  3A FF00     CONST:  LD   A,(ZEIPUF)
  650 EA6B  B7                  OR   A
  651 EA6C  C8                  RET  Z
  652 EA6D  3E FF               LD   A,0FFH
  653 EA6F  C9                  RET
  654                   ;
  655                   ;***************************   CONIN   ***********************
  656                   ;
  657 EA70  F3          CONIN:  DI
  658 EA71  ED 73 F420          LD   (SPCIN),SP
  659 EA75  31 F3C6             LD   SP,CINSP
  660 EA78  C5                  PUSH BC
  661 EA79  D5                  PUSH DE
  662 EA7A  E5                  PUSH HL
  663 EA7B  01 017F             LD   BC,017FH     ;Kursor-Blinker ruecksetzen
  664 EA7E  AF          CONIN1: XOR  A
  665 EA7F  F3                  DI
  666 EA80  2A FF00             LD   HL,(ZEIPUF)  ;L = Anz. der Zeichen, H = 1. Zeichen
  667 EA83  B5                  OR   L
  668 EA84  20 20               JR   NZ,CONIN4    ;Zeichen im Tastaturpuffer vorhanden
  669 EA86  FB                  EI
  670 EA87  10 F5               DJNZ CONIN1       ;256*LOOP: warte auf ein Zeichen
  671 EA89  3A F41B             LD   A,(CUFLAG)
  672 EA8C  B7                  OR   A
  673 EA8D  28 EF               JR   Z,CONIN1     ;kein "Kursor-Blinken"
  674 EA8F  F3                  DI
  675 EA90  CD E9D1             CALL AC1MOD       ;AC1 Mode
  676 EA93  2A 1800             LD   HL,(CUPOS)
  677 EA96  0C                  INC  C
  678 EA97  CB 79               BIT  7,C          ;hier wird die Cursor-Blinkfrequenz festgelegt
  679 EA99  3A F41F             LD   A,(CHAR)     ;bisheriges Zeichen auf der Kursorposition
  680 EA9C  28 02               JR   Z,CONIN3
  681 EA9E  3E 0F               LD   A,CUZEI      ;Kursor = 0FH
  682 EAA0  77          CONIN3: LD   (HL),A       ;"Kursor-Blinken" - Bildschirm-Ausgabe
  683 EAA1  CD E9CC             CALL CPMMOD       ;CP/M Mode
  684 EAA4  18 D8               JR   CONIN1
  685                   ;
  686 EAA6  3D          CONIN4: DEC  A            ;DEC Anzahl_der_Zeichen_im_Tastaturpuffer
  687 EAA7  32 FF00             LD   (ZEIPUF),A
  688 EAAA  7C                  LD   A,H          ;1. Zeichen aus dem Tastaturpuffer --> A
  689 EAAB  21 FF02             LD   HL,ZEIPUF+2
  690 EAAE  11 FF01             LD   DE,ZEIPUF+1
  691 EAB1  01 001F             LD   BC,001FH
  692 EAB4  ED B0               LDIR              ;alle Zeichen im Puffer rC<cken 1 Pos. n. links
  693 EAB6  E1                  POP  HL
  694 EAB7  D1                  POP  DE
  695 EAB8  C1                  POP  BC
  696 EAB9  ED 7B F420          LD   SP,(SPCIN)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  13
BIOS    ASM

  697 EABD  FB                  EI
  698 EABE  C9                  RET
  699                   ;
  700                   ;***************************   LIST   ************************
  701                   ;
  702 EABF  F3          LIST:   DI
  703 EAC0  CD E9D1             CALL AC1MOD
  704 EAC3  F5                  PUSH AF      
  705 EAC4  79                  LD   A,C
  706 EAC5  FE 0A               CP   0AH  
  707 EAC7  28 0C               JR   Z,LEND1  
  708 EAC9  CD 0DF9             CALL MV24A        ;MONI V24 Ausgabe Akku
  709 EACC  FE 0D               CP   0DH     
  710 EACE  20 05               JR   NZ,LEND1 
  711 EAD0  3E 0A               LD   A,0AH   
  712 EAD2  CD 0DF9             CALL MV24A        ;MONI V24 Ausgabe Akku
  713 EAD5  F1          LEND1:  POP  AF      
  714 EAD6  CD E9CC             CALL CPMMOD
  715 EAD9  FB                  EI
  716 EADA  C9                  RET
  717                   ;
  718                   ;***************************   PUNCH   ***********************
  719                   ;
  720 EADB  F3          PUNCH:  DI                ;Ausgabe C nach V24
  721 EADC  79                  LD   A,C
  722 EADD  CD E9D1             CALL AC1MOD
  723 EAE0  CD 0DF9             CALL MV24A        ;MONI V24 Ausgabe Akku
  724 EAE3  CD E9CC             CALL CPMMOD
  725 EAE6  FB                  EI
  726 EAE7  C9                  RET
  727                   ;
  728                   ;******************************* CONOUT  *********************
  729                   ;
  730                   ;       Ausgabe eines Zeichens,   IN: Zeichen in C
  731                   ;
  732 EAE8  F3          CONOUT: DI
  733 EAE9  ED 73 F422          LD   (SPCOUT),SP  ;Stack bei MON-Aufruf retten
  734 EAED  31 F3EC             LD   SP,COUTSP
  735 EAF0  F5                  PUSH AF
  736 EAF1  C5                  PUSH BC
  737 EAF2  D5                  PUSH DE
  738 EAF3  E5                  PUSH HL
  739 EAF4  CD E9D1             CALL AC1MOD
  740 EAF7  E5                  PUSH HL
  741 EAF8  2A 1800             LD   HL,(CUPOS)   ;Cursorposition
  742 EAFB  3A F41F             LD   A,(CHAR)
  743 EAFE  77                  LD   (HL),A       ;altes Zeichen auf Position
  744 EAFF  3A F41C             LD   A,(STZ00)    ;Durchlauf bei Steuerzeichen?
  745 EB02  A7                  AND  A
  746 EB03  C2 ED33             JP   NZ,KONV10    ;NZ= Steuerzeichen 2. oder 3. Durchlauf
  747 EB06  79                  LD   A,C          ;Byte
  748 EB07  FE 20               CP   20H          ;kleinstes Zeichen
  749 EB09  38 26               JR   C,KONVTB
  750 EB0B  FE 7F               CP   7FH          ;groesstes Zeichen
  751 EB0D  30 22               JR   NC,KONVTB
  752 EB0F  2A 1800             LD   HL,(CUPOS)
  753 EB12  C3 EC70             JP   CCHAR        ;Ausgabe einzelnes Zeichen
  754                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  14
BIOS    ASM

  755 EB15  2A 1800     KONVT9: LD   HL,(CUPOS)
  756 EB18  7E                  LD   A,(HL)
  757 EB19  32 F41F             LD   (CHAR),A
  758 EB1C  3A F41B             LD   A,(CUFLAG)
  759 EB1F  B7                  OR   A
  760 EB20  28 02               JR   Z,COEN1      ;Kursor nicht darstellen
  761 EB22  36 0F               LD   (HL),CUZEI
  762 EB24  CD E9CC     COEN1:  CALL CPMMOD
  763 EB27  E1                  POP  HL
  764 EB28  D1                  POP  DE
  765 EB29  C1                  POP  BC
  766 EB2A  F1                  POP  AF
  767 EB2B  ED 7B F422          LD   SP,(SPCOUT)
  768 EB2F  FB                  EI
  769 EB30  C9                  RET
  770                   ;
  771                   ;Verzweigung bei Steuerzeichen
  772                   ;INPUT:  A=Zeichen
  773                   ;
  774 EB31  FE 1B       KONVTB: CP   1BH          ;ESC ?
  775 EB33  20 07               JR   NZ,KONVT1
  776 EB35  3E 02               LD   A,02H        ;wenn ja
  777 EB37  32 F41C             LD   (STZ00),A    ;Zeiger auf 2
  778 EB3A  18 D9               JR   KONVT9       ;nichts ausgeben
  779                   ;
  780 EB3C  2A 1800     KONVT1: LD   HL,(CUPOS)
  781 EB3F  FE 01               CP   01H          ;^A Cursor home                      
  782 EB41  28 5B               JR   Z,CHOME                                             
  783 EB43  FE 07               CP   07H          ;^G akustisches Signal                                                 
  784 EB45  CA ECC2             JP   Z,MBEEP                                              
  785 EB48  FE 08               CP   08H          ;^H Cursor links                     
  786 EB4A  CA EBC6             JP   Z,CLEFT                                             
  787 EB4D  FE 0A               CP   0AH          ;^J Zeilenvorschub                   
  788 EB4F  CA EBCA             JP   Z,CLF                                               
  789 EB52  FE 0C               CP   0CH          ;^L CLS                              
  790 EB54  28 51               JR   Z,BCLS                                              
  791 EB56  FE 0D               CP   0DH          ;^M Wagenruecklauf                   
  792 EB58  CA EBE2             JP   Z,CCRET                                             
  793 EB5B  FE 14               CP   14H          ;^T BS ab Cursor loeschen            
  794 EB5D  CA EBE9             JP   Z,CBLOE                                             
  795 EB60  FE 15               CP   15H          ;^U Cursor nach rechts               
  796 EB62  CA EC0C             JP   Z,CRIGH                                             
  797 EB65  FE 16               CP   16H          ;^V Zeile ab Cursor loeschen         
  798 EB67  CA EC10             JP   Z,CZLOE                                             
  799 EB6A  FE 18               CP   18H          ;^X Zeile ab Cursor loeschen + CR    
  800 EB6C  CA EC37             JP   Z,CZLCR                                             
  801 EB6F  FE 1A               CP   1AH          ;^Z Cursor hoch                      
  802 EB71  CA EC60             JP   Z,CHOCH                                             
  803 EB74  FE 82               CP   82H          ;Kursor ein
  804 EB76  CA ED24             JP   Z,CUON
  805 EB79  FE 83               CP   83H          ;Kursor aus
  806 EB7B  CA ED2C             JP   Z,CUOFF
  807                   ;
  808 EB7E  47                  LD   B,A          ;Zeichen merken                      
  809 EB7F  3A F416             LD   A,(COLOR)                                         
  810 EB82  A7                  AND  A            ;Test auf Color-BWS                  
  811 EB83  CA EB15             JP   Z,KONVT9     ;Z = monochrom  
  812 EB86  78                  LD   A,B                                                 
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  15
BIOS    ASM

  813                   ;
  814 EB87  FE 84               CP   84H          ;normale Darstellung
  815 EB89  CA ECE9             JP   Z,BNORM
  816 EB8C  FE 85               CP   85H          ;invers
  817 EB8E  CA ECF7             JP   Z,BINVN
  818 EB91  FE 86               CP   86H          ;intensiv - HihgLight
  819 EB93  CA ED06             JP   Z,BINTE
  820 EB96  FE 87               CP   87H          ;intensiv + invers
  821 EB98  CA ED13             JP   Z,BIVIN
  822 EB9B  C3 EB15             JP   KONVT9
  823                   ;
  824 EB9E  21 17FF     CHOME:  LD   HL,17FFH
  825 EBA1  22 1800             LD   (CUPOS),HL
  826 EBA4  C3 EB15             JP   KONVT9
  827                   ;
  828 EBA7  3E 20       BCLS:   LD   A,20H        ;0Ch  Bildschirm loeschen
  829 EBA9  CD EBD3             CALL BCL1         ;Loeschroutine
  830 EBAC  22 1800             LD   (CUPOS),HL   ;Cursorposition
  831 EBAF  3A F416             LD   A,(COLOR)    ;Farbbyte
  832 EBB2  E6 77               AND  77H          ;Farb-BWS vorhanden?
  833 EBB4  CA EB15             JP   Z,KONVT9     ;Z = nein, dann Ende
  834 EBB7  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  835 EBBA  3A F416             LD   A,(COLOR)
  836 EBBD  CD EBD3             CALL BCL1
  837 EBC0  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  838 EBC3  C3 EB15             JP   KONVT9
  839                   ;
  840 EBC6  23          CLEFT:  INC  HL           ;08h  Cursor links
  841 EBC7  C3 EC64             JP   CHOLI
  842                   ;
  843 EBCA  11 0040     CLF:    LD   DE,0040H     ;0Ah  Zeilenvorschub
  844 EBCD  A7                  AND  A
  845 EBCE  ED 52               SBC  HL,DE
  846 EBD0  C3 EC81             JP   SCROL
  847                   ;
  848 EBD3  21 1000     BCL1:   LD   HL,1000H     ;Anfang BWS
  849 EBD6  77                  LD   (HL),A
  850 EBD7  54                  LD   D,H
  851 EBD8  5D                  LD   E,L
  852 EBD9  1C                  INC  E
  853 EBDA  C5                  PUSH BC
  854 EBDB  01 07FF             LD   BC,07FFH     ;Laenge BWS
  855 EBDE  ED B0               LDIR
  856 EBE0  C1                  POP  BC
  857 EBE1  C9                  RET
  858                   ;
  859 EBE2  7D          CCRET:  LD   A,L          ;0Dh  Wagenruecklauf
  860 EBE3  F6 3F               OR   3FH
  861 EBE5  6F                  LD   L,A
  862 EBE6  C3 EC81             JP   SCROL
  863                   ;
  864 EBE9  E5          CBLOE:  PUSH HL
  865 EBEA  3E 0F               LD   A,CUZEI      ;14h  BS ab Cursor loeschen
  866 EBEC  36 20       CBLO1:  LD   (HL),20H
  867 EBEE  2B                  DEC  HL
  868 EBEF  BC                  CP   H
  869 EBF0  20 FA               JR   NZ,CBLO1
  870 EBF2  E1                  POP  HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  16
BIOS    ASM

  871 EBF3  3A F416             LD   A,(COLOR)
  872 EBF6  47                  LD   B,A
  873 EBF7  E6 77               AND  77H
  874 EBF9  CA EB15             JP   Z,KONVT9
  875 EBFC  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  876 EBFF  3E 0F               LD   A,CUZEI
  877 EC01  70          CBLO2:  LD   (HL),B
  878 EC02  2B                  DEC  HL
  879 EC03  BC                  CP   H
  880 EC04  20 FB               JR   NZ,CBLO2
  881 EC06  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  882 EC09  C3 EB15             JP   KONVT9
  883                   ;
  884 EC0C  2B          CRIGH:  DEC  HL           ;15h  Cursor nach rechts
  885 EC0D  C3 EC81             JP   SCROL
  886                   ;
  887 EC10  E5          CZLOE:  PUSH HL           ;16h  Zeile ab Cursor loeschen
  888 EC11  7D                  LD   A,L
  889 EC12  E6 3F               AND  3FH
  890 EC14  47                  LD   B,A
  891 EC15  04                  INC  B
  892 EC16  36 20       CZLO1:  LD   (HL),20H
  893 EC18  2B                  DEC  HL
  894 EC19  10 FB               DJNZ CZLO1
  895 EC1B  E1                  POP  HL
  896 EC1C  3A F416             LD   A,(COLOR)
  897 EC1F  4F                  LD   C,A
  898 EC20  E6 77               AND  77H
  899 EC22  CA EB15             JP   Z,KONVT9
  900 EC25  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  901 EC28  7D                  LD   A,L
  902 EC29  E6 3F               AND  3FH
  903 EC2B  47                  LD   B,A
  904 EC2C  04                  INC  B
  905 EC2D  71          CZLO2:  LD   (HL),C
  906 EC2E  2B                  DEC  HL
  907 EC2F  10 FC               DJNZ CZLO2
  908 EC31  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  909 EC34  C3 EB15             JP   KONVT9
  910                   ;
  911 EC37  E5          CZLCR:  PUSH HL           ;18h  Zeile ab Cursor loeschen + CR
  912 EC38  7D                  LD   A,L
  913 EC39  F6 3F               OR   3FH
  914 EC3B  6F                  LD   L,A
  915 EC3C  22 1800             LD   (CUPOS),HL
  916 EC3F  E5                  PUSH HL
  917 EC40  06 40               LD   B,40H        ;Zeilenlaenge
  918 EC42  36 20       CZLC1:  LD   (HL),20H
  919 EC44  2B                  DEC  HL
  920 EC45  10 FB               DJNZ CZLC1
  921 EC47  E1                  POP  HL
  922 EC48  3A F416             LD   A,(COLOR)
  923 EC4B  4F                  LD   C,A
  924 EC4C  E6 77               AND  77H
  925 EC4E  CA EB15             JP   Z,KONVT9
  926 EC51  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  927 EC54  06 40               LD   B,40H
  928 EC56  71          CZLC2:  LD   (HL),C
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  17
BIOS    ASM

  929 EC57  2B                  DEC  HL
  930 EC58  10 FC               DJNZ CZLC2
  931 EC5A  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  932 EC5D  C3 EB15             JP   KONVT9
  933                   ;
  934 EC60  11 0040     CHOCH:  LD   DE,0040H     ;1Ah     Cursor hoch
  935 EC63  19                  ADD  HL,DE
  936                   ;
  937 EC64  3E 18       CHOLI:  LD   A,18H        ;Begrenzung Cursor hoch und links
  938 EC66  BC                  CP   H
  939 EC67  CA EB15             JP   Z,KONVT9
  940 EC6A  22 1800             LD   (CUPOS),HL
  941 EC6D  C3 EB15             JP   KONVT9
  942                   ;
  943 EC70  77          CCHAR:  LD   (HL),A
  944 EC71  3A F416             LD   A,(COLOR)
  945 EC74  4F                  LD   C,A
  946 EC75  E6 77               AND  77H
  947 EC77  28 07               JR   Z,CCHA1
  948 EC79  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  949 EC7C  71                  LD   (HL),C
  950 EC7D  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  951 EC80  2B          CCHA1:  DEC  HL
  952                   ;
  953 EC81  22 1800     SCROL:  LD   (CUPOS),HL
  954 EC84  EB                  EX   DE,HL        ;Test ob Scrollen noetig
  955 EC85  21 0FFF             LD   HL,0FFFH
  956 EC88  A7                  AND  A
  957 EC89  ED 52               SBC  HL,DE        ;DE = akt. Cursorpos.
  958 EC8B  EB                  EX   DE,HL
  959 EC8C  DA EB15             JP   C,KONVT9     ;CY = nicht scrollen
  960 EC8F  3E 20               LD   A,20H        ;Leerzeichen
  961 EC91  CD ECAB             CALL SCR11        ;Scrollen
  962 EC94  3A F416             LD   A,(COLOR)
  963 EC97  E6 77               AND  77H
  964 EC99  CA EB15             JP   Z,KONVT9     ;Z = kein Farbspeicher
  965 EC9C  CD EDB6             CALL BWSCOL       ;Farbspeicher ein
  966 EC9F  3A F416             LD   A,(COLOR)    ;Farbbyte
  967 ECA2  CD ECAB             CALL SCR11
  968 ECA5  CD EDBC             CALL BWSZEI       ;Farbspeicher aus
  969 ECA8  C3 EB15             JP   KONVT9
  970                   ;
  971 ECAB  21 17BF     SCR11:  LD   HL,17BFH     ;Umladeroutine Scrollen
  972 ECAE  11 17FF             LD   DE,17FFH
  973 ECB1  01 07C0             LD   BC,07C0H
  974 ECB4  ED B8               LDDR
  975 ECB6  EB                  EX   DE,HL
  976 ECB7  22 1800             LD   (CUPOS),HL
  977 ECBA  23                  INC  HL
  978 ECBB  06 40               LD   B,40H        ;eine Zeilenlaenge
  979 ECBD  2D          SCR12:  DEC  L
  980 ECBE  77                  LD   (HL),A       ;Leerzeile schreiben
  981 ECBF  10 FC               DJNZ SCR12
  982 ECC1  C9                  RET
  983                   ;
  984                   ;
  985                   ;UP 'MBEEP' (Monitor-Beep)
  986                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  18
BIOS    ASM

  987 ECC2  C5          MBEEP:  PUSH BC 
  988 ECC3  06 02               LD   B,02H        ;2 Wiederholungen
  989 ECC5  C5          MBEEP1: PUSH BC 
  990                   ;       LD   BC,0040H     ;--> fuer 2 MHz
  991 ECC6  01 0080             LD   BC,0080H     ;--> fuer 4 MHz
  992 ECC9  CD ECD9             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
  993                   ;       LD   BC,0F032H    ;--> fuer 2 MHz
  994 ECCC  01 F064             LD   BC,0F064H    ;--> fuer 4 MHz
  995 ECCF  CD ECD9             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
  996 ECD2  C1                  POP  BC 
  997 ECD3  10 F0               DJNZ MBEEP1 
  998 ECD5  C1                  POP  BC 
  999 ECD6  C3 EB24             JP   COEN1 
 1000                   ;
 1001                   ;
 1002                   ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1003                   ;
 1004 ECD9  F5          UPTON:  PUSH AF 
 1005 ECDA  DB 05       UPTON1: IN   A,(P05) 
 1006 ECDC  1F                  RRA 
 1007 ECDD  3F                  CCF 
 1008 ECDE  17                  RLA 
 1009 ECDF  D3 05               OUT  (P05),A 
 1010 ECE1  79                  LD   A,C 
 1011 ECE2  3D          UPTON2: DEC  A 
 1012 ECE3  20 FD               JR   NZ,UPTON2 
 1013 ECE5  10 F3               DJNZ UPTON1 
 1014 ECE7  F1                  POP  AF 
 1015 ECE8  C9                  RET 
 1016                   ;
 1017                   ;
 1018 ECE9  3A F417     BNORM:  LD   A,(COLO1)    ;84h  normale Darstellung
 1019 ECEC  E6 77               AND  77H
 1020 ECEE  32 F416             LD   (COLOR),A
 1021 ECF1  32 F417             LD   (COLO1),A
 1022 ECF4  C3 EB15             JP   KONVT9
 1023                   ;
 1024 ECF7  3A F417     BINVN:  LD   A,(COLO1)    ;85h  invers EIN
 1025 ECFA  E6 77               AND  77H
 1026 ECFC  0F                  RRCA
 1027 ECFD  0F                  RRCA
 1028 ECFE  0F                  RRCA
 1029 ECFF  0F                  RRCA
 1030 ED00  32 F416             LD   (COLOR),A
 1031 ED03  C3 EB15             JP   KONVT9
 1032                   ;
 1033 ED06  3A F417     BINTE:  LD   A,(COLO1)    ;86h  intensiv EIN
 1034 ED09  E6 77               AND  77H
 1035 ED0B  F6 08               OR   08H
 1036 ED0D  32 F416             LD   (COLOR),A
 1037 ED10  C3 EB15             JP   KONVT9
 1038                   ;
 1039 ED13  3A F416     BIVIN:  LD   A,(COLOR)    ;87h  intensiv + invers
 1040 ED16  E6 77               AND  77H
 1041 ED18  F6 08               OR   08H
 1042 ED1A  0F                  RRCA
 1043 ED1B  0F                  RRCA
 1044 ED1C  0F                  RRCA
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  19
BIOS    ASM

 1045 ED1D  0F                  RRCA
 1046 ED1E  32 F416             LD   (COLOR),A
 1047 ED21  C3 EB15             JP   KONVT9
 1048                   ;
 1049 ED24  3E 01       CUON:   LD   A,01H        ;82h Cursor EIN
 1050 ED26  32 F41B             LD   (CUFLAG),A
 1051 ED29  C3 EB15             JP   KONVT9
 1052                   ;
 1053 ED2C  AF          CUOFF:  XOR  A            ;83h Cursor AUS
 1054 ED2D  32 F41B             LD   (CUFLAG),A
 1055 ED30  C3 EB15             JP   KONVT9
 1056                   ;
 1057                   ; Behandlung ESC-Sequenzen
 1058                   ;
 1059                   ; Input: ESC + 2 Steuerzeichen
 1060                   ; wenn 1. Zeichen > 80h dann Cursorposition
 1061                   ; sonst Auswertung Farbe / Grafikzeichen
 1062                   ; (stz00) = Zaehler fuer Zeichenanzahl
 1063                   ;
 1064 ED33  3A F41C     KONV10: LD   A,(STZ00)
 1065 ED36  FE 02               CP   02H          ;2 = 1. Steuerzeichen (Zeile)
 1066 ED38  20 0C               JR   NZ,KONV20    ;sonst 3. Durchlauf (Spalte)
 1067 ED3A  79                  LD   A,C
 1068 ED3B  32 F41D             LD   (STZ01),A    ;erstes Zeichen merken
 1069 ED3E  3E 01               LD   A,01H        ;Zeiger fuer 3. Durchlauf
 1070 ED40  32 F41C             LD   (STZ00),A
 1071 ED43  C3 EB15             JP   KONVT9       ;nichts ausgeben
 1072                   ;
 1073                   ; Verzweigung Cursorposition / weitere Funktionen
 1074                   ;
 1075 ED46  79          KONV20: LD   A,C
 1076 ED47  32 F41E             LD   (STZ02),A    ;zweites Zeichen merken
 1077 ED4A  AF                  XOR  A
 1078 ED4B  32 F41C             LD   (STZ00),A    ;Durchlaufzaehler ruecksetzen
 1079 ED4E  21 F41D             LD   HL,STZ01
 1080 ED51  7E                  LD   A,(HL)
 1081 ED52  CB 7F               BIT  7,A          ;welche Funktion? NZ = Cursor
 1082 ED54  28 2F               JR   Z,KONV22     ;Z = weitere Funktionen
 1083                   
 1084                   ; Berechnung direkte Cursorposition
 1085                   ; OUT:    HL = BWS-Adresse
 1086                   ;
 1087 ED56  F5                  PUSH AF
 1088 ED57  79                  LD   A,C
 1089 ED58  E6 3F               AND  3FH          ;max. Spaltenzahl
 1090 ED5A  6F                  LD   L,A
 1091 ED5B  F1                  POP  AF
 1092 ED5C  E6 1F               AND  1FH          ;max. Zeilenzahl
 1093 ED5E  16 00               LD   D,00H
 1094 ED60  62                  LD   H,D
 1095 ED61  5F                  LD   E,A
 1096 ED62  06 06               LD   B,06H
 1097 ED64  CB 23       KONV21: SLA  E
 1098 ED66  CB 12               RL   D
 1099 ED68  10 FA               DJNZ KONV21
 1100 ED6A  19                  ADD  HL,DE
 1101 ED6B  EB                  EX   DE,HL
 1102 ED6C  21 17FF             LD   HL,17FFH     ;Ende BWS-RAM
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  20
BIOS    ASM

 1103 ED6F  A7                  AND  A
 1104 ED70  ED 52               SBC  HL,DE
 1105                   ;
 1106                   ; Cursor direkt positionieren
 1107                   ; IN:    HL = Adresse Cursor
 1108                   ;
 1109 ED72  E5                  PUSH HL
 1110 ED73  2A 1800             LD   HL,(CUPOS)	  ;alte Position
 1111 ED76  3A F41F             LD   A,(CHAR)	  ;Zeichen holen
 1112 ED79  77                  LD   (HL),A	      ;auf BS schreiben
 1113 ED7A  E1                  POP  HL
 1114 ED7B  22 1800             LD   (CUPOS),HL   ;neue Position setzen
 1115 ED7E  7E                  LD   A,(HL)       ;neues Zeichen holen
 1116 ED7F  32 F41F             LD   (CHAR),A     ;und merken
 1117 ED82  C3 EB15             JP   KONVT9
 1118                   ;
 1119                   ; Auswertung weiterer ESC-Funktionen
 1120                   ; IN:      A = 1. Steuerzeichen
 1121                   ;
 1122                   ; Ausgabe Grafikzeichen aus AC1-ZG ( > 80h )
 1123                   ;
 1124 ED85  FE 5F       KONV22: CP   5FH          ;Grafikzeichen?
 1125 ED87  20 08               JR   NZ,KONV24    ;NZ = nein
 1126 ED89  23                  INC  HL
 1127 ED8A  7E                  LD   A,(HL)       ;2. Zeichen holen
 1128 ED8B  2A 1800             LD   HL,(CUPOS)
 1129 ED8E  C3 EC70             JP   CCHAR        ;Zeichen ausgeben
 1130                   ;
 1131                   ; Einstellen der Farbe (nur Color-BWS)
 1132                   ;
 1133 ED91  FE 5D       KONV24: CP   5DH          ;Farbe?
 1134 ED93  C2 EB15             JP   NZ,KONVT9    ;NZ = nein
 1135 ED96  3A F416             LD   A,(COLOR)    ;Color-BWS?
 1136 ED99  A7                  AND  A
 1137 ED9A  CA EB15             JP   Z,KONVT9     ;Z = nein
 1138 ED9D  23                  INC  HL
 1139 ED9E  7E                  LD   A,(HL)       ;2. Zeichen holen
 1140 ED9F  E6 77               AND  77H          ;intensiv maskieren
 1141 EDA1  47                  LD   B,A
 1142 EDA2  0F                  RRCA
 1143 EDA3  0F                  RRCA
 1144 EDA4  0F                  RRCA
 1145 EDA5  0F                  RRCA
 1146 EDA6  B8                  CP   B            ;Zeichen- und HG-Farbe gleich?
 1147 EDA7  CA EB15             JP   Z,KONVT9     ;Z = Ja, dann ignorieren
 1148 EDAA  78                  LD   A,B
 1149 EDAB  32 F416             LD   (COLOR),A    ;Farbe setzen
 1150 EDAE  E6 77               AND  77H          ;intensiv maskieren
 1151 EDB0  32 F417             LD   (COLO1),A    ;Backup
 1152 EDB3  C3 EB15             JP   KONVT9
 1153                   ;
 1154 EDB6  DB F0       BWSCOL: IN   A,(PF0)      ;bwsport
 1155 EDB8  CB D7               SET  2,A          ;Farbspeicher ein
 1156 EDBA  18 04               JR   BWSZ1
 1157                   ;
 1158 EDBC  DB F0       BWSZEI: IN   A,(PF0)      ;bwsport
 1159 EDBE  CB 97               RES  2,A          ;Farbspeicher aus
 1160 EDC0  E6 07       BWSZ1:  AND  07H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  21
BIOS    ASM

 1161 EDC2  D3 F0               OUT  (PF0),A
 1162 EDC4  C9                  RET
 1163                   ;
 1164 EDC5  AF          BWSINI: XOR  A            ;Farbbyte auf Monochrom setzen
 1165 EDC6  32 F416             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1166 EDC9  32 F418             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1167 EDCC  0E F0               LD   C,0F0H       ;I/O-Adresse COLOR-BWS
 1168 EDCE  ED 40               IN   B,(C)        ;Konfigbyte COLOR-BWS lesen
 1169 EDD0  04                  INC  B            ;fuer COLOR-BWS muss B<255 sein
 1170 EDD1  C8                  RET  Z            ;kein COLOR-BWS vorhanden --> Ende
 1171                           ;hier wird die Routine verlassen, wenn kein CPLD vorh. ist
 1172 EDD2  05                  DEC  B            ;Konfigbyte COLOR-BWS: Farb-RAM aus
 1173 EDD3  50                  LD   D,B
 1174 EDD4  CB D2               SET  2,D          ;Konfigbyte COLOR-BWS: Farb-RAM ein
 1175 EDD6  21 1000             LD   HL,1000H
 1176 EDD9  5E                  LD   E,(HL)       ;Zeichen aus 1000h
 1177 EDDA  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1178 EDDC  3A 181F             LD   A,(CBWSB)    ;Farbbyte aus dem AC1-Monitor
 1179 EDDF  77                  LD   (HL),A       ;Farbe auf 1000h setzen
 1180 EDE0  BE                  CP   (HL)         ;ist Farb-RAM gesteckt?
 1181 EDE1  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1182 EDE3  73                  LD   (HL),E       ;Zeichen auf 1000h zurueckschreiben
 1183 EDE4  C0                  RET  NZ           ;Farbe hat nicht geklappt --> Ende
 1184                           ;hier wird die Routine verlassen, wenn kein Farb-RAM steckt
 1185 EDE5  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1186 EDE7  C5                  PUSH BC
 1187 EDE8  11 1001             LD   DE,1001H
 1188 EDEB  01 07FF             LD   BC,07FFH
 1189 EDEE  ED B0               LDIR              ;Farb-RAM initialisieren
 1190 EDF0  7E                  LD   A,(HL)       ;Farbe aus 17FFh ruecklesen
 1191 EDF1  C1                  POP  BC
 1192 EDF2  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1193 EDF4  32 F416             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1194 EDF7  32 F418             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1195 EDFA  C9                  RET
 1196                   ;
 1197                   ;+++++++++++++++++++++++++++++   Ende CONOUT  ++++++++++++++++
 1198                   ;
 1199 EDFB  AF          LISTST: XOR  A
 1200 EDFC  3D                  DEC  A
 1201 EDFD  C9                  RET
 1202                   ;
 1203                   ;--------------------------------------------------------------------------
 1204                   ;
 1205 EDFE  21 E641     SELDSK: LD   HL,NDISK     ;max. Anzahl der LW
 1206 EE01  79                  LD   A,C          ;C = akt. LW
 1207 EE02  BE                  CP   (HL)
 1208 EE03  21 0000             LD   HL,0000H     ;HL=0 --> kein LW
 1209 EE06  D0                  RET  NC           ;akt. LW >= NDISK!!!
 1210 EE07  2A E642             LD   HL,(DPHX)    ;AnfangsADR DPH(y)-Tabelle
 1211 EE0A  06 00               LD   B,00H        ;BC = akt. LW
 1212 EE0C  09                  ADD  HL,BC
 1213 EE0D  09                  ADD  HL,BC        ;HL = DPHY + (2 * LW)
 1214 EE0E  5E                  LD   E,(HL)
 1215 EE0F  23                  INC  HL
 1216 EE10  56                  LD   D,(HL)       ;DE = (DPHY + (2 * LW))
 1217 EE11  EB                  EX   DE,HL        ;HL = DPH-ADR vom akt. LW
 1218 EE12  7C                  LD   A,H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  22
BIOS    ASM

 1219 EE13  B5                  OR   L
 1220 EE14  C8                  RET  Z            ;HL=0 --> kein DPB
 1221 EE15  79                  LD   A,C
 1222 EE16  32 F43A             LD   (DRIVE),A    ;aktives LW --> A
 1223 EE19  22 F441             LD   (DPH),HL     ;zugeordneter DPH --> HL
 1224 EE1C  C9                  RET
 1225                   ;
 1226                   ;--------------------------------------------------------------------------
 1227                   ;
 1228 EE1D  01 0000     HOME:   LD   BC,0000H
 1229 EE20  ED 43 F43B  SETTRK: LD   (TRACK),BC
 1230 EE24  C9                  RET
 1231                   ;
 1232 EE25  ED 43 F43D  SETSEC: LD   (SECTOR),BC
 1233 EE29  C9                  RET
 1234                   ;
 1235 EE2A  ED 43 F43F  SETDMA: LD   (DMA),BC
 1236 EE2E  C9                  RET
 1237                   ;
 1238 EE2F  60          SECTRN: LD   H,B
 1239 EE30  69                  LD   L,C
 1240 EE31  7A                  LD   A,D
 1241 EE32  B3                  OR   E
 1242 EE33  C8                  RET  Z
 1243 EE34  EB                  EX   DE,HL
 1244 EE35  06 00               LD   B,00H
 1245 EE37  09                  ADD  HL,BC
 1246 EE38  6E                  LD   L,(HL)
 1247 EE39  62                  LD   H,D
 1248 EE3A  C9                  RET
 1249                   ;
 1250                   ;--------------------------------------------------------------------------
 1251                   ;
 1252 EE3B  0E 02       READ:   LD   C,02H
 1253 EE3D  3E 04               LD   A,04H
 1254 EE3F  21                  DEFB 21H          ;LD HL,063EH mit nxt. Befehl!!!
 1255 EE40  3E 06       WRITE:  LD   A,06H        ;DUMMY fuer READ
 1256 EE42  32 F439             LD   (RWBYTE),A   ;hier geht es fuer READ weiter!
 1257 EE45  79                  LD   A,C
 1258 EE46  32 F45C             LD   (DF51E),A
 1259 EE49  21 EE62             LD   HL,LEDEC
 1260 EE4C  E5                  PUSH HL
 1261 EE4D  2A F441             LD   HL,(DPH)
 1262 EE50  11 000A             LD   DE,000AH
 1263 EE53  19                  ADD  HL,DE
 1264 EE54  7E                  LD   A,(HL)
 1265 EE55  23                  INC  HL
 1266 EE56  66                  LD   H,(HL)
 1267 EE57  6F                  LD   L,A
 1268 EE58  2B                  DEC  HL
 1269 EE59  7E                  LD   A,(HL)
 1270 EE5A  2B                  DEC  HL
 1271 EE5B  6E                  LD   L,(HL)
 1272 EE5C  67                  LD   H,A
 1273 EE5D  E5                  PUSH HL
 1274 EE5E  21 F439             LD   HL,RWBYTE    ;HL -> Bytefolge fuer R/W
 1275 EE61  C9                  RET
 1276                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  23
BIOS    ASM

 1277 EE62  B7          LEDEC:  OR   A
 1278 EE63  C8                  RET  Z
 1279 EE64  3E 01               LD   A,01H
 1280 EE66  C9                  RET
 1281                   ;
 1282                   ;************************  RAM-Disk   ******************************
 1283                   ;
 1284 EE67  4E          RDSKRW: LD   C,(HL)       ;RWBYTE: 04 = Lesen; 06 = Schreiben 
 1285 EE68  23                  INC  HL           ;DRIVE wird uebersprungen
 1286 EE69  23                  INC  HL
 1287 EE6A  7E                  LD   A,(HL)       ;TRACK NWT
 1288 EE6B  32 F419             LD   (RAFTRK),A
 1289 EE6E  23                  INC  HL
 1290 EE6F  7E                  LD   A,(HL)       ;TRACK HWT
 1291 EE70  A7                  AND  A
 1292 EE71  20 32               JR   NZ,RDERR     ;muss 0 sein
 1293 EE73  23                  INC  HL
 1294 EE74  7E                  LD   A,(HL)       ;SEKTOR NWT
 1295 EE75  32 F41A             LD   (RAFSEC),A
 1296 EE78  CB 7F               BIT  7,A
 1297 EE7A  20 29               JR   NZ,RDERR     ;Bit 7 muss 0 sein
 1298 EE7C  CB 77               BIT  6,A
 1299 EE7E  20 25               JR   NZ,RDERR     ;Bit 6 muss 0 sein
 1300 EE80  23                  INC  HL
 1301 EE81  7E                  LD   A,(HL)       ;SEKTOR HWT
 1302 EE82  A7                  AND  A
 1303 EE83  20 20               JR   NZ,RDERR     ;muss 0 sein
 1304 EE85  23                  INC  HL
 1305 EE86  23                  INC  HL           ;DMA wird uebersprungen
 1306 EE87  79                  LD   A,C
 1307 EE88  01 0080             LD   BC,0080H
 1308 EE8B  FE 06               CP   06H
 1309 EE8D  28 08               JR   Z,RDSKWR     ;C = 06 --> RDSK Schreiben
 1310 EE8F  CD EFCA             CALL ADRRAF
 1311 EE92  ED B2               INIR
 1312 EE94  00                  NOP
 1313 EE95  AF                  XOR  A            ;in Ordnung
 1314 EE96  C9                  RET
 1315                   ;
 1316 EE97  21 0080     RDSKWR: LD   HL,0080H     ;RAM-Disk schreiben 
 1317 EE9A  ED 5B F43F          LD   DE,(DMA)
 1318 EE9E  CD EFCA             CALL ADRRAF
 1319 EEA1  ED B3               OTIR
 1320 EEA3  AF                  XOR  A            ;in Ordnung
 1321 EEA4  C9                  RET
 1322                   ;
 1323 EEA5  3E FF       RDERR:  LD   A,0FFH       ;Fehler
 1324 EEA7  C9                  RET
 1325                   ;
 1326 EEA8  20 3D 3E 49 TXTRDI: DEFM " =>INIT.."
 1327 EEB1  00                  DEFB 0
 1328                   ;
 1329 EEB2  4F 4B       TXTRDO: DEFM "OK"
 1330 EEB4  00                  DEFB 0
 1331                   ;
 1332 EEB5  52 46 4C 20 TXTRDE: DEFM "RFL ERROR!"
 1333 EEBF  0D 0A               DEFB 0DH,0AH
 1334 EEC1  00                  DEFB 0
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  24
BIOS    ASM

 1335                   ;
 1336 EEC2  AF          RDTEST: XOR  A            ;Kapazitaet der RAM-Disk testen
 1337 EEC3  D3 E6               OUT  (PE0+6),A    ;H-Adresse ruecksetzen
 1338 EEC5  21 EF16             LD   HL,RDMERK    ;Merkzellen im RAM
 1339 EEC8  06 04               LD   B,4          ;4 Durchlaeufe
 1340 EECA  0E E0               LD   C,PE0        ;Test erfolgt in der 1. RAM-Bank
 1341 EECC  16 04               LD   D,4          ;Startwert Extended-Adresse
 1342 EECE  AF          RDTST1: XOR  A
 1343 EECF  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1344 EED1  7A                  LD   A,D
 1345 EED2  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1346 EED4  ED 78               IN   A,(C)
 1347 EED6  77                  LD   (HL),A       ;Daten aus der RAM-Disk sichern
 1348 EED7  AF                  XOR  A
 1349 EED8  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1350 EEDA  7A                  LD   A,D
 1351 EEDB  ED 79               OUT  (C),A        ;Testwert in die RAM-Disk schreiben
 1352 EEDD  23                  INC  HL           ;Merkzelle++
 1353 EEDE  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1354 EEE0  10 EC               DJNZ RDTST1
 1355                   ;
 1356                   ;Tabelle der Test-Werte (mit *...* sind die zu testenden Werte):
 1357                   ;
 1358                   ;           RAM-Disk-Size =   256K   512K  1024K  2048K
 1359                   ;Extended-Adresse=00000100B    0      0      0     *4*
 1360                   ;Extended-Adresse=00000010B    0      0     *2*     2
 1361                   ;Extended-Adresse=00000001B    0     *1*     1      1
 1362                   ;Extended-Adresse=00000000B   *0*     0      0      0
 1363                   ;
 1364 EEE2  06 04               LD   B,4          ;4 Durchlaeufe
 1365 EEE4  16 04               LD   D,4          ;Startwert Extended-Adresse
 1366 EEE6  AF          RDTST2: XOR  A
 1367 EEE7  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1368 EEE9  7A                  LD   A,D
 1369 EEEA  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1370 EEEC  ED 78               IN   A,(C)
 1371 EEEE  BA                  CP   D
 1372 EEEF  28 07               JR   Z,RDTST3     ;2048(B=4),1024(B=3),512(B=2),256(B=1)
 1373 EEF1  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1374 EEF3  10 F1               DJNZ RDTST2
 1375 EEF5  C3 EFC1             JP   RDERRO       ;Fehler: hier stimmt was nicht!
 1376                   ;
 1377 EEF8  21 EF1A     RDTST3: LD   HL,RDSIZE
 1378 EEFB  05                  DEC  B
 1379 EEFC  70                  LD   (HL),B       ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1380                   ;
 1381 EEFD  21 EF19             LD   HL,RDMERK+3  ;Merkzellen RAM (in die RD zurueck)
 1382 EF00  04                  INC  B            ;1 bis 4 Durchlaeufe, je nach RDSIZE
 1383 EF01  0E E0               LD   C,PE0        ;1. RAM-Bank
 1384 EF03  16 01               LD   D,1          ;Startwert Ext.-Adr. (1 Bit n. rechts)
 1385 EF05  AF          RDTST4: XOR  A
 1386 EF06  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1387 EF08  7A                  LD   A,D
 1388 EF09  CB 3F               SRL  A            ;0 --> A7 --> A0 --> CY
 1389 EF0B  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1390 EF0D  7E                  LD   A,(HL)
 1391 EF0E  ED 79               OUT  (C),A        ;urspruengliche Daten zurueckschreiben
 1392 EF10  2B                  DEC  HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  25
BIOS    ASM

 1393 EF11  CB 22               SLA  D            ;CY <-- D7 <-- D0 <-- 0
 1394 EF13  10 F0               DJNZ RDTST4       ;WICHTIG: nicht mehr als notwendig
 1395 EF15  C9                  RET               ;in die RAM-Disk zurC<ckschreiben!!
 1396                   ;
 1397 EF16  00 00 00 00 RDMERK: DEFS 4,0          ;4 Merkzellen fuer den RAM
 1398 EF1A  00          RDSIZE: DEFB 0            ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1399                   ;
 1400 EF1B  21 EEA8     RDFORM: LD   HL,TXTRDI    ;Formatierungstext...
 1401 EF1E  CD EA58             CALL OUTTXT
 1402 EF21  21 C002             LD   HL,0C002H    ;Hilfsprogramm von 0C000H bis 0C800H
 1403 EF24  54                  LD   D,H
 1404 EF25  5D                  LD   E,L
 1405 EF26  2B                  DEC  HL
 1406 EF27  36 E0               LD   (HL),PE0     ;0C001H = Grundadresse der RAM-Disk
 1407 EF29  2B                  DEC  HL
 1408 EF2A  36 D3               LD   (HL),0D3H    ;0C000H = 0D3H --> OUT n
 1409 EF2C  01 0200             LD   BC,0200H
 1410 EF2F  ED B0               LDIR              ;0D3H,0E0H von 0C000H bis 0C1FFH
 1411 EF31  23                  INC  HL
 1412 EF32  36 E1               LD   (HL),PE0+1
 1413 EF34  2B                  DEC  HL
 1414 EF35  01 0200             LD   BC,0200H
 1415 EF38  ED B0               LDIR              ;0D3H,0E1H von 0C200H bis 0C3FFH
 1416 EF3A  23                  INC  HL
 1417 EF3B  36 E2               LD   (HL),PE0+2
 1418 EF3D  2B                  DEC  HL
 1419 EF3E  01 0200             LD   BC,0200H
 1420 EF41  ED B0               LDIR              ;0D3H,0E2H von 0C400H bis 0C5FFH
 1421 EF43  23                  INC  HL
 1422 EF44  36 E3               LD   (HL),PE0+3
 1423 EF46  2B                  DEC  HL
 1424 EF47  01 0200             LD   BC,0200H
 1425 EF4A  ED B0               LDIR              ;0D3H,0E3H von 0C600H bis 0C7FFH
 1426 EF4C  36 C9               LD   (HL),0C9H    ;RET auf 0C800H
 1427                   ;
 1428 EF4E  21 EF1A             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1429 EF51  7E                  LD   A,(HL)
 1430 EF52  FE 00               CP   0
 1431 EF54  28 0A               JR   Z,RDFOR1     ;RD 256K
 1432 EF56  FE 01               CP   1
 1433 EF58  28 06               JR   Z,RDFOR1     ;RD 512K
 1434 EF5A  3D                  DEC  A
 1435 EF5B  CB 27               SLA  A            ;A *= 2
 1436 EF5D  CB 27               SLA  A            ;A *= 2
 1437 EF5F  3D                  DEC  A
 1438 EF60  57          RDFOR1: LD   D,A
 1439 EF61  14                  INC  D            ;D ==> 1=256K 2=512K 4=1024K 8=2048K
 1440 EF62  AF                  XOR  A
 1441 EF63  D3 E7               OUT  (PE0+7),A    ;L-Adresse setzen
 1442 EF65  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1443 EF67  1E 00               LD   E,0          ;Merker fuer Extended-Adresse
 1444 EF69  06 00               LD   B,0          ;256 Durchlaeufe
 1445 EF6B  0E E6               LD   C,PE0+6
 1446 EF6D  ED 41       RDFOR2: OUT  (C),B        ;H-Adresse setzen
 1447 EF6F  3E E5               LD   A,0E5H       ;RD wird mit 0E5H formatiert
 1448 EF71  CD C000             CALL HPRDSK       ;Hilfsprog. Format RAM-Disk auf C000H
 1449 EF74  10 F7               DJNZ RDFOR2       ;fuer alle H-Adressen (256 Durchl.)
 1450 EF76  1C                  INC  E
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  26
BIOS    ASM

 1451 EF77  7B                  LD   A,E
 1452 EF78  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1453 EF7A  15                  DEC  D
 1454 EF7B  20 F0               JR   NZ,RDFOR2        
 1455                   ;
 1456 EF7D  21 D000             LD   HL,CCP
 1457 EF80  22 F43F             LD   (DMA),HL
 1458 EF83  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
 1459 EF85  CD EF92             CALL WRCCP
 1460 EF88  C2 E98E             JP   NZ,CPMERR
 1461 EF8B  21 EEB2             LD   HL,TXTRDO    ;"OK"
 1462 EF8E  CD EA58             CALL OUTTXT
 1463 EF91  C9                  RET
 1464                   ;
 1465 EF92  C5          WRCCP:  PUSH BC           ;CCP+BDOS in Systemtrack schreiben
 1466 EF93  0E 00               LD   C,00H        ;LW A:
 1467 EF95  CD EDFE             CALL SELDSK
 1468 EF98  C1                  POP  BC
 1469 EF99  21 0000             LD   HL,0000H
 1470 EF9C  22 F43B             LD   (TRACK),HL   ;Track 0
 1471 EF9F  EB                  EX   DE,HL
 1472 EFA0  21 D000             LD   HL,CCP
 1473 EFA3  ED 53 F43D  WRCCP1: LD   (SECTOR),DE
 1474 EFA7  22 F43F             LD   (DMA),HL
 1475 EFAA  C5                  PUSH BC
 1476 EFAB  CD                  DEFB 0CDH         ;CALL WRITE -> CD ED CA
 1477 EFAC  EE40        WRCCP2: DEFW WRITE        ;kannn durch READ (EDC5) ersetzt werden
 1478 EFAE  C1                  POP  BC
 1479 EFAF  20 10               JR   NZ,RDERRO
 1480 EFB1  2A F43F             LD   HL,(DMA)
 1481 EFB4  11 0080             LD   DE,0080H
 1482 EFB7  19                  ADD  HL,DE
 1483 EFB8  ED 5B F43D          LD   DE,(SECTOR)
 1484 EFBC  13                  INC  DE
 1485 EFBD  10 E4               DJNZ WRCCP1
 1486 EFBF  AF                  XOR  A
 1487 EFC0  C9                  RET
 1488                   ;
 1489 EFC1  21 EEB5     RDERRO: LD   HL,TXTRDE
 1490 EFC4  CD EA58             CALL OUTTXT
 1491 EFC7  AF                  XOR  A
 1492 EFC8  3D                  DEC  A
 1493 EFC9  C9                  RET
 1494                   ;
 1495                   ;Adressarithmetik RAF: L=RADR 0-7 , H=RADR 8-15 , A=RADR 16-19
 1496                   ;
 1497 EFCA  AF          ADRRAF: XOR  A            ;CY = 0
 1498 EFCB  6F                  LD   L,A 
 1499 EFCC  3A F41A             LD   A,(RAFSEC)   ;8 bit
 1500 EFCF  67                  LD   H,A          ;H=Sektor (max. 64 = Bit 0-5)
 1501 EFD0  CB 1C               RR   H
 1502 EFD2  CB 1D               RR   L            ;H0 -> L7 ...... H5 -> H4
 1503 EFD4  3A F419             LD   A,(RAFTRK)   ;8 bit , A=Track (max. 128 bei 1M = Bit 0-6)
 1504 EFD7  CB 1F               RR   A            ;A0 -> CY
 1505 EFD9  30 02               JR   NC,ADRAF1
 1506 EFDB  CB EC               SET  5,H          ;H5 = A0 (RADR13)
 1507 EFDD  CB 1F       ADRAF1: RR   A            ;A1 -> CY
 1508 EFDF  30 02               JR   NC,ADRAF2
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  27
BIOS    ASM

 1509 EFE1  CB F4               SET  6,H          ;H6 = A1 (RADR14)
 1510 EFE3  CB 1F       ADRAF2: RR   A            ;A2 -> CY
 1511 EFE5  30 02               JR   NC,ADRAF3
 1512 EFE7  CB FC               SET  7,H          ;H7 = A2 (RADR15)
 1513 EFE9  F5          ADRAF3: PUSH AF
 1514 EFEA  E6 03               AND  03H
 1515 EFEC  F6 E0               OR   PE0          ;Grundadresse der RAM-Disk
 1516 EFEE  4F                  LD   C,A
 1517 EFEF  7D                  LD   A,L
 1518 EFF0  D3 E7               OUT  (PE0+7),A    ;L-Adresse
 1519 EFF2  7C                  LD   A,H
 1520 EFF3  D3 E6               OUT  (PE0+6),A    ;H-Adresse
 1521 EFF5  F1                  POP  AF
 1522 EFF6  CB 1F               RR   A            ;Rotiere A rechts durch Carry
 1523 EFF8  CB 1F               RR   A
 1524 EFFA  E6 07               AND  07H          ;max. 2048K RAM-Disk
 1525 EFFC  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1526 EFFE  06 80               LD   B,80H
 1527 F000  2A F43F             LD   HL,(DMA)
 1528 F003  C9                  RET
 1529                   ;
 1530                   ;**********************  Ende  RAM-Disk  *********************
 1531                   ;
 1532                   ;*************************  LOAD-Befehl  *********************
 1533                   ;
 1534 F004  C9          LOAD:   RET
 1535                   ;
 1536                   ;******************************   Ende LOAD  *****************
 1537                   ;
 1538 F005  2A F441     LEFFA:  LD   HL,(DPH)     ;zugeordneter DPH --> HL
 1539 F008  22 F453             LD   (DF515),HL
 1540 F00B  2E 0F       LF000:  LD   L,0FH
 1541 F00D  D5          LF002:  PUSH DE
 1542 F00E  11 000A             LD   DE,000AH
 1543 F011  62                  LD   H,D
 1544 F012  E5                  PUSH HL
 1545 F013  2A F453             LD   HL,(DF515)
 1546 F016  19                  ADD  HL,DE
 1547 F017  5E                  LD   E,(HL)
 1548 F018  23                  INC  HL
 1549 F019  56                  LD   D,(HL)
 1550 F01A  E1                  POP  HL
 1551 F01B  19                  ADD  HL,DE
 1552 F01C  D1                  POP  DE
 1553 F01D  7E                  LD   A,(HL)
 1554 F01E  B7                  OR   A
 1555 F01F  C9                  RET
 1556                   ;Ansprung unklar
 1557 F020  23          LF015:  INC  HL
 1558 F021  CB FE               SET  7,(HL)
 1559 F023  2B                  DEC  HL
 1560 F024  AF          LF019:  XOR  A
 1561 F025  32 F45A             LD   (DF51C),A
 1562 F028  CD F02F             CALL LF024
 1563 F02B  3A F45A             LD   A,(DF51C)
 1564 F02E  C9                  RET
 1565                   ;
 1566 F02F  4E          LF024:  LD   C,(HL)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  28
BIOS    ASM

 1567 F030  CD F005             CALL LEFFA
 1568 F033  CA F0EC             JP   Z,LF0E1
 1569 F036  79                  LD   A,C
 1570 F037  FE 06               CP   06H
 1571 F039  3E 01               LD   A,01H
 1572 F03B  20 01               JR   NZ,LF033
 1573 F03D  AF                  XOR  A
 1574 F03E  32 F45B     LF033:  LD   (DF51D),A
 1575 F041  CD F00B             CALL LF000
 1576 F044  47                  LD   B,A
 1577 F045  2A F43D             LD   HL,(SECTOR)
 1578 F048  CB 3C       LF03D:  SRL  H
 1579 F04A  CB 1D               RR   L
 1580 F04C  10 FA               DJNZ LF03D
 1581 F04E  22 F456             LD   (DF518),HL
 1582 F051  21 F458             LD   HL,DF51A
 1583 F054  7E                  LD   A,(HL)
 1584 F055  36 01               LD   (HL),01H
 1585 F057  B7                  OR   A
 1586 F058  28 26               JR   Z,LF075
 1587 F05A  3A F43A             LD   A,(DRIVE)
 1588 F05D  21 F443             LD   HL,DF505
 1589 F060  BE                  CP   (HL)
 1590 F061  20 16               JR   NZ,LF06E
 1591 F063  2A F444             LD   HL,(DF506)
 1592 F066  ED 5B F43B          LD   DE,(TRACK)
 1593 F06A  ED 52               SBC  HL,DE
 1594 F06C  20 0B               JR   NZ,LF06E
 1595 F06E  2A F446             LD   HL,(DF508)
 1596 F071  ED 5B F456          LD   DE,(DF518)
 1597 F075  ED 52               SBC  HL,DE
 1598 F077  28 1F               JR   Z,LF08D
 1599 F079  3A F459     LF06E:  LD   A,(DF51B)
 1600 F07C  B7                  OR   A
 1601 F07D  C4 F0D9             CALL NZ,LF0CE
 1602 F080  21 F43A     LF075:  LD   HL,DRIVE
 1603 F083  11 F443             LD   DE,DF505
 1604 F086  01 0009             LD   BC,0009H
 1605 F089  ED B0               LDIR
 1606 F08B  2A F456             LD   HL,(DF518)
 1607 F08E  22 F446             LD   (DF508),HL
 1608 F091  CD F0DC             CALL LF0D1
 1609 F094  AF                  XOR  A
 1610 F095  32 F459             LD   (DF51B),A
 1611 F098  CD F00B     LF08D:  CALL LF000
 1612 F09B  23                  INC  HL
 1613 F09C  3A F43D             LD   A,(SECTOR)
 1614 F09F  A6                  AND  (HL)
 1615 F0A0  1F                  RRA
 1616 F0A1  67                  LD   H,A
 1617 F0A2  3E 00               LD   A,00H
 1618 F0A4  1F                  RRA
 1619 F0A5  6F                  LD   L,A
 1620 F0A6  11 F45D             LD   DE,DISKP
 1621 F0A9  19                  ADD  HL,DE
 1622 F0AA  ED 5B F43F          LD   DE,(DMA)
 1623 F0AE  3A F45B             LD   A,(DF51D)
 1624 F0B1  B7                  OR   A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  29
BIOS    ASM

 1625 F0B2  20 05               JR   NZ,LF0AE
 1626 F0B4  3C                  INC  A
 1627 F0B5  32 F459             LD   (DF51B),A
 1628 F0B8  EB                  EX   DE,HL
 1629 F0B9  01 0080     LF0AE:  LD   BC,0080H
 1630 F0BC  ED B0               LDIR
 1631 F0BE  3A F45A             LD   A,(DF51C)
 1632 F0C1  B7                  OR   A
 1633 F0C2  20 10               JR   NZ,LF0C9
 1634 F0C4  3A F45C             LD   A,(DF51E)
 1635 F0C7  3D                  DEC  A
 1636 F0C8  C0                  RET  NZ
 1637 F0C9  32 F459             LD   (DF51B),A
 1638 F0CC  CD F0D9             CALL LF0CE
 1639 F0CF  3A F45A             LD   A,(DF51C)
 1640 F0D2  B7                  OR   A
 1641 F0D3  C8                  RET  Z
 1642 F0D4  AF          LF0C9:  XOR  A
 1643 F0D5  32 F458             LD   (DF51A),A
 1644 F0D8  C9                  RET
 1645                   ;
 1646 F0D9  3E 06       LF0CE:  LD   A,06H
 1647 F0DB  21                  DEFB 21H          ;LD HL,043EH -> 21 3E 04
 1648 F0DC  3E 04       LF0D1:  LD   A,04H  
 1649 F0DE  32 F455             LD   (DF517),A
 1650 F0E1  21 F45D             LD   HL,DISKP
 1651 F0E4  22 F448             LD   (DF50A),HL
 1652 F0E7  21 F443             LD   HL,DF505
 1653 F0EA  18 09               JR   LF0EA
 1654                   ;
 1655 F0EC  3A F439     LF0E1:  LD   A,(RWBYTE)
 1656 F0EF  32 F455             LD   (DF517),A
 1657 F0F2  21 F43A             LD   HL,DRIVE
 1658 F0F5  11 F44C     LF0EA:  LD   DE,DF50E
 1659 F0F8  01 0009             LD   BC,0009H
 1660 F0FB  ED B0               LDIR
 1661 F0FD  3A F44C             LD   A,(DF50E)
 1662 F100  17                  RLA
 1663 F101  DA F313             JP   C,GIDERW     ;GIDE
 1664 F104  3A F44E             LD   A,(DF510)
 1665 F107  21 F450             LD   HL,DF512
 1666 F10A  B6                  OR   (HL)
 1667 F10B  C2 F1CC             JP   NZ,LF1C1
 1668 F10E  CD F00B             CALL LF000
 1669 F111  32 F42C             LD   (DF4E8),A
 1670 F114  B7                  OR   A
 1671 F115  3E FF               LD   A,0FFH
 1672 F117  28 02               JR   Z,LF110
 1673 F119  3E 80               LD   A,80H
 1674 F11B  32 F42F     LF110:  LD   (DF4EB),A
 1675 F11E  23                  INC  HL
 1676 F11F  23                  INC  HL
 1677 F120  7E                  LD   A,(HL)
 1678 F121  32 F42D             LD   (DF4E9),A
 1679 F124  3A F44F             LD   A,(DF511)
 1680 F127  BE                  CP   (HL)
 1681 F128  38 04               JR   C,LF123
 1682 F12A  96                  SUB  (HL)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  30
BIOS    ASM

 1683 F12B  01 0104             LD   BC,0104H
 1684 F12E  3C          LF123:  INC  A
 1685 F12F  32 F42B             LD   (DF4E7),A
 1686 F132  23                  INC  HL
 1687 F133  7E                  LD   A,(HL)
 1688 F134  32 F42E             LD   (DF4EA),A
 1689 F137  23                  INC  HL
 1690 F138  3A F44D             LD   A,(DF50F)
 1691 F13B  BE                  CP   (HL)
 1692 F13C  38 04               JR   C,LF137
 1693 F13E  96                  SUB  (HL)
 1694 F13F  01 0104             LD   BC,0104H
 1695 F142  32 F429     LF137:  LD   (DF4E5),A
 1696 F145  23                  INC  HL
 1697 F146  7E                  LD   A,(HL)
 1698 F147  B1                  OR   C
 1699 F148  32 F428             LD   (DF4E4),A
 1700 F14B  78                  LD   A,B
 1701 F14C  32 F42A             LD   (DF4E6),A
 1702 F14F  23                  INC  HL
 1703 F150  3A F455             LD   A,(DF517)
 1704 F153  16 05               LD   D,05H
 1705 F155  FE 06               CP   06H
 1706 F157  28 02               JR   Z,LF150
 1707 F159  16 06               LD   D,06H
 1708 F15B  7E          LF150:  LD   A,(HL)
 1709 F15C  E6 40               AND  40H
 1710 F15E  B2                  OR   D
 1711 F15F  32 F426             LD   (DF4E2),A
 1712 F162  11 F430             LD   DE,DF4EC
 1713 F165  01 0004             LD   BC,0004H
 1714 F168  ED B0               LDIR
 1715 F16A  0E 02               LD   C,02H
 1716 F16C  06 02       LF161:  LD   B,02H
 1717 F16E  C5          LF163:  PUSH BC
 1718 F16F  CD F180             CALL LF175
 1719 F172  C1                  POP  BC
 1720 F173  B7                  OR   A
 1721 F174  C8                  RET  Z
 1722 F175  10 F7               DJNZ LF163
 1723 F177  0D                  DEC  C
 1724 F178  C8                  RET  Z
 1725 F179  C5                  PUSH BC
 1726 F17A  CD F1E0             CALL LF1D5
 1727 F17D  C1                  POP  BC
 1728 F17E  18 EC               JR   LF161
 1729                   ;
 1730 F180  3E 03       LF175:  LD   A,03H
 1731 F182  06 02               LD   B,02H
 1732 F184  21 F432             LD   HL,CTAB      ;FDC Befehlsbyte
 1733 F187  D3 41               OUT  (DFDC),A     ;Datenport FDC
 1734 F189  CD F23B             CALL LF230
 1735 F18C  CD F1F2             CALL LF1E7
 1736 F18F  20 3B               JR   NZ,LF1C1
 1737 F191  21 0040             LD   HL,0040H
 1738 F194  3A F42C             LD   A,(DF4E8)
 1739 F197  3C                  INC  A
 1740 F198  29          LF18D:  ADD  HL,HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  31
BIOS    ASM

 1741 F199  3D                  DEC  A
 1742 F19A  20 FC               JR   NZ,LF18D
 1743 F19C  2B                  DEC  HL
 1744 F19D  24                  INC  H
 1745 F19E  2C                  INC  L
 1746 F19F  E5                  PUSH HL
 1747 F1A0  2A F451             LD   HL,(DF513)
 1748 F1A3  E5                  PUSH HL
 1749 F1A4  3A F426             LD   A,(DF4E2)
 1750 F1A7  4F                  LD   C,A
 1751 F1A8  06 09               LD   B,09H
 1752 F1AA  0F                  RRCA
 1753 F1AB  3E 51               LD   A,51H
 1754 F1AD  8F                  ADC  A,A
 1755 F1AE  32 F27A             LD   (MODE0),A    ;A2 --> INI
 1756 F1B1  32 F280             LD   (MODE1),A    ;A3 --> OUTI
 1757 F1B4  F3                  DI
 1758 F1B5  CD F232             CALL LF227
 1759 F1B8  E1                  POP  HL
 1760 F1B9  D1                  POP  DE
 1761 F1BA  43                  LD   B,E
 1762 F1BB  0E 41               LD   C,DFDC       ;Datenport FDC
 1763 F1BD  CD F26D             CALL RW           ;FDC RW-Routine
 1764 F1C0  FB                  EI
 1765 F1C1  CD F1D3             CALL LF1C8
 1766 F1C4  21 F434             LD   HL,DF4F0
 1767 F1C7  7E                  LD   A,(HL)
 1768 F1C8  E6 C0               AND  0C0H
 1769 F1CA  28 02               JR   Z,LF1C3
 1770 F1CC  3E FF       LF1C1:  LD   A,0FFH
 1771 F1CE  32 F45A     LF1C3:  LD   (DF51C),A
 1772 F1D1  B7                  OR   A
 1773 F1D2  C9                  RET
 1774                   ;
 1775 F1D3  06 07       LF1C8:  LD   B,07H
 1776 F1D5  21 F434             LD   HL,DF4F0
 1777 F1D8  CD F256     LF1CD:  CALL LF24B
 1778 F1DB  77                  LD   (HL),A
 1779 F1DC  23                  INC  HL
 1780 F1DD  10 F9               DJNZ LF1CD
 1781 F1DF  C9                  RET
 1782                   ;
 1783 F1E0  01 0207     LF1D5:  LD   BC,0207H
 1784 F1E3  CD F232             CALL LF227
 1785 F1E6  CD F212             CALL LF207
 1786 F1E9  C8                  RET  Z
 1787 F1EA  01 0207             LD   BC,0207H
 1788 F1ED  CD F232             CALL LF227
 1789 F1F0  18 20               JR   LF207
 1790                   ;
 1791 F1F2  3A F429     LF1E7:  LD   A,(DF4E5)
 1792 F1F5  32 F435             LD   (DF4F7),A
 1793 F1F8  B7                  OR   A
 1794 F1F9  28 E5               JR   Z,LF1D5
 1795 F1FB  01 030F             LD   BC,030FH
 1796 F1FE  21 F430             LD   HL,DF4EC
 1797 F201  CB 66               BIT  4,(HL)
 1798 F203  28 04               JR   Z,LF1FE
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  32
BIOS    ASM

 1799 F205  87                  ADD  A,A
 1800 F206  32 F429             LD   (DF4E5),A
 1801 F209  CD F232     LF1FE:  CALL LF227
 1802 F20C  3A F435             LD   A,(DF4F7)
 1803 F20F  32 F429             LD   (DF4E5),A
 1804 F212  01 0108     LF207:  LD   BC,0108H
 1805 F215  CD F232             CALL LF227
 1806 F218  CD F256             CALL LF24B
 1807 F21B  47                  LD   B,A
 1808 F21C  32 F434             LD   (DF4F0),A
 1809 F21F  FE 80               CP   80H
 1810 F221  C4 F256             CALL NZ,LF24B
 1811 F224  CB 68               BIT  5,B
 1812 F226  28 EA               JR   Z,LF207
 1813 F228  78                  LD   A,B
 1814 F229  E6 F0               AND  0F0H
 1815 F22B  FE C0               CP   0C0H
 1816 F22D  28 E3               JR   Z,LF207
 1817 F22F  EE 20               XOR  20H
 1818 F231  C9                  RET
 1819                   ;
 1820 F232  C5          LF227:  PUSH BC
 1821 F233  CD F290             CALL LF285
 1822 F236  C1                  POP  BC
 1823 F237  21 F427     LF22C:  LD   HL,DF4E3
 1824 F23A  71                  LD   (HL),C
 1825 F23B  0E 41       LF230:  LD   C,41H
 1826 F23D  D5                  PUSH DE
 1827 F23E  11 1FFF     LF233:  LD   DE,1FFFH
 1828 F241  7B          LF236:  LD   A,E
 1829 F242  B2                  OR   D
 1830 F243  28 0D               JR   Z,LF247      ;Abbruch nach 8192 Versuchen
 1831 F245  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1832 F247  E6 C0               AND  0C0H
 1833 F249  FE 80               CP   80H          ;FDC bereit zum Schreiben?
 1834 F24B  1B                  DEC  DE
 1835 F24C  20 F3               JR   NZ,LF236     ;noch nicht bereit
 1836 F24E  ED A3               OUTI              ;1 Byte --> FDC
 1837 F250  20 EC               JR   NZ,LF233     ;Wdhlg., bis B=0
 1838 F252  06 00       LF247:  LD   B,00H
 1839 F254  D1                  POP  DE
 1840 F255  C9                  RET
 1841                   ;
 1842 F256  E5          LF24B:  PUSH HL
 1843 F257  21 1FFF             LD   HL,1FFFH
 1844 F25A  7D          LF24F:  LD   A,L
 1845 F25B  B4                  OR   H
 1846 F25C  3E C0               LD   A,0C0H
 1847 F25E  28 0B               JR   Z,LF260      ;Abbruch nach 8192 Versuchen
 1848 F260  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1849 F262  E6 C0               AND  0C0H
 1850 F264  FE C0               CP   0C0H         ;FDC bereit zum Lesen?
 1851 F266  2B                  DEC  HL
 1852 F267  20 F1               JR   NZ,LF24F     ;noch nicht bereit
 1853 F269  DB 41               IN   A,(DFDC)     ;1 Byte vom FDC lesen --> A
 1854 F26B  E1          LF260:  POP  HL
 1855 F26C  C9                  RET
 1856                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  33
BIOS    ASM

 1857                   ;
 1858                   ;       FDC READ/WRITE Routine
 1859                   ;       ----------------------
 1860                   ;
 1861 F26D  3A F438     RW:     LD   A,(LATPU)
 1862 F270  CB CF               SET  1,A
 1863 F272  D3 45               OUT  (LATCH),A    ;WAIT-Freigabe
 1864 F274  DB 40       RW01:   IN   A,(CFDC)     ;Lese Hauptstatusregister
 1865 F276  07                  RLCA
 1866 F277  30 FB               JR   NC,RW01      ;FDC noch nicht bereit
 1867 F279  ED                  DEFB 0EDH         ;ED A2 = INI
 1868 F27A  A2          MODE0:  DEFB 0A2H         ;ED A3 = OUTI
 1869 F27B  00                  NOP
 1870 F27C  D3 43       RW02:   OUT  (WAIT),A     ;WAIT bis Interrupt FDC
 1871 F27E  00                  NOP
 1872 F27F  ED                  DEFB 0EDH         ;ED A2 = INI
 1873 F280  A2          MODE1:  DEFB 0A2H         ;ED A3 = OUTI
 1874 F281  C2 F27C             JP   NZ,RW02
 1875 F284  15                  DEC  D
 1876 F285  C2 F27C             JP   NZ,RW02
 1877 F288  3A F438             LD   A,(LATPU)
 1878 F28B  CB E7               SET  4,A          ;Terminal Count
 1879 F28D  D3 45               OUT  (LATCH),A    ;TC + WAIT-Sperrung
 1880 F28F  C9                  RET
 1881                   ;
 1882 F290  21 F436     LF285:  LD   HL,DF4F8
 1883 F293  3A F428             LD   A,(DF4E4)
 1884 F296  E6 03               AND  03H
 1885 F298  BE                  CP   (HL)
 1886 F299  77                  LD   (HL),A
 1887 F29A  23                  INC  HL
 1888 F29B  4E                  LD   C,(HL)
 1889 F29C  36 48               LD   (HL),48H
 1890 F29E  F5                  PUSH AF
 1891 F29F  E5                  PUSH HL
 1892 F2A0  21 F438             LD   HL,LATPU
 1893 F2A3  3A F428             LD   A,(DF4E4)
 1894 F2A6  E6 03               AND  03H
 1895 F2A8  28 08               JR   Z,LF2A7
 1896 F2AA  FE 02               CP   02H
 1897 F2AC  28 04               JR   Z,LF2A7
 1898 F2AE  CB DE               SET  3,(HL)       ;Floppy-LW 1: Motor an
 1899 F2B0  18 02               JR   LF2A9
 1900                   ;
 1901 F2B2  CB C6       LF2A7:  SET  0,(HL)       ;Floppy-LW 0: Motor an
 1902 F2B4  7E          LF2A9:  LD   A,(HL)
 1903 F2B5  D3 45               OUT  (LATCH),A
 1904 F2B7  E1                  POP  HL
 1905 F2B8  F1                  POP  AF
 1906 F2B9  20 04               JR   NZ,LF2B4
 1907 F2BB  79                  LD   A,C
 1908 F2BC  A7                  AND  A
 1909 F2BD  20 09               JR   NZ,LF2BD
 1910 F2BF  3E 48       LF2B4:  LD   A,48H
 1911 F2C1  CB 3F               SRL  A
 1912 F2C3  CB 3F               SRL  A
 1913 F2C5  BE                  CP   (HL)
 1914 F2C6  38 F7               JR   C,LF2B4
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  34
BIOS    ASM

 1915 F2C8  7E          LF2BD:  LD   A,(HL)
 1916 F2C9  A7                  AND  A
 1917 F2CA  20 08               JR   NZ,LF2C9
 1918 F2CC  E5                  PUSH HL
 1919 F2CD  21 F2E8             LD   HL,DISCTX
 1920 F2D0  CD EA58             CALL OUTTXT
 1921 F2D3  E1                  POP  HL
 1922 F2D4  C5          LF2C9:  PUSH BC
 1923 F2D5  E5                  PUSH HL
 1924 F2D6  01 0204             LD   BC,0204H
 1925 F2D9  CD F237             CALL LF22C
 1926 F2DC  CD F256             CALL LF24B
 1927 F2DF  E1                  POP  HL
 1928 F2E0  C1                  POP  BC
 1929 F2E1  CB 6F               BIT  5,A
 1930 F2E3  28 E3               JR   Z,LF2BD
 1931 F2E5  36 90               LD   (HL),90H
 1932 F2E7  C9                  RET
 1933                   ;
 1934 F2E8  20 44 49 53 DISCTX: DEFM ' DISC?'
 1935 F2EE  08 08 08 08         DEFB 8,8,8,8,8,8
 1936 F2F4  00                  NOP
 1937                   ;
 1938                   ;
 1939                   ; Interrupteinsprung von CTC Kanal 3
 1940                   ;
 1941 F2F5  F3          ISRCTC: DI                ;DI hat gefehlt, wurde ergaenzt
 1942 F2F6  F5                  PUSH AF
 1943 F2F7  3A F437             LD   A,(CTCCNT)   ;CTC-Zusatzzaehler lesen
 1944 F2FA  A7                  AND  A
 1945 F2FB  28 12               JR   Z,ISRCTE     ;bei "0", die Fkt. beenden
 1946                           ;Beim Start von HRCPM wird CNTCNT per Interrupt von 255 auf 0 heruntergezaehlt.
 1947                           ;Das sieht nach einer verzoegerten Steuerung von LATPU und LATCH aus.
 1948 F2FD  3D                  DEC  A
 1949 F2FE  32 F437             LD   (CTCCNT),A
 1950 F301  20 0C               JR   NZ,ISRCTE
 1951 F303  E5                  PUSH HL           ;Bei 2 MHz CPU-Takt wird nach 8 Sekunden diese Stelle erreicht
 1952 F304  21 F438             LD   HL,LATPU
 1953 F307  CB 86               RES  0,(HL)       ;Floppy-LW 0: Motor aus
 1954 F309  CB 9E               RES  3,(HL)       ;Floppy-LW 1: Motor aus
 1955 F30B  7E                  LD   A,(HL)
 1956 F30C  D3 45               OUT  (LATCH),A    ;Latch auf dem Floppy-Controller ruecksetzen
 1957 F30E  E1                  POP  HL
 1958 F30F  F1          ISRCTE: POP  AF
 1959 F310  FB          INTEND: EI                ;ist zusaetzlich Einsprungpunkt fuer nicht genutzte Interrupts
 1960 F311  ED 4D               RETI
 1961                   ;
 1962                   ;-------------  R/W GIDE HW  -----------------------------------------------------------
 1963                   
 1964 F313  DB 8F       GIDERW: IN   A,(P8F)      ;Command / Status
 1965 F315  17                  RLA               ;Bit 0 = CY
 1966 F316  38 FB               JR   C,GIDERW     ;wait for hard disk ready (non-busy)
 1967 F318  2E 19               LD   L,19H
 1968 F31A  CD F00D             CALL LF002
 1969 F31D  4F                  LD   C,A
 1970 F31E  2A F44F             LD   HL,(DF511)
 1971 F321  23                  INC  HL
 1972 F322  AF                  XOR  A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  35
BIOS    ASM

 1973 F323  47                  LD   B,A
 1974 F324  3C          LF318:  INC  A
 1975 F325  ED 42               SBC  HL,BC
 1976 F327  28 02               JR   Z,LF31F
 1977 F329  30 F9               JR   NC,LF318
 1978 F32B  09          LF31F:  ADD  HL,BC
 1979 F32C  3D                  DEC  A
 1980 F32D  57                  LD   D,A
 1981 F32E  5D                  LD   E,L
 1982 F32F  2E 11               LD   L,11H
 1983 F331  CD F00D             CALL LF002
 1984 F334  B2                  OR   D
 1985 F335  D3 8E               OUT  (P8E),A      ;Drive and Head
 1986 F337  7B                  LD   A,E
 1987 F338  D3 8B               OUT  (P8B),A      ;Sector Number
 1988 F33A  23                  INC  HL
 1989 F33B  5E                  LD   E,(HL)
 1990 F33C  23                  INC  HL
 1991 F33D  56                  LD   D,(HL)
 1992 F33E  2A F44D             LD   HL,(DF50F)
 1993 F341  19                  ADD  HL,DE
 1994 F342  7D                  LD   A,L
 1995 F343  D3 8C               OUT  (P8C),A      ;Cylinder Low
 1996 F345  7C                  LD   A,H
 1997 F346  D3 8D               OUT  (P8D),A      ;Cylinder High
 1998 F348  3E 01               LD   A,01H
 1999 F34A  D3 8A               OUT  (P8A),A      ;Sector Count
 2000 F34C  3A F455             LD   A,(DF517)
 2001 F34F  FE 06               CP   06H
 2002 F351  28 16               JR   Z,LF35D      ;6 = schreiben
 2003                   ;
 2004                   ;  GIDE lesen 1 Sektor = 512 Bytes nach Puffer
 2005                   ;
 2006 F353  3E 20               LD   A,20H        ;Read Sector
 2007 F355  D3 8F               OUT  (P8F),A      ;Command / Status
 2008 F357  DB 8F       LF34B:  IN   A,(P8F)      ;Command / Status
 2009 F359  CB 5F               BIT  3,A
 2010 F35B  28 FA               JR   Z,LF34B      ;wait resp. DRQ active.
 2011 F35D  2A F451             LD   HL,(DF513)
 2012 F360  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2013 F363  ED B2               INIR
 2014 F365  ED B2               INIR              ;512 bytes gesamt lesen
 2015 F367  18 19               JR   LF376
 2016                   ;
 2017                   ;  GIDE schreiben 1 Sektor = 512 Bytes von Puffer
 2018                   ;
 2019 F369  3E 30       LF35D:  LD   A,30H        ;Write Sector
 2020 F36B  D3 8F               OUT  (P8F),A      ;Command / Status
 2021 F36D  DB 8F       LF361:  IN   A,(P8F)      ;Command / Status
 2022 F36F  17                  RLA               ;Bit 0 = CY
 2023 F370  38 FB               JR   C,LF361      ;wait for hard disk ready (non-busy)
 2024 F372  DB 8F       LF366:  IN   A,(P8F)      ;Command / Status
 2025 F374  CB 5F               BIT  3,A
 2026 F376  28 FA               JR   Z,LF366      ;wait resp. DRQ active.
 2027 F378  2A F451             LD   HL,(DF513)
 2028 F37B  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2029 F37E  ED B3               OTIR             
 2030 F380  ED B3               OTIR              ;512 bytes gesamt schreiben 
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  36
BIOS    ASM

 2031                   ;        
 2032 F382  DB 8F       LF376:  IN   A,(P8F)      ;Command / Status
 2033 F384  17                  RLA               ;Bit 0 = CY
 2034 F385  38 FB               JR   C,LF376      ;wait for hard disk ready (non-busy)
 2035 F387  DB 8F               IN   A,(P8F)      ;Command / Status
 2036 F389  E6 89               AND  89H          ;10001001b - busy, DRQ, or error?
 2037 F38B  C8                  RET  Z            ;no: all is fine, mit A=0
 2038 F38C  3E FF               LD   A,0FFH
 2039 F38E  32 F45A             LD   (DF51C),A
 2040 F391  C9                  RET               ;on errors, return with A=FFh
 2041                   ;
 2042                   ;-----------------  ENDE GIDE HW  ------------------------------------------
 2043                   ;
 2044 F392  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2045 F3AC  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2046 F3C6  43 4F 4E 4F CINSP:  DEFM "CONOUT-STACK_CONOUT-STACK_CONOUT-STACK"
 2047 F3EC  5A 42 49 4F COUTSP: DEFM "ZBIOS(C)ML-SOFT 2003 & AC1-BIOS(C)HR 2011"
 2048 F415  00          CPMSTK: NOP
 2049                   ;
 2050                   ;****************  Ende CP/M StackBereich  *******************
 2051                   ;
 2052 F416  00          COLOR:  DEFB 0            ;Merkzelle aktuelle BWS-Farbe (0=Monochrom)
 2053 F417  00          COLO1:  DEFB 0            ;aktuelle Farbe ohne invers und intensiv
 2054 F418  00          COLO2:  DEFB 0            ;Farbe fuer Monitor und CP/M Warmstart
 2055                   ;
 2056 F419  00          RAFTRK: DEFB 0            ;RAFTRK EQU 0F4C2H
 2057 F41A  00          RAFSEC: DEFB 0
 2058                   ;
 2059 F41B  01          CUFLAG: DEFB 1            ;CUON/CUOFF  KursorFlag  F4CDh
 2060 F41C  00          STZ00:  DEFB 0            ;Merkzelle Anz. BS-Steuerzeichen  F4CFh
 2061 F41D  00          STZ01:  DEFB 0            ;Merkzelle fuer 1. ESC-Steuerzeichen
 2062 F41E  00          STZ02:  DEFB 0            ;Merkzelle fuer 2. ESC-Steuerzeichen
 2063                   ;
 2064 F41F  00          CHAR:   DEFB 0            ;Merkzelle Zeichen <> Cursor  F4D2h
 2065                   ;
 2066 F420  0000        SPCIN:  DEFW 0            ;Merkzelle Stackpointer waehrend CONIN
 2067 F422  0000        SPCOUT: DEFW 0            ;Merkzelle Stackpointer waehrend CONOUT
 2068 F424  0000        OLDNMI: DEFW 0            ;2 Bytes fuer alten NMI
 2069                   ;
 2070 F426  00          DF4E2:  NOP
 2071 F427  00          DF4E3:  NOP               ;Merkzelle
 2072 F428  00          DF4E4:  NOP
 2073 F429  00          DF4E5:  NOP
 2074 F42A  00          DF4E6:  NOP
 2075 F42B  00          DF4E7:  NOP
 2076 F42C  00          DF4E8:  NOP
 2077 F42D  00          DF4E9:  NOP
 2078 F42E  00          DF4EA:  NOP
 2079 F42F  00          DF4EB:  NOP
 2080                   ;
 2081 F430  00          DF4EC:  NOP               ;4 Merkzellen  
 2082 F431  00                  NOP
 2083 F432  00          CTAB:   NOP               ;FDC Befehlsbyte
 2084 F433  00                  NOP               ;4 Merkzellen Ende
 2085                   ;
 2086 F434  00          DF4F0:  NOP
 2087 F435  00          DF4F7:  NOP
 2088 F436  00          DF4F8:  NOP
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  37
BIOS    ASM

 2089 F437  00          CTCCNT: DEFB 0            ;CTC-Counter - Zusatzzaehler fuer CTC-Interrupt
 2090 F438  00          LATPU:  NOP               ;Latch fuer den Floppy-Controler
 2091                   ;
 2092                   ;hier beginnt eine Bytefolge fuer Read/Write Operationen
 2093                   ;
 2094 F439  04          RWBYTE: DEFB 4            ;4 = READ, 6 = WRITE
 2095 F43A  00          DRIVE:  DEFB 0            ;LW-Nr.
 2096 F43B  0000        TRACK:  DEFW 0            ;akt. Track
 2097 F43D  0000        SECTOR: DEFW 0            ;akt. Sektor
 2098 F43F  0000        DMA:    DEFW 0            ;DMA-Adresse
 2099 F441  0000        DPH:    DEFW 0
 2100                   ;
 2101 F443  00          DF505:  DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2102 F444  0000        DF506:  DEFW 0
 2103 F446  0000        DF508:  DEFW 0
 2104 F448  0000        DF50A:  DEFW 0
 2105 F44A  0000                DEFW 0            ;Ende 9 Bytes
 2106                   ;
 2107 F44C  00          DF50E:  NOP               ;9 Bytes Kopie ab DRIVE: bzw. DF505:
 2108 F44D  00          DF50F:  NOP
 2109 F44E  00          DF510:  NOP
 2110 F44F  00          DF511:  DEFB 0
 2111 F450  00          DF512:  DEFB 0
 2112 F451  0000        DF513:  DEFW 0            ;Adresse akt. DISKPuffer
 2113 F453  0000        DF515:  DEFW 0            ;zugeordneter DPH - Ende 9 Bytes
 2114                   ;
 2115 F455  04          DF517:  DEFB 4            ;4 = READ, 6 = WRITE
 2116 F456  0000        DF518:  DEFW 0
 2117 F458  00          DF51A:  DEFB 0
 2118 F459  00          DF51B:  NOP
 2119 F45A  00          DF51C:  NOP
 2120 F45B  00          DF51D:  NOP
 2121 F45C  00          DF51E:  NOP
 2122                   ;
 2123 F45D  00 00 00 00 DISKP:  DEFS 1024,0       ;HW-Sektor Puffer aller LW (1k max. fuer FDD)
 2124 F85D  00 00 00 00 DIRBF:  DEFS 128,0        ;1 REC Puffer fuer Direktory
 2125 F8DD  00 00 00 00 ALL00:  DEFS 128,0        ;2048k(max.) / 2k / 8 = 128
 2126 F95D  00 00 00 00 ALL01:  DEFS 50,0         ;0F99FH
 2127 F98F  00 00 00 00 ALL02:  DEFS 504,0        ;0F9D1H
 2128 FB87  00 00 00 00 ALL03:  DEFS 256,0        ;0FBC9H
 2129 FC87  00 00 00 00 ALL04:  DEFS 256,0        ;0FCC9H
 2130 FD87  00 00 00 00 ALL05:  DEFS 50,0         ;0FDC9H
 2131 FDB9  00 00 00 00 ALL06:  DEFS 50,0         ;0FDFBH
 2132 FDEB  00 00 00 00 CHK01:  DEFS 32,0         ;0FE2DH
 2133 FE0B  00 00 00 00 CHK05:  DEFS 32,0         ;0FE4DH
 2134 FE2B  00 00 00 00 CHK06:  DEFS 32,0         ;0FE6DH
 2135                   ;
 2136 FE4B  42 49 4F 53         DEFM "BIOS-Ende"  ;nur fuer Frieder zur Info
 2137                   ;
 2138                   ;
 2139         FF80      DFF80   EQU  0FF80H       ;Interrupt-Einsprungpunkt CTC Kanal 0
 2140         FF82      DFF82   EQU  0FF82H       ;Interrupt-Einsprungpunkt CTC Kanal 1
 2141         FF84      DFF84   EQU  0FF84H       ;Interrupt-Einsprungpunkt CTC Kanal 2
 2142         FF86      DFF86   EQU  0FF86H       ;Interrupt-Einsprungpunkt CTC Kanal 3
 2143         FF88      DFF88   EQU  0FF88H       ;Interrupt-Einsprungpunkt Nr.1 PIO1A
 2144         FF8A      DFF8A   EQU  0FF8AH       ;Interrupt-Einsprungpunkt Nr.2 PIO1A
 2145                   ;
 2146                   ;#############################   PortAdressen   ##############
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  38
BIOS    ASM

 2147                   ;
 2148         0000      P00     EQU  00H          ;CTC Kanal 0
 2149         0001      P01     EQU  01H          ;CTC Kanal 1
 2150         0002      P02     EQU  02H          ;CTC Kanal 2
 2151         0003      P03     EQU  03H          ;CTC Kanal 3
 2152                   ;
 2153         0004      P04     EQU  04H          ;PIO_A-Daten
 2154         0005      P05     EQU  05H          ;PIO_B-Daten
 2155         0006      P06     EQU  06H          ;PIO_A-Control
 2156                   ;
 2157         0014      P14     EQU  14H          ;Modul_1 - ggf. EPROMs ausblenden
 2158                   ;
 2159         001E      P1E     EQU  1EH          ;CP/M - Umschalter
 2160                   ;
 2161         008A      P8A     EQU  8AH          ;GIDE Sector Count
 2162         008B      P8B     EQU  8BH          ;GIDE Sector Number
 2163         008C      P8C     EQU  8CH          ;GIDE Cylinder Low
 2164         008D      P8D     EQU  8DH          ;GIDE Cylinder High
 2165         008E      P8E     EQU  8EH          ;GIDE Drive and Head
 2166         008F      P8F     EQU  8FH          ;GIDE Command/Status
 2167                   ;
 2168                           .DEPHASE
 2169                           END
 0 Error(s) Detected.
 6228 Absolute Bytes. 323 Symbols Detected.
     0004      P04     EQU  04H          ;PIO_A-Daten
 2154         0005    