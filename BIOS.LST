Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   1
BIOS    ASM

    1                   ; ***********************************************************
    2                   ; *                                                         *
    3                   ; *  HRCPM12-BIOS fuer den AC1      Version vom 23.01.2024  *
    4                   ; *                                                         *
    5                   ; *                                                  V.141  *
    6                   ; *                                                         *
    7                   ; ***********************************************************
    8                   ;
    9                   ; Korrekturen/Fehlerbehebungen:
   10                   ; - alle nicht genutzten Programmteile (HRDOS12) entfernt
   11                   ; - (Turbo-)LOAD entfernt
   12                   ; - BWS(Farb)Init geaendert
   13                   ; - ^G BEEP + PUNCH:=V24out + LIST:=V24out hinzugefuegt
   14                   ; - keine Pruefsumme, kein Vergleichslesen der RAM-Disk (entfernt)
   15                   ; - fehlerhafte Maskierung USER in WBOOT entfernt
   16                   ; - Kursorblinken im Texteditor
   17                   ; - Consolenkommandos Kursor-ON / Kursor-OFF
   18                   ; - RAM-Disk mit 64 REC/TRK, Systemspur auf 8K reduziert
   19                   ; - GIDE-Laufwerke (C:, D:, E:) auf 8MByte verkleinert
   20                   ; - Formatierung RAM-Disk: letzter Sektor wurde nicht formatiert
   21                   ; - ISR angepasst, damit HRCPM12 mit JKCEMU V0.9.8.3 funktioniert
   22                   ;
   23                   ; Neu hinzugekommen:
   24                   ; - EXIT loescht CCPPUFLEN (V.132)
   25                   ; - WBOOT loescht CCPPUFLEN, weil in Systemspur "aktiver Befehl" (V.133)
   26                   ; - Eintragen von NMI auf 066h in BOOT1 entfernt (CPM Page-Zero) (V.133)
   27                   ; - Tastaturpuffer von FFD0h -> FF00h , "d"-Befehl ueberschrieben (V.134)
   28                   ; - nicht benutzte RAM-Zellen am Ende auskommentiert (V.135)
   29                   ; - automatische Erkennung der RAM-Disk 256k/512k/1024k/2048k (V.140)
   30                   ;
   31                   ;
   32                           .CREF
   33                           .Z80
   34                   ;
   35                           .PHASE 0E600H
   36                   ;
   37                   ;
   38         07F1      OUTHL   EQU  07F1H
   39         01A5      RSA     EQU  01A5H        ;CPU-Register nach RSA - nicht Monitor 11 !
   40         05CE      REGIST  EQU  05CEH        ;Registeranzeige - nicht Monitor 11 !
   41         0DF9      MV24A   EQU  0DF9H        ;MO-UP V24-Out
   42                   ;
   43                   ;
   44         1800      CUPOS   EQU  1800H
   45         1818      BREAK   EQU  1818H        ;NMI Sprungziel
   46         181F      CBWSB   EQU  181FH        ;Merkzelle fuer das Farbbyte im AC1-Monitor 
   47                   ;                         ;0=kein Color-BWS, sonst der eingestellte Farbwert
   48         185B      ARG1    EQU  185BH
   49         185D      ARG2    EQU  185DH
   50                   ;
   51                   ;
   52         0000      WARMBT  EQU  0000H        ;WBOOT der Grundseite
   53         0005      BDOSF   EQU  0005H        ;BDOS-Aufruf + TPA-MAX
   54         0038      RST38   EQU  0038H        ;CP/M-Break
   55         0066      NMI     EQU  0066H
   56                   ;
   57                   ;
   58         0003      IOBYTE  EQU  0003H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   2
BIOS    ASM

   59         0004      LWBYTE  EQU  0004H        ;LW (Bit0-3) + USER Nr.(Bit4-7)
   60                   ;
   61         FF00      ZEIPUF  EQU  0FF00H       ;1 + 32 Byte Puffer fuer Tastatur
   62                   ;                          --> war urspruenlich auf 0FFD0H
   63                   ;                          --> ueberschreibt den "d"-Befehl
   64                   ;
   65         D806      BDOS    EQU  0D806H       ;BDOS-EinsprungAdresse
   66         E603      WBOOTB  EQU  0E603H       ;BIOS-Eisprung WBOOT
   67                   ;
   68                   ;
   69         C000      HPRDSK  EQU  0C000H       ;Hilfsprogramm: Format RAM-Disk
   70         D000      CCP     EQU  0D000H       ;Start CCP
   71         D007      COMLEN  EQU  CCP+07       ;CCP-Kommandopuffer-Laenge
   72                   ;
   73         00E0      PE0     EQU  0E0H         ;Grundadresse der RAM-Disk
   74         00F0      PF0     EQU  0F0H         ;BWS-CPLD-(Steuer)Port
   75                   ;
   76         0040      CFDC    EQU  40H          ;Hauptstatusregister FDC
   77         0041      DFDC    EQU  41H          ;Datenport FDC
   78         0043      WAIT    EQU  43H          ;IO-Adr. /WAIT Monoflop
   79         0045      LATCH   EQU  45H          ;IO-Adr. Latch 74LS175
   80                   ;
   81         000F      CUZEI   EQU  0FH          ;KursorSymbol
   82                   ;
   83                   ;******************************   Sprungverteiler   ******************************
   84                   ;
   85 E600  C3 E878             JP   BOOT
   86 E603  C3 E944             JP   WBOOT
   87 E606  C3 EA65             JP   CONST
   88 E609  C3 EA6D             JP   CONIN
   89 E60C  C3 EAE5             JP   CONOUT
   90 E60F  C3 EABC             JP   LIST
   91 E612  C3 EAD8             JP   PUNCH
   92 E615  C3 EA6D             JP   CONIN        ;eigentlich JP READER
   93 E618  C3 EE1A             JP   HOME
   94 E61B  C3 EDFB             JP   SELDSK
   95 E61E  C3 EE1D             JP   SETTRK
   96 E621  C3 EE22             JP   SETSEC
   97 E624  C3 EE27             JP   SETDMA
   98 E627  C3 EE38             JP   READ
   99 E62A  C3 EE3D             JP   WRITE
  100 E62D  C3 EDF8             JP   LISTST
  101 E630  C3 EE2C             JP   SECTRN
  102                   ;
  103 E633  43 38 35 41         DEFM 'C85AC'      ;fuer PC/BC Progr.
  104 E638  C3 E9D6             JP   EXIT         ;User-Kommando EXIT
  105 E63B  C3 F009             JP   LOAD         ;User-Kommando LOAD
  106 E63E  C3 0000             JP   0000H
  107                   ;
  108 E641  07          NDISK:  DEFB 7            ;Anzahl der LW = 7
  109                   ;
  110 E642  E644        DPHX:   DEFW DPHY         ;Zeiger auf den 1. Block?
  111 E644  E652        DPHY:   DEFW DPH0         ;DPH von LW A:
  112 E646  E662                DEFW DPH1         ;DPH von LW B:
  113 E648  E672                DEFW DPH2         ;DPH von LW C:
  114 E64A  E682                DEFW DPH3         ;DPH von LW D:
  115 E64C  E692                DEFW DPH4         ;DPH von LW E:
  116 E64E  E6A2                DEFW DPH5         ;DPH von LW F:
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   3
BIOS    ASM

  117 E650  E6B2                DEFW DPH6         ;DPH von LW G:
  118                   ;
  119 E652  0000        DPH0:   DEFW 0            ;RAM-Disk A:
  120 E654  0000                DEFW 0
  121 E656  0000                DEFW 0
  122 E658  0000                DEFW 0
  123 E65A  F862                DEFW DIRBF
  124 E65C  E6C4                DEFW DPB0
  125 E65E  0000                DEFW 0            ;weil nichtwechselbares Medium
  126 E660  F8E2                DEFW ALL00
  127                   ;
  128 E662  0000        DPH1:   DEFW 0            ;Floppy B:
  129 E664  0000                DEFW 0
  130 E666  0000                DEFW 0
  131 E668  0000                DEFW 0
  132 E66A  F862                DEFW DIRBF
  133 E66C  E6D5                DEFW DPB1
  134 E66E  FDF0                DEFW CHK01
  135 E670  F962                DEFW ALL01
  136                   ;
  137 E672  0000        DPH2:   DEFW 0            ;GIDE C:
  138 E674  0000                DEFW 0
  139 E676  0000                DEFW 0
  140 E678  0000                DEFW 0
  141 E67A  F862                DEFW DIRBF
  142 E67C  E6F1                DEFW DPB2
  143 E67E  0000                DEFW 0            ;weil nichtwechselbares Medium
  144 E680  F994                DEFW ALL02
  145                   ;
  146 E682  0000        DPH3:   DEFW 0            ;GIDE D:
  147 E684  0000                DEFW 0
  148 E686  0000                DEFW 0
  149 E688  0000                DEFW 0
  150 E68A  F862                DEFW DIRBF
  151 E68C  E70D                DEFW DPB3
  152 E68E  0000                DEFW 0            ;weil nichtwechselbares Medium
  153 E690  FB8C                DEFW ALL03
  154                   ;
  155 E692  0000        DPH4:   DEFW 0            ;GIDE E:
  156 E694  0000                DEFW 0
  157 E696  0000                DEFW 0
  158 E698  0000                DEFW 0
  159 E69A  F862                DEFW DIRBF
  160 E69C  E729                DEFW DPB4
  161 E69E  0000                DEFW 0            ;weil nichtwechselbares Medium
  162 E6A0  FC8C                DEFW ALL04
  163                   ;
  164 E6A2  0000        DPH5:   DEFW 0            ;Floppy F:
  165 E6A4  0000                DEFW 0
  166 E6A6  0000                DEFW 0
  167 E6A8  0000                DEFW 0
  168 E6AA  F862                DEFW DIRBF
  169 E6AC  E745                DEFW DPB5
  170 E6AE  FE10                DEFW CHK05
  171 E6B0  FD8C                DEFW ALL05
  172                   ;
  173 E6B2  0000        DPH6:   DEFW 0            ;Floppy G:
  174 E6B4  0000                DEFW 0
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   4
BIOS    ASM

  175 E6B6  0000                DEFW 0
  176 E6B8  0000                DEFW 0
  177 E6BA  F862                DEFW DIRBF
  178 E6BC  E761                DEFW DPB6
  179 E6BE  FE30                DEFW CHK06
  180 E6C0  FDBE                DEFW ALL06
  181                   ;
  182                   ; https://hc-ddr.hucki.net/wiki/doku.php/cpm/write_a_bios/teil_1
  183                   ;
  184                   ;RAM-Disk 256 KByte  LW A:
  185                   ;
  186 E6C2  EE64                DEFW RWRDSK       ;Routine zum Lesen/Schreiben der RAM-Disk
  187                   ;
  188 E6C4  0040        DPB0:   DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  189 E6C6  03                  DEFB 3            ;Blockgroesse = 1 Kbyte
  190 E6C7  07                  DEFB 7
  191 E6C8  00                  DEFB 0            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  192 E6C9  00F7                DEFW 247          ;248 * 1 Kbyte-Bloecke  -> 256k-8k(System)=248k(CP/M) ( - 2k(DIR) -> 246k (NETTO f. Daten))
  193 E6CB  003F                DEFW 63           ;64 DIR - Eintaege
  194 E6CD  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  195 E6CF  0000                DEFW 0            ;weil nichtwechselbares Medium
  196 E6D1  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  197                   ;
  198                   ;Floppy 780 KByte  LW B:
  199                   ;
  200 E6D3  F029                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  201                   ;
  202 E6D5  0050        DPB1:   DEFW 80           ;80 Sectoren/Track
  203 E6D7  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  204 E6D8  0F                  DEFB 15
  205 E6D9  00                  DEFB 0
  206 E6DA  0185                DEFW 389          ;390 * 2 Kbyte - Bloecke
  207 E6DC  007F                DEFW 127          ;128 DIR - Eintraege
  208 E6DE  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  209 E6E0  0020                DEFW 32
  210 E6E2  0002                DEFW 2            ;20 Kbyte System
  211                   ;
  212 E6E4  03 07 05 25         DEFB 3,7,5,25H
  213 E6E8  50 00 43 FF         DEFB 50H,0,43H,0FFH
  214 E6EC  E1 33 FF            DEFB 0E1H,33H,0FFH
  215                   ;
  216                   ;GIDE 8 MByte  LW C:
  217                   ;
  218 E6EF  F025                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  219                   ;
  220 E6F1  0800        DPB2:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  221 E6F3  05                  DEFB 5
  222 E6F4  1F                  DEFB 31           ;4k Bloecke
  223 E6F5  01                  DEFB 1            ;16-Bit Blockadressen im FCB/DIR
  224 E6F6  07BF                DEFW 1983         ;1984 * 4k-Bloecke = 7936k
  225 E6F8  07FF                DEFW 2047         ;2048 DIR-Eintraege
  226 E6FA  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke = 64 k
  227 E6FC  0000                DEFW 0            ;weil nichtwechselbares Medium
  228 E6FE  0001                DEFW 1            ;1 Trk = 256k System
  229                   ;
  230 E700  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  231 E703  000A                DEFW 000AH        ;10 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  232 E705  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   5
BIOS    ASM

  233 E707  03D8                DEFW 03D8H        ;984 Zylinder HDD
  234 E709  10                  DEFB 10H          ;16 Koepfe HDD
  235 E70A  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  236                   ;
  237                   ;GIDE 8 MByte  LW D:
  238                   ;
  239 E70B  F025                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  240                   ;
  241 E70D  0800        DPB3:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  242 E70F  06                  DEFB 6
  243 E710  3F                  DEFB 63           ;8k Bloecke
  244 E711  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  245 E712  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  246 E714  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  247 E716  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  248 E718  0000                DEFW 0            ;weil nichtwechselbares Medium
  249 E71A  0000                DEFW 0            ;kein System-Track
  250                   ;
  251 E71C  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  252 E71F  0096                DEFW 0096H        ;150 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  253 E721  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  254 E723  03D8                DEFW 03D8H        ;984 Zylinder HDD
  255 E725  10                  DEFB 10H          ;16 Koepfe HDD
  256 E726  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  257                   ;
  258                   ;GIDE 8 MByte  LW E:
  259                   ;
  260 E727  F025                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  261                   ;
  262 E729  0800        DPB4:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  263 E72B  06                  DEFB 6
  264 E72C  3F                  DEFB 63           ;8k Bloecke
  265 E72D  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  266 E72E  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  267 E730  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  268 E732  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  269 E734  0000                DEFW 0            ;weil nichtwechselbares Medium
  270 E736  0000                DEFW 0            ;kein System-Track
  271                   ;
  272 E738  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  273 E73B  012C                DEFW 012CH        ;300 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  274 E73D  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  275 E73F  03D8                DEFW 03D8H        ;984 Zylinder HDD
  276 E741  10                  DEFB 10H          ;16 Koepfe HDD
  277 E742  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  278                   ;
  279                   ;Floppy 640 KByte  LW F:
  280                   ;
  281 E743  F029                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  282                   ;
  283 E745  0040        DPB5:   DEFW 64           ;64 Sectoren/Track
  284 E747  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  285 E748  0F                  DEFB 15
  286 E749  00                  DEFB 0
  287 E74A  013F                DEFW 319          ;320 * 2 Kbyte - Bloecke
  288 E74C  007F                DEFW 127          ;128 DIR - Eintraege
  289 E74E  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  290 E750  0020                DEFW 32
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   6
BIOS    ASM

  291 E752  0000                DEFW 0            ;kein System-Track
  292                   ;
  293 E754  01 01 10 14         DEFB 1,1,10H,14H
  294 E758  50 00 43 FF         DEFB 50H,0,43H,0FFH
  295 E75C  E1 33 FF            DEFB 0E1H,33H,0FFH
  296                   ;
  297                   ;Floppy 800 KByte  LW G:
  298                   ;
  299 E75F  F029                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  300                   ;
  301 E761  0050        DPB6:   DEFW 80           ;80 Sectoren/Track
  302 E763  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  303 E764  0F                  DEFB 15
  304 E765  00                  DEFB 0
  305 E766  018F                DEFW 399          ;400 * 2 Kbyte - Bloecke
  306 E768  007F                DEFW 127          ;128 DIR - Eintraege
  307 E76A  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  308 E76C  0020                DEFW 32
  309 E76E  0000                DEFW 0            ;kein System-Track
  310                   ;
  311 E770  03 07 05 25         DEFB 3,7,5,25H
  312 E774  50 01 43 FF         DEFB 50H,1,43H,0FFH
  313 E778  E1 33 FF            DEFB 0E1H,33H,0FFH
  314                   ;
  315                   ;RAM-Disk 512 KByte  LW A:
  316 E77B  0040        DP512:  DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  317 E77D  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  318 E77E  0F                  DEFB 15
  319 E77F  01                  DEFB 1            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  320 E780  00FB                DEFW 251          ;252 * 2 Kbyte-Bloecke  -> 512k-8k(System)=504k(CP/M) ( - 2k(DIR) -> 502k (NETTO f. Daten))
  321 E782  003F                DEFW 63           ;64 DIR - Eintaege
  322 E784  0080                DEFW 080H         ;1 DIR-Block
  323 E786  0000                DEFW 0            ;weil nichtwechselbares Medium
  324 E788  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  325                   ;
  326                   ;RAM-Disk 1024 KByte  LW A:
  327 E78A  0040        DP1024: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  328 E78C  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  329 E78D  0F                  DEFB 15
  330 E78E  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  331 E78F  01FB                DEFW 507          ;508 * 2 Kbyte-Bloecke  -> 1024k-8k(System)=1016k(CP/M) ( - 4k(DIR) -> 1012k (NETTO f. Daten))
  332 E791  007F                DEFW 127          ;128 DIR - Eintraege -> bei 64 DIR-Eintraegen bekommt man die RAM-Disk nicht voll
  333 E793  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  334 E795  0000                DEFW 0            ;weil nichtwechselbares Medium
  335 E797  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  336                   ;
  337                   ;RAM-Disk 2048 KByte  LW A:
  338 E799  0040        DP2048: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  339 E79B  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  340 E79C  0F                  DEFB 15
  341 E79D  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  342 E79E  03FB                DEFW 1019         ;1020 * 2 Kbyte-Bloecke  -> 2048k-8k(System)=2040k(CP/M) ( - 8k(DIR) -> 2032k (NETTO f. Daten))
  343 E7A0  00FF                DEFW 255          ;256 DIR - Eintraege
  344 E7A2  00F0                DEFW 0F0H         ;4 DIR-Bloecke
  345 E7A4  0000                DEFW 0            ;weil nichtwechselbares Medium
  346 E7A6  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  347                   ;
  348 E7A8  0C          TXT01:  DEFB 0CH
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   7
BIOS    ASM

  349 E7A9  48 52 43 50         DEFM "HRCPM AC1 V1.2 CPA "
  350 E7BC  31 31 2E 30         DEFM "11.01.89 FA-MODE "
  351 E7CD  76 6F 6D 20         DEFM "vom 23.01.2024 V.141"
  352 E7E1  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  353 E7E5  47 49 44 45         DEFM "GIDE(80H) C0:8MB,"
  354 E7F6  20 20 20 44         DEFM "   D0: 8MB   E0: 8MB"
  355 E80A  0D 0A               DEFB 0DH,0AH
  356 E80C  46 44 43 20         DEFM "FDC (45H) B0:5*1024"   ;B0 --> Floppy-Drive 0,
  357 E81F  20 46 30 3A         DEFM " F0:16*256 G1:5*1024"  ;F0 --> Floppy-Drive 0, G1 --> Floppy-Drive 1
  358 E833  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  359 E837  52 46 4C 20         DEFM "RFL Praeci.Port E0H"
  360 E84A  20 41 3A 20         DEFM " A: "
  361 E84E  00                  DEFB 0
  362 E84F  32 35 36 6B TXT01A: DEFM "256k"
  363 E853  00                  DEFB 0
  364 E854  35 31 32 6B TXT01B: DEFM "512k"
  365 E858  00                  DEFB 0
  366 E859  31 30 32 34 TXT01C: DEFM "1024k"
  367 E85E  00                  DEFB 0
  368 E85F  32 30 34 38 TXT01D: DEFM "2048k"
  369 E864  00                  DEFB 0
  370 E865  20 2D 2D 3E TXT02:  DEFM " --> Format A:(J)?"
  371 E877  00                  DEFB 0
  372                   ;
  373                   ;******************************   BOOT   ******************************
  374                   ;
  375 E878  F3          BOOT:   DI
  376 E879  31 F41A             LD   SP,CPMSTK
  377 E87C  AF                  XOR  A
  378 E87D  D3 1E               OUT  (P1E),A      ;zwingend AC1-Mode !!
  379 E87F  32 F43D             LD   (LATPU),A    ;FDC-Latch zuruecksetzen
  380 E882  CD EDC2             CALL BWSINI
  381 E885  DB 05               IN   A,(P05)
  382 E887  CB 9F               RES  3,A          ;BildInvers (PIO1B) Bit3 aus
  383 E889  D3 05               OUT  (P05),A
  384 E88B  2A 1818             LD   HL,(BREAK)   ;Sprungtabelle NMI Monitor
  385 E88E  22 F429             LD   (OLDNMI),HL  ;sichern
  386 E891  21 E603             LD   HL,WBOOTB    ;CP/M-Warmstart-Einsprungadresse
  387 E894  22 1818             LD   (BREAK),HL
  388 E897  CD E9CB             CALL CPMMOD
  389 E89A  AF                  XOR  A
  390 E89B  32 F45D             LD   (DF51A),A
  391 E89E  32 0003             LD   (IOBYTE),A
  392 E8A1  32 0004             LD   (LWBYTE),A
  393 E8A4  32 FF00             LD   (ZEIPUF),A   ;Init. Tastaturpuffer
  394 E8A7  CD E9A7             CALL BOOT1        ;CP/M "Grundseite" INIT
  395                   ;
  396 E8AA  3E 03               LD   A,03H        ;CTC init. + Interrupt abgeschaltet
  397 E8AC  D3 00               OUT  (P00),A
  398 E8AE  D3 01               OUT  (P01),A
  399 E8B0  D3 02               OUT  (P02),A
  400 E8B2  D3 03               OUT  (P03),A
  401 E8B4  3E FF               LD   A,0FFH       ;HWT vom Interruptvektor 0FF80h ff.
  402 E8B6  ED 47               LD   I,A
  403 E8B8  ED 5E               IM   2            ;Interrupt freigeben
  404 E8BA  21 F315             LD   HL,INTEND    ;Adresse Einsprungpunkt fuer nicht verwendete Interrupts
  405 E8BD  22 FF80             LD   (DFF80),HL   ;Prog. Einsprung IV fuer CTC-Kanal 0
  406 E8C0  22 FF82             LD   (DFF82),HL   ;Prog. Einsprung IV fuer CTC-Kanal 1
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   8
BIOS    ASM

  407 E8C3  22 FF84             LD   (DFF84),HL   ;Prog. Einsprung IV fuer CTC-Kanal 2
  408 E8C6  21 F2FA             LD   HL,ISRCTC    ;Einsprungpunkt CTC-Interrupt - Steuerung Nachlauf Floppy-LW
  409 E8C9  22 FF86             LD   (DFF86),HL   ;Prog. Einsprung IV fuer CTC-Kanal 3
  410 E8CC  3E 80               LD   A,80H
  411 E8CE  D3 00               OUT  (P00),A      ;CTC-Interruptadresse NWT (= 80h) eintragen
  412 E8D0  3E FF               LD   A,0FFH
  413 E8D2  32 F43C             LD   (CTCCNT),A   ;Init. CTC-Counter = 255 --> Zusatzzaehler fuer CTC-Interrupt
  414 E8D5  3E A7               LD   A,0A7H
  415 E8D7  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 als Zeitgeber mit Interrupt, Vorteiler 256
  416 E8D9  AF                  XOR  A
  417 E8DA  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 - Hauptteiler = 256
  418                                             ;d.h. bei 2 MHz CPU-Takt wird alle 33ms ein CTC-Interrupt ausgeloest
  419                   ;
  420 E8DC  21 E9FB             LD   HL,ISRTAS    ;1. Einsprungpunkt PIO-Interrupt --> Taste in Tastaturpuffer schreiben
  421 E8DF  22 FF88             LD   (DFF88),HL   ;auf 0FF88h eintragen
  422 E8E2  01 0506             LD   BC,0506H     ;5 Bytes auf Controlkanal PIO1 A
  423 E8E5  21 EA50             LD   HL,PIOTAB
  424 E8E8  ED B3               OTIR              ;PIO1_A Init. fuer 1. Einsprungpunkt
  425                   ;
  426 E8EA  21 E7A8             LD   HL,TXT01     ;Begruessungstext
  427 E8ED  CD EA55             CALL OUTTXT
  428                   ;
  429 E8F0  CD EEBF             CALL RDTEST       ;Kapazitaet der RAM-Disk bestimmen
  430 E8F3  21 EF1F             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
  431 E8F6  7E                  LD   A,(HL)
  432 E8F7  21 E799             LD   HL,DP2048    ;DPB 2048K RAM-Disk
  433 E8FA  FE 03               CP   3
  434 E8FC  28 10               JR   Z,BOOT2
  435 E8FE  21 E78A             LD   HL,DP1024    ;DPB 1024K RAM-Disk
  436 E901  FE 02               CP   2
  437 E903  28 09               JR   Z,BOOT2
  438 E905  21 E77B             LD   HL,DP512     ;DPB 512K RAM-Disk
  439 E908  FE 01               CP   1
  440 E90A  28 02               JR   Z,BOOT2
  441 E90C  18 08               JR   BOOT3        ;256K RAM-Disk, nichts kopieren
  442                   ;        
  443 E90E  11 E6C4     BOOT2:  LD   DE,DPB0
  444 E911  01 000F             LD   BC,15
  445 E914  ED B0               LDIR
  446 E916  21 E85F     BOOT3:  LD   HL,TXT01D    ;2048k
  447 E919  FE 03               CP   3
  448 E91B  28 11               JR   Z,BOOT4
  449 E91D  21 E859             LD   HL,TXT01C    ;1024k
  450 E920  FE 02               CP   2
  451 E922  28 0A               JR   Z,BOOT4
  452 E924  21 E854             LD   HL,TXT01B    ;512k
  453 E927  FE 01               CP   1
  454 E929  28 03               JR   Z,BOOT4
  455 E92B  21 E84F             LD   HL,TXT01A    ;256k
  456 E92E  CD EA55     BOOT4:  CALL OUTTXT
  457 E931  21 E865             LD   HL,TXT02     ;Formatieren? (J)
  458 E934  CD EA55             CALL OUTTXT
  459 E937  FB                  EI
  460 E938  CD EA6D             CALL CONIN
  461 E93B  CB AF               RES  5,A          ;Upcase
  462 E93D  FE 4A               CP   4AH          ;J --> RAM-Disk formatieren
  463 E93F  CC EF20             CALL Z,RDFORM
  464                   ;       LD   HL,8000H     ;POWER.COM nach 100h kopieren
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   9
BIOS    ASM

  465                   ;       LD   DE,0100H
  466                   ;       LD   BC,4000H
  467                   ;       LDIR
  468 E942  18 22               JR   WBOOT1
  469                   ;
  470                   ;******************************   WBOOT   ******************************
  471                   ;
  472 E944  31 F41A     WBOOT:  LD   SP,CPMSTK
  473 E947  CD E9CB             CALL CPMMOD
  474 E94A  3A F45E             LD   A,(DF51B)
  475 E94D  B7                  OR   A
  476 E94E  C4 F0DE             CALL NZ,LF0CE
  477 E951  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
  478 E953  21 EE38             LD   HL,READ
  479 E956  22 EFB1             LD   (WRCCP2),HL
  480 E959  CD EF97             CALL WRCCP        ;wirklich READCCP !
  481 E95C  21 EE3D             LD   HL,WRITE
  482 E95F  22 EFB1             LD   (WRCCP2),HL
  483 E962  AF                  XOR  A
  484 E963  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  485                   ;
  486 E966  CD E9A7     WBOOT1: CALL BOOT1        ;CP/M "Grundseite" INIT
  487 E969  3E 01               LD   A,01H        ;Kursor einschalten
  488 E96B  32 F420             LD   (CUFLAG),A
  489 E96E  3A F41D             LD   A,(COLO2)
  490 E971  32 F41B             LD   (COLOR),A    ;Arbeitszelle Farbbyte
  491 E974  E6 77               AND  77H          ;Intensivdarstellung maskieren
  492 E976  32 F41C             LD   (COLO1),A    ;Arbeitszelle "Normaldarstellung"
  493 E979  3A 0004             LD   A,(LWBYTE)
  494 E97C  4F                  LD   C,A
  495 E97D  CD EDFB             CALL SELDSK
  496 E980  C3 D000             JP   CCP          ;JP CCP
  497                   ;
  498                   ;
  499 E983  F5          CPMERR: PUSH AF           ;CP/M-Fehler - zurueck z. Monitor
  500 E984  E5                  PUSH HL
  501 E985  CD E9DA             CALL EXIT1
  502 E988  DF                  RST  18H
  503 E989  0D                  DEFB 0DH
  504 E98A  43 50 2F 4D         DEFM "CP/M-Fehler:"
  505 E996  A0                  DEFB 20H+80H
  506 E997  E1                  POP  HL
  507 E998  F1                  POP  AF
  508 E999  CD 01A5             CALL RSA          ;CPU-Register nach RSA - nicht Monitor 11 !
  509 E99C  E1                  POP  HL
  510 E99D  2B                  DEC  HL
  511 E99E  CD 07F1             CALL OUTHL
  512 E9A1  DF                  RST  18H
  513 E9A2  8D                  DEFB 0DH+80H
  514 E9A3  CD 05CE             CALL REGIST       ;Monitor - Registeranzeige - nicht Monitor 11 !
  515 E9A6  FF                  RST  38H          ;zurueck zum Monitor
  516                   ;
  517                   ;
  518 E9A7  3E C3       BOOT1:  LD   A,0C3H       ;CP/M "Grundseite" INIT
  519 E9A9  32 0000             LD   (WARMBT),A
  520 E9AC  32 0005             LD   (BDOSF),A
  521 E9AF  32 0038             LD   (RST38),A
  522 E9B2  21 E603             LD   HL,WBOOTB
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  10
BIOS    ASM

  523 E9B5  22 0001             LD   (WARMBT+1),HL
  524 E9B8  21 D806             LD   HL,BDOS
  525 E9BB  22 0006             LD   (BDOSF+1),HL
  526 E9BE  21 E983             LD   HL,CPMERR
  527 E9C1  22 0039             LD   (RST38+1),HL
  528 E9C4  21 0080             LD   HL,0080H
  529 E9C7  22 F444             LD   (DMA),HL
  530 E9CA  C9                  RET
  531                   ;
  532                   ;******************************   Ende BOOT / WBOOT   ******************************
  533                   ;
  534 E9CB  F5          CPMMOD: PUSH AF           ;CP/M EIN
  535 E9CC  3E 01               LD   A,01H
  536 E9CE  18 02               JR   MOD1
  537                   ;
  538 E9D0  F5          AC1MOD: PUSH AF           ;CP/M AUS (AC1-Mode)
  539 E9D1  AF                  XOR  A
  540 E9D2  D3 1E       MOD1:   OUT  (P1E),A
  541 E9D4  F1                  POP  AF
  542 E9D5  C9                  RET
  543                   ;
  544                   ;--------------------------------------------------------------------------
  545                   ;
  546                   ;EXIT - Routine
  547                   ;
  548 E9D6  21 0000     EXIT:   LD   HL,0000H     ;Ruecksprungadresse fuer RET
  549 E9D9  E5                  PUSH HL
  550 E9DA  AF          EXIT1:  XOR  A            ;Einsprung aus CPMERR
  551 E9DB  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  552 E9DE  D3 1E               OUT  (P1E),A      ;AC1-Mode
  553 E9E0  2A F429             LD   HL,(OLDNMI)
  554 E9E3  22 1818             LD   (BREAK),HL   ;alten NMI wiederherstellen
  555 E9E6  3E 03               LD   A,03H
  556 E9E8  D3 00               OUT  (P00),A      ;CTC: Interrupts ausschalten
  557 E9EA  D3 01               OUT  (P01),A
  558 E9EC  D3 02               OUT  (P02),A
  559 E9EE  D3 03               OUT  (P03),A
  560 E9F0  D3 06               OUT  (P06),A      ;PIO1 A: Interrupt auschalten
  561 E9F2  3E CF               LD   A,0CFH
  562 E9F4  D3 06               OUT  (P06),A      ;PIO1 A: "Mode 3" + "Set Mode"
  563 E9F6  3E FF               LD   A,0FFH
  564 E9F8  D3 06               OUT  (P06),A      ;PIO1 A: PA0 bis PA7 sind Eingaenge
  565 E9FA  C9                  RET               ;zurueck zum Monitor
  566                   ;
  567                   ;
  568                   ;Interrupt-Einsprung fuer die Tastatur
  569                   ;
  570 E9FB  F3          ISRTAS: DI
  571 E9FC  F5                  PUSH AF
  572 E9FD  C5                  PUSH BC
  573 E9FE  E5                  PUSH HL
  574 E9FF  DB 04               IN   A,(P04)      ;PIO_A abfragen
  575 EA01  CB 7F               BIT  7,A          ;Taste gedrueckt?
  576 EA03  28 45               JR   Z,ISREND     ;nein, ISR beenden
  577 EA05  4F                  LD   C,A
  578                   ;
  579 EA06  06 1E               LD   B,1EH        ;Tastaturentprellung
  580 EA08  DB 04       PRELL1: IN   A,(P04)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  11
BIOS    ASM

  581 EA0A  B9                  CP   C
  582 EA0B  20 3D               JR   NZ,ISREND
  583 EA0D  10 F9               DJNZ PRELL1       ;30 Durchlaeufe
  584                   ;
  585 EA0F  FE 80               CP   80H
  586 EA11  28 37               JR   Z,ISREND     ;das war eine NULL-Eingabe
  587                   ;
  588 EA13  4F                  LD   C,A
  589 EA14  21 FF00             LD   HL,ZEIPUF
  590 EA17  7E                  LD   A,(HL)       ;Fuellstand Zeichenpuffer
  591 EA18  3C                  INC  A
  592 EA19  FE 1F               CP   1FH          ;Puffer voll?
  593 EA1B  28 2D               JR   Z,ISREND
  594 EA1D  77                  LD   (HL),A       ;Anzahl der Zeichen rueckschreiben
  595 EA1E  C5                  PUSH BC
  596 EA1F  06 00               LD   B,0
  597 EA21  4F                  LD   C,A
  598 EA22  09                  ADD  HL,BC        ;HL = Position im Zeichenpuffer
  599 EA23  C1                  POP  BC
  600 EA24  CB B9               RES  7,C          ;7. Bit loeschen und
  601 EA26  71                  LD   (HL),C       ;Taste in Zeichenpuffer eintragen
  602                   ;
  603                   ;       LD   BC,8034H     ;Initialisierung Tastenpiep --> 2 MHz
  604 EA27  01 8068             LD   BC,8068H     ;Initialisierung Tastenpiep --> 4 MHz
  605 EA2A  79          BEEP1:  LD   A,C
  606 EA2B  3D          BEEP2:  DEC  A
  607 EA2C  20 FD               JR   NZ,BEEP2
  608 EA2E  DB 05               IN   A,(P05)      ;PIO_B-Daten
  609 EA30  EE 01               XOR  01H          ;Tastenpiep
  610 EA32  D3 05               OUT  (P05),A
  611 EA34  10 F4               DJNZ BEEP1
  612 EA36  E6 FE               AND  0FEH
  613 EA38  D3 05               OUT  (P05),A
  614                   ;
  615 EA3A  01 0200             LD   BC,0200H     ;Tastaturentprellung
  616 EA3D  0B          PRELL2: DEC  BC
  617 EA3E  78                  LD   A,B
  618 EA3F  B1                  OR   C
  619 EA40  20 FB               JR   NZ,PRELL2
  620                   ;
  621 EA42  3E B7               LD   A,0B7H       ;weitere Interrupts loeschen
  622 EA44  D3 06               OUT  (P06),A
  623 EA46  3E 7F               LD   A,7FH
  624 EA48  D3 06               OUT  (P06),A
  625                   ;
  626 EA4A  E1          ISREND: POP  HL
  627 EA4B  C1                  POP  BC
  628 EA4C  F1                  POP  AF
  629 EA4D  FB                  EI
  630 EA4E  ED 4D               RETI
  631                   ;
  632 EA50  88 CF FF B7 PIOTAB: DEFB 88H,0CFH,0FFH,0B7H,7FH  ;PIO 1A: Init.-Tabelle
  633                   ;  88H --> NWT Interruptvektor --> 0FF88H
  634                   ; 0CFH --> "Mode 3" + "Set Mode" (kein Handshaking, next Byte = I/O-Zuordnung)
  635                   ; 0FFH --> PA0 bis PA7 sind Eingaenge
  636                   ; 0B7H --> Setting Interrupt Control Word --> mit nachfolgender Maskierung
  637                   ;  7FH --> Bit7=L --> nur PA7 erzeugt Interrupts
  638                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  12
BIOS    ASM

  639 EA55  C5          OUTTXT: PUSH BC
  640 EA56  F5                  PUSH AF
  641 EA57  4E          TEXT1:  LD   C,(HL)
  642 EA58  79                  LD   A,C
  643 EA59  B7                  OR   A
  644 EA5A  28 06               JR   Z,TEXT2
  645 EA5C  CD EAE5             CALL CONOUT
  646 EA5F  23                  INC  HL
  647 EA60  18 F5               JR   TEXT1
  648 EA62  F1          TEXT2:  POP  AF
  649 EA63  C1                  POP  BC
  650 EA64  C9                  RET
  651                   ;
  652                   ;******************************   CONST   ******************************
  653                   ;
  654 EA65  3A FF00     CONST:  LD   A,(ZEIPUF)
  655 EA68  B7                  OR   A
  656 EA69  C8                  RET  Z
  657 EA6A  3E FF               LD   A,0FFH
  658 EA6C  C9                  RET
  659                   ;
  660                   ;******************************   CONIN   ******************************
  661                   ;
  662 EA6D  F3          CONIN:  DI
  663 EA6E  ED 73 F425          LD   (SPCIN),SP
  664 EA72  31 F3CB             LD   SP,CINSP
  665 EA75  C5                  PUSH BC
  666 EA76  D5                  PUSH DE
  667 EA77  E5                  PUSH HL
  668 EA78  01 017F             LD   BC,017FH     ;Kursor-Blinker ruecksetzen
  669 EA7B  AF          CONIN1: XOR  A
  670 EA7C  F3                  DI
  671 EA7D  2A FF00             LD   HL,(ZEIPUF)  ;L = Anz. der Zeichen, H = 1. Zeichen
  672 EA80  B5                  OR   L
  673 EA81  20 20               JR   NZ,CONIN3    ;Zeichen im Tastaturpuffer vorhanden
  674 EA83  FB                  EI
  675 EA84  10 F5               DJNZ CONIN1       ;256*LOOP: warte auf ein Zeichen
  676 EA86  3A F420             LD   A,(CUFLAG)
  677 EA89  B7                  OR   A
  678 EA8A  28 EF               JR   Z,CONIN1     ;kein "Kursor-Blinken"
  679 EA8C  F3                  DI
  680 EA8D  CD E9D0             CALL AC1MOD       ;AC1 Mode
  681 EA90  2A 1800             LD   HL,(CUPOS)
  682 EA93  0C                  INC  C
  683 EA94  CB 79               BIT  7,C          ;hier wird die Cursor-Blinkfrequenz festgelegt
  684 EA96  3A F424             LD   A,(CHAR)     ;bisheriges Zeichen auf der Kursorposition
  685 EA99  28 02               JR   Z,CONIN2
  686 EA9B  3E 0F               LD   A,CUZEI      ;Kursor = 0FH
  687 EA9D  77          CONIN2: LD   (HL),A       ;"Kursor-Blinken" - Bildschirm-Ausgabe
  688 EA9E  CD E9CB             CALL CPMMOD       ;CP/M Mode
  689 EAA1  18 D8               JR   CONIN1
  690                   ;
  691 EAA3  3D          CONIN3: DEC  A            ;DEC Anzahl_der_Zeichen_im_Tastaturpuffer
  692 EAA4  32 FF00             LD   (ZEIPUF),A
  693 EAA7  7C                  LD   A,H          ;1. Zeichen aus dem Tastaturpuffer --> A
  694 EAA8  21 FF02             LD   HL,ZEIPUF+2
  695 EAAB  11 FF01             LD   DE,ZEIPUF+1
  696 EAAE  01 001F             LD   BC,001FH
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  13
BIOS    ASM

  697 EAB1  ED B0               LDIR              ;alle Zeichen im Puffer ruecken 1 Pos. n. links
  698 EAB3  E1                  POP  HL
  699 EAB4  D1                  POP  DE
  700 EAB5  C1                  POP  BC
  701 EAB6  ED 7B F425          LD   SP,(SPCIN)
  702 EABA  FB                  EI
  703 EABB  C9                  RET
  704                   ;
  705                   ;******************************   LIST   ******************************
  706                   ;
  707 EABC  F3          LIST:   DI
  708 EABD  CD E9D0             CALL AC1MOD
  709 EAC0  F5                  PUSH AF      
  710 EAC1  79                  LD   A,C
  711 EAC2  FE 0A               CP   0AH  
  712 EAC4  28 0C               JR   Z,LIST1  
  713 EAC6  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  714 EAC9  FE 0D               CP   0DH     
  715 EACB  20 05               JR   NZ,LIST1 
  716 EACD  3E 0A               LD   A,0AH   
  717 EACF  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  718 EAD2  F1          LIST1:  POP  AF      
  719 EAD3  CD E9CB             CALL CPMMOD
  720 EAD6  FB                  EI
  721 EAD7  C9                  RET
  722                   ;
  723                   ;******************************   PUNCH   ******************************
  724                   ;
  725 EAD8  F3          PUNCH:  DI                ;Ausgabe C nach V24
  726 EAD9  79                  LD   A,C
  727 EADA  CD E9D0             CALL AC1MOD
  728 EADD  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  729 EAE0  CD E9CB             CALL CPMMOD
  730 EAE3  FB                  EI
  731 EAE4  C9                  RET
  732                   ;
  733                   ;******************************   CONOUT   ******************************
  734                   ;
  735                   ;       Ausgabe eines Zeichens,   IN: Zeichen in C
  736                   ;
  737 EAE5  F3          CONOUT: DI
  738 EAE6  ED 73 F427          LD   (SPCOUT),SP  ;Stack bei MON-Aufruf retten
  739 EAEA  31 F3F1             LD   SP,COUTSP
  740 EAED  F5                  PUSH AF
  741 EAEE  C5                  PUSH BC
  742 EAEF  D5                  PUSH DE
  743 EAF0  E5                  PUSH HL
  744 EAF1  CD E9D0             CALL AC1MOD
  745 EAF4  E5                  PUSH HL
  746 EAF5  2A 1800             LD   HL,(CUPOS)   ;Cursorposition
  747 EAF8  3A F424             LD   A,(CHAR)
  748 EAFB  77                  LD   (HL),A       ;altes Zeichen auf Position
  749 EAFC  3A F421             LD   A,(STZ00)    ;Durchlauf bei Steuerzeichen?
  750 EAFF  A7                  AND  A
  751 EB00  C2 ED30             JP   NZ,KONV10    ;NZ= Steuerzeichen 2. oder 3. Durchlauf
  752 EB03  79                  LD   A,C          ;Byte
  753 EB04  FE 20               CP   20H          ;kleinstes Zeichen
  754 EB06  38 26               JR   C,KONVTB
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  14
BIOS    ASM

  755 EB08  FE 7F               CP   7FH          ;groesstes Zeichen
  756 EB0A  30 22               JR   NC,KONVTB
  757 EB0C  2A 1800             LD   HL,(CUPOS)
  758 EB0F  C3 EC6D             JP   CCHAR        ;Ausgabe einzelnes Zeichen
  759                   ;
  760 EB12  2A 1800     KONVT9: LD   HL,(CUPOS)
  761 EB15  7E                  LD   A,(HL)
  762 EB16  32 F424             LD   (CHAR),A
  763 EB19  3A F420             LD   A,(CUFLAG)
  764 EB1C  B7                  OR   A
  765 EB1D  28 02               JR   Z,COEN1      ;Kursor nicht darstellen
  766 EB1F  36 0F               LD   (HL),CUZEI
  767 EB21  CD E9CB     COEN1:  CALL CPMMOD
  768 EB24  E1                  POP  HL
  769 EB25  D1                  POP  DE
  770 EB26  C1                  POP  BC
  771 EB27  F1                  POP  AF
  772 EB28  ED 7B F427          LD   SP,(SPCOUT)
  773 EB2C  FB                  EI
  774 EB2D  C9                  RET
  775                   ;
  776                   ;Verzweigung bei Steuerzeichen
  777                   ;INPUT:  A=Zeichen
  778                   ;
  779 EB2E  FE 1B       KONVTB: CP   1BH          ;ESC ?
  780 EB30  20 07               JR   NZ,KONVT1
  781 EB32  3E 02               LD   A,02H        ;wenn ja
  782 EB34  32 F421             LD   (STZ00),A    ;Zeiger auf 2
  783 EB37  18 D9               JR   KONVT9       ;nichts ausgeben
  784                   ;
  785 EB39  2A 1800     KONVT1: LD   HL,(CUPOS)
  786 EB3C  FE 01               CP   01H          ;^A Cursor home                      
  787 EB3E  28 5B               JR   Z,CHOME                                             
  788 EB40  FE 07               CP   07H          ;^G akustisches Signal                                                 
  789 EB42  CA ECBF             JP   Z,MBEEP                                              
  790 EB45  FE 08               CP   08H          ;^H Cursor links                     
  791 EB47  CA EBC3             JP   Z,CLEFT                                             
  792 EB4A  FE 0A               CP   0AH          ;^J Zeilenvorschub                   
  793 EB4C  CA EBC7             JP   Z,CLF                                               
  794 EB4F  FE 0C               CP   0CH          ;^L CLS                              
  795 EB51  28 51               JR   Z,BCLS                                              
  796 EB53  FE 0D               CP   0DH          ;^M Wagenruecklauf                   
  797 EB55  CA EBDF             JP   Z,CCRET                                             
  798 EB58  FE 14               CP   14H          ;^T BS ab Cursor loeschen            
  799 EB5A  CA EBE6             JP   Z,CBLOE                                             
  800 EB5D  FE 15               CP   15H          ;^U Cursor nach rechts               
  801 EB5F  CA EC09             JP   Z,CRIGH                                             
  802 EB62  FE 16               CP   16H          ;^V Zeile ab Cursor loeschen         
  803 EB64  CA EC0D             JP   Z,CZLOE                                             
  804 EB67  FE 18               CP   18H          ;^X Zeile ab Cursor loeschen + CR    
  805 EB69  CA EC34             JP   Z,CZLCR                                             
  806 EB6C  FE 1A               CP   1AH          ;^Z Cursor hoch                      
  807 EB6E  CA EC5D             JP   Z,CHOCH                                             
  808 EB71  FE 82               CP   82H          ;Kursor ein
  809 EB73  CA ED21             JP   Z,CUON
  810 EB76  FE 83               CP   83H          ;Kursor aus
  811 EB78  CA ED29             JP   Z,CUOFF
  812                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  15
BIOS    ASM

  813 EB7B  47                  LD   B,A          ;Zeichen merken                      
  814 EB7C  3A F41B             LD   A,(COLOR)                                         
  815 EB7F  A7                  AND  A            ;Test auf Color-BWS                  
  816 EB80  CA EB12             JP   Z,KONVT9     ;Z = monochrom  
  817 EB83  78                  LD   A,B                                                 
  818                   ;
  819 EB84  FE 84               CP   84H          ;normale Darstellung
  820 EB86  CA ECE6             JP   Z,BNORM
  821 EB89  FE 85               CP   85H          ;invers
  822 EB8B  CA ECF4             JP   Z,BINVN
  823 EB8E  FE 86               CP   86H          ;intensiv - HihgLight
  824 EB90  CA ED03             JP   Z,BINTE
  825 EB93  FE 87               CP   87H          ;intensiv + invers
  826 EB95  CA ED10             JP   Z,BIVIN
  827 EB98  C3 EB12             JP   KONVT9
  828                   ;
  829 EB9B  21 17FF     CHOME:  LD   HL,17FFH
  830 EB9E  22 1800             LD   (CUPOS),HL
  831 EBA1  C3 EB12             JP   KONVT9
  832                   ;
  833 EBA4  3E 20       BCLS:   LD   A,20H        ;0Ch  Bildschirm loeschen
  834 EBA6  CD EBD0             CALL BCL1         ;Loeschroutine
  835 EBA9  22 1800             LD   (CUPOS),HL   ;Cursorposition
  836 EBAC  3A F41B             LD   A,(COLOR)    ;Farbbyte
  837 EBAF  E6 77               AND  77H          ;Farb-BWS vorhanden?
  838 EBB1  CA EB12             JP   Z,KONVT9     ;Z = nein, dann Ende
  839 EBB4  CD EDB3             CALL BWSCOL       ;Farbspeicher ein
  840 EBB7  3A F41B             LD   A,(COLOR)
  841 EBBA  CD EBD0             CALL BCL1
  842 EBBD  CD EDB9             CALL BWSZEI       ;Farbspeicher aus
  843 EBC0  C3 EB12             JP   KONVT9
  844                   ;
  845 EBC3  23          CLEFT:  INC  HL           ;08h  Cursor links
  846 EBC4  C3 EC61             JP   CHOLI
  847                   ;
  848 EBC7  11 0040     CLF:    LD   DE,0040H     ;0Ah  Zeilenvorschub
  849 EBCA  A7                  AND  A
  850 EBCB  ED 52               SBC  HL,DE
  851 EBCD  C3 EC7E             JP   SCROL
  852                   ;
  853 EBD0  21 1000     BCL1:   LD   HL,1000H     ;Anfang BWS
  854 EBD3  77                  LD   (HL),A
  855 EBD4  54                  LD   D,H
  856 EBD5  5D                  LD   E,L
  857 EBD6  1C                  INC  E
  858 EBD7  C5                  PUSH BC
  859 EBD8  01 07FF             LD   BC,07FFH     ;Laenge BWS
  860 EBDB  ED B0               LDIR
  861 EBDD  C1                  POP  BC
  862 EBDE  C9                  RET
  863                   ;
  864 EBDF  7D          CCRET:  LD   A,L          ;0Dh  Wagenruecklauf
  865 EBE0  F6 3F               OR   3FH
  866 EBE2  6F                  LD   L,A
  867 EBE3  C3 EC7E             JP   SCROL
  868                   ;
  869 EBE6  E5          CBLOE:  PUSH HL
  870 EBE7  3E 0F               LD   A,CUZEI      ;14h  BS ab Cursor loeschen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  16
BIOS    ASM

  871 EBE9  36 20       CBLO1:  LD   (HL),20H
  872 EBEB  2B                  DEC  HL
  873 EBEC  BC                  CP   H
  874 EBED  20 FA               JR   NZ,CBLO1
  875 EBEF  E1                  POP  HL
  876 EBF0  3A F41B             LD   A,(COLOR)
  877 EBF3  47                  LD   B,A
  878 EBF4  E6 77               AND  77H
  879 EBF6  CA EB12             JP   Z,KONVT9
  880 EBF9  CD EDB3             CALL BWSCOL       ;Farbspeicher ein
  881 EBFC  3E 0F               LD   A,CUZEI
  882 EBFE  70          CBLO2:  LD   (HL),B
  883 EBFF  2B                  DEC  HL
  884 EC00  BC                  CP   H
  885 EC01  20 FB               JR   NZ,CBLO2
  886 EC03  CD EDB9             CALL BWSZEI       ;Farbspeicher aus
  887 EC06  C3 EB12             JP   KONVT9
  888                   ;
  889 EC09  2B          CRIGH:  DEC  HL           ;15h  Cursor nach rechts
  890 EC0A  C3 EC7E             JP   SCROL
  891                   ;
  892 EC0D  E5          CZLOE:  PUSH HL           ;16h  Zeile ab Cursor loeschen
  893 EC0E  7D                  LD   A,L
  894 EC0F  E6 3F               AND  3FH
  895 EC11  47                  LD   B,A
  896 EC12  04                  INC  B
  897 EC13  36 20       CZLO1:  LD   (HL),20H
  898 EC15  2B                  DEC  HL
  899 EC16  10 FB               DJNZ CZLO1
  900 EC18  E1                  POP  HL
  901 EC19  3A F41B             LD   A,(COLOR)
  902 EC1C  4F                  LD   C,A
  903 EC1D  E6 77               AND  77H
  904 EC1F  CA EB12             JP   Z,KONVT9
  905 EC22  CD EDB3             CALL BWSCOL       ;Farbspeicher ein
  906 EC25  7D                  LD   A,L
  907 EC26  E6 3F               AND  3FH
  908 EC28  47                  LD   B,A
  909 EC29  04                  INC  B
  910 EC2A  71          CZLO2:  LD   (HL),C
  911 EC2B  2B                  DEC  HL
  912 EC2C  10 FC               DJNZ CZLO2
  913 EC2E  CD EDB9             CALL BWSZEI       ;Farbspeicher aus
  914 EC31  C3 EB12             JP   KONVT9
  915                   ;
  916 EC34  E5          CZLCR:  PUSH HL           ;18h  Zeile ab Cursor loeschen + CR
  917 EC35  7D                  LD   A,L
  918 EC36  F6 3F               OR   3FH
  919 EC38  6F                  LD   L,A
  920 EC39  22 1800             LD   (CUPOS),HL
  921 EC3C  E5                  PUSH HL
  922 EC3D  06 40               LD   B,40H        ;Zeilenlaenge
  923 EC3F  36 20       CZLC1:  LD   (HL),20H
  924 EC41  2B                  DEC  HL
  925 EC42  10 FB               DJNZ CZLC1
  926 EC44  E1                  POP  HL
  927 EC45  3A F41B             LD   A,(COLOR)
  928 EC48  4F                  LD   C,A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  17
BIOS    ASM

  929 EC49  E6 77               AND  77H
  930 EC4B  CA EB12             JP   Z,KONVT9
  931 EC4E  CD EDB3             CALL BWSCOL       ;Farbspeicher ein
  932 EC51  06 40               LD   B,40H
  933 EC53  71          CZLC2:  LD   (HL),C
  934 EC54  2B                  DEC  HL
  935 EC55  10 FC               DJNZ CZLC2
  936 EC57  CD EDB9             CALL BWSZEI       ;Farbspeicher aus
  937 EC5A  C3 EB12             JP   KONVT9
  938                   ;
  939 EC5D  11 0040     CHOCH:  LD   DE,0040H     ;1Ah     Cursor hoch
  940 EC60  19                  ADD  HL,DE
  941                   ;
  942 EC61  3E 18       CHOLI:  LD   A,18H        ;Begrenzung Cursor hoch und links
  943 EC63  BC                  CP   H
  944 EC64  CA EB12             JP   Z,KONVT9
  945 EC67  22 1800             LD   (CUPOS),HL
  946 EC6A  C3 EB12             JP   KONVT9
  947                   ;
  948 EC6D  77          CCHAR:  LD   (HL),A
  949 EC6E  3A F41B             LD   A,(COLOR)
  950 EC71  4F                  LD   C,A
  951 EC72  E6 77               AND  77H
  952 EC74  28 07               JR   Z,CCHA1
  953 EC76  CD EDB3             CALL BWSCOL       ;Farbspeicher ein
  954 EC79  71                  LD   (HL),C
  955 EC7A  CD EDB9             CALL BWSZEI       ;Farbspeicher aus
  956 EC7D  2B          CCHA1:  DEC  HL
  957                   ;
  958 EC7E  22 1800     SCROL:  LD   (CUPOS),HL
  959 EC81  EB                  EX   DE,HL        ;Test ob Scrollen noetig
  960 EC82  21 0FFF             LD   HL,0FFFH
  961 EC85  A7                  AND  A
  962 EC86  ED 52               SBC  HL,DE        ;DE = akt. Cursorpos.
  963 EC88  EB                  EX   DE,HL
  964 EC89  DA EB12             JP   C,KONVT9     ;CY = nicht scrollen
  965 EC8C  3E 20               LD   A,20H        ;Leerzeichen
  966 EC8E  CD ECA8             CALL SCR11        ;Scrollen
  967 EC91  3A F41B             LD   A,(COLOR)
  968 EC94  E6 77               AND  77H
  969 EC96  CA EB12             JP   Z,KONVT9     ;Z = kein Farbspeicher
  970 EC99  CD EDB3             CALL BWSCOL       ;Farbspeicher ein
  971 EC9C  3A F41B             LD   A,(COLOR)    ;Farbbyte
  972 EC9F  CD ECA8             CALL SCR11
  973 ECA2  CD EDB9             CALL BWSZEI       ;Farbspeicher aus
  974 ECA5  C3 EB12             JP   KONVT9
  975                   ;
  976 ECA8  21 17BF     SCR11:  LD   HL,17BFH     ;Umladeroutine Scrollen
  977 ECAB  11 17FF             LD   DE,17FFH
  978 ECAE  01 07C0             LD   BC,07C0H
  979 ECB1  ED B8               LDDR
  980 ECB3  EB                  EX   DE,HL
  981 ECB4  22 1800             LD   (CUPOS),HL
  982 ECB7  23                  INC  HL
  983 ECB8  06 40               LD   B,40H        ;eine Zeilenlaenge
  984 ECBA  2D          SCR12:  DEC  L
  985 ECBB  77                  LD   (HL),A       ;Leerzeile schreiben
  986 ECBC  10 FC               DJNZ SCR12
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  18
BIOS    ASM

  987 ECBE  C9                  RET
  988                   ;
  989                   ;
  990                   ;UP 'MBEEP' (Monitor-Beep)
  991                   ;
  992 ECBF  C5          MBEEP:  PUSH BC 
  993 ECC0  06 02               LD   B,02H        ;2 Wiederholungen
  994 ECC2  C5          MBEEP1: PUSH BC 
  995                   ;       LD   BC,0040H     ;--> fuer 2 MHz
  996 ECC3  01 0080             LD   BC,0080H     ;--> fuer 4 MHz
  997 ECC6  CD ECD6             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
  998                   ;       LD   BC,0F032H    ;--> fuer 2 MHz
  999 ECC9  01 F064             LD   BC,0F064H    ;--> fuer 4 MHz
 1000 ECCC  CD ECD6             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1001 ECCF  C1                  POP  BC 
 1002 ECD0  10 F0               DJNZ MBEEP1 
 1003 ECD2  C1                  POP  BC 
 1004 ECD3  C3 EB21             JP   COEN1 
 1005                   ;
 1006                   ;
 1007                   ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1008                   ;
 1009 ECD6  F5          UPTON:  PUSH AF 
 1010 ECD7  DB 05       UPTON1: IN   A,(P05) 
 1011 ECD9  1F                  RRA 
 1012 ECDA  3F                  CCF 
 1013 ECDB  17                  RLA 
 1014 ECDC  D3 05               OUT  (P05),A 
 1015 ECDE  79                  LD   A,C 
 1016 ECDF  3D          UPTON2: DEC  A 
 1017 ECE0  20 FD               JR   NZ,UPTON2 
 1018 ECE2  10 F3               DJNZ UPTON1 
 1019 ECE4  F1                  POP  AF 
 1020 ECE5  C9                  RET 
 1021                   ;
 1022                   ;
 1023 ECE6  3A F41C     BNORM:  LD   A,(COLO1)    ;84h  normale Darstellung
 1024 ECE9  E6 77               AND  77H
 1025 ECEB  32 F41B             LD   (COLOR),A
 1026 ECEE  32 F41C             LD   (COLO1),A
 1027 ECF1  C3 EB12             JP   KONVT9
 1028                   ;
 1029 ECF4  3A F41C     BINVN:  LD   A,(COLO1)    ;85h  invers EIN
 1030 ECF7  E6 77               AND  77H
 1031 ECF9  0F                  RRCA
 1032 ECFA  0F                  RRCA
 1033 ECFB  0F                  RRCA
 1034 ECFC  0F                  RRCA
 1035 ECFD  32 F41B             LD   (COLOR),A
 1036 ED00  C3 EB12             JP   KONVT9
 1037                   ;
 1038 ED03  3A F41C     BINTE:  LD   A,(COLO1)    ;86h  intensiv EIN
 1039 ED06  E6 77               AND  77H
 1040 ED08  F6 08               OR   08H
 1041 ED0A  32 F41B             LD   (COLOR),A
 1042 ED0D  C3 EB12             JP   KONVT9
 1043                   ;
 1044 ED10  3A F41B     BIVIN:  LD   A,(COLOR)    ;87h  intensiv + invers
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  19
BIOS    ASM

 1045 ED13  E6 77               AND  77H
 1046 ED15  F6 08               OR   08H
 1047 ED17  0F                  RRCA
 1048 ED18  0F                  RRCA
 1049 ED19  0F                  RRCA
 1050 ED1A  0F                  RRCA
 1051 ED1B  32 F41B             LD   (COLOR),A
 1052 ED1E  C3 EB12             JP   KONVT9
 1053                   ;
 1054 ED21  3E 01       CUON:   LD   A,01H        ;82h Cursor EIN
 1055 ED23  32 F420             LD   (CUFLAG),A
 1056 ED26  C3 EB12             JP   KONVT9
 1057                   ;
 1058 ED29  AF          CUOFF:  XOR  A            ;83h Cursor AUS
 1059 ED2A  32 F420             LD   (CUFLAG),A
 1060 ED2D  C3 EB12             JP   KONVT9
 1061                   ;
 1062                   ; Behandlung ESC-Sequenzen
 1063                   ;
 1064                   ; Input: ESC + 2 Steuerzeichen
 1065                   ; wenn 1. Zeichen > 80h dann Cursorposition
 1066                   ; sonst Auswertung Farbe / Grafikzeichen
 1067                   ; (stz00) = Zaehler fuer Zeichenanzahl
 1068                   ;
 1069 ED30  3A F421     KONV10: LD   A,(STZ00)
 1070 ED33  FE 02               CP   02H          ;2 = 1. Steuerzeichen (Zeile)
 1071 ED35  20 0C               JR   NZ,KONV20    ;sonst 3. Durchlauf (Spalte)
 1072 ED37  79                  LD   A,C
 1073 ED38  32 F422             LD   (STZ01),A    ;erstes Zeichen merken
 1074 ED3B  3E 01               LD   A,01H        ;Zeiger fuer 3. Durchlauf
 1075 ED3D  32 F421             LD   (STZ00),A
 1076 ED40  C3 EB12             JP   KONVT9       ;nichts ausgeben
 1077                   ;
 1078                   ; Verzweigung Cursorposition / weitere Funktionen
 1079                   ;
 1080 ED43  79          KONV20: LD   A,C
 1081 ED44  32 F423             LD   (STZ02),A    ;zweites Zeichen merken
 1082 ED47  AF                  XOR  A
 1083 ED48  32 F421             LD   (STZ00),A    ;Durchlaufzaehler ruecksetzen
 1084 ED4B  21 F422             LD   HL,STZ01
 1085 ED4E  7E                  LD   A,(HL)
 1086 ED4F  CB 7F               BIT  7,A          ;welche Funktion? NZ = Cursor
 1087 ED51  28 2F               JR   Z,KONV22     ;Z = weitere Funktionen
 1088                   
 1089                   ; Berechnung direkte Cursorposition
 1090                   ; OUT:    HL = BWS-Adresse
 1091                   ;
 1092 ED53  F5                  PUSH AF
 1093 ED54  79                  LD   A,C
 1094 ED55  E6 3F               AND  3FH          ;max. Spaltenzahl
 1095 ED57  6F                  LD   L,A
 1096 ED58  F1                  POP  AF
 1097 ED59  E6 1F               AND  1FH          ;max. Zeilenzahl
 1098 ED5B  16 00               LD   D,00H
 1099 ED5D  62                  LD   H,D
 1100 ED5E  5F                  LD   E,A
 1101 ED5F  06 06               LD   B,06H
 1102 ED61  CB 23       KONV21: SLA  E
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  20
BIOS    ASM

 1103 ED63  CB 12               RL   D
 1104 ED65  10 FA               DJNZ KONV21
 1105 ED67  19                  ADD  HL,DE
 1106 ED68  EB                  EX   DE,HL
 1107 ED69  21 17FF             LD   HL,17FFH     ;Ende BWS-RAM
 1108 ED6C  A7                  AND  A
 1109 ED6D  ED 52               SBC  HL,DE
 1110                   ;
 1111                   ; Cursor direkt positionieren
 1112                   ; IN:    HL = Adresse Cursor
 1113                   ;
 1114 ED6F  E5                  PUSH HL
 1115 ED70  2A 1800             LD   HL,(CUPOS)	  ;alte Position
 1116 ED73  3A F424             LD   A,(CHAR)	  ;Zeichen holen
 1117 ED76  77                  LD   (HL),A	      ;auf BS schreiben
 1118 ED77  E1                  POP  HL
 1119 ED78  22 1800             LD   (CUPOS),HL   ;neue Position setzen
 1120 ED7B  7E                  LD   A,(HL)       ;neues Zeichen holen
 1121 ED7C  32 F424             LD   (CHAR),A     ;und merken
 1122 ED7F  C3 EB12             JP   KONVT9
 1123                   ;
 1124                   ; Auswertung weiterer ESC-Funktionen
 1125                   ; IN:      A = 1. Steuerzeichen
 1126                   ;
 1127                   ; Ausgabe Grafikzeichen aus AC1-ZG ( > 80h )
 1128                   ;
 1129 ED82  FE 5F       KONV22: CP   5FH          ;Grafikzeichen?
 1130 ED84  20 08               JR   NZ,KONV24    ;NZ = nein
 1131 ED86  23                  INC  HL
 1132 ED87  7E                  LD   A,(HL)       ;2. Zeichen holen
 1133 ED88  2A 1800             LD   HL,(CUPOS)
 1134 ED8B  C3 EC6D             JP   CCHAR        ;Zeichen ausgeben
 1135                   ;
 1136                   ; Einstellen der Farbe (nur Color-BWS)
 1137                   ;
 1138 ED8E  FE 5D       KONV24: CP   5DH          ;Farbe?
 1139 ED90  C2 EB12             JP   NZ,KONVT9    ;NZ = nein
 1140 ED93  3A F41B             LD   A,(COLOR)    ;Color-BWS?
 1141 ED96  A7                  AND  A
 1142 ED97  CA EB12             JP   Z,KONVT9     ;Z = nein
 1143 ED9A  23                  INC  HL
 1144 ED9B  7E                  LD   A,(HL)       ;2. Zeichen holen
 1145 ED9C  E6 77               AND  77H          ;intensiv maskieren
 1146 ED9E  47                  LD   B,A
 1147 ED9F  0F                  RRCA
 1148 EDA0  0F                  RRCA
 1149 EDA1  0F                  RRCA
 1150 EDA2  0F                  RRCA
 1151 EDA3  B8                  CP   B            ;Zeichen- und HG-Farbe gleich?
 1152 EDA4  CA EB12             JP   Z,KONVT9     ;Z = Ja, dann ignorieren
 1153 EDA7  78                  LD   A,B
 1154 EDA8  32 F41B             LD   (COLOR),A    ;Farbe setzen
 1155 EDAB  E6 77               AND  77H          ;intensiv maskieren
 1156 EDAD  32 F41C             LD   (COLO1),A    ;Backup
 1157 EDB0  C3 EB12             JP   KONVT9
 1158                   ;
 1159 EDB3  DB F0       BWSCOL: IN   A,(PF0)      ;bwsport
 1160 EDB5  CB D7               SET  2,A          ;Farbspeicher ein
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  21
BIOS    ASM

 1161 EDB7  18 04               JR   BWSZ1
 1162                   ;
 1163 EDB9  DB F0       BWSZEI: IN   A,(PF0)      ;bwsport
 1164 EDBB  CB 97               RES  2,A          ;Farbspeicher aus
 1165 EDBD  E6 07       BWSZ1:  AND  07H
 1166 EDBF  D3 F0               OUT  (PF0),A
 1167 EDC1  C9                  RET
 1168                   ;
 1169 EDC2  AF          BWSINI: XOR  A            ;Farbbyte auf Monochrom setzen
 1170 EDC3  32 F41B             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1171 EDC6  32 F41D             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1172 EDC9  0E F0               LD   C,0F0H       ;I/O-Adresse COLOR-BWS
 1173 EDCB  ED 40               IN   B,(C)        ;Konfigbyte COLOR-BWS lesen
 1174 EDCD  04                  INC  B            ;fuer COLOR-BWS muss B<255 sein
 1175 EDCE  C8                  RET  Z            ;kein COLOR-BWS vorhanden --> Ende
 1176                           ;hier wird die Routine verlassen, wenn kein CPLD vorh. ist
 1177 EDCF  05                  DEC  B            ;Konfigbyte COLOR-BWS: Farb-RAM aus
 1178 EDD0  50                  LD   D,B
 1179 EDD1  CB D2               SET  2,D          ;Konfigbyte COLOR-BWS: Farb-RAM ein
 1180 EDD3  21 1000             LD   HL,1000H
 1181 EDD6  5E                  LD   E,(HL)       ;Zeichen aus 1000h
 1182 EDD7  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1183 EDD9  3A 181F             LD   A,(CBWSB)    ;Farbbyte aus dem AC1-Monitor
 1184 EDDC  77                  LD   (HL),A       ;Farbe auf 1000h setzen
 1185 EDDD  BE                  CP   (HL)         ;ist Farb-RAM gesteckt?
 1186 EDDE  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1187 EDE0  73                  LD   (HL),E       ;Zeichen auf 1000h zurueckschreiben
 1188 EDE1  C0                  RET  NZ           ;Farbe hat nicht geklappt --> Ende
 1189                           ;hier wird die Routine verlassen, wenn kein Farb-RAM steckt
 1190 EDE2  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1191 EDE4  C5                  PUSH BC
 1192 EDE5  11 1001             LD   DE,1001H
 1193 EDE8  01 07FF             LD   BC,07FFH
 1194 EDEB  ED B0               LDIR              ;Farb-RAM initialisieren
 1195 EDED  7E                  LD   A,(HL)       ;Farbe aus 17FFh ruecklesen
 1196 EDEE  C1                  POP  BC
 1197 EDEF  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1198 EDF1  32 F41B             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1199 EDF4  32 F41D             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1200 EDF7  C9                  RET
 1201                   ;
 1202                   ;******************************   LISTST   ******************************
 1203                   ;
 1204 EDF8  AF          LISTST: XOR  A
 1205 EDF9  3D                  DEC  A
 1206 EDFA  C9                  RET
 1207                   ;
 1208                   ;******************************   SELDSK   ******************************
 1209                   ;
 1210 EDFB  21 E641     SELDSK: LD   HL,NDISK     ;max. Anzahl der LW
 1211 EDFE  79                  LD   A,C          ;C = akt. LW
 1212 EDFF  BE                  CP   (HL)
 1213 EE00  21 0000             LD   HL,0000H     ;HL=0 --> kein LW
 1214 EE03  D0                  RET  NC           ;akt. LW >= NDISK!!!
 1215 EE04  2A E642             LD   HL,(DPHX)    ;AnfangsADR DPH(y)-Tabelle
 1216 EE07  06 00               LD   B,00H        ;BC = akt. LW
 1217 EE09  09                  ADD  HL,BC
 1218 EE0A  09                  ADD  HL,BC        ;HL = DPHY + (2 * LW)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  22
BIOS    ASM

 1219 EE0B  5E                  LD   E,(HL)
 1220 EE0C  23                  INC  HL
 1221 EE0D  56                  LD   D,(HL)       ;DE = (DPHY + (2 * LW))
 1222 EE0E  EB                  EX   DE,HL        ;HL = DPH-ADR vom akt. LW
 1223 EE0F  7C                  LD   A,H
 1224 EE10  B5                  OR   L
 1225 EE11  C8                  RET  Z            ;HL=0 --> kein DPB
 1226 EE12  79                  LD   A,C
 1227 EE13  32 F43F             LD   (DRIVE),A    ;aktives LW --> A
 1228 EE16  22 F446             LD   (DPH),HL     ;zugeordneter DPH --> HL
 1229 EE19  C9                  RET
 1230                   ;
 1231                   ;******************************   HOME   ******************************
 1232                   ;
 1233 EE1A  01 0000     HOME:   LD   BC,0000H
 1234 EE1D  ED 43 F440  SETTRK: LD   (TRACK),BC
 1235 EE21  C9                  RET
 1236                   ;
 1237                   ;******************************   SETSEC   ******************************
 1238                   ;
 1239 EE22  ED 43 F442  SETSEC: LD   (SECTOR),BC
 1240 EE26  C9                  RET
 1241                   ;
 1242                   ;******************************   SETDMA   ******************************
 1243                   ;
 1244 EE27  ED 43 F444  SETDMA: LD   (DMA),BC
 1245 EE2B  C9                  RET
 1246                   ;
 1247                   ;******************************   SECTRN   ******************************
 1248                   ;
 1249 EE2C  60          SECTRN: LD   H,B
 1250 EE2D  69                  LD   L,C
 1251 EE2E  7A                  LD   A,D
 1252 EE2F  B3                  OR   E
 1253 EE30  C8                  RET  Z
 1254 EE31  EB                  EX   DE,HL
 1255 EE32  06 00               LD   B,00H
 1256 EE34  09                  ADD  HL,BC
 1257 EE35  6E                  LD   L,(HL)
 1258 EE36  62                  LD   H,D
 1259 EE37  C9                  RET
 1260                   ;
 1261                   ;******************************   READ + WRITE   ******************************
 1262                   ;
 1263 EE38  0E 02       READ:   LD   C,02H
 1264 EE3A  3E 04               LD   A,04H
 1265 EE3C  21                  DEFB 21H          ;LD HL,063EH mit nxt. Befehl!!!
 1266 EE3D  3E 06       WRITE:  LD   A,06H        ;DUMMY fuer READ
 1267 EE3F  32 F43E             LD   (RWBYTE),A   ;RWBYTE: 04 = Lesen; 06 = Schreiben
 1268 EE42  79                  LD   A,C
 1269 EE43  32 F461             LD   (DF51E),A
 1270 EE46  21 EE5F             LD   HL,RWEND
 1271 EE49  E5                  PUSH HL
 1272 EE4A  2A F446             LD   HL,(DPH)
 1273 EE4D  11 000A             LD   DE,000AH
 1274 EE50  19                  ADD  HL,DE
 1275 EE51  7E                  LD   A,(HL)       ;NWT vom DPB
 1276 EE52  23                  INC  HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  23
BIOS    ASM

 1277 EE53  66                  LD   H,(HL)       ;HWT vom DPB
 1278 EE54  6F                  LD   L,A
 1279 EE55  2B                  DEC  HL
 1280 EE56  7E                  LD   A,(HL)       ;HWT der R/W-Funktion
 1281 EE57  2B                  DEC  HL
 1282 EE58  6E                  LD   L,(HL)       ;NWT der R/W-Funktion
 1283 EE59  67                  LD   H,A
 1284 EE5A  E5                  PUSH HL           ;Adresse der R/W-Funktion
 1285 EE5B  21 F43E             LD   HL,RWBYTE    ;HL -> R/W-Byte
 1286 EE5E  C9                  RET               ;JP R/W-Funktion
 1287                   ;
 1288 EE5F  B7          RWEND:  OR   A
 1289 EE60  C8                  RET  Z
 1290 EE61  3E 01               LD   A,01H        ;Fehler
 1291 EE63  C9                  RET
 1292                   ;
 1293                   ;******************************   RAM-Disk   ******************************
 1294                   ;
 1295 EE64  4E          RWRDSK: LD   C,(HL)       ;RWBYTE: 04 = Lesen; 06 = Schreiben 
 1296 EE65  23                  INC  HL           ;DRIVE wird uebersprungen
 1297 EE66  23                  INC  HL
 1298 EE67  7E                  LD   A,(HL)       ;TRACK NWT
 1299 EE68  32 F41E             LD   (RAFTRK),A
 1300 EE6B  23                  INC  HL
 1301 EE6C  7E                  LD   A,(HL)       ;TRACK HWT
 1302 EE6D  A7                  AND  A
 1303 EE6E  20 32               JR   NZ,RDERR     ;muss 0 sein
 1304 EE70  23                  INC  HL
 1305 EE71  7E                  LD   A,(HL)       ;SEKTOR NWT
 1306 EE72  32 F41F             LD   (RAFSEC),A
 1307 EE75  CB 7F               BIT  7,A
 1308 EE77  20 29               JR   NZ,RDERR     ;Bit 7 muss 0 sein
 1309 EE79  CB 77               BIT  6,A
 1310 EE7B  20 25               JR   NZ,RDERR     ;Bit 6 muss 0 sein
 1311 EE7D  23                  INC  HL
 1312 EE7E  7E                  LD   A,(HL)       ;SEKTOR HWT
 1313 EE7F  A7                  AND  A
 1314 EE80  20 20               JR   NZ,RDERR     ;muss 0 sein
 1315 EE82  23                  INC  HL
 1316 EE83  23                  INC  HL           ;DMA wird uebersprungen
 1317 EE84  79                  LD   A,C
 1318 EE85  01 0080             LD   BC,0080H
 1319 EE88  FE 06               CP   06H
 1320 EE8A  28 08               JR   Z,RDSKWR     ;C = 06 --> RDSK Schreiben
 1321 EE8C  CD EFCF             CALL ADRRAF
 1322 EE8F  ED B2               INIR
 1323 EE91  00                  NOP
 1324 EE92  AF                  XOR  A            ;in Ordnung
 1325 EE93  C9                  RET
 1326                   ;
 1327 EE94  21 0080     RDSKWR: LD   HL,0080H     ;RAM-Disk schreiben 
 1328 EE97  ED 5B F444          LD   DE,(DMA)
 1329 EE9B  CD EFCF             CALL ADRRAF
 1330 EE9E  ED B3               OTIR
 1331 EEA0  AF                  XOR  A            ;in Ordnung
 1332 EEA1  C9                  RET
 1333                   ;
 1334 EEA2  3E FF       RDERR:  LD   A,0FFH       ;Fehler
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  24
BIOS    ASM

 1335 EEA4  C9                  RET
 1336                   ;
 1337 EEA5  20 3D 3E 49 TXTRDI: DEFM " =>INIT.."
 1338 EEAE  00                  DEFB 0
 1339                   ;
 1340 EEAF  4F 4B       TXTRDO: DEFM "OK"
 1341 EEB1  00                  DEFB 0
 1342                   ;
 1343 EEB2  52 46 4C 20 TXTRDE: DEFM "RFL ERROR!"
 1344 EEBC  0D 0A               DEFB 0DH,0AH
 1345 EEBE  00                  DEFB 0
 1346                   ;
 1347                   ; Test der RAM-Disk - GrC6Ce (256 / 512 / 1024 / 2048 KByte)
 1348                   ;
 1349 EEBF  AF          RDTEST: XOR  A            ;Kapazitaet der RAM-Disk testen
 1350 EEC0  D3 E6               OUT  (PE0+6),A    ;H-Adresse ruecksetzen
 1351 EEC2  0E E0               LD   C,PE0        ;Test erfolgt in der 1. RAM-Bank
 1352                   ;
 1353                   ; Inhalte der 4 RAM-Testzellen sichern
 1354                   ;
 1355 EEC4  21 EF1B             LD   HL,RDMERK    ;Merkzellen im RAM
 1356 EEC7  06 04               LD   B,4          ;4 Durchlaeufe
 1357 EEC9  16 04               LD   D,4          ;Startwert Extended-Adresse
 1358 EECB  AF          RDTST1: XOR  A
 1359 EECC  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1360 EECE  7A                  LD   A,D
 1361 EECF  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1362 EED1  ED 78               IN   A,(C)
 1363 EED3  77                  LD   (HL),A       ;Daten aus der RAM-Disk sichern
 1364 EED4  23                  INC  HL           ;Merkzelle++
 1365 EED5  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1366 EED7  10 F2               DJNZ RDTST1
 1367                   ;
 1368                   ; 4 Testwerte in die RAM-Disk schreiben
 1369                   ;
 1370 EED9  06 04               LD   B,4          ;4 Durchlaeufe
 1371 EEDB  16 04               LD   D,4          ;Startwert Extended-Adresse
 1372 EEDD  AF          RDTST2: XOR  A
 1373 EEDE  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1374 EEE0  7A                  LD   A,D
 1375 EEE1  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1376 EEE3  ED 79               OUT  (C),A        ;Testwert in die RAM-Disk schreiben
 1377 EEE5  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1378 EEE7  10 F4               DJNZ RDTST2
 1379                   ;
 1380                   ;Tabelle der Test-Werte (mit *...* sind die zu testenden Werte):
 1381                   ;
 1382                   ;           RAM-Disk-Size =   256K   512K  1024K  2048K
 1383                   ;Extended-Adresse=00000100B    0      0      0     *4*
 1384                   ;Extended-Adresse=00000010B    0      0     *2*     2
 1385                   ;Extended-Adresse=00000001B    0     *1*     1      1
 1386                   ;Extended-Adresse=00000000B   *0*     0      0      0
 1387                   ;
 1388                   ; Groesse der RAM-Disk bestimmen
 1389                   ;
 1390 EEE9  06 04               LD   B,4          ;4 Durchlaeufe
 1391 EEEB  16 04               LD   D,4          ;Startwert Extended-Adresse
 1392 EEED  AF          RDTST3: XOR  A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  25
BIOS    ASM

 1393 EEEE  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1394 EEF0  7A                  LD   A,D
 1395 EEF1  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1396 EEF3  ED 78               IN   A,(C)
 1397 EEF5  BA                  CP   D
 1398 EEF6  28 07               JR   Z,RDTST4     ;2048(B=4),1024(B=3),512(B=2),256(B=1)
 1399 EEF8  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1400 EEFA  10 F1               DJNZ RDTST3
 1401 EEFC  C3 EFC6             JP   RDERRO       ;Fehler: hier stimmt was nicht!
 1402                   ;
 1403 EEFF  21 EF1F     RDTST4: LD   HL,RDSIZE
 1404 EF02  05                  DEC  B
 1405 EF03  70                  LD   (HL),B       ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1406                   ;
 1407                   ; gesicherte Daten in die RAM-Disk zurueckschreiben
 1408                   ; 
 1409 EF04  21 EF1E             LD   HL,RDMERK+3  ;Merkzellen RAM (letzter Eintrag)
 1410 EF07  04                  INC  B            ;1 bis 4 Durchlaeufe, je nach RDSIZE
 1411 EF08  16 01               LD   D,1          ;Startwert Ext.-Adr. (1 Bit n. rechts)
 1412 EF0A  AF          RDTST5: XOR  A
 1413 EF0B  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1414 EF0D  7A                  LD   A,D
 1415 EF0E  CB 3F               SRL  A            ;0 --> A7 --> A0 --> CY
 1416 EF10  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1417 EF12  7E                  LD   A,(HL)
 1418 EF13  ED 79               OUT  (C),A        ;urspruengliche Daten zurueckschreiben
 1419 EF15  2B                  DEC  HL
 1420 EF16  CB 22               SLA  D            ;CY <-- D7 <-- D0 <-- 0
 1421 EF18  10 F0               DJNZ RDTST5       ;WICHTIG: nicht mehr als notwendig
 1422 EF1A  C9                  RET               ;in die RAM-Disk zurueckschreiben!
 1423                   ;
 1424 EF1B  00 00 00 00 RDMERK: DEFS 4,0          ;4 Merkzellen fuer den RAM-Disk Test
 1425 EF1F  00          RDSIZE: DEFB 0            ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1426                   ;
 1427 EF20  21 EEA5     RDFORM: LD   HL,TXTRDI    ;Formatierungstext...
 1428 EF23  CD EA55             CALL OUTTXT
 1429 EF26  21 C002             LD   HL,0C002H    ;Hilfsprogramm von 0C000H bis 0C800H
 1430 EF29  54                  LD   D,H
 1431 EF2A  5D                  LD   E,L
 1432 EF2B  2B                  DEC  HL
 1433 EF2C  36 E0               LD   (HL),PE0     ;0C001H = Grundadresse der RAM-Disk
 1434 EF2E  2B                  DEC  HL
 1435 EF2F  36 D3               LD   (HL),0D3H    ;0C000H = 0D3H --> OUT n
 1436 EF31  01 0200             LD   BC,0200H
 1437 EF34  ED B0               LDIR              ;0D3H,0E0H von 0C000H bis 0C1FFH
 1438 EF36  23                  INC  HL
 1439 EF37  36 E1               LD   (HL),PE0+1
 1440 EF39  2B                  DEC  HL
 1441 EF3A  01 0200             LD   BC,0200H
 1442 EF3D  ED B0               LDIR              ;0D3H,0E1H von 0C200H bis 0C3FFH
 1443 EF3F  23                  INC  HL
 1444 EF40  36 E2               LD   (HL),PE0+2
 1445 EF42  2B                  DEC  HL
 1446 EF43  01 0200             LD   BC,0200H
 1447 EF46  ED B0               LDIR              ;0D3H,0E2H von 0C400H bis 0C5FFH
 1448 EF48  23                  INC  HL
 1449 EF49  36 E3               LD   (HL),PE0+3
 1450 EF4B  2B                  DEC  HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  26
BIOS    ASM

 1451 EF4C  01 0200             LD   BC,0200H
 1452 EF4F  ED B0               LDIR              ;0D3H,0E3H von 0C600H bis 0C7FFH
 1453 EF51  36 C9               LD   (HL),0C9H    ;RET auf 0C800H
 1454                   ;
 1455 EF53  21 EF1F             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1456 EF56  7E                  LD   A,(HL)
 1457 EF57  FE 00               CP   0
 1458 EF59  28 0A               JR   Z,RDFOR1     ;RD 256K
 1459 EF5B  FE 01               CP   1
 1460 EF5D  28 06               JR   Z,RDFOR1     ;RD 512K
 1461 EF5F  3D                  DEC  A
 1462 EF60  CB 27               SLA  A            ;A *= 2
 1463 EF62  CB 27               SLA  A            ;A *= 2
 1464 EF64  3D                  DEC  A
 1465 EF65  57          RDFOR1: LD   D,A
 1466 EF66  14                  INC  D            ;D ==> 1=256K 2=512K 4=1024K 8=2048K
 1467 EF67  AF                  XOR  A
 1468 EF68  D3 E7               OUT  (PE0+7),A    ;L-Adresse setzen
 1469 EF6A  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1470 EF6C  1E 00               LD   E,0          ;Merker fuer Extended-Adresse
 1471 EF6E  06 00               LD   B,0          ;256 Durchlaeufe
 1472 EF70  0E E6               LD   C,PE0+6
 1473 EF72  ED 41       RDFOR2: OUT  (C),B        ;H-Adresse setzen
 1474 EF74  3E E5               LD   A,0E5H       ;RD wird mit 0E5H formatiert
 1475 EF76  CD C000             CALL HPRDSK       ;Hilfsprog. Format RAM-Disk auf C000H
 1476 EF79  10 F7               DJNZ RDFOR2       ;fuer alle H-Adressen (256 Durchl.)
 1477 EF7B  1C                  INC  E
 1478 EF7C  7B                  LD   A,E
 1479 EF7D  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1480 EF7F  15                  DEC  D
 1481 EF80  20 F0               JR   NZ,RDFOR2        
 1482                   ;
 1483 EF82  21 D000             LD   HL,CCP
 1484 EF85  22 F444             LD   (DMA),HL
 1485 EF88  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
 1486 EF8A  CD EF97             CALL WRCCP
 1487 EF8D  C2 E983             JP   NZ,CPMERR
 1488 EF90  21 EEAF             LD   HL,TXTRDO    ;"OK"
 1489 EF93  CD EA55             CALL OUTTXT
 1490 EF96  C9                  RET
 1491                   ;
 1492 EF97  C5          WRCCP:  PUSH BC           ;CCP+BDOS in Systemtrack schreiben
 1493 EF98  0E 00               LD   C,0          ;LW A:
 1494 EF9A  CD EDFB             CALL SELDSK
 1495 EF9D  C1                  POP  BC
 1496 EF9E  21 0000             LD   HL,0000H
 1497 EFA1  22 F440             LD   (TRACK),HL   ;Track 0
 1498 EFA4  EB                  EX   DE,HL
 1499 EFA5  21 D000             LD   HL,CCP
 1500 EFA8  ED 53 F442  WRCCP1: LD   (SECTOR),DE  ;Sektor 0 ff.
 1501 EFAC  22 F444             LD   (DMA),HL
 1502 EFAF  C5                  PUSH BC
 1503 EFB0  CD                  DEFB 0CDH         ;CALL WRITE -> CD ED CA
 1504 EFB1  EE3D        WRCCP2: DEFW WRITE        ;kannn durch READ (EDC5) ersetzt werden
 1505 EFB3  C1                  POP  BC
 1506 EFB4  20 10               JR   NZ,RDERRO
 1507 EFB6  2A F444             LD   HL,(DMA)
 1508 EFB9  11 0080             LD   DE,0080H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  27
BIOS    ASM

 1509 EFBC  19                  ADD  HL,DE
 1510 EFBD  ED 5B F442          LD   DE,(SECTOR)
 1511 EFC1  13                  INC  DE
 1512 EFC2  10 E4               DJNZ WRCCP1
 1513 EFC4  AF                  XOR  A
 1514 EFC5  C9                  RET
 1515                   ;
 1516 EFC6  21 EEB2     RDERRO: LD   HL,TXTRDE
 1517 EFC9  CD EA55             CALL OUTTXT
 1518 EFCC  AF                  XOR  A
 1519 EFCD  3D                  DEC  A
 1520 EFCE  C9                  RET
 1521                   ;
 1522                   ;Adressarithmetik RAF: L=RADR 0-7 , H=RADR 8-15 , A=RADR 16-19
 1523                   ;
 1524 EFCF  AF          ADRRAF: XOR  A            ;CY = 0
 1525 EFD0  6F                  LD   L,A 
 1526 EFD1  3A F41F             LD   A,(RAFSEC)   ;8 bit
 1527 EFD4  67                  LD   H,A          ;H=Sektor (max. 64 = Bit 0-5)
 1528 EFD5  CB 1C               RR   H
 1529 EFD7  CB 1D               RR   L            ;H0 -> L7 ...... H5 -> H4
 1530 EFD9  3A F41E             LD   A,(RAFTRK)   ;8 bit , A=Track (max. 128 bei 1M = Bit 0-6)
 1531 EFDC  CB 1F               RR   A            ;A0 -> CY
 1532 EFDE  30 02               JR   NC,ADRAF1
 1533 EFE0  CB EC               SET  5,H          ;H5 = A0 (RADR13)
 1534 EFE2  CB 1F       ADRAF1: RR   A            ;A1 -> CY
 1535 EFE4  30 02               JR   NC,ADRAF2
 1536 EFE6  CB F4               SET  6,H          ;H6 = A1 (RADR14)
 1537 EFE8  CB 1F       ADRAF2: RR   A            ;A2 -> CY
 1538 EFEA  30 02               JR   NC,ADRAF3
 1539 EFEC  CB FC               SET  7,H          ;H7 = A2 (RADR15)
 1540 EFEE  F5          ADRAF3: PUSH AF
 1541 EFEF  E6 03               AND  03H
 1542 EFF1  F6 E0               OR   PE0          ;Grundadresse der RAM-Disk
 1543 EFF3  4F                  LD   C,A
 1544 EFF4  7D                  LD   A,L
 1545 EFF5  D3 E7               OUT  (PE0+7),A    ;L-Adresse
 1546 EFF7  7C                  LD   A,H
 1547 EFF8  D3 E6               OUT  (PE0+6),A    ;H-Adresse
 1548 EFFA  F1                  POP  AF
 1549 EFFB  CB 1F               RR   A            ;Rotiere A rechts durch Carry
 1550 EFFD  CB 1F               RR   A
 1551 EFFF  E6 07               AND  07H          ;max. 2048K RAM-Disk
 1552 F001  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1553 F003  06 80               LD   B,80H
 1554 F005  2A F444             LD   HL,(DMA)
 1555 F008  C9                  RET
 1556                   ;
 1557                   ;******************************  LOAD  ******************************
 1558                   ;
 1559 F009  C9          LOAD:   RET
 1560                   ;
 1561 F00A  2A F446     LEFFA:  LD   HL,(DPH)     ;zugeordneter DPH --> HL
 1562 F00D  22 F458             LD   (DPH3M),HL   ;Merkzelle DPH
 1563 F010  2E 0F       LF000:  LD   L,0FH
 1564 F012  D5          LF002:  PUSH DE
 1565 F013  11 000A             LD   DE,000AH
 1566 F016  62                  LD   H,D
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  28
BIOS    ASM

 1567 F017  E5                  PUSH HL
 1568 F018  2A F458             LD   HL,(DPH3M)   ;Merkzelle DPH
 1569 F01B  19                  ADD  HL,DE
 1570 F01C  5E                  LD   E,(HL)
 1571 F01D  23                  INC  HL
 1572 F01E  56                  LD   D,(HL)
 1573 F01F  E1                  POP  HL
 1574 F020  19                  ADD  HL,DE
 1575 F021  D1                  POP  DE
 1576 F022  7E                  LD   A,(HL)
 1577 F023  B7                  OR   A
 1578 F024  C9                  RET
 1579                   ;
 1580                   ;
 1581                   ;       READ/WRITE Routinen GIDE + Floppy-Disk
 1582                   ;       --------------------------------------
 1583                   ;
 1584 F025  23          RWGIDE: INC  HL
 1585 F026  CB FE               SET  7,(HL)
 1586 F028  2B                  DEC  HL
 1587 F029  AF          RWFLO:  XOR  A
 1588 F02A  32 F45F             LD   (DF51C),A
 1589 F02D  CD F034             CALL LF024
 1590 F030  3A F45F             LD   A,(DF51C)
 1591 F033  C9                  RET
 1592                   ;
 1593 F034  4E          LF024:  LD   C,(HL)
 1594 F035  CD F00A             CALL LEFFA
 1595 F038  CA F0F1             JP   Z,LF0E1
 1596 F03B  79                  LD   A,C
 1597 F03C  FE 06               CP   06H
 1598 F03E  3E 01               LD   A,01H
 1599 F040  20 01               JR   NZ,LF033
 1600 F042  AF                  XOR  A
 1601 F043  32 F460     LF033:  LD   (DF51D),A
 1602 F046  CD F010             CALL LF000
 1603 F049  47                  LD   B,A
 1604 F04A  2A F442             LD   HL,(SECTOR)
 1605 F04D  CB 3C       LF03D:  SRL  H
 1606 F04F  CB 1D               RR   L
 1607 F051  10 FA               DJNZ LF03D
 1608 F053  22 F45B             LD   (DF518),HL
 1609 F056  21 F45D             LD   HL,DF51A
 1610 F059  7E                  LD   A,(HL)
 1611 F05A  36 01               LD   (HL),01H
 1612 F05C  B7                  OR   A
 1613 F05D  28 26               JR   Z,LF075
 1614 F05F  3A F43F             LD   A,(DRIVE)
 1615 F062  21 F448             LD   HL,DRV2
 1616 F065  BE                  CP   (HL)
 1617 F066  20 16               JR   NZ,LF06E
 1618 F068  2A F449             LD   HL,(TRK2)
 1619 F06B  ED 5B F440          LD   DE,(TRACK)
 1620 F06F  ED 52               SBC  HL,DE
 1621 F071  20 0B               JR   NZ,LF06E
 1622 F073  2A F44B             LD   HL,(SEC2)
 1623 F076  ED 5B F45B          LD   DE,(DF518)
 1624 F07A  ED 52               SBC  HL,DE
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  29
BIOS    ASM

 1625 F07C  28 1F               JR   Z,LF08D
 1626 F07E  3A F45E     LF06E:  LD   A,(DF51B)
 1627 F081  B7                  OR   A
 1628 F082  C4 F0DE             CALL NZ,LF0CE
 1629 F085  21 F43F     LF075:  LD   HL,DRIVE
 1630 F088  11 F448             LD   DE,DRV2
 1631 F08B  01 0009             LD   BC,9         ;9 Bytes kopieren
 1632 F08E  ED B0               LDIR
 1633 F090  2A F45B             LD   HL,(DF518)
 1634 F093  22 F44B             LD   (SEC2),HL
 1635 F096  CD F0E1             CALL LF0D1
 1636 F099  AF                  XOR  A
 1637 F09A  32 F45E             LD   (DF51B),A
 1638 F09D  CD F010     LF08D:  CALL LF000
 1639 F0A0  23                  INC  HL
 1640 F0A1  3A F442             LD   A,(SECTOR)
 1641 F0A4  A6                  AND  (HL)
 1642 F0A5  1F                  RRA
 1643 F0A6  67                  LD   H,A
 1644 F0A7  3E 00               LD   A,00H
 1645 F0A9  1F                  RRA
 1646 F0AA  6F                  LD   L,A
 1647 F0AB  11 F462             LD   DE,DISKP
 1648 F0AE  19                  ADD  HL,DE
 1649 F0AF  ED 5B F444          LD   DE,(DMA)
 1650 F0B3  3A F460             LD   A,(DF51D)
 1651 F0B6  B7                  OR   A
 1652 F0B7  20 05               JR   NZ,LF0AE
 1653 F0B9  3C                  INC  A
 1654 F0BA  32 F45E             LD   (DF51B),A
 1655 F0BD  EB                  EX   DE,HL
 1656 F0BE  01 0080     LF0AE:  LD   BC,0080H
 1657 F0C1  ED B0               LDIR
 1658 F0C3  3A F45F             LD   A,(DF51C)
 1659 F0C6  B7                  OR   A
 1660 F0C7  20 10               JR   NZ,LF0C9
 1661 F0C9  3A F461             LD   A,(DF51E)
 1662 F0CC  3D                  DEC  A
 1663 F0CD  C0                  RET  NZ
 1664 F0CE  32 F45E             LD   (DF51B),A
 1665 F0D1  CD F0DE             CALL LF0CE
 1666 F0D4  3A F45F             LD   A,(DF51C)
 1667 F0D7  B7                  OR   A
 1668 F0D8  C8                  RET  Z
 1669 F0D9  AF          LF0C9:  XOR  A
 1670 F0DA  32 F45D             LD   (DF51A),A
 1671 F0DD  C9                  RET
 1672                   ;
 1673 F0DE  3E 06       LF0CE:  LD   A,06H
 1674 F0E0  21                  DEFB 21H          ;LD HL,043EH -> 21 3E 04
 1675 F0E1  3E 04       LF0D1:  LD   A,04H  
 1676 F0E3  32 F45A             LD   (MERKRW),A
 1677 F0E6  21 F462             LD   HL,DISKP
 1678 F0E9  22 F44D             LD   (DMA2),HL
 1679 F0EC  21 F448             LD   HL,DRV2
 1680 F0EF  18 09               JR   LF0EA
 1681                   ;
 1682 F0F1  3A F43E     LF0E1:  LD   A,(RWBYTE)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  30
BIOS    ASM

 1683 F0F4  32 F45A             LD   (MERKRW),A
 1684 F0F7  21 F43F             LD   HL,DRIVE
 1685 F0FA  11 F451     LF0EA:  LD   DE,DRV3
 1686 F0FD  01 0009             LD   BC,9         ;9 Bytes kopieren
 1687 F100  ED B0               LDIR
 1688 F102  3A F451             LD   A,(DRV3)
 1689 F105  17                  RLA
 1690 F106  DA F318             JP   C,GIDERW     ;GIDE
 1691 F109  3A F453             LD   A,(TRK3+1)
 1692 F10C  21 F455             LD   HL,SEC3+1
 1693 F10F  B6                  OR   (HL)
 1694 F110  C2 F1D1             JP   NZ,LF1C1
 1695 F113  CD F010             CALL LF000
 1696 F116  32 F431             LD   (DF4E8),A
 1697 F119  B7                  OR   A
 1698 F11A  3E FF               LD   A,0FFH
 1699 F11C  28 02               JR   Z,LF110
 1700 F11E  3E 80               LD   A,80H
 1701 F120  32 F434     LF110:  LD   (DF4EB),A
 1702 F123  23                  INC  HL
 1703 F124  23                  INC  HL
 1704 F125  7E                  LD   A,(HL)
 1705 F126  32 F432             LD   (DF4E9),A
 1706 F129  3A F454             LD   A,(SEC3)
 1707 F12C  BE                  CP   (HL)
 1708 F12D  38 04               JR   C,LF123
 1709 F12F  96                  SUB  (HL)
 1710 F130  01 0104             LD   BC,0104H
 1711 F133  3C          LF123:  INC  A
 1712 F134  32 F430             LD   (DF4E7),A
 1713 F137  23                  INC  HL
 1714 F138  7E                  LD   A,(HL)
 1715 F139  32 F433             LD   (DF4EA),A
 1716 F13C  23                  INC  HL
 1717 F13D  3A F452             LD   A,(TRK3)
 1718 F140  BE                  CP   (HL)
 1719 F141  38 04               JR   C,LF137
 1720 F143  96                  SUB  (HL)
 1721 F144  01 0104             LD   BC,0104H
 1722 F147  32 F42E     LF137:  LD   (DF4E5),A
 1723 F14A  23                  INC  HL
 1724 F14B  7E                  LD   A,(HL)
 1725 F14C  B1                  OR   C
 1726 F14D  32 F42D             LD   (DF4E4),A
 1727 F150  78                  LD   A,B
 1728 F151  32 F42F             LD   (DF4E6),A
 1729 F154  23                  INC  HL
 1730 F155  3A F45A             LD   A,(MERKRW)
 1731 F158  16 05               LD   D,05H
 1732 F15A  FE 06               CP   06H
 1733 F15C  28 02               JR   Z,LF150
 1734 F15E  16 06               LD   D,06H
 1735 F160  7E          LF150:  LD   A,(HL)
 1736 F161  E6 40               AND  40H
 1737 F163  B2                  OR   D
 1738 F164  32 F42B             LD   (DF4E2),A
 1739 F167  11 F435             LD   DE,DF4EC
 1740 F16A  01 0004             LD   BC,0004H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  31
BIOS    ASM

 1741 F16D  ED B0               LDIR
 1742 F16F  0E 02               LD   C,02H
 1743 F171  06 02       LF161:  LD   B,02H
 1744 F173  C5          LF163:  PUSH BC
 1745 F174  CD F185             CALL LF175
 1746 F177  C1                  POP  BC
 1747 F178  B7                  OR   A
 1748 F179  C8                  RET  Z
 1749 F17A  10 F7               DJNZ LF163
 1750 F17C  0D                  DEC  C
 1751 F17D  C8                  RET  Z
 1752 F17E  C5                  PUSH BC
 1753 F17F  CD F1E5             CALL LF1D5
 1754 F182  C1                  POP  BC
 1755 F183  18 EC               JR   LF161
 1756                   ;
 1757 F185  3E 03       LF175:  LD   A,03H
 1758 F187  06 02               LD   B,02H
 1759 F189  21 F437             LD   HL,CTAB      ;FDC Befehlsbyte
 1760 F18C  D3 41               OUT  (DFDC),A     ;Datenport FDC
 1761 F18E  CD F240             CALL LF230
 1762 F191  CD F1F7             CALL LF1E7
 1763 F194  20 3B               JR   NZ,LF1C1
 1764 F196  21 0040             LD   HL,0040H
 1765 F199  3A F431             LD   A,(DF4E8)
 1766 F19C  3C                  INC  A
 1767 F19D  29          LF18D:  ADD  HL,HL
 1768 F19E  3D                  DEC  A
 1769 F19F  20 FC               JR   NZ,LF18D
 1770 F1A1  2B                  DEC  HL
 1771 F1A2  24                  INC  H
 1772 F1A3  2C                  INC  L
 1773 F1A4  E5                  PUSH HL
 1774 F1A5  2A F456             LD   HL,(DMA3)
 1775 F1A8  E5                  PUSH HL
 1776 F1A9  3A F42B             LD   A,(DF4E2)
 1777 F1AC  4F                  LD   C,A
 1778 F1AD  06 09               LD   B,09H
 1779 F1AF  0F                  RRCA
 1780 F1B0  3E 51               LD   A,51H
 1781 F1B2  8F                  ADC  A,A
 1782 F1B3  32 F27F             LD   (MODE0),A    ;A2 --> INI
 1783 F1B6  32 F285             LD   (MODE1),A    ;A3 --> OUTI
 1784 F1B9  F3                  DI
 1785 F1BA  CD F237             CALL LF227
 1786 F1BD  E1                  POP  HL
 1787 F1BE  D1                  POP  DE
 1788 F1BF  43                  LD   B,E
 1789 F1C0  0E 41               LD   C,DFDC       ;Datenport FDC
 1790 F1C2  CD F272             CALL RW           ;FDC RW-Routine
 1791 F1C5  FB                  EI
 1792 F1C6  CD F1D8             CALL LF1C8
 1793 F1C9  21 F439             LD   HL,DF4F0
 1794 F1CC  7E                  LD   A,(HL)
 1795 F1CD  E6 C0               AND  0C0H
 1796 F1CF  28 02               JR   Z,LF1C3
 1797 F1D1  3E FF       LF1C1:  LD   A,0FFH
 1798 F1D3  32 F45F     LF1C3:  LD   (DF51C),A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  32
BIOS    ASM

 1799 F1D6  B7                  OR   A
 1800 F1D7  C9                  RET
 1801                   ;
 1802 F1D8  06 07       LF1C8:  LD   B,07H
 1803 F1DA  21 F439             LD   HL,DF4F0
 1804 F1DD  CD F25B     LF1CD:  CALL RBYTE
 1805 F1E0  77                  LD   (HL),A
 1806 F1E1  23                  INC  HL
 1807 F1E2  10 F9               DJNZ LF1CD
 1808 F1E4  C9                  RET
 1809                   ;
 1810 F1E5  01 0207     LF1D5:  LD   BC,0207H     ;Spur 0 einstellen
 1811 F1E8  CD F237             CALL LF227
 1812 F1EB  CD F217             CALL SENSE
 1813 F1EE  C8                  RET  Z
 1814 F1EF  01 0207             LD   BC,0207H
 1815 F1F2  CD F237             CALL LF227
 1816 F1F5  18 20               JR   SENSE
 1817                   ;
 1818 F1F7  3A F42E     LF1E7:  LD   A,(DF4E5)
 1819 F1FA  32 F43A             LD   (DF4F7),A
 1820 F1FD  B7                  OR   A
 1821 F1FE  28 E5               JR   Z,LF1D5
 1822 F200  01 030F             LD   BC,030FH
 1823 F203  21 F435             LD   HL,DF4EC
 1824 F206  CB 66               BIT  4,(HL)
 1825 F208  28 04               JR   Z,LF1FE
 1826 F20A  87                  ADD  A,A
 1827 F20B  32 F42E             LD   (DF4E5),A
 1828 F20E  CD F237     LF1FE:  CALL LF227
 1829 F211  3A F43A             LD   A,(DF4F7)
 1830 F214  32 F42E             LD   (DF4E5),A
 1831 F217  01 0108     SENSE:  LD   BC,0108H
 1832 F21A  CD F237             CALL LF227
 1833 F21D  CD F25B             CALL RBYTE
 1834 F220  47                  LD   B,A
 1835 F221  32 F439             LD   (DF4F0),A
 1836 F224  FE 80               CP   80H
 1837 F226  C4 F25B             CALL NZ,RBYTE     ;PCN holen
 1838 F229  CB 68               BIT  5,B          ;SEEK Ende?
 1839 F22B  28 EA               JR   Z,SENSE
 1840 F22D  78                  LD   A,B
 1841 F22E  E6 F0               AND  0F0H
 1842 F230  FE C0               CP   0C0H
 1843 F232  28 E3               JR   Z,SENSE
 1844 F234  EE 20               XOR  20H
 1845 F236  C9                  RET
 1846                   ;
 1847 F237  C5          LF227:  PUSH BC
 1848 F238  CD F295             CALL LF285
 1849 F23B  C1                  POP  BC
 1850 F23C  21 F42C     LF22C:  LD   HL,DF4E3
 1851 F23F  71                  LD   (HL),C
 1852 F240  0E 41       LF230:  LD   C,41H
 1853 F242  D5                  PUSH DE
 1854 F243  11 1FFF     LF233:  LD   DE,1FFFH
 1855 F246  7B          LF236:  LD   A,E
 1856 F247  B2                  OR   D
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  33
BIOS    ASM

 1857 F248  28 0D               JR   Z,LF247      ;Abbruch nach 8192 Versuchen
 1858 F24A  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1859 F24C  E6 C0               AND  0C0H
 1860 F24E  FE 80               CP   80H          ;FDC bereit zum Schreiben?
 1861 F250  1B                  DEC  DE
 1862 F251  20 F3               JR   NZ,LF236     ;noch nicht bereit
 1863 F253  ED A3               OUTI              ;1 Byte --> FDC
 1864 F255  20 EC               JR   NZ,LF233     ;Wdhlg., bis B=0
 1865 F257  06 00       LF247:  LD   B,00H
 1866 F259  D1                  POP  DE
 1867 F25A  C9                  RET
 1868                   ;
 1869 F25B  E5          RBYTE:  PUSH HL           ;1 Byte lesen
 1870 F25C  21 1FFF             LD   HL,1FFFH
 1871 F25F  7D          RBYTE1: LD   A,L
 1872 F260  B4                  OR   H
 1873 F261  3E C0               LD   A,0C0H
 1874 F263  28 0B               JR   Z,RBYTE2     ;Abbruch nach 8192 Versuchen
 1875 F265  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1876 F267  E6 C0               AND  0C0H
 1877 F269  FE C0               CP   0C0H         ;FDC bereit zum Lesen?
 1878 F26B  2B                  DEC  HL
 1879 F26C  20 F1               JR   NZ,RBYTE1    ;noch nicht bereit
 1880 F26E  DB 41               IN   A,(DFDC)     ;1 Byte vom FDC lesen --> A
 1881 F270  E1          RBYTE2: POP  HL
 1882 F271  C9                  RET
 1883                   ;
 1884                   ;
 1885                   ;       FDC READ/WRITE Routine
 1886                   ;       ----------------------
 1887                   ;
 1888 F272  3A F43D     RW:     LD   A,(LATPU)
 1889 F275  CB CF               SET  1,A
 1890 F277  D3 45               OUT  (LATCH),A    ;WAIT-Freigabe
 1891 F279  DB 40       RW01:   IN   A,(CFDC)     ;Lese Hauptstatusregister
 1892 F27B  07                  RLCA
 1893 F27C  30 FB               JR   NC,RW01      ;FDC noch nicht bereit
 1894 F27E  ED                  DEFB 0EDH         ;ED A2 = INI
 1895 F27F  A2          MODE0:  DEFB 0A2H         ;ED A3 = OUTI
 1896 F280  00                  NOP
 1897 F281  D3 43       RW02:   OUT  (WAIT),A     ;WAIT bis Interrupt FDC
 1898 F283  00                  NOP
 1899 F284  ED                  DEFB 0EDH         ;ED A2 = INI
 1900 F285  A2          MODE1:  DEFB 0A2H         ;ED A3 = OUTI
 1901 F286  C2 F281             JP   NZ,RW02
 1902 F289  15                  DEC  D
 1903 F28A  C2 F281             JP   NZ,RW02
 1904 F28D  3A F43D             LD   A,(LATPU)
 1905 F290  CB E7               SET  4,A          ;Terminal Count
 1906 F292  D3 45               OUT  (LATCH),A    ;TC + WAIT-Sperrung
 1907 F294  C9                  RET
 1908                   ;
 1909 F295  21 F43B     LF285:  LD   HL,DF4F8
 1910 F298  3A F42D             LD   A,(DF4E4)
 1911 F29B  E6 03               AND  03H
 1912 F29D  BE                  CP   (HL)
 1913 F29E  77                  LD   (HL),A
 1914 F29F  23                  INC  HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  34
BIOS    ASM

 1915 F2A0  4E                  LD   C,(HL)
 1916 F2A1  36 48               LD   (HL),48H
 1917 F2A3  F5                  PUSH AF
 1918 F2A4  E5                  PUSH HL
 1919 F2A5  21 F43D             LD   HL,LATPU
 1920 F2A8  3A F42D             LD   A,(DF4E4)
 1921 F2AB  E6 03               AND  03H
 1922 F2AD  28 08               JR   Z,LF2A7
 1923 F2AF  FE 02               CP   02H
 1924 F2B1  28 04               JR   Z,LF2A7
 1925 F2B3  CB DE               SET  3,(HL)       ;Floppy-LW 1: Motor an
 1926 F2B5  18 02               JR   LF2A9
 1927                   ;
 1928 F2B7  CB C6       LF2A7:  SET  0,(HL)       ;Floppy-LW 0: Motor an
 1929 F2B9  7E          LF2A9:  LD   A,(HL)
 1930 F2BA  D3 45               OUT  (LATCH),A
 1931 F2BC  E1                  POP  HL
 1932 F2BD  F1                  POP  AF
 1933 F2BE  20 04               JR   NZ,LF2B4
 1934 F2C0  79                  LD   A,C
 1935 F2C1  A7                  AND  A
 1936 F2C2  20 09               JR   NZ,LF2BD
 1937 F2C4  3E 48       LF2B4:  LD   A,48H
 1938 F2C6  CB 3F               SRL  A
 1939 F2C8  CB 3F               SRL  A
 1940 F2CA  BE                  CP   (HL)
 1941 F2CB  38 F7               JR   C,LF2B4
 1942 F2CD  7E          LF2BD:  LD   A,(HL)
 1943 F2CE  A7                  AND  A
 1944 F2CF  20 08               JR   NZ,LF2C9
 1945 F2D1  E5                  PUSH HL
 1946 F2D2  21 F2ED             LD   HL,DISCTX
 1947 F2D5  CD EA55             CALL OUTTXT
 1948 F2D8  E1                  POP  HL
 1949 F2D9  C5          LF2C9:  PUSH BC
 1950 F2DA  E5                  PUSH HL
 1951 F2DB  01 0204             LD   BC,0204H
 1952 F2DE  CD F23C             CALL LF22C
 1953 F2E1  CD F25B             CALL RBYTE
 1954 F2E4  E1                  POP  HL
 1955 F2E5  C1                  POP  BC
 1956 F2E6  CB 6F               BIT  5,A
 1957 F2E8  28 E3               JR   Z,LF2BD
 1958 F2EA  36 90               LD   (HL),90H
 1959 F2EC  C9                  RET
 1960                   ;
 1961 F2ED  20 44 49 53 DISCTX: DEFM ' DISC?'
 1962 F2F3  08 08 08 08         DEFB 8,8,8,8,8,8
 1963 F2F9  00                  NOP
 1964                   ;
 1965                   ;
 1966                   ; Interrupteinsprung von CTC Kanal 3
 1967                   ;
 1968 F2FA  F3          ISRCTC: DI                ;DI hat gefehlt, wurde ergaenzt
 1969 F2FB  F5                  PUSH AF
 1970 F2FC  3A F43C             LD   A,(CTCCNT)   ;CTC-Zusatzzaehler lesen
 1971 F2FF  A7                  AND  A
 1972 F300  28 12               JR   Z,ISRCTE     ;bei "0", die Fkt. beenden
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  35
BIOS    ASM

 1973                           ;Beim Start von HRCPM wird CNTCNT per Interrupt von 255 auf 0 heruntergezaehlt.
 1974                           ;--> verzoegerte Steuerung von LATPU und LATCH
 1975 F302  3D                  DEC  A
 1976 F303  32 F43C             LD   (CTCCNT),A
 1977 F306  20 0C               JR   NZ,ISRCTE
 1978 F308  E5                  PUSH HL           ;Bei 2 MHz CPU-Takt wird nach 8 Sekunden diese Stelle erreicht
 1979 F309  21 F43D             LD   HL,LATPU
 1980 F30C  CB 86               RES  0,(HL)       ;Floppy-LW 0: Motor aus
 1981 F30E  CB 9E               RES  3,(HL)       ;Floppy-LW 1: Motor aus
 1982 F310  7E                  LD   A,(HL)
 1983 F311  D3 45               OUT  (LATCH),A    ;Latch auf dem Floppy-Controller ruecksetzen
 1984 F313  E1                  POP  HL
 1985 F314  F1          ISRCTE: POP  AF
 1986 F315  FB          INTEND: EI                ;ist zusaetzlich Einsprungpunkt fuer nicht genutzte Interrupts
 1987 F316  ED 4D               RETI
 1988                   ;
 1989                   ;-------------  R/W GIDE HW  -----------------------------------------------------------
 1990                   
 1991 F318  DB 8F       GIDERW: IN   A,(P8F)      ;Command / Status
 1992 F31A  17                  RLA               ;Bit 0 = CY
 1993 F31B  38 FB               JR   C,GIDERW     ;wait for hard disk ready (non-busy)
 1994 F31D  2E 19               LD   L,19H
 1995 F31F  CD F012             CALL LF002
 1996 F322  4F                  LD   C,A
 1997 F323  2A F454             LD   HL,(SEC3)
 1998 F326  23                  INC  HL
 1999 F327  AF                  XOR  A
 2000 F328  47                  LD   B,A
 2001 F329  3C          LF318:  INC  A
 2002 F32A  ED 42               SBC  HL,BC
 2003 F32C  28 02               JR   Z,LF31F
 2004 F32E  30 F9               JR   NC,LF318
 2005 F330  09          LF31F:  ADD  HL,BC
 2006 F331  3D                  DEC  A
 2007 F332  57                  LD   D,A
 2008 F333  5D                  LD   E,L
 2009 F334  2E 11               LD   L,11H
 2010 F336  CD F012             CALL LF002
 2011 F339  B2                  OR   D
 2012 F33A  D3 8E               OUT  (P8E),A      ;Drive and Head
 2013 F33C  7B                  LD   A,E
 2014 F33D  D3 8B               OUT  (P8B),A      ;Sector Number
 2015 F33F  23                  INC  HL
 2016 F340  5E                  LD   E,(HL)
 2017 F341  23                  INC  HL
 2018 F342  56                  LD   D,(HL)
 2019 F343  2A F452             LD   HL,(TRK3)
 2020 F346  19                  ADD  HL,DE
 2021 F347  7D                  LD   A,L
 2022 F348  D3 8C               OUT  (P8C),A      ;Cylinder Low
 2023 F34A  7C                  LD   A,H
 2024 F34B  D3 8D               OUT  (P8D),A      ;Cylinder High
 2025 F34D  3E 01               LD   A,01H
 2026 F34F  D3 8A               OUT  (P8A),A      ;Sector Count
 2027 F351  3A F45A             LD   A,(MERKRW)
 2028 F354  FE 06               CP   06H
 2029 F356  28 16               JR   Z,LF35D      ;6 = schreiben
 2030                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  36
BIOS    ASM

 2031                   ;  GIDE lesen 1 Sektor = 512 Bytes nach Puffer
 2032                   ;
 2033 F358  3E 20               LD   A,20H        ;Read Sector
 2034 F35A  D3 8F               OUT  (P8F),A      ;Command / Status
 2035 F35C  DB 8F       LF34B:  IN   A,(P8F)      ;Command / Status
 2036 F35E  CB 5F               BIT  3,A
 2037 F360  28 FA               JR   Z,LF34B      ;wait resp. DRQ active.
 2038 F362  2A F456             LD   HL,(DMA3)
 2039 F365  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2040 F368  ED B2               INIR
 2041 F36A  ED B2               INIR              ;512 bytes gesamt lesen
 2042 F36C  18 19               JR   LF376
 2043                   ;
 2044                   ;  GIDE schreiben 1 Sektor = 512 Bytes von Puffer
 2045                   ;
 2046 F36E  3E 30       LF35D:  LD   A,30H        ;Write Sector
 2047 F370  D3 8F               OUT  (P8F),A      ;Command / Status
 2048 F372  DB 8F       LF361:  IN   A,(P8F)      ;Command / Status
 2049 F374  17                  RLA               ;Bit 0 = CY
 2050 F375  38 FB               JR   C,LF361      ;wait for hard disk ready (non-busy)
 2051 F377  DB 8F       LF366:  IN   A,(P8F)      ;Command / Status
 2052 F379  CB 5F               BIT  3,A
 2053 F37B  28 FA               JR   Z,LF366      ;wait resp. DRQ active.
 2054 F37D  2A F456             LD   HL,(DMA3)
 2055 F380  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2056 F383  ED B3               OTIR             
 2057 F385  ED B3               OTIR              ;512 bytes gesamt schreiben 
 2058                   ;        
 2059 F387  DB 8F       LF376:  IN   A,(P8F)      ;Command / Status
 2060 F389  17                  RLA               ;Bit 0 = CY
 2061 F38A  38 FB               JR   C,LF376      ;wait for hard disk ready (non-busy)
 2062 F38C  DB 8F               IN   A,(P8F)      ;Command / Status
 2063 F38E  E6 89               AND  89H          ;10001001b - busy, DRQ, or error?
 2064 F390  C8                  RET  Z            ;no: all is fine, mit A=0
 2065 F391  3E FF               LD   A,0FFH
 2066 F393  32 F45F             LD   (DF51C),A
 2067 F396  C9                  RET               ;on errors, return with A=FFh
 2068                   ;
 2069                   ;-----------------  ENDE GIDE HW  ------------------------------------------
 2070                   ;
 2071 F397  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2072 F3B1  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2073 F3CB  43 4F 4E 4F CINSP:  DEFM "CONOUT-STACK_CONOUT-STACK_CONOUT-STACK"
 2074 F3F1  5A 42 49 4F COUTSP: DEFM "ZBIOS(C)ML-SOFT 2003 & AC1-BIOS(C)HR 2011"
 2075 F41A  00          CPMSTK: NOP
 2076                   ;
 2077                   ;******************************  Ende CP/M-Stack  ******************************
 2078                   ;
 2079 F41B  00          COLOR:  DEFB 0            ;Merkzelle aktuelle BWS-Farbe (0=Monochrom)
 2080 F41C  00          COLO1:  DEFB 0            ;aktuelle Farbe ohne invers und intensiv
 2081 F41D  00          COLO2:  DEFB 0            ;Farbe fuer Monitor und CP/M Warmstart
 2082                   ;
 2083 F41E  00          RAFTRK: DEFB 0            ;RAFTRK EQU 0F4C2H
 2084 F41F  00          RAFSEC: DEFB 0
 2085                   ;
 2086 F420  01          CUFLAG: DEFB 1            ;CUON/CUOFF  KursorFlag
 2087 F421  00          STZ00:  DEFB 0            ;Merkzelle Anz. BS-Steuerzeichen
 2088 F422  00          STZ01:  DEFB 0            ;Merkzelle fuer 1. ESC-Steuerzeichen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  37
BIOS    ASM

 2089 F423  00          STZ02:  DEFB 0            ;Merkzelle fuer 2. ESC-Steuerzeichen
 2090                   ;
 2091 F424  00          CHAR:   DEFB 0            ;Merkzelle Zeichen <> Cursor
 2092                   ;
 2093 F425  0000        SPCIN:  DEFW 0            ;Merkzelle Stackpointer waehrend CONIN
 2094 F427  0000        SPCOUT: DEFW 0            ;Merkzelle Stackpointer waehrend CONOUT
 2095 F429  0000        OLDNMI: DEFW 0            ;2 Bytes fuer alten NMI
 2096                   ;
 2097 F42B  00          DF4E2:  NOP
 2098 F42C  00          DF4E3:  NOP               ;Merkzelle
 2099 F42D  00          DF4E4:  NOP
 2100 F42E  00          DF4E5:  NOP
 2101 F42F  00          DF4E6:  NOP
 2102 F430  00          DF4E7:  NOP
 2103 F431  00          DF4E8:  NOP
 2104 F432  00          DF4E9:  NOP
 2105 F433  00          DF4EA:  NOP
 2106 F434  00          DF4EB:  NOP
 2107                   ;
 2108 F435  00          DF4EC:  NOP               ;4 Merkzellen  
 2109 F436  00                  NOP
 2110 F437  00          CTAB:   NOP               ;FDC Befehlsbyte
 2111 F438  00                  NOP               ;4 Merkzellen Ende
 2112                   ;
 2113 F439  00          DF4F0:  NOP
 2114 F43A  00          DF4F7:  NOP
 2115 F43B  00          DF4F8:  NOP
 2116 F43C  00          CTCCNT: DEFB 0            ;CTC-Counter - Zusatzzaehler fuer CTC-Interrupt
 2117 F43D  00          LATPU:  DEFB 0            ;Latch fuer den Floppy-Controler
 2118                   ;
 2119                   ;hier beginnt eine Bytefolge fuer Read/Write Operationen
 2120                   ;
 2121 F43E  04          RWBYTE: DEFB 4            ;4 = READ, 6 = WRITE
 2122 F43F  00          DRIVE:  DEFB 0            ;LW-Nr.
 2123 F440  0000        TRACK:  DEFW 0            ;akt. Track
 2124 F442  0000        SECTOR: DEFW 0            ;akt. Sektor
 2125 F444  0000        DMA:    DEFW 0            ;DMA-Adresse
 2126 F446  0000        DPH:    DEFW 0            ;akt. DPH
 2127                   ;
 2128 F448  00          DRV2:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2129 F449  0000        TRK2:   DEFW 0
 2130 F44B  0000        SEC2:   DEFW 0
 2131 F44D  0000        DMA2:   DEFW 0            ;DMA-Adresse
 2132 F44F  0000                DEFW 0
 2133                   ;
 2134 F451  00          DRV3:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2135 F452  0000        TRK3:   DEFW 0
 2136 F454  0000        SEC3:   DEFW 0
 2137 F456  0000        DMA3:   DEFW 0            ;DMA-Adresse
 2138 F458  0000        DPH3M:  DEFW 0            ;Merkzelle akt. DPH
 2139                   ;
 2140 F45A  04          MERKRW: DEFB 4            ;Merkzelle: 4 = READ, 6 = WRITE
 2141 F45B  0000        DF518:  DEFW 0
 2142 F45D  00          DF51A:  DEFB 0
 2143 F45E  00          DF51B:  DEFB 0
 2144 F45F  00          DF51C:  DEFB 0
 2145 F460  00          DF51D:  DEFB 0
 2146 F461  00          DF51E:  DEFB 0
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  38
BIOS    ASM

 2147                   ;
 2148 F462  00 00 00 00 DISKP:  DEFS 1024,0       ;HW-Sektor Puffer aller LW (1k max. fuer FDD)
 2149 F862  00 00 00 00 DIRBF:  DEFS 128,0        ;1 REC Puffer fuer Direktory
 2150 F8E2  00 00 00 00 ALL00:  DEFS 128,0        ;2048k(max.) / 2k / 8 = 128
 2151 F962  00 00 00 00 ALL01:  DEFS 50,0         ;0F99FH
 2152 F994  00 00 00 00 ALL02:  DEFS 504,0        ;0F9D1H
 2153 FB8C  00 00 00 00 ALL03:  DEFS 256,0        ;0FBC9H
 2154 FC8C  00 00 00 00 ALL04:  DEFS 256,0        ;0FCC9H
 2155 FD8C  00 00 00 00 ALL05:  DEFS 50,0         ;0FDC9H
 2156 FDBE  00 00 00 00 ALL06:  DEFS 50,0         ;0FDFBH
 2157 FDF0  00 00 00 00 CHK01:  DEFS 32,0         ;0FE2DH
 2158 FE10  00 00 00 00 CHK05:  DEFS 32,0         ;0FE4DH
 2159 FE30  00 00 00 00 CHK06:  DEFS 32,0         ;0FE6DH
 2160                   ;
 2161 FE50  42 49 4F 53         DEFM "BIOS-Ende"  ;nur fuer Frieder zur Info
 2162                   ;
 2163                   ;
 2164         FF80      DFF80   EQU  0FF80H       ;Interrupt-Einsprungpunkt CTC Kanal 0
 2165         FF82      DFF82   EQU  0FF82H       ;Interrupt-Einsprungpunkt CTC Kanal 1
 2166         FF84      DFF84   EQU  0FF84H       ;Interrupt-Einsprungpunkt CTC Kanal 2
 2167         FF86      DFF86   EQU  0FF86H       ;Interrupt-Einsprungpunkt CTC Kanal 3
 2168         FF88      DFF88   EQU  0FF88H       ;Interrupt-Einsprungpunkt Nr.1 PIO1A
 2169         FF8A      DFF8A   EQU  0FF8AH       ;Interrupt-Einsprungpunkt Nr.2 PIO1A
 2170                   ;
 2171                   ;******************************   PortAdressen   ******************************
 2172                   ;
 2173         0000      P00     EQU  00H          ;CTC Kanal 0
 2174         0001      P01     EQU  01H          ;CTC Kanal 1
 2175         0002      P02     EQU  02H          ;CTC Kanal 2
 2176         0003      P03     EQU  03H          ;CTC Kanal 3
 2177                   ;
 2178         0004      P04     EQU  04H          ;PIO_A-Daten
 2179         0005      P05     EQU  05H          ;PIO_B-Daten
 2180         0006      P06     EQU  06H          ;PIO_A-Control
 2181                   ;
 2182         001E      P1E     EQU  1EH          ;CP/M - Umschalter
 2183                   ;
 2184         008A      P8A     EQU  8AH          ;GIDE Sector Count
 2185         008B      P8B     EQU  8BH          ;GIDE Sector Number
 2186         008C      P8C     EQU  8CH          ;GIDE Cylinder Low
 2187         008D      P8D     EQU  8DH          ;GIDE Cylinder High
 2188         008E      P8E     EQU  8EH          ;GIDE Drive and Head
 2189         008F      P8F     EQU  8FH          ;GIDE Command/Status
 2190                   ;
 2191                           .DEPHASE
 2192                           END
 0 Error(s) Detected.
 6233 Absolute Bytes. 321 Symbols Detected.
         