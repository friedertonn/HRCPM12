Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   1
BIOS    ASM

    1                   ; ***********************************************************
    2                   ; *                                                         *
    3                   ; *  HRCPM12-BIOS fuer den AC1      Version vom 27.02.2024  *
    4                   ; *                                                         *
    5                   ; *                                                  V.142  *
    6                   ; *                                                         *
    7                   ; ***********************************************************
    8                   ;
    9                   ; Korrekturen/Fehlerbehebungen:
   10                   ; - alle nicht genutzten Programmteile (HRDOS12) entfernt
   11                   ; - (Turbo-)LOAD entfernt
   12                   ; - BWS (Farb-)Init geaendert
   13                   ; - ^G BEEP + PUNCH:=V24out + LIST:=V24out hinzugefuegt
   14                   ; - keine Pruefsumme, kein Vergleichslesen der RAM-Disk (entfernt)
   15                   ; - fehlerhafte Maskierung USER in WBOOT entfernt
   16                   ; - Kursorblinken im Texteditor
   17                   ; - Consolenkommandos Kursor-ON / Kursor-OFF
   18                   ; - RAM-Disk mit 64 REC/TRK, Systemspur auf 8K reduziert
   19                   ; - GIDE-Laufwerke (C:, D:, E:) auf 8MByte verkleinert
   20                   ; - Formatierung RAM-Disk: letzter Sektor wurde nicht formatiert
   21                   ; - ISR angepasst, damit HRCPM12 mit JKCEMU V0.9.8.3 funktioniert
   22                   ;
   23                   ; Neu hinzugekommen:
   24                   ; - EXIT loescht CCPPUFLEN (V.132)
   25                   ; - WBOOT loescht CCPPUFLEN, weil in Systemspur "aktiver Befehl" (V.133)
   26                   ; - Eintragen von NMI auf 066h in BOOT1 entfernt (CPM Page-Zero) (V.133)
   27                   ; - Tastaturpuffer von FFD0h -> FF00h, "d"-Befehl ueberschrieben (V.134)
   28                   ; - nicht benutzte RAM-Zellen am Ende auskommentiert (V.135)
   29                   ; - automatische Erkennung der RAM-Disk 256k/512k/1024k/2048k (V.140)
   30                   ; - Cnderungen an READ_CCP (V.142)
   31                   ;
   32                   ;
   33                           .CREF
   34                           .Z80
   35                   ;
   36                           .PHASE 0E600H
   37                   ;
   38                   ;
   39         07F1      OUTHL   EQU  07F1H
   40         01A5      RSA     EQU  01A5H        ;CPU-Register nach RSA - nicht Monitor 11 !
   41         05CE      REGIST  EQU  05CEH        ;Registeranzeige - nicht Monitor 11 !
   42         0DF9      MV24A   EQU  0DF9H        ;MO-UP V24-Out
   43                   ;
   44                   ;
   45         1800      CUPOS   EQU  1800H
   46         1818      BREAK   EQU  1818H        ;NMI Sprungziel
   47         181F      CBWSB   EQU  181FH        ;Merkzelle fuer das Farbbyte im AC1-Monitor 
   48                   ;                         ;0=kein Color-BWS, sonst der eingestellte Farbwert
   49         185B      ARG1    EQU  185BH
   50         185D      ARG2    EQU  185DH
   51                   ;
   52                   ;
   53         0000      WARMBT  EQU  0000H        ;WBOOT der Grundseite
   54         0005      BDOSF   EQU  0005H        ;BDOS-Aufruf + TPA-MAX
   55         0038      RST38   EQU  0038H        ;CP/M-Break
   56         0066      NMI     EQU  0066H
   57                   ;
   58                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   2
BIOS    ASM

   59         0003      IOBYTE  EQU  0003H
   60         0004      LWBYTE  EQU  0004H        ;LW (Bit0-3) + USER Nr.(Bit4-7)
   61                   ;
   62         FF00      ZEIPUF  EQU  0FF00H       ;1 + 32 Byte Puffer fuer Tastatur
   63                   ;                          --> war urspruenlich auf 0FFD0H
   64                   ;                          --> ueberschreibt den "d"-Befehl
   65                   ;
   66         D806      BDOS    EQU  0D806H       ;BDOS-EinsprungAdresse
   67         E603      WBOOTB  EQU  0E603H       ;BIOS-Eisprung WBOOT
   68                   ;
   69                   ;
   70         C000      HPRDSK  EQU  0C000H       ;Hilfsprogramm: Format RAM-Disk
   71         D000      CCP     EQU  0D000H       ;Start CCP
   72         D007      COMLEN  EQU  CCP+07       ;CCP-Kommandopuffer-Laenge
   73                   ;
   74         00E0      PE0     EQU  0E0H         ;Grundadresse der RAM-Disk
   75         00F0      PF0     EQU  0F0H         ;BWS-CPLD-(Steuer)Port
   76                   ;
   77         0040      CFDC    EQU  40H          ;Hauptstatusregister FDC
   78         0041      DFDC    EQU  41H          ;Datenport FDC
   79         0043      FLWAIT  EQU  43H          ;IO-Adr. /WAIT Monoflop
   80         0045      LATCH   EQU  45H          ;IO-Adr. Latch 74LS175
   81                   ;
   82         000F      CUZEI   EQU  0FH          ;KursorSymbol
   83                   ;
   84                   ;******************************   Sprungverteiler   ******************************
   85                   ;
   86 E600  C3 E878             JP   BOOT
   87 E603  C3 E944             JP   WBOOT
   88 E606  C3 EA5F             JP   CONST
   89 E609  C3 EA67             JP   CONIN
   90 E60C  C3 EADF             JP   CONOUT
   91 E60F  C3 EAB6             JP   LIST
   92 E612  C3 EAD2             JP   PUNCH
   93 E615  C3 EA67             JP   CONIN        ;eigentlich JP READER
   94 E618  C3 EE14             JP   HOME
   95 E61B  C3 EDF5             JP   SELDSK
   96 E61E  C3 EE17             JP   SETTRK
   97 E621  C3 EE1C             JP   SETSEC
   98 E624  C3 EE21             JP   SETDMA
   99 E627  C3 EE32             JP   READ
  100 E62A  C3 EE37             JP   WRITE
  101 E62D  C3 EDF2             JP   LISTST
  102 E630  C3 EE26             JP   SECTRN
  103                   ;
  104 E633  43 38 35 41         DEFM 'C85AC'      ;fuer PC/BC Progr.
  105 E638  C3 E9D0             JP   EXIT         ;User-Kommando EXIT
  106 E63B  C3 F005             JP   LOAD         ;User-Kommando LOAD
  107 E63E  C3 0000             JP   0000H
  108                   ;
  109 E641  07          NDISK:  DEFB 7            ;Anzahl der LW = 7
  110                   ;
  111 E642  E644        DPHX:   DEFW DPHY         ;Zeiger auf den 1. Block?
  112 E644  E652        DPHY:   DEFW DPH0         ;DPH von LW A:
  113 E646  E662                DEFW DPH1         ;DPH von LW B:
  114 E648  E672                DEFW DPH2         ;DPH von LW C:
  115 E64A  E682                DEFW DPH3         ;DPH von LW D:
  116 E64C  E692                DEFW DPH4         ;DPH von LW E:
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   3
BIOS    ASM

  117 E64E  E6A2                DEFW DPH5         ;DPH von LW F:
  118 E650  E6B2                DEFW DPH6         ;DPH von LW G:
  119                   ;
  120 E652  0000        DPH0:   DEFW 0            ;RAM-Disk A:
  121 E654  0000                DEFW 0
  122 E656  0000                DEFW 0
  123 E658  0000                DEFW 0
  124 E65A  F85E                DEFW DIRBF
  125 E65C  E6C4                DEFW DPB0
  126 E65E  0000                DEFW 0            ;weil nichtwechselbares Medium
  127 E660  F8DE                DEFW ALL00
  128                   ;
  129 E662  0000        DPH1:   DEFW 0            ;Floppy B:
  130 E664  0000                DEFW 0
  131 E666  0000                DEFW 0
  132 E668  0000                DEFW 0
  133 E66A  F85E                DEFW DIRBF
  134 E66C  E6D5                DEFW DPB1
  135 E66E  FDEC                DEFW CHK01
  136 E670  F95E                DEFW ALL01
  137                   ;
  138 E672  0000        DPH2:   DEFW 0            ;GIDE C:
  139 E674  0000                DEFW 0
  140 E676  0000                DEFW 0
  141 E678  0000                DEFW 0
  142 E67A  F85E                DEFW DIRBF
  143 E67C  E6F1                DEFW DPB2
  144 E67E  0000                DEFW 0            ;weil nichtwechselbares Medium
  145 E680  F990                DEFW ALL02
  146                   ;
  147 E682  0000        DPH3:   DEFW 0            ;GIDE D:
  148 E684  0000                DEFW 0
  149 E686  0000                DEFW 0
  150 E688  0000                DEFW 0
  151 E68A  F85E                DEFW DIRBF
  152 E68C  E70D                DEFW DPB3
  153 E68E  0000                DEFW 0            ;weil nichtwechselbares Medium
  154 E690  FB88                DEFW ALL03
  155                   ;
  156 E692  0000        DPH4:   DEFW 0            ;GIDE E:
  157 E694  0000                DEFW 0
  158 E696  0000                DEFW 0
  159 E698  0000                DEFW 0
  160 E69A  F85E                DEFW DIRBF
  161 E69C  E729                DEFW DPB4
  162 E69E  0000                DEFW 0            ;weil nichtwechselbares Medium
  163 E6A0  FC88                DEFW ALL04
  164                   ;
  165 E6A2  0000        DPH5:   DEFW 0            ;Floppy F:
  166 E6A4  0000                DEFW 0
  167 E6A6  0000                DEFW 0
  168 E6A8  0000                DEFW 0
  169 E6AA  F85E                DEFW DIRBF
  170 E6AC  E745                DEFW DPB5
  171 E6AE  FE0C                DEFW CHK05
  172 E6B0  FD88                DEFW ALL05
  173                   ;
  174 E6B2  0000        DPH6:   DEFW 0            ;Floppy G:
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   4
BIOS    ASM

  175 E6B4  0000                DEFW 0
  176 E6B6  0000                DEFW 0
  177 E6B8  0000                DEFW 0
  178 E6BA  F85E                DEFW DIRBF
  179 E6BC  E761                DEFW DPB6
  180 E6BE  FE2C                DEFW CHK06
  181 E6C0  FDBA                DEFW ALL06
  182                   ;
  183                   ; https://hc-ddr.hucki.net/wiki/doku.php/cpm/write_a_bios/teil_1
  184                   ;
  185                   ;RAM-Disk 256 KByte  LW A:
  186                   ;
  187 E6C2  EE5E                DEFW RWRDSK       ;Routine zum Lesen/Schreiben der RAM-Disk
  188                   ;
  189 E6C4  0040        DPB0:   DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  190 E6C6  03                  DEFB 3            ;Blockgroesse = 1 Kbyte
  191 E6C7  07                  DEFB 7
  192 E6C8  00                  DEFB 0            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  193 E6C9  00F7                DEFW 247          ;248 * 1 Kbyte-Bloecke  -> 256k-8k(System)=248k(CP/M) ( - 2k(DIR) -> 246k (NETTO f. Daten))
  194 E6CB  003F                DEFW 63           ;64 DIR - Eintaege
  195 E6CD  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  196 E6CF  0000                DEFW 0            ;weil nichtwechselbares Medium
  197 E6D1  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  198                   ;
  199                   ;Floppy 780 KByte  LW B:
  200                   ;
  201 E6D3  F025                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  202                   ;
  203 E6D5  0050        DPB1:   DEFW 80           ;80 Sectoren/Track
  204 E6D7  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  205 E6D8  0F                  DEFB 15
  206 E6D9  00                  DEFB 0
  207 E6DA  0185                DEFW 389          ;390 * 2 Kbyte - Bloecke
  208 E6DC  007F                DEFW 127          ;128 DIR - Eintraege
  209 E6DE  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  210 E6E0  0020                DEFW 32
  211 E6E2  0002                DEFW 2            ;20 Kbyte System
  212                   ;
  213 E6E4  03 07 05 25         DEFB 3,7,5,25H
  214 E6E8  50 00 43 FF         DEFB 50H,0,43H,0FFH
  215 E6EC  E1 33 FF            DEFB 0E1H,33H,0FFH
  216                   ;
  217                   ;GIDE 8 MByte  LW C:
  218                   ;
  219 E6EF  F021                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  220                   ;
  221 E6F1  0800        DPB2:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  222 E6F3  05                  DEFB 5
  223 E6F4  1F                  DEFB 31           ;4k Bloecke
  224 E6F5  01                  DEFB 1            ;16-Bit Blockadressen im FCB/DIR
  225 E6F6  07BF                DEFW 1983         ;1984 * 4k-Bloecke = 7936k
  226 E6F8  07FF                DEFW 2047         ;2048 DIR-Eintraege
  227 E6FA  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke = 64 k
  228 E6FC  0000                DEFW 0            ;weil nichtwechselbares Medium
  229 E6FE  0001                DEFW 1            ;1 Trk = 256k System
  230                   ;
  231 E700  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  232 E703  000A                DEFW 000AH        ;10 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   5
BIOS    ASM

  233 E705  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  234 E707  03D8                DEFW 03D8H        ;984 Zylinder HDD
  235 E709  10                  DEFB 10H          ;16 Koepfe HDD
  236 E70A  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  237                   ;
  238                   ;GIDE 8 MByte  LW D:
  239                   ;
  240 E70B  F021                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  241                   ;
  242 E70D  0800        DPB3:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  243 E70F  06                  DEFB 6
  244 E710  3F                  DEFB 63           ;8k Bloecke
  245 E711  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  246 E712  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  247 E714  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  248 E716  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  249 E718  0000                DEFW 0            ;weil nichtwechselbares Medium
  250 E71A  0000                DEFW 0            ;kein System-Track
  251                   ;
  252 E71C  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  253 E71F  0096                DEFW 0096H        ;150 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  254 E721  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  255 E723  03D8                DEFW 03D8H        ;984 Zylinder HDD
  256 E725  10                  DEFB 10H          ;16 Koepfe HDD
  257 E726  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  258                   ;
  259                   ;GIDE 8 MByte  LW E:
  260                   ;
  261 E727  F021                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  262                   ;
  263 E729  0800        DPB4:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  264 E72B  06                  DEFB 6
  265 E72C  3F                  DEFB 63           ;8k Bloecke
  266 E72D  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  267 E72E  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  268 E730  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  269 E732  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  270 E734  0000                DEFW 0            ;weil nichtwechselbares Medium
  271 E736  0000                DEFW 0            ;kein System-Track
  272                   ;
  273 E738  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  274 E73B  012C                DEFW 012CH        ;300 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  275 E73D  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  276 E73F  03D8                DEFW 03D8H        ;984 Zylinder HDD
  277 E741  10                  DEFB 10H          ;16 Koepfe HDD
  278 E742  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  279                   ;
  280                   ;Floppy 640 KByte  LW F:
  281                   ;
  282 E743  F025                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  283                   ;
  284 E745  0040        DPB5:   DEFW 64           ;64 Sectoren/Track
  285 E747  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  286 E748  0F                  DEFB 15
  287 E749  00                  DEFB 0
  288 E74A  013F                DEFW 319          ;320 * 2 Kbyte - Bloecke
  289 E74C  007F                DEFW 127          ;128 DIR - Eintraege
  290 E74E  00C0                DEFW 0C0H         ;2 DIR-Bloecke
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   6
BIOS    ASM

  291 E750  0020                DEFW 32
  292 E752  0000                DEFW 0            ;kein System-Track
  293                   ;
  294 E754  01 01 10 14         DEFB 1,1,10H,14H
  295 E758  50 00 43 FF         DEFB 50H,0,43H,0FFH
  296 E75C  E1 33 FF            DEFB 0E1H,33H,0FFH
  297                   ;
  298                   ;Floppy 800 KByte  LW G:
  299                   ;
  300 E75F  F025                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  301                   ;
  302 E761  0050        DPB6:   DEFW 80           ;80 Sectoren/Track
  303 E763  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  304 E764  0F                  DEFB 15
  305 E765  00                  DEFB 0
  306 E766  018F                DEFW 399          ;400 * 2 Kbyte - Bloecke
  307 E768  007F                DEFW 127          ;128 DIR - Eintraege
  308 E76A  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  309 E76C  0020                DEFW 32
  310 E76E  0000                DEFW 0            ;kein System-Track
  311                   ;
  312 E770  03 07 05 25         DEFB 3,7,5,25H
  313 E774  50 01 43 FF         DEFB 50H,1,43H,0FFH
  314 E778  E1 33 FF            DEFB 0E1H,33H,0FFH
  315                   ;
  316                   ;RAM-Disk 512 KByte  LW A:
  317 E77B  0040        DP512:  DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  318 E77D  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  319 E77E  0F                  DEFB 15
  320 E77F  01                  DEFB 1            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  321 E780  00FB                DEFW 251          ;252 * 2 Kbyte-Bloecke  -> 512k-8k(System)=504k(CP/M) ( - 2k(DIR) -> 502k (NETTO f. Daten))
  322 E782  003F                DEFW 63           ;64 DIR - Eintaege
  323 E784  0080                DEFW 080H         ;1 DIR-Block
  324 E786  0000                DEFW 0            ;weil nichtwechselbares Medium
  325 E788  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  326                   ;
  327                   ;RAM-Disk 1024 KByte  LW A:
  328 E78A  0040        DP1024: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  329 E78C  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  330 E78D  0F                  DEFB 15
  331 E78E  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  332 E78F  01FB                DEFW 507          ;508 * 2 Kbyte-Bloecke  -> 1024k-8k(System)=1016k(CP/M) ( - 4k(DIR) -> 1012k (NETTO f. Daten))
  333 E791  007F                DEFW 127          ;128 DIR - Eintraege -> bei 64 DIR-Eintraegen bekommt man die RAM-Disk nicht voll
  334 E793  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  335 E795  0000                DEFW 0            ;weil nichtwechselbares Medium
  336 E797  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  337                   ;
  338                   ;RAM-Disk 2048 KByte  LW A:
  339 E799  0040        DP2048: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  340 E79B  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  341 E79C  0F                  DEFB 15
  342 E79D  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  343 E79E  03FB                DEFW 1019         ;1020 * 2 Kbyte-Bloecke  -> 2048k-8k(System)=2040k(CP/M) ( - 8k(DIR) -> 2032k (NETTO f. Daten))
  344 E7A0  00FF                DEFW 255          ;256 DIR - Eintraege
  345 E7A2  00F0                DEFW 0F0H         ;4 DIR-Bloecke
  346 E7A4  0000                DEFW 0            ;weil nichtwechselbares Medium
  347 E7A6  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  348                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   7
BIOS    ASM

  349 E7A8  0C          TXT01:  DEFB 0CH
  350 E7A9  48 52 43 50         DEFM "HRCPM AC1 V1.2 CPA "
  351 E7BC  31 31 2E 30         DEFM "11.01.89 FA-MODE "
  352 E7CD  76 6F 6D 20         DEFM "vom 27.02.2024 V.142"
  353 E7E1  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  354 E7E5  47 49 44 45         DEFM "GIDE(80H) C0:8MB,"
  355 E7F6  20 20 20 44         DEFM "   D0: 8MB   E0: 8MB"
  356 E80A  0D 0A               DEFB 0DH,0AH
  357 E80C  46 44 43 20         DEFM "FDC (45H) B0:5*1024"   ;B0 --> Floppy-Drive 0,
  358 E81F  20 46 30 3A         DEFM " F0:16*256 G1:5*1024"  ;F0 --> Floppy-Drive 0, G1 --> Floppy-Drive 1
  359 E833  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  360 E837  52 46 4C 20         DEFM "RFL Praeci.Port E0H"
  361 E84A  20 41 3A 20         DEFM " A: "
  362 E84E  00                  DEFB 0
  363 E84F  32 35 36 6B TXT01A: DEFM "256k"
  364 E853  00                  DEFB 0
  365 E854  35 31 32 6B TXT01B: DEFM "512k"
  366 E858  00                  DEFB 0
  367 E859  31 30 32 34 TXT01C: DEFM "1024k"
  368 E85E  00                  DEFB 0
  369 E85F  32 30 34 38 TXT01D: DEFM "2048k"
  370 E864  00                  DEFB 0
  371 E865  20 2D 2D 3E TXT02:  DEFM " --> Format A:(J)?"
  372 E877  00                  DEFB 0
  373                   ;
  374                   ;******************************   BOOT   ******************************
  375                   ;
  376 E878  F3          BOOT:   DI
  377 E879  31 F416             LD   SP,CPMSTK
  378 E87C  AF                  XOR  A
  379 E87D  D3 1E               OUT  (P1E),A      ;zwingend AC1-Mode !!
  380 E87F  32 F439             LD   (LATPU),A    ;FDC-Latch zuruecksetzen
  381 E882  CD EDBC             CALL BWSINI
  382 E885  DB 05               IN   A,(P05)
  383 E887  CB 9F               RES  3,A          ;ACC-Zeichensatz ein (PIO1B, Bit3)
  384 E889  D3 05               OUT  (P05),A
  385 E88B  2A 1818             LD   HL,(BREAK)   ;Sprungtabelle NMI Monitor
  386 E88E  22 F425             LD   (OLDNMI),HL  ;sichern
  387 E891  21 E603             LD   HL,WBOOTB    ;CP/M-Warmstart-Einsprungadresse
  388 E894  22 1818             LD   (BREAK),HL
  389 E897  CD E9C5             CALL CPMMOD
  390 E89A  AF                  XOR  A
  391 E89B  32 F459             LD   (DF51A),A
  392 E89E  32 0003             LD   (IOBYTE),A
  393 E8A1  32 0004             LD   (LWBYTE),A
  394 E8A4  32 FF00             LD   (ZEIPUF),A   ;Init. Tastaturpuffer
  395 E8A7  CD E9A1             CALL BOOT1        ;CP/M "Grundseite" INIT
  396                   ;
  397 E8AA  3E 03               LD   A,03H        ;CTC init. + Interrupt abgeschaltet
  398 E8AC  D3 00               OUT  (P00),A
  399 E8AE  D3 01               OUT  (P01),A
  400 E8B0  D3 02               OUT  (P02),A
  401 E8B2  D3 03               OUT  (P03),A
  402 E8B4  3E FF               LD   A,0FFH       ;HWT vom Interruptvektor 0FF80h ff.
  403 E8B6  ED 47               LD   I,A
  404 E8B8  ED 5E               IM   2            ;Interrupt freigeben
  405 E8BA  21 F311             LD   HL,INTEND    ;Adresse Einsprungpunkt fuer nicht verwendete Interrupts
  406 E8BD  22 FF80             LD   (DFF80),HL   ;Prog. Einsprung IV fuer CTC-Kanal 0
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   8
BIOS    ASM

  407 E8C0  22 FF82             LD   (DFF82),HL   ;Prog. Einsprung IV fuer CTC-Kanal 1
  408 E8C3  22 FF84             LD   (DFF84),HL   ;Prog. Einsprung IV fuer CTC-Kanal 2
  409 E8C6  21 F2F6             LD   HL,ISRCTC    ;Einsprungpunkt CTC-Interrupt - Steuerung Nachlauf Floppy-LW
  410 E8C9  22 FF86             LD   (DFF86),HL   ;Prog. Einsprung IV fuer CTC-Kanal 3
  411 E8CC  3E 80               LD   A,80H
  412 E8CE  D3 00               OUT  (P00),A      ;CTC-Interruptadresse NWT (= 80h) eintragen
  413 E8D0  3E FF               LD   A,0FFH
  414 E8D2  32 F438             LD   (CTCCNT),A   ;Init. CTC-Counter = 255 --> Zusatzzaehler fuer CTC-Interrupt
  415 E8D5  3E A7               LD   A,0A7H
  416 E8D7  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 als Zeitgeber mit Interrupt, Vorteiler 256
  417 E8D9  AF                  XOR  A
  418 E8DA  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 - Hauptteiler = 256
  419                                             ;d.h. bei 2 MHz CPU-Takt wird alle 33ms ein CTC-Interrupt ausgeloest
  420                   ;
  421 E8DC  21 E9F5             LD   HL,ISRTAS    ;1. Einsprungpunkt PIO-Interrupt --> Taste in Tastaturpuffer schreiben
  422 E8DF  22 FF88             LD   (DFF88),HL   ;auf 0FF88h eintragen
  423 E8E2  01 0506             LD   BC,0506H     ;5 Bytes auf Controlkanal PIO1 A
  424 E8E5  21 EA4A             LD   HL,PIOTAB
  425 E8E8  ED B3               OTIR              ;PIO1_A Init. fuer 1. Einsprungpunkt
  426                   ;
  427 E8EA  21 E7A8             LD   HL,TXT01     ;Begruessungstext
  428 E8ED  CD EA4F             CALL OUTTXT
  429                   ;
  430 E8F0  CD EEB9             CALL RDTEST       ;Kapazitaet der RAM-Disk bestimmen
  431 E8F3  21 EF19             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
  432 E8F6  7E                  LD   A,(HL)
  433 E8F7  21 E799             LD   HL,DP2048    ;DPB 2048K RAM-Disk
  434 E8FA  FE 03               CP   3
  435 E8FC  28 10               JR   Z,BOOT2
  436 E8FE  21 E78A             LD   HL,DP1024    ;DPB 1024K RAM-Disk
  437 E901  FE 02               CP   2
  438 E903  28 09               JR   Z,BOOT2
  439 E905  21 E77B             LD   HL,DP512     ;DPB 512K RAM-Disk
  440 E908  FE 01               CP   1
  441 E90A  28 02               JR   Z,BOOT2
  442 E90C  18 08               JR   BOOT3        ;256K RAM-Disk, nichts kopieren
  443                   ;        
  444 E90E  11 E6C4     BOOT2:  LD   DE,DPB0
  445 E911  01 000F             LD   BC,15
  446 E914  ED B0               LDIR
  447 E916  21 E85F     BOOT3:  LD   HL,TXT01D    ;2048k
  448 E919  FE 03               CP   3
  449 E91B  28 11               JR   Z,BOOT4
  450 E91D  21 E859             LD   HL,TXT01C    ;1024k
  451 E920  FE 02               CP   2
  452 E922  28 0A               JR   Z,BOOT4
  453 E924  21 E854             LD   HL,TXT01B    ;512k
  454 E927  FE 01               CP   1
  455 E929  28 03               JR   Z,BOOT4
  456 E92B  21 E84F             LD   HL,TXT01A    ;256k
  457 E92E  CD EA4F     BOOT4:  CALL OUTTXT
  458 E931  21 E865             LD   HL,TXT02     ;Formatieren? (J)
  459 E934  CD EA4F             CALL OUTTXT
  460 E937  FB                  EI
  461 E938  CD EA67             CALL CONIN
  462 E93B  CB AF               RES  5,A          ;Upcase
  463 E93D  FE 4A               CP   4AH          ;J --> RAM-Disk formatieren
  464 E93F  CA EF1A             JP   Z,RDFORM
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   9
BIOS    ASM

  465                   ;       LD   HL,6000H     ;FC64.COM von 6000h nach 100h kopieren
  466                   ;       LD   DE,0100H
  467                   ;       LD   BC,5880H     ;5880h Bytes
  468                   ;       LDIR
  469 E942  18 1C               JR   WBOOT1       ;READCCP ueberspringen
  470                   ;
  471                   ;******************************   WBOOT   ******************************
  472                   ;
  473 E944  31 F416     WBOOT:  LD   SP,CPMSTK
  474 E947  CD E9C5             CALL CPMMOD
  475 E94A  3A F45A             LD   A,(DF51B)
  476 E94D  B7                  OR   A
  477 E94E  C4 F0DA             CALL NZ,LF0CE
  478 E951  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
  479 E953  21 EE32             LD   HL,READ
  480 E956  22 EFAD             LD   (WRCCP2),HL
  481 E959  CD EF93             CALL WRCCP        ;hier READ_CCP!
  482                   ;       LD   HL,WRITE
  483                   ;       LD   (WRCCP2),HL
  484 E95C  AF                  XOR  A
  485 E95D  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  486                   ;
  487 E960  CD E9A1     WBOOT1: CALL BOOT1        ;CP/M "Grundseite" INIT
  488 E963  3E 01               LD   A,01H        ;Kursor einschalten
  489 E965  32 F41C             LD   (CUFLAG),A
  490 E968  3A F419             LD   A,(COLO2)
  491 E96B  32 F417             LD   (COLOR),A    ;Arbeitszelle Farbbyte
  492 E96E  E6 77               AND  77H          ;Intensivdarstellung maskieren
  493 E970  32 F418             LD   (COLO1),A    ;Arbeitszelle "Normaldarstellung"
  494 E973  3A 0004             LD   A,(LWBYTE)
  495 E976  4F                  LD   C,A
  496 E977  CD EDF5             CALL SELDSK
  497 E97A  C3 D000             JP   CCP          ;hier beginnt die Party
  498                   ;
  499 E97D  F5          CPMERR: PUSH AF           ;CP/M-Fehler - zurueck z. Monitor
  500 E97E  E5                  PUSH HL
  501 E97F  CD E9D4             CALL EXIT1
  502 E982  DF                  RST  18H
  503 E983  0D                  DEFB 0DH
  504 E984  43 50 2F 4D         DEFM "CP/M-Fehler:"
  505 E990  A0                  DEFB 20H+80H
  506 E991  E1                  POP  HL
  507 E992  F1                  POP  AF
  508 E993  CD 01A5             CALL RSA          ;CPU-Register nach RSA - nicht Monitor 11 !
  509 E996  E1                  POP  HL
  510 E997  2B                  DEC  HL
  511 E998  CD 07F1             CALL OUTHL
  512 E99B  DF                  RST  18H
  513 E99C  8D                  DEFB 0DH+80H
  514 E99D  CD 05CE             CALL REGIST       ;Monitor - Registeranzeige - nicht Monitor 11 !
  515 E9A0  FF                  RST  38H          ;zurueck zum Monitor
  516                   ;
  517 E9A1  3E C3       BOOT1:  LD   A,0C3H       ;CP/M "Grundseite" INIT
  518 E9A3  32 0000             LD   (WARMBT),A
  519 E9A6  32 0005             LD   (BDOSF),A
  520 E9A9  32 0038             LD   (RST38),A
  521 E9AC  21 E603             LD   HL,WBOOTB
  522 E9AF  22 0001             LD   (WARMBT+1),HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  10
BIOS    ASM

  523 E9B2  21 D806             LD   HL,BDOS
  524 E9B5  22 0006             LD   (BDOSF+1),HL
  525 E9B8  21 E97D             LD   HL,CPMERR
  526 E9BB  22 0039             LD   (RST38+1),HL
  527 E9BE  21 0080             LD   HL,0080H
  528 E9C1  22 F440             LD   (DMA),HL
  529 E9C4  C9                  RET
  530                   ;
  531                   ;******************************   Ende BOOT / WBOOT   ******************************
  532                   ;
  533 E9C5  F5          CPMMOD: PUSH AF           ;CP/M EIN
  534 E9C6  3E 01               LD   A,01H
  535 E9C8  18 02               JR   MOD1
  536                   ;
  537 E9CA  F5          AC1MOD: PUSH AF           ;CP/M AUS (AC1-Mode)
  538 E9CB  AF                  XOR  A
  539 E9CC  D3 1E       MOD1:   OUT  (P1E),A
  540 E9CE  F1                  POP  AF
  541 E9CF  C9                  RET
  542                   ;
  543                   ;--------------------------------------------------------------------------
  544                   ;
  545                   ;EXIT - Routine
  546                   ;
  547 E9D0  21 0000     EXIT:   LD   HL,0000H     ;Ruecksprungadresse fuer RET
  548 E9D3  E5                  PUSH HL
  549 E9D4  AF          EXIT1:  XOR  A            ;Einsprung aus CPMERR
  550 E9D5  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  551 E9D8  D3 1E               OUT  (P1E),A      ;AC1-Mode
  552 E9DA  2A F425             LD   HL,(OLDNMI)
  553 E9DD  22 1818             LD   (BREAK),HL   ;alten NMI wiederherstellen
  554 E9E0  3E 03               LD   A,03H
  555 E9E2  D3 00               OUT  (P00),A      ;CTC: Interrupts ausschalten
  556 E9E4  D3 01               OUT  (P01),A
  557 E9E6  D3 02               OUT  (P02),A
  558 E9E8  D3 03               OUT  (P03),A
  559 E9EA  D3 06               OUT  (P06),A      ;PIO1 A: Interrupt auschalten
  560 E9EC  3E CF               LD   A,0CFH
  561 E9EE  D3 06               OUT  (P06),A      ;PIO1 A: "Mode 3" + "Set Mode"
  562 E9F0  3E FF               LD   A,0FFH
  563 E9F2  D3 06               OUT  (P06),A      ;PIO1 A: PA0 bis PA7 sind Eingaenge
  564 E9F4  C9                  RET               ;zurueck zum Monitor
  565                   ;
  566                   ;
  567                   ;Interrupt-Einsprung fuer die Tastatur
  568                   ;
  569 E9F5  F3          ISRTAS: DI
  570 E9F6  F5                  PUSH AF
  571 E9F7  C5                  PUSH BC
  572 E9F8  E5                  PUSH HL
  573 E9F9  DB 04               IN   A,(P04)      ;PIO_A abfragen
  574 E9FB  CB 7F               BIT  7,A          ;Taste gedrueckt?
  575 E9FD  28 45               JR   Z,ISREND     ;nein, ISR beenden
  576 E9FF  4F                  LD   C,A
  577                   ;
  578 EA00  06 1E               LD   B,1EH        ;Tastaturentprellung
  579 EA02  DB 04       PRELL1: IN   A,(P04)
  580 EA04  B9                  CP   C
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  11
BIOS    ASM

  581 EA05  20 3D               JR   NZ,ISREND
  582 EA07  10 F9               DJNZ PRELL1       ;30 Durchlaeufe
  583                   ;
  584 EA09  FE 80               CP   80H
  585 EA0B  28 37               JR   Z,ISREND     ;das war eine NULL-Eingabe
  586                   ;
  587 EA0D  4F                  LD   C,A
  588 EA0E  21 FF00             LD   HL,ZEIPUF
  589 EA11  7E                  LD   A,(HL)       ;Fuellstand Zeichenpuffer
  590 EA12  3C                  INC  A
  591 EA13  FE 1F               CP   1FH          ;Puffer voll?
  592 EA15  28 2D               JR   Z,ISREND
  593 EA17  77                  LD   (HL),A       ;Anzahl der Zeichen rueckschreiben
  594 EA18  C5                  PUSH BC
  595 EA19  06 00               LD   B,0
  596 EA1B  4F                  LD   C,A
  597 EA1C  09                  ADD  HL,BC        ;HL = Position im Zeichenpuffer
  598 EA1D  C1                  POP  BC
  599 EA1E  CB B9               RES  7,C          ;7. Bit loeschen und
  600 EA20  71                  LD   (HL),C       ;Taste in Zeichenpuffer eintragen
  601                   ;
  602                   ;       LD   BC,8034H     ;Initialisierung Tastenpiep --> 2 MHz
  603 EA21  01 8068             LD   BC,8068H     ;Initialisierung Tastenpiep --> 4 MHz
  604 EA24  79          BEEP1:  LD   A,C
  605 EA25  3D          BEEP2:  DEC  A
  606 EA26  20 FD               JR   NZ,BEEP2
  607 EA28  DB 05               IN   A,(P05)      ;PIO_B-Daten
  608 EA2A  EE 01               XOR  01H          ;Tastenpiep
  609 EA2C  D3 05               OUT  (P05),A
  610 EA2E  10 F4               DJNZ BEEP1
  611 EA30  E6 FE               AND  0FEH
  612 EA32  D3 05               OUT  (P05),A
  613                   ;
  614 EA34  01 0200             LD   BC,0200H     ;Tastaturentprellung
  615 EA37  0B          PRELL2: DEC  BC
  616 EA38  78                  LD   A,B
  617 EA39  B1                  OR   C
  618 EA3A  20 FB               JR   NZ,PRELL2
  619                   ;
  620 EA3C  3E B7               LD   A,0B7H       ;weitere Interrupts loeschen
  621 EA3E  D3 06               OUT  (P06),A
  622 EA40  3E 7F               LD   A,7FH
  623 EA42  D3 06               OUT  (P06),A
  624                   ;
  625 EA44  E1          ISREND: POP  HL
  626 EA45  C1                  POP  BC
  627 EA46  F1                  POP  AF
  628 EA47  FB                  EI
  629 EA48  ED 4D               RETI
  630                   ;
  631 EA4A  88 CF FF B7 PIOTAB: DEFB 88H,0CFH,0FFH,0B7H,7FH  ;PIO 1A: Init.-Tabelle
  632                   ;  88H --> NWT Interruptvektor --> 0FF88H
  633                   ; 0CFH --> "Mode 3" + "Set Mode" (kein Handshaking, next Byte = I/O-Zuordnung)
  634                   ; 0FFH --> PA0 bis PA7 sind Eingaenge
  635                   ; 0B7H --> Setting Interrupt Control Word --> mit nachfolgender Maskierung
  636                   ;  7FH --> Bit7=L --> nur PA7 erzeugt Interrupts
  637                   ;
  638 EA4F  C5          OUTTXT: PUSH BC
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  12
BIOS    ASM

  639 EA50  F5                  PUSH AF
  640 EA51  4E          TEXT1:  LD   C,(HL)
  641 EA52  79                  LD   A,C
  642 EA53  B7                  OR   A
  643 EA54  28 06               JR   Z,TEXT2
  644 EA56  CD EADF             CALL CONOUT
  645 EA59  23                  INC  HL
  646 EA5A  18 F5               JR   TEXT1
  647 EA5C  F1          TEXT2:  POP  AF
  648 EA5D  C1                  POP  BC
  649 EA5E  C9                  RET
  650                   ;
  651                   ;******************************   CONST   ******************************
  652                   ;
  653 EA5F  3A FF00     CONST:  LD   A,(ZEIPUF)
  654 EA62  B7                  OR   A
  655 EA63  C8                  RET  Z
  656 EA64  3E FF               LD   A,0FFH
  657 EA66  C9                  RET
  658                   ;
  659                   ;******************************   CONIN   ******************************
  660                   ;
  661 EA67  F3          CONIN:  DI
  662 EA68  ED 73 F421          LD   (SPCIN),SP
  663 EA6C  31 F3C7             LD   SP,CINSP
  664 EA6F  C5                  PUSH BC
  665 EA70  D5                  PUSH DE
  666 EA71  E5                  PUSH HL
  667 EA72  01 017F             LD   BC,017FH     ;Kursor-Blinker ruecksetzen
  668 EA75  AF          CONIN1: XOR  A
  669 EA76  F3                  DI
  670 EA77  2A FF00             LD   HL,(ZEIPUF)  ;L = Anz. der Zeichen, H = 1. Zeichen
  671 EA7A  B5                  OR   L
  672 EA7B  20 20               JR   NZ,CONIN3    ;Zeichen im Tastaturpuffer vorhanden
  673 EA7D  FB                  EI
  674 EA7E  10 F5               DJNZ CONIN1       ;256*LOOP: warte auf ein Zeichen
  675 EA80  3A F41C             LD   A,(CUFLAG)
  676 EA83  B7                  OR   A
  677 EA84  28 EF               JR   Z,CONIN1     ;kein "Kursor-Blinken"
  678 EA86  F3                  DI
  679 EA87  CD E9CA             CALL AC1MOD       ;AC1 Mode
  680 EA8A  2A 1800             LD   HL,(CUPOS)
  681 EA8D  0C                  INC  C
  682 EA8E  CB 79               BIT  7,C          ;hier wird die Cursor-Blinkfrequenz festgelegt
  683 EA90  3A F420             LD   A,(CHAR)     ;bisheriges Zeichen auf der Kursorposition
  684 EA93  28 02               JR   Z,CONIN2
  685 EA95  3E 0F               LD   A,CUZEI      ;Kursor = 0FH
  686 EA97  77          CONIN2: LD   (HL),A       ;"Kursor-Blinken" - Bildschirm-Ausgabe
  687 EA98  CD E9C5             CALL CPMMOD       ;CP/M Mode
  688 EA9B  18 D8               JR   CONIN1
  689                   ;
  690 EA9D  3D          CONIN3: DEC  A            ;DEC Anzahl_der_Zeichen_im_Tastaturpuffer
  691 EA9E  32 FF00             LD   (ZEIPUF),A
  692 EAA1  7C                  LD   A,H          ;1. Zeichen aus dem Tastaturpuffer --> A
  693 EAA2  21 FF02             LD   HL,ZEIPUF+2
  694 EAA5  11 FF01             LD   DE,ZEIPUF+1
  695 EAA8  01 001F             LD   BC,001FH
  696 EAAB  ED B0               LDIR              ;alle Zeichen im Puffer ruecken 1 Pos. n. links
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  13
BIOS    ASM

  697 EAAD  E1                  POP  HL
  698 EAAE  D1                  POP  DE
  699 EAAF  C1                  POP  BC
  700 EAB0  ED 7B F421          LD   SP,(SPCIN)
  701 EAB4  FB                  EI
  702 EAB5  C9                  RET
  703                   ;
  704                   ;******************************   LIST   ******************************
  705                   ;
  706 EAB6  F3          LIST:   DI
  707 EAB7  CD E9CA             CALL AC1MOD
  708 EABA  F5                  PUSH AF      
  709 EABB  79                  LD   A,C
  710 EABC  FE 0A               CP   0AH  
  711 EABE  28 0C               JR   Z,LIST1  
  712 EAC0  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  713 EAC3  FE 0D               CP   0DH     
  714 EAC5  20 05               JR   NZ,LIST1 
  715 EAC7  3E 0A               LD   A,0AH   
  716 EAC9  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  717 EACC  F1          LIST1:  POP  AF      
  718 EACD  CD E9C5             CALL CPMMOD
  719 EAD0  FB                  EI
  720 EAD1  C9                  RET
  721                   ;
  722                   ;******************************   PUNCH   ******************************
  723                   ;
  724 EAD2  F3          PUNCH:  DI                ;Ausgabe C nach V24
  725 EAD3  79                  LD   A,C
  726 EAD4  CD E9CA             CALL AC1MOD
  727 EAD7  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  728 EADA  CD E9C5             CALL CPMMOD
  729 EADD  FB                  EI
  730 EADE  C9                  RET
  731                   ;
  732                   ;******************************   CONOUT   ******************************
  733                   ;
  734                   ;       Ausgabe eines Zeichens,   IN: Zeichen in C
  735                   ;
  736 EADF  F3          CONOUT: DI
  737 EAE0  ED 73 F423          LD   (SPCOUT),SP  ;Stack bei MON-Aufruf retten
  738 EAE4  31 F3ED             LD   SP,COUTSP
  739 EAE7  F5                  PUSH AF
  740 EAE8  C5                  PUSH BC
  741 EAE9  D5                  PUSH DE
  742 EAEA  E5                  PUSH HL
  743 EAEB  CD E9CA             CALL AC1MOD
  744 EAEE  E5                  PUSH HL
  745 EAEF  2A 1800             LD   HL,(CUPOS)   ;Cursorposition
  746 EAF2  3A F420             LD   A,(CHAR)
  747 EAF5  77                  LD   (HL),A       ;altes Zeichen auf Position
  748 EAF6  3A F41D             LD   A,(STZ00)    ;Durchlauf bei Steuerzeichen?
  749 EAF9  A7                  AND  A
  750 EAFA  C2 ED2A             JP   NZ,KONV10    ;NZ= Steuerzeichen 2. oder 3. Durchlauf
  751 EAFD  79                  LD   A,C          ;Byte
  752 EAFE  FE 20               CP   20H          ;kleinstes Zeichen
  753 EB00  38 26               JR   C,KONVTB
  754 EB02  FE 7F               CP   7FH          ;groesstes Zeichen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  14
BIOS    ASM

  755 EB04  30 22               JR   NC,KONVTB
  756 EB06  2A 1800             LD   HL,(CUPOS)
  757 EB09  C3 EC67             JP   CCHAR        ;Ausgabe einzelnes Zeichen
  758                   ;
  759 EB0C  2A 1800     KONVT9: LD   HL,(CUPOS)
  760 EB0F  7E                  LD   A,(HL)
  761 EB10  32 F420             LD   (CHAR),A
  762 EB13  3A F41C             LD   A,(CUFLAG)
  763 EB16  B7                  OR   A
  764 EB17  28 02               JR   Z,COEN1      ;Kursor nicht darstellen
  765 EB19  36 0F               LD   (HL),CUZEI
  766 EB1B  CD E9C5     COEN1:  CALL CPMMOD
  767 EB1E  E1                  POP  HL
  768 EB1F  D1                  POP  DE
  769 EB20  C1                  POP  BC
  770 EB21  F1                  POP  AF
  771 EB22  ED 7B F423          LD   SP,(SPCOUT)
  772 EB26  FB                  EI
  773 EB27  C9                  RET
  774                   ;
  775                   ;Verzweigung bei Steuerzeichen
  776                   ;INPUT:  A=Zeichen
  777                   ;
  778 EB28  FE 1B       KONVTB: CP   1BH          ;ESC ?
  779 EB2A  20 07               JR   NZ,KONVT1
  780 EB2C  3E 02               LD   A,02H        ;wenn ja
  781 EB2E  32 F41D             LD   (STZ00),A    ;Zeiger auf 2
  782 EB31  18 D9               JR   KONVT9       ;nichts ausgeben
  783                   ;
  784 EB33  2A 1800     KONVT1: LD   HL,(CUPOS)
  785 EB36  FE 01               CP   01H          ;^A Cursor home                      
  786 EB38  28 5B               JR   Z,CHOME                                             
  787 EB3A  FE 07               CP   07H          ;^G akustisches Signal                                                 
  788 EB3C  CA ECB9             JP   Z,MBEEP                                              
  789 EB3F  FE 08               CP   08H          ;^H Cursor links                     
  790 EB41  CA EBBD             JP   Z,CLEFT                                             
  791 EB44  FE 0A               CP   0AH          ;^J Zeilenvorschub                   
  792 EB46  CA EBC1             JP   Z,CLF                                               
  793 EB49  FE 0C               CP   0CH          ;^L CLS                              
  794 EB4B  28 51               JR   Z,BCLS                                              
  795 EB4D  FE 0D               CP   0DH          ;^M Wagenruecklauf                   
  796 EB4F  CA EBD9             JP   Z,CCRET                                             
  797 EB52  FE 14               CP   14H          ;^T BS ab Cursor loeschen            
  798 EB54  CA EBE0             JP   Z,CBLOE                                             
  799 EB57  FE 15               CP   15H          ;^U Cursor nach rechts               
  800 EB59  CA EC03             JP   Z,CRIGH                                             
  801 EB5C  FE 16               CP   16H          ;^V Zeile ab Cursor loeschen         
  802 EB5E  CA EC07             JP   Z,CZLOE                                             
  803 EB61  FE 18               CP   18H          ;^X Zeile ab Cursor loeschen + CR    
  804 EB63  CA EC2E             JP   Z,CZLCR                                             
  805 EB66  FE 1A               CP   1AH          ;^Z Cursor hoch                      
  806 EB68  CA EC57             JP   Z,CHOCH                                             
  807 EB6B  FE 82               CP   82H          ;Kursor ein
  808 EB6D  CA ED1B             JP   Z,CUON
  809 EB70  FE 83               CP   83H          ;Kursor aus
  810 EB72  CA ED23             JP   Z,CUOFF
  811                   ;
  812 EB75  47                  LD   B,A          ;Zeichen merken                      
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  15
BIOS    ASM

  813 EB76  3A F417             LD   A,(COLOR)                                         
  814 EB79  A7                  AND  A            ;Test auf Color-BWS                  
  815 EB7A  CA EB0C             JP   Z,KONVT9     ;Z = monochrom  
  816 EB7D  78                  LD   A,B                                                 
  817                   ;
  818 EB7E  FE 84               CP   84H          ;normale Darstellung
  819 EB80  CA ECE0             JP   Z,BNORM
  820 EB83  FE 85               CP   85H          ;invers
  821 EB85  CA ECEE             JP   Z,BINVN
  822 EB88  FE 86               CP   86H          ;intensiv - HihgLight
  823 EB8A  CA ECFD             JP   Z,BINTE
  824 EB8D  FE 87               CP   87H          ;intensiv + invers
  825 EB8F  CA ED0A             JP   Z,BIVIN
  826 EB92  C3 EB0C             JP   KONVT9
  827                   ;
  828 EB95  21 17FF     CHOME:  LD   HL,17FFH
  829 EB98  22 1800             LD   (CUPOS),HL
  830 EB9B  C3 EB0C             JP   KONVT9
  831                   ;
  832 EB9E  3E 20       BCLS:   LD   A,20H        ;0Ch  Bildschirm loeschen
  833 EBA0  CD EBCA             CALL BCL1         ;Loeschroutine
  834 EBA3  22 1800             LD   (CUPOS),HL   ;Cursorposition
  835 EBA6  3A F417             LD   A,(COLOR)    ;Farbbyte
  836 EBA9  E6 77               AND  77H          ;Farb-BWS vorhanden?
  837 EBAB  CA EB0C             JP   Z,KONVT9     ;Z = nein, dann Ende
  838 EBAE  CD EDAD             CALL BWSCOL       ;Farbspeicher ein
  839 EBB1  3A F417             LD   A,(COLOR)
  840 EBB4  CD EBCA             CALL BCL1
  841 EBB7  CD EDB3             CALL BWSZEI       ;Farbspeicher aus
  842 EBBA  C3 EB0C             JP   KONVT9
  843                   ;
  844 EBBD  23          CLEFT:  INC  HL           ;08h  Cursor links
  845 EBBE  C3 EC5B             JP   CHOLI
  846                   ;
  847 EBC1  11 0040     CLF:    LD   DE,0040H     ;0Ah  Zeilenvorschub
  848 EBC4  A7                  AND  A
  849 EBC5  ED 52               SBC  HL,DE
  850 EBC7  C3 EC78             JP   SCROL
  851                   ;
  852 EBCA  21 1000     BCL1:   LD   HL,1000H     ;Anfang BWS
  853 EBCD  77                  LD   (HL),A
  854 EBCE  54                  LD   D,H
  855 EBCF  5D                  LD   E,L
  856 EBD0  1C                  INC  E
  857 EBD1  C5                  PUSH BC
  858 EBD2  01 07FF             LD   BC,07FFH     ;Laenge BWS
  859 EBD5  ED B0               LDIR
  860 EBD7  C1                  POP  BC
  861 EBD8  C9                  RET
  862                   ;
  863 EBD9  7D          CCRET:  LD   A,L          ;0Dh  Wagenruecklauf
  864 EBDA  F6 3F               OR   3FH
  865 EBDC  6F                  LD   L,A
  866 EBDD  C3 EC78             JP   SCROL
  867                   ;
  868 EBE0  E5          CBLOE:  PUSH HL
  869 EBE1  3E 0F               LD   A,CUZEI      ;14h  BS ab Cursor loeschen
  870 EBE3  36 20       CBLO1:  LD   (HL),20H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  16
BIOS    ASM

  871 EBE5  2B                  DEC  HL
  872 EBE6  BC                  CP   H
  873 EBE7  20 FA               JR   NZ,CBLO1
  874 EBE9  E1                  POP  HL
  875 EBEA  3A F417             LD   A,(COLOR)
  876 EBED  47                  LD   B,A
  877 EBEE  E6 77               AND  77H
  878 EBF0  CA EB0C             JP   Z,KONVT9
  879 EBF3  CD EDAD             CALL BWSCOL       ;Farbspeicher ein
  880 EBF6  3E 0F               LD   A,CUZEI
  881 EBF8  70          CBLO2:  LD   (HL),B
  882 EBF9  2B                  DEC  HL
  883 EBFA  BC                  CP   H
  884 EBFB  20 FB               JR   NZ,CBLO2
  885 EBFD  CD EDB3             CALL BWSZEI       ;Farbspeicher aus
  886 EC00  C3 EB0C             JP   KONVT9
  887                   ;
  888 EC03  2B          CRIGH:  DEC  HL           ;15h  Cursor nach rechts
  889 EC04  C3 EC78             JP   SCROL
  890                   ;
  891 EC07  E5          CZLOE:  PUSH HL           ;16h  Zeile ab Cursor loeschen
  892 EC08  7D                  LD   A,L
  893 EC09  E6 3F               AND  3FH
  894 EC0B  47                  LD   B,A
  895 EC0C  04                  INC  B
  896 EC0D  36 20       CZLO1:  LD   (HL),20H
  897 EC0F  2B                  DEC  HL
  898 EC10  10 FB               DJNZ CZLO1
  899 EC12  E1                  POP  HL
  900 EC13  3A F417             LD   A,(COLOR)
  901 EC16  4F                  LD   C,A
  902 EC17  E6 77               AND  77H
  903 EC19  CA EB0C             JP   Z,KONVT9
  904 EC1C  CD EDAD             CALL BWSCOL       ;Farbspeicher ein
  905 EC1F  7D                  LD   A,L
  906 EC20  E6 3F               AND  3FH
  907 EC22  47                  LD   B,A
  908 EC23  04                  INC  B
  909 EC24  71          CZLO2:  LD   (HL),C
  910 EC25  2B                  DEC  HL
  911 EC26  10 FC               DJNZ CZLO2
  912 EC28  CD EDB3             CALL BWSZEI       ;Farbspeicher aus
  913 EC2B  C3 EB0C             JP   KONVT9
  914                   ;
  915 EC2E  E5          CZLCR:  PUSH HL           ;18h  Zeile ab Cursor loeschen + CR
  916 EC2F  7D                  LD   A,L
  917 EC30  F6 3F               OR   3FH
  918 EC32  6F                  LD   L,A
  919 EC33  22 1800             LD   (CUPOS),HL
  920 EC36  E5                  PUSH HL
  921 EC37  06 40               LD   B,40H        ;Zeilenlaenge
  922 EC39  36 20       CZLC1:  LD   (HL),20H
  923 EC3B  2B                  DEC  HL
  924 EC3C  10 FB               DJNZ CZLC1
  925 EC3E  E1                  POP  HL
  926 EC3F  3A F417             LD   A,(COLOR)
  927 EC42  4F                  LD   C,A
  928 EC43  E6 77               AND  77H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  17
BIOS    ASM

  929 EC45  CA EB0C             JP   Z,KONVT9
  930 EC48  CD EDAD             CALL BWSCOL       ;Farbspeicher ein
  931 EC4B  06 40               LD   B,40H
  932 EC4D  71          CZLC2:  LD   (HL),C
  933 EC4E  2B                  DEC  HL
  934 EC4F  10 FC               DJNZ CZLC2
  935 EC51  CD EDB3             CALL BWSZEI       ;Farbspeicher aus
  936 EC54  C3 EB0C             JP   KONVT9
  937                   ;
  938 EC57  11 0040     CHOCH:  LD   DE,0040H     ;1Ah     Cursor hoch
  939 EC5A  19                  ADD  HL,DE
  940                   ;
  941 EC5B  3E 18       CHOLI:  LD   A,18H        ;Begrenzung Cursor hoch und links
  942 EC5D  BC                  CP   H
  943 EC5E  CA EB0C             JP   Z,KONVT9
  944 EC61  22 1800             LD   (CUPOS),HL
  945 EC64  C3 EB0C             JP   KONVT9
  946                   ;
  947 EC67  77          CCHAR:  LD   (HL),A
  948 EC68  3A F417             LD   A,(COLOR)
  949 EC6B  4F                  LD   C,A
  950 EC6C  E6 77               AND  77H
  951 EC6E  28 07               JR   Z,CCHA1
  952 EC70  CD EDAD             CALL BWSCOL       ;Farbspeicher ein
  953 EC73  71                  LD   (HL),C
  954 EC74  CD EDB3             CALL BWSZEI       ;Farbspeicher aus
  955 EC77  2B          CCHA1:  DEC  HL
  956                   ;
  957 EC78  22 1800     SCROL:  LD   (CUPOS),HL
  958 EC7B  EB                  EX   DE,HL        ;Test ob Scrollen noetig
  959 EC7C  21 0FFF             LD   HL,0FFFH
  960 EC7F  A7                  AND  A
  961 EC80  ED 52               SBC  HL,DE        ;DE = akt. Cursorpos.
  962 EC82  EB                  EX   DE,HL
  963 EC83  DA EB0C             JP   C,KONVT9     ;CY = nicht scrollen
  964 EC86  3E 20               LD   A,20H        ;Leerzeichen
  965 EC88  CD ECA2             CALL SCR11        ;Scrollen
  966 EC8B  3A F417             LD   A,(COLOR)
  967 EC8E  E6 77               AND  77H
  968 EC90  CA EB0C             JP   Z,KONVT9     ;Z = kein Farbspeicher
  969 EC93  CD EDAD             CALL BWSCOL       ;Farbspeicher ein
  970 EC96  3A F417             LD   A,(COLOR)    ;Farbbyte
  971 EC99  CD ECA2             CALL SCR11
  972 EC9C  CD EDB3             CALL BWSZEI       ;Farbspeicher aus
  973 EC9F  C3 EB0C             JP   KONVT9
  974                   ;
  975 ECA2  21 17BF     SCR11:  LD   HL,17BFH     ;Umladeroutine Scrollen
  976 ECA5  11 17FF             LD   DE,17FFH
  977 ECA8  01 07C0             LD   BC,07C0H
  978 ECAB  ED B8               LDDR
  979 ECAD  EB                  EX   DE,HL
  980 ECAE  22 1800             LD   (CUPOS),HL
  981 ECB1  23                  INC  HL
  982 ECB2  06 40               LD   B,40H        ;eine Zeilenlaenge
  983 ECB4  2D          SCR12:  DEC  L
  984 ECB5  77                  LD   (HL),A       ;Leerzeile schreiben
  985 ECB6  10 FC               DJNZ SCR12
  986 ECB8  C9                  RET
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  18
BIOS    ASM

  987                   ;
  988                   ;
  989                   ;UP 'MBEEP' (Monitor-Beep)
  990                   ;
  991 ECB9  C5          MBEEP:  PUSH BC 
  992 ECBA  06 02               LD   B,02H        ;2 Wiederholungen
  993 ECBC  C5          MBEEP1: PUSH BC 
  994                   ;       LD   BC,0040H     ;--> fuer 2 MHz
  995 ECBD  01 0080             LD   BC,0080H     ;--> fuer 4 MHz
  996 ECC0  CD ECD0             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
  997                   ;       LD   BC,0F032H    ;--> fuer 2 MHz
  998 ECC3  01 F064             LD   BC,0F064H    ;--> fuer 4 MHz
  999 ECC6  CD ECD0             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1000 ECC9  C1                  POP  BC 
 1001 ECCA  10 F0               DJNZ MBEEP1 
 1002 ECCC  C1                  POP  BC 
 1003 ECCD  C3 EB1B             JP   COEN1 
 1004                   ;
 1005                   ;
 1006                   ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1007                   ;
 1008 ECD0  F5          UPTON:  PUSH AF 
 1009 ECD1  DB 05       UPTON1: IN   A,(P05) 
 1010 ECD3  1F                  RRA 
 1011 ECD4  3F                  CCF 
 1012 ECD5  17                  RLA 
 1013 ECD6  D3 05               OUT  (P05),A 
 1014 ECD8  79                  LD   A,C 
 1015 ECD9  3D          UPTON2: DEC  A 
 1016 ECDA  20 FD               JR   NZ,UPTON2 
 1017 ECDC  10 F3               DJNZ UPTON1 
 1018 ECDE  F1                  POP  AF 
 1019 ECDF  C9                  RET 
 1020                   ;
 1021                   ;
 1022 ECE0  3A F418     BNORM:  LD   A,(COLO1)    ;84h  normale Darstellung
 1023 ECE3  E6 77               AND  77H
 1024 ECE5  32 F417             LD   (COLOR),A
 1025 ECE8  32 F418             LD   (COLO1),A
 1026 ECEB  C3 EB0C             JP   KONVT9
 1027                   ;
 1028 ECEE  3A F418     BINVN:  LD   A,(COLO1)    ;85h  invers EIN
 1029 ECF1  E6 77               AND  77H
 1030 ECF3  0F                  RRCA
 1031 ECF4  0F                  RRCA
 1032 ECF5  0F                  RRCA
 1033 ECF6  0F                  RRCA
 1034 ECF7  32 F417             LD   (COLOR),A
 1035 ECFA  C3 EB0C             JP   KONVT9
 1036                   ;
 1037 ECFD  3A F418     BINTE:  LD   A,(COLO1)    ;86h  intensiv EIN
 1038 ED00  E6 77               AND  77H
 1039 ED02  F6 08               OR   08H
 1040 ED04  32 F417             LD   (COLOR),A
 1041 ED07  C3 EB0C             JP   KONVT9
 1042                   ;
 1043 ED0A  3A F417     BIVIN:  LD   A,(COLOR)    ;87h  intensiv + invers
 1044 ED0D  E6 77               AND  77H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  19
BIOS    ASM

 1045 ED0F  F6 08               OR   08H
 1046 ED11  0F                  RRCA
 1047 ED12  0F                  RRCA
 1048 ED13  0F                  RRCA
 1049 ED14  0F                  RRCA
 1050 ED15  32 F417             LD   (COLOR),A
 1051 ED18  C3 EB0C             JP   KONVT9
 1052                   ;
 1053 ED1B  3E 01       CUON:   LD   A,01H        ;82h Cursor EIN
 1054 ED1D  32 F41C             LD   (CUFLAG),A
 1055 ED20  C3 EB0C             JP   KONVT9
 1056                   ;
 1057 ED23  AF          CUOFF:  XOR  A            ;83h Cursor AUS
 1058 ED24  32 F41C             LD   (CUFLAG),A
 1059 ED27  C3 EB0C             JP   KONVT9
 1060                   ;
 1061                   ; Behandlung ESC-Sequenzen
 1062                   ;
 1063                   ; Input: ESC + 2 Steuerzeichen
 1064                   ; wenn 1. Zeichen > 80h dann Cursorposition
 1065                   ; sonst Auswertung Farbe / Grafikzeichen
 1066                   ; (stz00) = Zaehler fuer Zeichenanzahl
 1067                   ;
 1068 ED2A  3A F41D     KONV10: LD   A,(STZ00)
 1069 ED2D  FE 02               CP   02H          ;2 = 1. Steuerzeichen (Zeile)
 1070 ED2F  20 0C               JR   NZ,KONV20    ;sonst 3. Durchlauf (Spalte)
 1071 ED31  79                  LD   A,C
 1072 ED32  32 F41E             LD   (STZ01),A    ;erstes Zeichen merken
 1073 ED35  3E 01               LD   A,01H        ;Zeiger fuer 3. Durchlauf
 1074 ED37  32 F41D             LD   (STZ00),A
 1075 ED3A  C3 EB0C             JP   KONVT9       ;nichts ausgeben
 1076                   ;
 1077                   ; Verzweigung Cursorposition / weitere Funktionen
 1078                   ;
 1079 ED3D  79          KONV20: LD   A,C
 1080 ED3E  32 F41F             LD   (STZ02),A    ;zweites Zeichen merken
 1081 ED41  AF                  XOR  A
 1082 ED42  32 F41D             LD   (STZ00),A    ;Durchlaufzaehler ruecksetzen
 1083 ED45  21 F41E             LD   HL,STZ01
 1084 ED48  7E                  LD   A,(HL)
 1085 ED49  CB 7F               BIT  7,A          ;welche Funktion? NZ = Cursor
 1086 ED4B  28 2F               JR   Z,KONV22     ;Z = weitere Funktionen
 1087                   
 1088                   ; Berechnung direkte Cursorposition
 1089                   ; OUT:    HL = BWS-Adresse
 1090                   ;
 1091 ED4D  F5                  PUSH AF
 1092 ED4E  79                  LD   A,C
 1093 ED4F  E6 3F               AND  3FH          ;max. Spaltenzahl
 1094 ED51  6F                  LD   L,A
 1095 ED52  F1                  POP  AF
 1096 ED53  E6 1F               AND  1FH          ;max. Zeilenzahl
 1097 ED55  16 00               LD   D,00H
 1098 ED57  62                  LD   H,D
 1099 ED58  5F                  LD   E,A
 1100 ED59  06 06               LD   B,06H
 1101 ED5B  CB 23       KONV21: SLA  E
 1102 ED5D  CB 12               RL   D
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  20
BIOS    ASM

 1103 ED5F  10 FA               DJNZ KONV21
 1104 ED61  19                  ADD  HL,DE
 1105 ED62  EB                  EX   DE,HL
 1106 ED63  21 17FF             LD   HL,17FFH     ;Ende BWS-RAM
 1107 ED66  A7                  AND  A
 1108 ED67  ED 52               SBC  HL,DE
 1109                   ;
 1110                   ; Cursor direkt positionieren
 1111                   ; IN:    HL = Adresse Cursor
 1112                   ;
 1113 ED69  E5                  PUSH HL
 1114 ED6A  2A 1800             LD   HL,(CUPOS)	  ;alte Position
 1115 ED6D  3A F420             LD   A,(CHAR)	  ;Zeichen holen
 1116 ED70  77                  LD   (HL),A	      ;auf BS schreiben
 1117 ED71  E1                  POP  HL
 1118 ED72  22 1800             LD   (CUPOS),HL   ;neue Position setzen
 1119 ED75  7E                  LD   A,(HL)       ;neues Zeichen holen
 1120 ED76  32 F420             LD   (CHAR),A     ;und merken
 1121 ED79  C3 EB0C             JP   KONVT9
 1122                   ;
 1123                   ; Auswertung weiterer ESC-Funktionen
 1124                   ; IN:      A = 1. Steuerzeichen
 1125                   ;
 1126                   ; Ausgabe Grafikzeichen aus AC1-ZG ( > 80h )
 1127                   ;
 1128 ED7C  FE 5F       KONV22: CP   5FH          ;Grafikzeichen?
 1129 ED7E  20 08               JR   NZ,KONV24    ;NZ = nein
 1130 ED80  23                  INC  HL
 1131 ED81  7E                  LD   A,(HL)       ;2. Zeichen holen
 1132 ED82  2A 1800             LD   HL,(CUPOS)
 1133 ED85  C3 EC67             JP   CCHAR        ;Zeichen ausgeben
 1134                   ;
 1135                   ; Einstellen der Farbe (nur Color-BWS)
 1136                   ;
 1137 ED88  FE 5D       KONV24: CP   5DH          ;Farbe?
 1138 ED8A  C2 EB0C             JP   NZ,KONVT9    ;NZ = nein
 1139 ED8D  3A F417             LD   A,(COLOR)    ;Color-BWS?
 1140 ED90  A7                  AND  A
 1141 ED91  CA EB0C             JP   Z,KONVT9     ;Z = nein
 1142 ED94  23                  INC  HL
 1143 ED95  7E                  LD   A,(HL)       ;2. Zeichen holen
 1144 ED96  E6 77               AND  77H          ;intensiv maskieren
 1145 ED98  47                  LD   B,A
 1146 ED99  0F                  RRCA
 1147 ED9A  0F                  RRCA
 1148 ED9B  0F                  RRCA
 1149 ED9C  0F                  RRCA
 1150 ED9D  B8                  CP   B            ;Zeichen- und HG-Farbe gleich?
 1151 ED9E  CA EB0C             JP   Z,KONVT9     ;Z = Ja, dann ignorieren
 1152 EDA1  78                  LD   A,B
 1153 EDA2  32 F417             LD   (COLOR),A    ;Farbe setzen
 1154 EDA5  E6 77               AND  77H          ;intensiv maskieren
 1155 EDA7  32 F418             LD   (COLO1),A    ;Backup
 1156 EDAA  C3 EB0C             JP   KONVT9
 1157                   ;
 1158 EDAD  DB F0       BWSCOL: IN   A,(PF0)      ;bwsport
 1159 EDAF  CB D7               SET  2,A          ;Farbspeicher ein
 1160 EDB1  18 04               JR   BWSZ1
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  21
BIOS    ASM

 1161                   ;
 1162 EDB3  DB F0       BWSZEI: IN   A,(PF0)      ;bwsport
 1163 EDB5  CB 97               RES  2,A          ;Farbspeicher aus
 1164 EDB7  E6 07       BWSZ1:  AND  07H
 1165 EDB9  D3 F0               OUT  (PF0),A
 1166 EDBB  C9                  RET
 1167                   ;
 1168 EDBC  AF          BWSINI: XOR  A            ;Farbbyte auf Monochrom setzen
 1169 EDBD  32 F417             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1170 EDC0  32 F419             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1171 EDC3  0E F0               LD   C,0F0H       ;I/O-Adresse COLOR-BWS
 1172 EDC5  ED 40               IN   B,(C)        ;Konfigbyte COLOR-BWS lesen
 1173 EDC7  04                  INC  B            ;fuer COLOR-BWS muss B<255 sein
 1174 EDC8  C8                  RET  Z            ;kein COLOR-BWS vorhanden --> Ende
 1175                           ;hier wird die Routine verlassen, wenn kein CPLD vorh. ist
 1176 EDC9  05                  DEC  B            ;Konfigbyte COLOR-BWS: Farb-RAM aus
 1177 EDCA  50                  LD   D,B
 1178 EDCB  CB D2               SET  2,D          ;Konfigbyte COLOR-BWS: Farb-RAM ein
 1179 EDCD  21 1000             LD   HL,1000H
 1180 EDD0  5E                  LD   E,(HL)       ;Zeichen aus 1000h
 1181 EDD1  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1182 EDD3  3A 181F             LD   A,(CBWSB)    ;Farbbyte aus dem AC1-Monitor
 1183 EDD6  77                  LD   (HL),A       ;Farbe auf 1000h setzen
 1184 EDD7  BE                  CP   (HL)         ;ist Farb-RAM gesteckt?
 1185 EDD8  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1186 EDDA  73                  LD   (HL),E       ;Zeichen auf 1000h zurueckschreiben
 1187 EDDB  C0                  RET  NZ           ;Farbe hat nicht geklappt --> Ende
 1188                           ;hier wird die Routine verlassen, wenn kein Farb-RAM steckt
 1189 EDDC  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1190 EDDE  C5                  PUSH BC
 1191 EDDF  11 1001             LD   DE,1001H
 1192 EDE2  01 07FF             LD   BC,07FFH
 1193 EDE5  ED B0               LDIR              ;Farb-RAM initialisieren
 1194 EDE7  7E                  LD   A,(HL)       ;Farbe aus 17FFh ruecklesen
 1195 EDE8  C1                  POP  BC
 1196 EDE9  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1197 EDEB  32 F417             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1198 EDEE  32 F419             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1199 EDF1  C9                  RET
 1200                   ;
 1201                   ;******************************   LISTST   ******************************
 1202                   ;
 1203 EDF2  AF          LISTST: XOR  A
 1204 EDF3  3D                  DEC  A
 1205 EDF4  C9                  RET
 1206                   ;
 1207                   ;******************************   SELDSK   ******************************
 1208                   ;
 1209 EDF5  21 E641     SELDSK: LD   HL,NDISK     ;max. Anzahl der LW
 1210 EDF8  79                  LD   A,C          ;C = akt. LW
 1211 EDF9  BE                  CP   (HL)
 1212 EDFA  21 0000             LD   HL,0000H     ;HL=0 --> kein LW
 1213 EDFD  D0                  RET  NC           ;akt. LW >= NDISK!!!
 1214 EDFE  2A E642             LD   HL,(DPHX)    ;AnfangsADR DPH(y)-Tabelle
 1215 EE01  06 00               LD   B,00H        ;BC = akt. LW
 1216 EE03  09                  ADD  HL,BC
 1217 EE04  09                  ADD  HL,BC        ;HL = DPHY + (2 * LW)
 1218 EE05  5E                  LD   E,(HL)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  22
BIOS    ASM

 1219 EE06  23                  INC  HL
 1220 EE07  56                  LD   D,(HL)       ;DE = (DPHY + (2 * LW))
 1221 EE08  EB                  EX   DE,HL        ;HL = DPH-ADR vom akt. LW
 1222 EE09  7C                  LD   A,H
 1223 EE0A  B5                  OR   L
 1224 EE0B  C8                  RET  Z            ;HL=0 --> kein DPB
 1225 EE0C  79                  LD   A,C
 1226 EE0D  32 F43B             LD   (DRIVE),A    ;aktives LW --> A
 1227 EE10  22 F442             LD   (DPH),HL     ;zugeordneter DPH --> HL
 1228 EE13  C9                  RET
 1229                   ;
 1230                   ;******************************   HOME   ******************************
 1231                   ;
 1232 EE14  01 0000     HOME:   LD   BC,0000H
 1233 EE17  ED 43 F43C  SETTRK: LD   (TRACK),BC
 1234 EE1B  C9                  RET
 1235                   ;
 1236                   ;******************************   SETSEC   ******************************
 1237                   ;
 1238 EE1C  ED 43 F43E  SETSEC: LD   (SECTOR),BC
 1239 EE20  C9                  RET
 1240                   ;
 1241                   ;******************************   SETDMA   ******************************
 1242                   ;
 1243 EE21  ED 43 F440  SETDMA: LD   (DMA),BC
 1244 EE25  C9                  RET
 1245                   ;
 1246                   ;******************************   SECTRN   ******************************
 1247                   ;
 1248 EE26  60          SECTRN: LD   H,B
 1249 EE27  69                  LD   L,C
 1250 EE28  7A                  LD   A,D
 1251 EE29  B3                  OR   E
 1252 EE2A  C8                  RET  Z
 1253 EE2B  EB                  EX   DE,HL
 1254 EE2C  06 00               LD   B,00H
 1255 EE2E  09                  ADD  HL,BC
 1256 EE2F  6E                  LD   L,(HL)
 1257 EE30  62                  LD   H,D
 1258 EE31  C9                  RET
 1259                   ;
 1260                   ;******************************   READ + WRITE   ******************************
 1261                   ;
 1262 EE32  0E 02       READ:   LD   C,02H
 1263 EE34  3E 04               LD   A,04H
 1264 EE36  21                  DEFB 21H          ;LD HL,063EH mit nxt. Befehl!!!
 1265 EE37  3E 06       WRITE:  LD   A,06H        ;DUMMY fuer READ
 1266 EE39  32 F43A             LD   (RWBYTE),A   ;RWBYTE: 04 = Lesen; 06 = Schreiben
 1267 EE3C  79                  LD   A,C
 1268 EE3D  32 F45D             LD   (DF51E),A
 1269 EE40  21 EE59             LD   HL,RWEND
 1270 EE43  E5                  PUSH HL
 1271 EE44  2A F442             LD   HL,(DPH)
 1272 EE47  11 000A             LD   DE,000AH
 1273 EE4A  19                  ADD  HL,DE
 1274 EE4B  7E                  LD   A,(HL)       ;NWT vom DPB
 1275 EE4C  23                  INC  HL
 1276 EE4D  66                  LD   H,(HL)       ;HWT vom DPB
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  23
BIOS    ASM

 1277 EE4E  6F                  LD   L,A
 1278 EE4F  2B                  DEC  HL
 1279 EE50  7E                  LD   A,(HL)       ;HWT der R/W-Funktion
 1280 EE51  2B                  DEC  HL
 1281 EE52  6E                  LD   L,(HL)       ;NWT der R/W-Funktion
 1282 EE53  67                  LD   H,A
 1283 EE54  E5                  PUSH HL           ;Adresse der R/W-Funktion
 1284 EE55  21 F43A             LD   HL,RWBYTE    ;HL -> R/W-Byte
 1285 EE58  C9                  RET               ;JP R/W-Funktion
 1286                   ;
 1287 EE59  B7          RWEND:  OR   A
 1288 EE5A  C8                  RET  Z
 1289 EE5B  3E 01               LD   A,01H        ;Fehler
 1290 EE5D  C9                  RET
 1291                   ;
 1292                   ;******************************   RAM-Disk   ******************************
 1293                   ;
 1294 EE5E  4E          RWRDSK: LD   C,(HL)       ;RWBYTE: 04 = Lesen; 06 = Schreiben 
 1295 EE5F  23                  INC  HL           ;DRIVE wird uebersprungen
 1296 EE60  23                  INC  HL
 1297 EE61  7E                  LD   A,(HL)       ;TRACK NWT
 1298 EE62  32 F41A             LD   (RAFTRK),A
 1299 EE65  23                  INC  HL
 1300 EE66  7E                  LD   A,(HL)       ;TRACK HWT
 1301 EE67  A7                  AND  A
 1302 EE68  20 32               JR   NZ,RDERR     ;muss 0 sein
 1303 EE6A  23                  INC  HL
 1304 EE6B  7E                  LD   A,(HL)       ;SEKTOR NWT
 1305 EE6C  32 F41B             LD   (RAFSEC),A
 1306 EE6F  CB 7F               BIT  7,A
 1307 EE71  20 29               JR   NZ,RDERR     ;Bit 7 muss 0 sein
 1308 EE73  CB 77               BIT  6,A
 1309 EE75  20 25               JR   NZ,RDERR     ;Bit 6 muss 0 sein
 1310 EE77  23                  INC  HL
 1311 EE78  7E                  LD   A,(HL)       ;SEKTOR HWT
 1312 EE79  A7                  AND  A
 1313 EE7A  20 20               JR   NZ,RDERR     ;muss 0 sein
 1314 EE7C  23                  INC  HL
 1315 EE7D  23                  INC  HL           ;DMA wird uebersprungen
 1316 EE7E  79                  LD   A,C
 1317 EE7F  01 0080             LD   BC,0080H
 1318 EE82  FE 06               CP   06H
 1319 EE84  28 08               JR   Z,RDSKWR     ;C = 06 --> RDSK Schreiben
 1320 EE86  CD EFCB             CALL ADRRAF
 1321 EE89  ED B2               INIR
 1322 EE8B  00                  NOP
 1323 EE8C  AF                  XOR  A            ;in Ordnung
 1324 EE8D  C9                  RET
 1325                   ;
 1326 EE8E  21 0080     RDSKWR: LD   HL,0080H     ;RAM-Disk schreiben 
 1327 EE91  ED 5B F440          LD   DE,(DMA)
 1328 EE95  CD EFCB             CALL ADRRAF
 1329 EE98  ED B3               OTIR
 1330 EE9A  AF                  XOR  A            ;in Ordnung
 1331 EE9B  C9                  RET
 1332                   ;
 1333 EE9C  3E FF       RDERR:  LD   A,0FFH       ;Fehler
 1334 EE9E  C9                  RET
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  24
BIOS    ASM

 1335                   ;
 1336 EE9F  20 3D 3E 49 TXTRDI: DEFM " =>INIT.."
 1337 EEA8  00                  DEFB 0
 1338                   ;
 1339 EEA9  4F 4B       TXTRDO: DEFM "OK"
 1340 EEAB  00                  DEFB 0
 1341                   ;
 1342 EEAC  52 46 4C 20 TXTRDE: DEFM "RFL ERROR!"
 1343 EEB6  0D 0A               DEFB 0DH,0AH
 1344 EEB8  00                  DEFB 0
 1345                   ;
 1346                   ; Test der RAM-Disk - GrC6Ce (256 / 512 / 1024 / 2048 KByte)
 1347                   ;
 1348 EEB9  AF          RDTEST: XOR  A            ;Kapazitaet der RAM-Disk testen
 1349 EEBA  D3 E6               OUT  (PE0+6),A    ;H-Adresse ruecksetzen
 1350 EEBC  0E E0               LD   C,PE0        ;Test erfolgt in der 1. RAM-Bank
 1351                   ;
 1352                   ; Inhalte der 4 RAM-Testzellen sichern
 1353                   ;
 1354 EEBE  21 EF15             LD   HL,RDMERK    ;Merkzellen im RAM
 1355 EEC1  06 04               LD   B,4          ;4 Durchlaeufe
 1356 EEC3  16 04               LD   D,4          ;Startwert Extended-Adresse
 1357 EEC5  AF          RDTST1: XOR  A
 1358 EEC6  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1359 EEC8  7A                  LD   A,D
 1360 EEC9  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1361 EECB  ED 78               IN   A,(C)
 1362 EECD  77                  LD   (HL),A       ;Daten aus der RAM-Disk sichern
 1363 EECE  23                  INC  HL           ;Merkzelle++
 1364 EECF  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1365 EED1  10 F2               DJNZ RDTST1
 1366                   ;
 1367                   ; 4 Testwerte in die RAM-Disk schreiben
 1368                   ;
 1369 EED3  06 04               LD   B,4          ;4 Durchlaeufe
 1370 EED5  16 04               LD   D,4          ;Startwert Extended-Adresse
 1371 EED7  AF          RDTST2: XOR  A
 1372 EED8  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1373 EEDA  7A                  LD   A,D
 1374 EEDB  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1375 EEDD  ED 79               OUT  (C),A        ;Testwert in die RAM-Disk schreiben
 1376 EEDF  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1377 EEE1  10 F4               DJNZ RDTST2
 1378                   ;
 1379                   ;Tabelle der Test-Werte (mit *...* sind die zu testenden Werte):
 1380                   ;
 1381                   ;           RAM-Disk-Size =   256K   512K  1024K  2048K
 1382                   ;Extended-Adresse=00000100B    0      0      0     *4*
 1383                   ;Extended-Adresse=00000010B    0      0     *2*     2
 1384                   ;Extended-Adresse=00000001B    0     *1*     1      1
 1385                   ;Extended-Adresse=00000000B   *0*     0      0      0
 1386                   ;
 1387                   ; Groesse der RAM-Disk bestimmen
 1388                   ;
 1389 EEE3  06 04               LD   B,4          ;4 Durchlaeufe
 1390 EEE5  16 04               LD   D,4          ;Startwert Extended-Adresse
 1391 EEE7  AF          RDTST3: XOR  A
 1392 EEE8  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  25
BIOS    ASM

 1393 EEEA  7A                  LD   A,D
 1394 EEEB  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1395 EEED  ED 78               IN   A,(C)
 1396 EEEF  BA                  CP   D
 1397 EEF0  28 07               JR   Z,RDTST4     ;2048(B=4),1024(B=3),512(B=2),256(B=1)
 1398 EEF2  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1399 EEF4  10 F1               DJNZ RDTST3
 1400 EEF6  C3 EFC2             JP   RDERRO       ;Fehler: hier stimmt was nicht!
 1401                   ;
 1402 EEF9  21 EF19     RDTST4: LD   HL,RDSIZE
 1403 EEFC  05                  DEC  B
 1404 EEFD  70                  LD   (HL),B       ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1405                   ;
 1406                   ; gesicherte Daten in die RAM-Disk zurueckschreiben
 1407                   ; 
 1408 EEFE  21 EF18             LD   HL,RDMERK+3  ;Merkzellen RAM (letzter Eintrag)
 1409 EF01  04                  INC  B            ;1 bis 4 Durchlaeufe, je nach RDSIZE
 1410 EF02  16 01               LD   D,1          ;Startwert Ext.-Adr. (1 Bit n. rechts)
 1411 EF04  AF          RDTST5: XOR  A
 1412 EF05  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1413 EF07  7A                  LD   A,D
 1414 EF08  CB 3F               SRL  A            ;0 --> A7 --> A0 --> CY
 1415 EF0A  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1416 EF0C  7E                  LD   A,(HL)
 1417 EF0D  ED 79               OUT  (C),A        ;urspruengliche Daten zurueckschreiben
 1418 EF0F  2B                  DEC  HL
 1419 EF10  CB 22               SLA  D            ;CY <-- D7 <-- D0 <-- 0
 1420 EF12  10 F0               DJNZ RDTST5       ;WICHTIG: nicht mehr als notwendig
 1421 EF14  C9                  RET               ;in die RAM-Disk zurueckschreiben!
 1422                   ;
 1423 EF15  00 00 00 00 RDMERK: DEFS 4,0          ;4 Merkzellen fuer den RAM-Disk Test
 1424 EF19  00          RDSIZE: DEFB 0            ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1425                   ;
 1426 EF1A  21 EE9F     RDFORM: LD   HL,TXTRDI    ;Formatierungstext...
 1427 EF1D  CD EA4F             CALL OUTTXT
 1428 EF20  21 C002             LD   HL,0C002H    ;Hilfsprogramm von 0C000H bis 0C800H
 1429 EF23  54                  LD   D,H
 1430 EF24  5D                  LD   E,L
 1431 EF25  2B                  DEC  HL
 1432 EF26  36 E0               LD   (HL),PE0     ;0C001H = Grundadresse der RAM-Disk
 1433 EF28  2B                  DEC  HL
 1434 EF29  36 D3               LD   (HL),0D3H    ;0C000H = 0D3H --> OUT n
 1435 EF2B  01 0200             LD   BC,0200H
 1436 EF2E  ED B0               LDIR              ;0D3H,0E0H von 0C000H bis 0C1FFH
 1437 EF30  23                  INC  HL
 1438 EF31  36 E1               LD   (HL),PE0+1
 1439 EF33  2B                  DEC  HL
 1440 EF34  01 0200             LD   BC,0200H
 1441 EF37  ED B0               LDIR              ;0D3H,0E1H von 0C200H bis 0C3FFH
 1442 EF39  23                  INC  HL
 1443 EF3A  36 E2               LD   (HL),PE0+2
 1444 EF3C  2B                  DEC  HL
 1445 EF3D  01 0200             LD   BC,0200H
 1446 EF40  ED B0               LDIR              ;0D3H,0E2H von 0C400H bis 0C5FFH
 1447 EF42  23                  INC  HL
 1448 EF43  36 E3               LD   (HL),PE0+3
 1449 EF45  2B                  DEC  HL
 1450 EF46  01 0200             LD   BC,0200H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  26
BIOS    ASM

 1451 EF49  ED B0               LDIR              ;0D3H,0E3H von 0C600H bis 0C7FFH
 1452 EF4B  36 C9               LD   (HL),0C9H    ;RET auf 0C800H
 1453                   ;
 1454 EF4D  21 EF19             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1455 EF50  7E                  LD   A,(HL)
 1456 EF51  FE 00               CP   0
 1457 EF53  28 0A               JR   Z,RDFOR1     ;RD 256K
 1458 EF55  FE 01               CP   1
 1459 EF57  28 06               JR   Z,RDFOR1     ;RD 512K
 1460 EF59  3D                  DEC  A
 1461 EF5A  CB 27               SLA  A            ;A *= 2
 1462 EF5C  CB 27               SLA  A            ;A *= 2
 1463 EF5E  3D                  DEC  A
 1464 EF5F  57          RDFOR1: LD   D,A
 1465 EF60  14                  INC  D            ;D ==> 1=256K 2=512K 4=1024K 8=2048K
 1466 EF61  AF                  XOR  A
 1467 EF62  D3 E7               OUT  (PE0+7),A    ;L-Adresse setzen
 1468 EF64  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1469 EF66  1E 00               LD   E,0          ;Merker fuer Extended-Adresse
 1470 EF68  06 00               LD   B,0          ;256 Durchlaeufe
 1471 EF6A  0E E6               LD   C,PE0+6
 1472 EF6C  ED 41       RDFOR2: OUT  (C),B        ;H-Adresse setzen
 1473 EF6E  3E E5               LD   A,0E5H       ;RD wird mit 0E5H formatiert
 1474 EF70  CD C000             CALL HPRDSK       ;Hilfsprog. Format RAM-Disk auf C000H
 1475 EF73  10 F7               DJNZ RDFOR2       ;fuer alle H-Adressen (256 Durchl.)
 1476 EF75  1C                  INC  E
 1477 EF76  7B                  LD   A,E
 1478 EF77  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1479 EF79  15                  DEC  D
 1480 EF7A  20 F0               JR   NZ,RDFOR2        
 1481                   ;
 1482 EF7C  21 D000             LD   HL,CCP
 1483 EF7F  22 F440             LD   (DMA),HL
 1484 EF82  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
 1485 EF84  CD EF93             CALL WRCCP
 1486 EF87  C2 E97D             JP   NZ,CPMERR
 1487 EF8A  21 EEA9             LD   HL,TXTRDO    ;"OK"
 1488 EF8D  CD EA4F             CALL OUTTXT
 1489 EF90  C3 E960             JP   WBOOT1
 1490                   ;
 1491 EF93  C5          WRCCP:  PUSH BC           ;CCP+BDOS in Systemtrack schreiben
 1492 EF94  0E 00               LD   C,0          ;LW A:
 1493 EF96  CD EDF5             CALL SELDSK
 1494 EF99  C1                  POP  BC
 1495 EF9A  21 0000             LD   HL,0000H
 1496 EF9D  22 F43C             LD   (TRACK),HL   ;Track 0
 1497 EFA0  EB                  EX   DE,HL
 1498 EFA1  21 D000             LD   HL,CCP
 1499 EFA4  ED 53 F43E  WRCCP1: LD   (SECTOR),DE  ;Sektor 0 ff.
 1500 EFA8  22 F440             LD   (DMA),HL
 1501 EFAB  C5                  PUSH BC
 1502 EFAC  CD                  DEFB 0CDH         ;CALL WRITE -> CD ED CA
 1503 EFAD  EE37        WRCCP2: DEFW WRITE        ;kannn durch READ (EDC5) ersetzt werden
 1504 EFAF  C1                  POP  BC
 1505 EFB0  20 10               JR   NZ,RDERRO
 1506 EFB2  2A F440             LD   HL,(DMA)
 1507 EFB5  11 0080             LD   DE,0080H
 1508 EFB8  19                  ADD  HL,DE
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  27
BIOS    ASM

 1509 EFB9  ED 5B F43E          LD   DE,(SECTOR)
 1510 EFBD  13                  INC  DE
 1511 EFBE  10 E4               DJNZ WRCCP1
 1512 EFC0  AF                  XOR  A
 1513 EFC1  C9                  RET
 1514                   ;
 1515 EFC2  21 EEAC     RDERRO: LD   HL,TXTRDE
 1516 EFC5  CD EA4F             CALL OUTTXT
 1517 EFC8  AF                  XOR  A
 1518 EFC9  3D                  DEC  A
 1519 EFCA  C9                  RET
 1520                   ;
 1521                   ;Adressarithmetik RAF: L=RADR 0-7 , H=RADR 8-15 , A=RADR 16-19
 1522                   ;
 1523 EFCB  AF          ADRRAF: XOR  A            ;CY = 0
 1524 EFCC  6F                  LD   L,A 
 1525 EFCD  3A F41B             LD   A,(RAFSEC)   ;8 bit
 1526 EFD0  67                  LD   H,A          ;H=Sektor (max. 64 = Bit 0-5)
 1527 EFD1  CB 1C               RR   H
 1528 EFD3  CB 1D               RR   L            ;H0 -> L7 ...... H5 -> H4
 1529 EFD5  3A F41A             LD   A,(RAFTRK)   ;8 bit , A=Track (max. 128 bei 1M = Bit 0-6)
 1530 EFD8  CB 1F               RR   A            ;A0 -> CY
 1531 EFDA  30 02               JR   NC,ADRAF1
 1532 EFDC  CB EC               SET  5,H          ;H5 = A0 (RADR13)
 1533 EFDE  CB 1F       ADRAF1: RR   A            ;A1 -> CY
 1534 EFE0  30 02               JR   NC,ADRAF2
 1535 EFE2  CB F4               SET  6,H          ;H6 = A1 (RADR14)
 1536 EFE4  CB 1F       ADRAF2: RR   A            ;A2 -> CY
 1537 EFE6  30 02               JR   NC,ADRAF3
 1538 EFE8  CB FC               SET  7,H          ;H7 = A2 (RADR15)
 1539 EFEA  F5          ADRAF3: PUSH AF
 1540 EFEB  E6 03               AND  03H
 1541 EFED  F6 E0               OR   PE0          ;Grundadresse der RAM-Disk
 1542 EFEF  4F                  LD   C,A
 1543 EFF0  7D                  LD   A,L
 1544 EFF1  D3 E7               OUT  (PE0+7),A    ;L-Adresse
 1545 EFF3  7C                  LD   A,H
 1546 EFF4  D3 E6               OUT  (PE0+6),A    ;H-Adresse
 1547 EFF6  F1                  POP  AF
 1548 EFF7  CB 1F               RR   A            ;Rotiere A rechts durch Carry
 1549 EFF9  CB 1F               RR   A
 1550 EFFB  E6 07               AND  07H          ;max. 2048K RAM-Disk
 1551 EFFD  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1552 EFFF  06 80               LD   B,80H
 1553 F001  2A F440             LD   HL,(DMA)
 1554 F004  C9                  RET
 1555                   ;
 1556                   ;******************************  LOAD  ******************************
 1557                   ;
 1558 F005  C9          LOAD:   RET
 1559                   ;
 1560 F006  2A F442     LEFFA:  LD   HL,(DPH)     ;zugeordneter DPH --> HL
 1561 F009  22 F454             LD   (DPH3M),HL   ;Merkzelle DPH
 1562 F00C  2E 0F       LF000:  LD   L,0FH
 1563 F00E  D5          LF002:  PUSH DE
 1564 F00F  11 000A             LD   DE,000AH
 1565 F012  62                  LD   H,D
 1566 F013  E5                  PUSH HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  28
BIOS    ASM

 1567 F014  2A F454             LD   HL,(DPH3M)   ;Merkzelle DPH
 1568 F017  19                  ADD  HL,DE
 1569 F018  5E                  LD   E,(HL)
 1570 F019  23                  INC  HL
 1571 F01A  56                  LD   D,(HL)
 1572 F01B  E1                  POP  HL
 1573 F01C  19                  ADD  HL,DE
 1574 F01D  D1                  POP  DE
 1575 F01E  7E                  LD   A,(HL)
 1576 F01F  B7                  OR   A
 1577 F020  C9                  RET
 1578                   ;
 1579                   ;
 1580                   ;       READ/WRITE Routinen GIDE + Floppy-Disk
 1581                   ;       --------------------------------------
 1582                   ;
 1583 F021  23          RWGIDE: INC  HL
 1584 F022  CB FE               SET  7,(HL)
 1585 F024  2B                  DEC  HL
 1586 F025  AF          RWFLO:  XOR  A
 1587 F026  32 F45B             LD   (DF51C),A
 1588 F029  CD F030             CALL LF024
 1589 F02C  3A F45B             LD   A,(DF51C)
 1590 F02F  C9                  RET
 1591                   ;
 1592 F030  4E          LF024:  LD   C,(HL)
 1593 F031  CD F006             CALL LEFFA
 1594 F034  CA F0ED             JP   Z,LF0E1
 1595 F037  79                  LD   A,C
 1596 F038  FE 06               CP   06H
 1597 F03A  3E 01               LD   A,01H
 1598 F03C  20 01               JR   NZ,LF033
 1599 F03E  AF                  XOR  A
 1600 F03F  32 F45C     LF033:  LD   (DF51D),A
 1601 F042  CD F00C             CALL LF000
 1602 F045  47                  LD   B,A
 1603 F046  2A F43E             LD   HL,(SECTOR)
 1604 F049  CB 3C       LF03D:  SRL  H
 1605 F04B  CB 1D               RR   L
 1606 F04D  10 FA               DJNZ LF03D
 1607 F04F  22 F457             LD   (DF518),HL
 1608 F052  21 F459             LD   HL,DF51A
 1609 F055  7E                  LD   A,(HL)
 1610 F056  36 01               LD   (HL),01H
 1611 F058  B7                  OR   A
 1612 F059  28 26               JR   Z,LF075
 1613 F05B  3A F43B             LD   A,(DRIVE)
 1614 F05E  21 F444             LD   HL,DRV2
 1615 F061  BE                  CP   (HL)
 1616 F062  20 16               JR   NZ,LF06E
 1617 F064  2A F445             LD   HL,(TRK2)
 1618 F067  ED 5B F43C          LD   DE,(TRACK)
 1619 F06B  ED 52               SBC  HL,DE
 1620 F06D  20 0B               JR   NZ,LF06E
 1621 F06F  2A F447             LD   HL,(SEC2)
 1622 F072  ED 5B F457          LD   DE,(DF518)
 1623 F076  ED 52               SBC  HL,DE
 1624 F078  28 1F               JR   Z,LF08D
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  29
BIOS    ASM

 1625 F07A  3A F45A     LF06E:  LD   A,(DF51B)
 1626 F07D  B7                  OR   A
 1627 F07E  C4 F0DA             CALL NZ,LF0CE
 1628 F081  21 F43B     LF075:  LD   HL,DRIVE
 1629 F084  11 F444             LD   DE,DRV2
 1630 F087  01 0009             LD   BC,9         ;9 Bytes kopieren
 1631 F08A  ED B0               LDIR
 1632 F08C  2A F457             LD   HL,(DF518)
 1633 F08F  22 F447             LD   (SEC2),HL
 1634 F092  CD F0DD             CALL LF0D1
 1635 F095  AF                  XOR  A
 1636 F096  32 F45A             LD   (DF51B),A
 1637 F099  CD F00C     LF08D:  CALL LF000
 1638 F09C  23                  INC  HL
 1639 F09D  3A F43E             LD   A,(SECTOR)
 1640 F0A0  A6                  AND  (HL)
 1641 F0A1  1F                  RRA
 1642 F0A2  67                  LD   H,A
 1643 F0A3  3E 00               LD   A,00H
 1644 F0A5  1F                  RRA
 1645 F0A6  6F                  LD   L,A
 1646 F0A7  11 F45E             LD   DE,DISKP
 1647 F0AA  19                  ADD  HL,DE
 1648 F0AB  ED 5B F440          LD   DE,(DMA)
 1649 F0AF  3A F45C             LD   A,(DF51D)
 1650 F0B2  B7                  OR   A
 1651 F0B3  20 05               JR   NZ,LF0AE
 1652 F0B5  3C                  INC  A
 1653 F0B6  32 F45A             LD   (DF51B),A
 1654 F0B9  EB                  EX   DE,HL
 1655 F0BA  01 0080     LF0AE:  LD   BC,0080H
 1656 F0BD  ED B0               LDIR
 1657 F0BF  3A F45B             LD   A,(DF51C)
 1658 F0C2  B7                  OR   A
 1659 F0C3  20 10               JR   NZ,LF0C9
 1660 F0C5  3A F45D             LD   A,(DF51E)
 1661 F0C8  3D                  DEC  A
 1662 F0C9  C0                  RET  NZ
 1663 F0CA  32 F45A             LD   (DF51B),A
 1664 F0CD  CD F0DA             CALL LF0CE
 1665 F0D0  3A F45B             LD   A,(DF51C)
 1666 F0D3  B7                  OR   A
 1667 F0D4  C8                  RET  Z
 1668 F0D5  AF          LF0C9:  XOR  A
 1669 F0D6  32 F459             LD   (DF51A),A
 1670 F0D9  C9                  RET
 1671                   ;
 1672 F0DA  3E 06       LF0CE:  LD   A,06H
 1673 F0DC  21                  DEFB 21H          ;LD HL,043EH -> 21 3E 04
 1674 F0DD  3E 04       LF0D1:  LD   A,04H  
 1675 F0DF  32 F456             LD   (MERKRW),A
 1676 F0E2  21 F45E             LD   HL,DISKP
 1677 F0E5  22 F449             LD   (DMA2),HL
 1678 F0E8  21 F444             LD   HL,DRV2
 1679 F0EB  18 09               JR   LF0EA
 1680                   ;
 1681 F0ED  3A F43A     LF0E1:  LD   A,(RWBYTE)
 1682 F0F0  32 F456             LD   (MERKRW),A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  30
BIOS    ASM

 1683 F0F3  21 F43B             LD   HL,DRIVE
 1684 F0F6  11 F44D     LF0EA:  LD   DE,DRV3
 1685 F0F9  01 0009             LD   BC,9         ;9 Bytes kopieren
 1686 F0FC  ED B0               LDIR
 1687 F0FE  3A F44D             LD   A,(DRV3)
 1688 F101  17                  RLA
 1689 F102  DA F314             JP   C,GIDERW     ;GIDE
 1690 F105  3A F44F             LD   A,(TRK3+1)
 1691 F108  21 F451             LD   HL,SEC3+1
 1692 F10B  B6                  OR   (HL)
 1693 F10C  C2 F1CD             JP   NZ,LF1C1
 1694 F10F  CD F00C             CALL LF000
 1695 F112  32 F42D             LD   (DF4E8),A
 1696 F115  B7                  OR   A
 1697 F116  3E FF               LD   A,0FFH
 1698 F118  28 02               JR   Z,LF110
 1699 F11A  3E 80               LD   A,80H
 1700 F11C  32 F430     LF110:  LD   (DF4EB),A
 1701 F11F  23                  INC  HL
 1702 F120  23                  INC  HL
 1703 F121  7E                  LD   A,(HL)
 1704 F122  32 F42E             LD   (DF4E9),A
 1705 F125  3A F450             LD   A,(SEC3)
 1706 F128  BE                  CP   (HL)
 1707 F129  38 04               JR   C,LF123
 1708 F12B  96                  SUB  (HL)
 1709 F12C  01 0104             LD   BC,0104H
 1710 F12F  3C          LF123:  INC  A
 1711 F130  32 F42C             LD   (DF4E7),A
 1712 F133  23                  INC  HL
 1713 F134  7E                  LD   A,(HL)
 1714 F135  32 F42F             LD   (DF4EA),A
 1715 F138  23                  INC  HL
 1716 F139  3A F44E             LD   A,(TRK3)
 1717 F13C  BE                  CP   (HL)
 1718 F13D  38 04               JR   C,LF137
 1719 F13F  96                  SUB  (HL)
 1720 F140  01 0104             LD   BC,0104H
 1721 F143  32 F42A     LF137:  LD   (DF4E5),A
 1722 F146  23                  INC  HL
 1723 F147  7E                  LD   A,(HL)
 1724 F148  B1                  OR   C
 1725 F149  32 F429             LD   (DF4E4),A
 1726 F14C  78                  LD   A,B
 1727 F14D  32 F42B             LD   (DF4E6),A
 1728 F150  23                  INC  HL
 1729 F151  3A F456             LD   A,(MERKRW)
 1730 F154  16 05               LD   D,05H
 1731 F156  FE 06               CP   06H
 1732 F158  28 02               JR   Z,LF150
 1733 F15A  16 06               LD   D,06H
 1734 F15C  7E          LF150:  LD   A,(HL)
 1735 F15D  E6 40               AND  40H
 1736 F15F  B2                  OR   D
 1737 F160  32 F427             LD   (DF4E2),A
 1738 F163  11 F431             LD   DE,DF4EC
 1739 F166  01 0004             LD   BC,0004H
 1740 F169  ED B0               LDIR
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  31
BIOS    ASM

 1741 F16B  0E 02               LD   C,02H
 1742 F16D  06 02       LF161:  LD   B,02H
 1743 F16F  C5          LF163:  PUSH BC
 1744 F170  CD F181             CALL LF175
 1745 F173  C1                  POP  BC
 1746 F174  B7                  OR   A
 1747 F175  C8                  RET  Z
 1748 F176  10 F7               DJNZ LF163
 1749 F178  0D                  DEC  C
 1750 F179  C8                  RET  Z
 1751 F17A  C5                  PUSH BC
 1752 F17B  CD F1E1             CALL LF1D5
 1753 F17E  C1                  POP  BC
 1754 F17F  18 EC               JR   LF161
 1755                   ;
 1756 F181  3E 03       LF175:  LD   A,03H
 1757 F183  06 02               LD   B,02H
 1758 F185  21 F433             LD   HL,CTAB      ;FDC Befehlsbyte
 1759 F188  D3 41               OUT  (DFDC),A     ;Datenport FDC
 1760 F18A  CD F23C             CALL LF230
 1761 F18D  CD F1F3             CALL LF1E7
 1762 F190  20 3B               JR   NZ,LF1C1
 1763 F192  21 0040             LD   HL,0040H
 1764 F195  3A F42D             LD   A,(DF4E8)
 1765 F198  3C                  INC  A
 1766 F199  29          LF18D:  ADD  HL,HL
 1767 F19A  3D                  DEC  A
 1768 F19B  20 FC               JR   NZ,LF18D
 1769 F19D  2B                  DEC  HL
 1770 F19E  24                  INC  H
 1771 F19F  2C                  INC  L
 1772 F1A0  E5                  PUSH HL
 1773 F1A1  2A F452             LD   HL,(DMA3)
 1774 F1A4  E5                  PUSH HL
 1775 F1A5  3A F427             LD   A,(DF4E2)
 1776 F1A8  4F                  LD   C,A
 1777 F1A9  06 09               LD   B,09H
 1778 F1AB  0F                  RRCA
 1779 F1AC  3E 51               LD   A,51H
 1780 F1AE  8F                  ADC  A,A
 1781 F1AF  32 F27B             LD   (MODE0),A    ;A2 --> INI
 1782 F1B2  32 F281             LD   (MODE1),A    ;A3 --> OUTI
 1783 F1B5  F3                  DI
 1784 F1B6  CD F233             CALL LF227
 1785 F1B9  E1                  POP  HL
 1786 F1BA  D1                  POP  DE
 1787 F1BB  43                  LD   B,E
 1788 F1BC  0E 41               LD   C,DFDC       ;Datenport FDC
 1789 F1BE  CD F26E             CALL RW           ;FDC RW-Routine
 1790 F1C1  FB                  EI
 1791 F1C2  CD F1D4             CALL LF1C8
 1792 F1C5  21 F435             LD   HL,DF4F0
 1793 F1C8  7E                  LD   A,(HL)
 1794 F1C9  E6 C0               AND  0C0H
 1795 F1CB  28 02               JR   Z,LF1C3
 1796 F1CD  3E FF       LF1C1:  LD   A,0FFH
 1797 F1CF  32 F45B     LF1C3:  LD   (DF51C),A
 1798 F1D2  B7                  OR   A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  32
BIOS    ASM

 1799 F1D3  C9                  RET
 1800                   ;
 1801 F1D4  06 07       LF1C8:  LD   B,07H
 1802 F1D6  21 F435             LD   HL,DF4F0
 1803 F1D9  CD F257     LF1CD:  CALL RBYTE
 1804 F1DC  77                  LD   (HL),A
 1805 F1DD  23                  INC  HL
 1806 F1DE  10 F9               DJNZ LF1CD
 1807 F1E0  C9                  RET
 1808                   ;
 1809 F1E1  01 0207     LF1D5:  LD   BC,0207H     ;Spur 0 einstellen
 1810 F1E4  CD F233             CALL LF227
 1811 F1E7  CD F213             CALL SENSE
 1812 F1EA  C8                  RET  Z
 1813 F1EB  01 0207             LD   BC,0207H
 1814 F1EE  CD F233             CALL LF227
 1815 F1F1  18 20               JR   SENSE
 1816                   ;
 1817 F1F3  3A F42A     LF1E7:  LD   A,(DF4E5)
 1818 F1F6  32 F436             LD   (DF4F7),A
 1819 F1F9  B7                  OR   A
 1820 F1FA  28 E5               JR   Z,LF1D5
 1821 F1FC  01 030F             LD   BC,030FH
 1822 F1FF  21 F431             LD   HL,DF4EC
 1823 F202  CB 66               BIT  4,(HL)
 1824 F204  28 04               JR   Z,LF1FE
 1825 F206  87                  ADD  A,A
 1826 F207  32 F42A             LD   (DF4E5),A
 1827 F20A  CD F233     LF1FE:  CALL LF227
 1828 F20D  3A F436             LD   A,(DF4F7)
 1829 F210  32 F42A             LD   (DF4E5),A
 1830 F213  01 0108     SENSE:  LD   BC,0108H
 1831 F216  CD F233             CALL LF227
 1832 F219  CD F257             CALL RBYTE
 1833 F21C  47                  LD   B,A
 1834 F21D  32 F435             LD   (DF4F0),A
 1835 F220  FE 80               CP   80H
 1836 F222  C4 F257             CALL NZ,RBYTE     ;PCN holen
 1837 F225  CB 68               BIT  5,B          ;SEEK Ende?
 1838 F227  28 EA               JR   Z,SENSE
 1839 F229  78                  LD   A,B
 1840 F22A  E6 F0               AND  0F0H
 1841 F22C  FE C0               CP   0C0H
 1842 F22E  28 E3               JR   Z,SENSE
 1843 F230  EE 20               XOR  20H
 1844 F232  C9                  RET
 1845                   ;
 1846 F233  C5          LF227:  PUSH BC
 1847 F234  CD F291             CALL LF285
 1848 F237  C1                  POP  BC
 1849 F238  21 F428     LF22C:  LD   HL,DF4E3
 1850 F23B  71                  LD   (HL),C
 1851 F23C  0E 41       LF230:  LD   C,41H
 1852 F23E  D5                  PUSH DE
 1853 F23F  11 1FFF     LF233:  LD   DE,1FFFH
 1854 F242  7B          LF236:  LD   A,E
 1855 F243  B2                  OR   D
 1856 F244  28 0D               JR   Z,LF247      ;Abbruch nach 8192 Versuchen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  33
BIOS    ASM

 1857 F246  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1858 F248  E6 C0               AND  0C0H
 1859 F24A  FE 80               CP   80H          ;FDC bereit zum Schreiben?
 1860 F24C  1B                  DEC  DE
 1861 F24D  20 F3               JR   NZ,LF236     ;noch nicht bereit
 1862 F24F  ED A3               OUTI              ;1 Byte --> FDC
 1863 F251  20 EC               JR   NZ,LF233     ;Wdhlg., bis B=0
 1864 F253  06 00       LF247:  LD   B,00H
 1865 F255  D1                  POP  DE
 1866 F256  C9                  RET
 1867                   ;
 1868 F257  E5          RBYTE:  PUSH HL           ;1 Byte lesen
 1869 F258  21 1FFF             LD   HL,1FFFH
 1870 F25B  7D          RBYTE1: LD   A,L
 1871 F25C  B4                  OR   H
 1872 F25D  3E C0               LD   A,0C0H
 1873 F25F  28 0B               JR   Z,RBYTE2     ;Abbruch nach 8192 Versuchen
 1874 F261  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1875 F263  E6 C0               AND  0C0H
 1876 F265  FE C0               CP   0C0H         ;FDC bereit zum Lesen?
 1877 F267  2B                  DEC  HL
 1878 F268  20 F1               JR   NZ,RBYTE1    ;noch nicht bereit
 1879 F26A  DB 41               IN   A,(DFDC)     ;1 Byte vom FDC lesen --> A
 1880 F26C  E1          RBYTE2: POP  HL
 1881 F26D  C9                  RET
 1882                   ;
 1883                   ;
 1884                   ;       FDC READ/WRITE Routine
 1885                   ;       ----------------------
 1886                   ;
 1887 F26E  3A F439     RW:     LD   A,(LATPU)
 1888 F271  CB CF               SET  1,A
 1889 F273  D3 45               OUT  (LATCH),A    ;WAIT-Freigabe
 1890 F275  DB 40       RW01:   IN   A,(CFDC)     ;Lese Hauptstatusregister
 1891 F277  07                  RLCA
 1892 F278  30 FB               JR   NC,RW01      ;FDC noch nicht bereit
 1893 F27A  ED                  DEFB 0EDH         ;ED A2 = INI
 1894 F27B  A2          MODE0:  DEFB 0A2H         ;ED A3 = OUTI
 1895 F27C  00                  NOP
 1896 F27D  D3 43       RW02:   OUT  (FLWAIT),A   ;WAIT bis Interrupt FDC
 1897 F27F  00                  NOP
 1898 F280  ED                  DEFB 0EDH         ;ED A2 = INI
 1899 F281  A2          MODE1:  DEFB 0A2H         ;ED A3 = OUTI
 1900 F282  C2 F27D             JP   NZ,RW02
 1901 F285  15                  DEC  D
 1902 F286  C2 F27D             JP   NZ,RW02
 1903 F289  3A F439             LD   A,(LATPU)
 1904 F28C  CB E7               SET  4,A          ;Terminal Count
 1905 F28E  D3 45               OUT  (LATCH),A    ;TC + WAIT-Sperrung
 1906 F290  C9                  RET
 1907                   ;
 1908 F291  21 F437     LF285:  LD   HL,DF4F8
 1909 F294  3A F429             LD   A,(DF4E4)
 1910 F297  E6 03               AND  03H
 1911 F299  BE                  CP   (HL)
 1912 F29A  77                  LD   (HL),A
 1913 F29B  23                  INC  HL
 1914 F29C  4E                  LD   C,(HL)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  34
BIOS    ASM

 1915 F29D  36 48               LD   (HL),48H
 1916 F29F  F5                  PUSH AF
 1917 F2A0  E5                  PUSH HL
 1918 F2A1  21 F439             LD   HL,LATPU
 1919 F2A4  3A F429             LD   A,(DF4E4)
 1920 F2A7  E6 03               AND  03H
 1921 F2A9  28 08               JR   Z,LF2A7
 1922 F2AB  FE 02               CP   02H
 1923 F2AD  28 04               JR   Z,LF2A7
 1924 F2AF  CB DE               SET  3,(HL)       ;Floppy-LW 1: Motor an
 1925 F2B1  18 02               JR   LF2A9
 1926                   ;
 1927 F2B3  CB C6       LF2A7:  SET  0,(HL)       ;Floppy-LW 0: Motor an
 1928 F2B5  7E          LF2A9:  LD   A,(HL)
 1929 F2B6  D3 45               OUT  (LATCH),A
 1930 F2B8  E1                  POP  HL
 1931 F2B9  F1                  POP  AF
 1932 F2BA  20 04               JR   NZ,LF2B4
 1933 F2BC  79                  LD   A,C
 1934 F2BD  A7                  AND  A
 1935 F2BE  20 09               JR   NZ,LF2BD
 1936 F2C0  3E 48       LF2B4:  LD   A,48H
 1937 F2C2  CB 3F               SRL  A
 1938 F2C4  CB 3F               SRL  A
 1939 F2C6  BE                  CP   (HL)
 1940 F2C7  38 F7               JR   C,LF2B4
 1941 F2C9  7E          LF2BD:  LD   A,(HL)
 1942 F2CA  A7                  AND  A
 1943 F2CB  20 08               JR   NZ,LF2C9
 1944 F2CD  E5                  PUSH HL
 1945 F2CE  21 F2E9             LD   HL,DISCTX
 1946 F2D1  CD EA4F             CALL OUTTXT
 1947 F2D4  E1                  POP  HL
 1948 F2D5  C5          LF2C9:  PUSH BC
 1949 F2D6  E5                  PUSH HL
 1950 F2D7  01 0204             LD   BC,0204H
 1951 F2DA  CD F238             CALL LF22C
 1952 F2DD  CD F257             CALL RBYTE
 1953 F2E0  E1                  POP  HL
 1954 F2E1  C1                  POP  BC
 1955 F2E2  CB 6F               BIT  5,A
 1956 F2E4  28 E3               JR   Z,LF2BD
 1957 F2E6  36 90               LD   (HL),90H
 1958 F2E8  C9                  RET
 1959                   ;
 1960 F2E9  20 44 49 53 DISCTX: DEFM ' DISC?'
 1961 F2EF  08 08 08 08         DEFB 8,8,8,8,8,8
 1962 F2F5  00                  NOP
 1963                   ;
 1964                   ;
 1965                   ; Interrupteinsprung von CTC Kanal 3
 1966                   ;
 1967 F2F6  F3          ISRCTC: DI                ;DI hat gefehlt, wurde ergaenzt
 1968 F2F7  F5                  PUSH AF
 1969 F2F8  3A F438             LD   A,(CTCCNT)   ;CTC-Zusatzzaehler lesen
 1970 F2FB  A7                  AND  A
 1971 F2FC  28 12               JR   Z,ISRCTE     ;bei "0", die Fkt. beenden
 1972                           ;Beim Start von HRCPM wird CNTCNT per Interrupt von 255 auf 0 heruntergezaehlt.
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  35
BIOS    ASM

 1973                           ;--> verzoegerte Steuerung von LATPU und LATCH
 1974 F2FE  3D                  DEC  A
 1975 F2FF  32 F438             LD   (CTCCNT),A
 1976 F302  20 0C               JR   NZ,ISRCTE
 1977 F304  E5                  PUSH HL           ;Bei 2 MHz CPU-Takt wird nach 8 Sekunden diese Stelle erreicht
 1978 F305  21 F439             LD   HL,LATPU
 1979 F308  CB 86               RES  0,(HL)       ;Floppy-LW 0: Motor aus
 1980 F30A  CB 9E               RES  3,(HL)       ;Floppy-LW 1: Motor aus
 1981 F30C  7E                  LD   A,(HL)
 1982 F30D  D3 45               OUT  (LATCH),A    ;Latch auf dem Floppy-Controller ruecksetzen
 1983 F30F  E1                  POP  HL
 1984 F310  F1          ISRCTE: POP  AF
 1985 F311  FB          INTEND: EI                ;ist zusaetzlich Einsprungpunkt fuer nicht genutzte Interrupts
 1986 F312  ED 4D               RETI
 1987                   ;
 1988                   ;-------------  R/W GIDE HW  -----------------------------------------------------------
 1989                   
 1990 F314  DB 8F       GIDERW: IN   A,(P8F)      ;Command / Status
 1991 F316  17                  RLA               ;Bit 0 = CY
 1992 F317  38 FB               JR   C,GIDERW     ;wait for hard disk ready (non-busy)
 1993 F319  2E 19               LD   L,19H
 1994 F31B  CD F00E             CALL LF002
 1995 F31E  4F                  LD   C,A
 1996 F31F  2A F450             LD   HL,(SEC3)
 1997 F322  23                  INC  HL
 1998 F323  AF                  XOR  A
 1999 F324  47                  LD   B,A
 2000 F325  3C          LF318:  INC  A
 2001 F326  ED 42               SBC  HL,BC
 2002 F328  28 02               JR   Z,LF31F
 2003 F32A  30 F9               JR   NC,LF318
 2004 F32C  09          LF31F:  ADD  HL,BC
 2005 F32D  3D                  DEC  A
 2006 F32E  57                  LD   D,A
 2007 F32F  5D                  LD   E,L
 2008 F330  2E 11               LD   L,11H
 2009 F332  CD F00E             CALL LF002
 2010 F335  B2                  OR   D
 2011 F336  D3 8E               OUT  (P8E),A      ;Drive and Head
 2012 F338  7B                  LD   A,E
 2013 F339  D3 8B               OUT  (P8B),A      ;Sector Number
 2014 F33B  23                  INC  HL
 2015 F33C  5E                  LD   E,(HL)
 2016 F33D  23                  INC  HL
 2017 F33E  56                  LD   D,(HL)
 2018 F33F  2A F44E             LD   HL,(TRK3)
 2019 F342  19                  ADD  HL,DE
 2020 F343  7D                  LD   A,L
 2021 F344  D3 8C               OUT  (P8C),A      ;Cylinder Low
 2022 F346  7C                  LD   A,H
 2023 F347  D3 8D               OUT  (P8D),A      ;Cylinder High
 2024 F349  3E 01               LD   A,01H
 2025 F34B  D3 8A               OUT  (P8A),A      ;Sector Count
 2026 F34D  3A F456             LD   A,(MERKRW)
 2027 F350  FE 06               CP   06H
 2028 F352  28 16               JR   Z,LF35D      ;6 = schreiben
 2029                   ;
 2030                   ;  GIDE lesen 1 Sektor = 512 Bytes nach Puffer
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  36
BIOS    ASM

 2031                   ;
 2032 F354  3E 20               LD   A,20H        ;Read Sector
 2033 F356  D3 8F               OUT  (P8F),A      ;Command / Status
 2034 F358  DB 8F       LF34B:  IN   A,(P8F)      ;Command / Status
 2035 F35A  CB 5F               BIT  3,A
 2036 F35C  28 FA               JR   Z,LF34B      ;wait resp. DRQ active.
 2037 F35E  2A F452             LD   HL,(DMA3)
 2038 F361  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2039 F364  ED B2               INIR
 2040 F366  ED B2               INIR              ;512 bytes gesamt lesen
 2041 F368  18 19               JR   LF376
 2042                   ;
 2043                   ;  GIDE schreiben 1 Sektor = 512 Bytes von Puffer
 2044                   ;
 2045 F36A  3E 30       LF35D:  LD   A,30H        ;Write Sector
 2046 F36C  D3 8F               OUT  (P8F),A      ;Command / Status
 2047 F36E  DB 8F       LF361:  IN   A,(P8F)      ;Command / Status
 2048 F370  17                  RLA               ;Bit 0 = CY
 2049 F371  38 FB               JR   C,LF361      ;wait for hard disk ready (non-busy)
 2050 F373  DB 8F       LF366:  IN   A,(P8F)      ;Command / Status
 2051 F375  CB 5F               BIT  3,A
 2052 F377  28 FA               JR   Z,LF366      ;wait resp. DRQ active.
 2053 F379  2A F452             LD   HL,(DMA3)
 2054 F37C  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2055 F37F  ED B3               OTIR             
 2056 F381  ED B3               OTIR              ;512 bytes gesamt schreiben 
 2057                   ;        
 2058 F383  DB 8F       LF376:  IN   A,(P8F)      ;Command / Status
 2059 F385  17                  RLA               ;Bit 0 = CY
 2060 F386  38 FB               JR   C,LF376      ;wait for hard disk ready (non-busy)
 2061 F388  DB 8F               IN   A,(P8F)      ;Command / Status
 2062 F38A  E6 89               AND  89H          ;10001001b - busy, DRQ, or error?
 2063 F38C  C8                  RET  Z            ;no: all is fine, mit A=0
 2064 F38D  3E FF               LD   A,0FFH
 2065 F38F  32 F45B             LD   (DF51C),A
 2066 F392  C9                  RET               ;on errors, return with A=FFh
 2067                   ;
 2068                   ;-----------------  ENDE GIDE HW  ------------------------------------------
 2069                   ;
 2070 F393  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2071 F3AD  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2072 F3C7  43 4F 4E 4F CINSP:  DEFM "CONOUT-STACK_CONOUT-STACK_CONOUT-STACK"
 2073 F3ED  5A 42 49 4F COUTSP: DEFM "ZBIOS(C)ML-SOFT 2003 & AC1-BIOS(C)HR 2011"
 2074 F416  00          CPMSTK: NOP
 2075                   ;
 2076                   ;******************************  Ende CP/M-Stack  ******************************
 2077                   ;
 2078 F417  00          COLOR:  DEFB 0            ;Merkzelle aktuelle BWS-Farbe (0=Monochrom)
 2079 F418  00          COLO1:  DEFB 0            ;aktuelle Farbe ohne invers und intensiv
 2080 F419  00          COLO2:  DEFB 0            ;Farbe fuer Monitor und CP/M Warmstart
 2081                   ;
 2082 F41A  00          RAFTRK: DEFB 0            ;RAFTRK EQU 0F4C2H
 2083 F41B  00          RAFSEC: DEFB 0
 2084                   ;
 2085 F41C  01          CUFLAG: DEFB 1            ;CUON/CUOFF  KursorFlag
 2086 F41D  00          STZ00:  DEFB 0            ;Merkzelle Anz. BS-Steuerzeichen
 2087 F41E  00          STZ01:  DEFB 0            ;Merkzelle fuer 1. ESC-Steuerzeichen
 2088 F41F  00          STZ02:  DEFB 0            ;Merkzelle fuer 2. ESC-Steuerzeichen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  37
BIOS    ASM

 2089                   ;
 2090 F420  00          CHAR:   DEFB 0            ;Merkzelle Zeichen <> Cursor
 2091                   ;
 2092 F421  0000        SPCIN:  DEFW 0            ;Merkzelle Stackpointer waehrend CONIN
 2093 F423  0000        SPCOUT: DEFW 0            ;Merkzelle Stackpointer waehrend CONOUT
 2094 F425  0000        OLDNMI: DEFW 0            ;2 Bytes fuer alten NMI
 2095                   ;
 2096 F427  00          DF4E2:  NOP
 2097 F428  00          DF4E3:  NOP               ;Merkzelle
 2098 F429  00          DF4E4:  NOP
 2099 F42A  00          DF4E5:  NOP
 2100 F42B  00          DF4E6:  NOP
 2101 F42C  00          DF4E7:  NOP
 2102 F42D  00          DF4E8:  NOP
 2103 F42E  00          DF4E9:  NOP
 2104 F42F  00          DF4EA:  NOP
 2105 F430  00          DF4EB:  NOP
 2106                   ;
 2107 F431  00          DF4EC:  NOP               ;4 Merkzellen  
 2108 F432  00                  NOP
 2109 F433  00          CTAB:   NOP               ;FDC Befehlsbyte
 2110 F434  00                  NOP               ;4 Merkzellen Ende
 2111                   ;
 2112 F435  00          DF4F0:  NOP
 2113 F436  00          DF4F7:  NOP
 2114 F437  00          DF4F8:  NOP
 2115 F438  00          CTCCNT: DEFB 0            ;CTC-Counter - Zusatzzaehler fuer CTC-Interrupt
 2116 F439  00          LATPU:  DEFB 0            ;Latch fuer den Floppy-Controler
 2117                   ;
 2118                   ;hier beginnt eine Bytefolge fuer Read/Write Operationen
 2119                   ;
 2120 F43A  04          RWBYTE: DEFB 4            ;4 = READ, 6 = WRITE
 2121 F43B  00          DRIVE:  DEFB 0            ;LW-Nr.
 2122 F43C  0000        TRACK:  DEFW 0            ;akt. Track
 2123 F43E  0000        SECTOR: DEFW 0            ;akt. Sektor
 2124 F440  0000        DMA:    DEFW 0            ;DMA-Adresse
 2125 F442  0000        DPH:    DEFW 0            ;akt. DPH
 2126                   ;
 2127 F444  00          DRV2:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2128 F445  0000        TRK2:   DEFW 0
 2129 F447  0000        SEC2:   DEFW 0
 2130 F449  0000        DMA2:   DEFW 0            ;DMA-Adresse
 2131 F44B  0000                DEFW 0
 2132                   ;
 2133 F44D  00          DRV3:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2134 F44E  0000        TRK3:   DEFW 0
 2135 F450  0000        SEC3:   DEFW 0
 2136 F452  0000        DMA3:   DEFW 0            ;DMA-Adresse
 2137 F454  0000        DPH3M:  DEFW 0            ;Merkzelle akt. DPH
 2138                   ;
 2139 F456  04          MERKRW: DEFB 4            ;Merkzelle: 4 = READ, 6 = WRITE
 2140 F457  0000        DF518:  DEFW 0
 2141 F459  00          DF51A:  DEFB 0
 2142 F45A  00          DF51B:  DEFB 0
 2143 F45B  00          DF51C:  DEFB 0
 2144 F45C  00          DF51D:  DEFB 0
 2145 F45D  00          DF51E:  DEFB 0
 2146                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  38
BIOS    ASM

 2147 F45E  00 00 00 00 DISKP:  DEFS 1024,0       ;HW-Sektor Puffer aller LW (1k max. fuer FDD)
 2148 F85E  00 00 00 00 DIRBF:  DEFS 128,0        ;1 REC Puffer fuer Direktory
 2149 F8DE  00 00 00 00 ALL00:  DEFS 128,0        ;2048k(max.) / 2k / 8 = 128
 2150 F95E  00 00 00 00 ALL01:  DEFS 50,0         ;0F99FH
 2151 F990  00 00 00 00 ALL02:  DEFS 504,0        ;0F9D1H
 2152 FB88  00 00 00 00 ALL03:  DEFS 256,0        ;0FBC9H
 2153 FC88  00 00 00 00 ALL04:  DEFS 256,0        ;0FCC9H
 2154 FD88  00 00 00 00 ALL05:  DEFS 50,0         ;0FDC9H
 2155 FDBA  00 00 00 00 ALL06:  DEFS 50,0         ;0FDFBH
 2156 FDEC  00 00 00 00 CHK01:  DEFS 32,0         ;0FE2DH
 2157 FE0C  00 00 00 00 CHK05:  DEFS 32,0         ;0FE4DH
 2158 FE2C  00 00 00 00 CHK06:  DEFS 32,0         ;0FE6DH
 2159                   ;
 2160 FE4C  42 49 4F 53         DEFM "BIOS-Ende"  ;nur fuer Frieder zur Info
 2161                   ;
 2162                   ;
 2163         FF80      DFF80   EQU  0FF80H       ;Interrupt-Einsprungpunkt CTC Kanal 0
 2164         FF82      DFF82   EQU  0FF82H       ;Interrupt-Einsprungpunkt CTC Kanal 1
 2165         FF84      DFF84   EQU  0FF84H       ;Interrupt-Einsprungpunkt CTC Kanal 2
 2166         FF86      DFF86   EQU  0FF86H       ;Interrupt-Einsprungpunkt CTC Kanal 3
 2167         FF88      DFF88   EQU  0FF88H       ;Interrupt-Einsprungpunkt Nr.1 PIO1A
 2168         FF8A      DFF8A   EQU  0FF8AH       ;Interrupt-Einsprungpunkt Nr.2 PIO1A
 2169                   ;
 2170                   ;******************************   PortAdressen   ******************************
 2171                   ;
 2172         0000      P00     EQU  00H          ;CTC Kanal 0
 2173         0001      P01     EQU  01H          ;CTC Kanal 1
 2174         0002      P02     EQU  02H          ;CTC Kanal 2
 2175         0003      P03     EQU  03H          ;CTC Kanal 3
 2176                   ;
 2177         0004      P04     EQU  04H          ;PIO_A-Daten
 2178         0005      P05     EQU  05H          ;PIO_B-Daten
 2179         0006      P06     EQU  06H          ;PIO_A-Control
 2180                   ;
 2181         001E      P1E     EQU  1EH          ;CP/M - Umschalter
 2182                   ;
 2183         008A      P8A     EQU  8AH          ;GIDE Sector Count
 2184         008B      P8B     EQU  8BH          ;GIDE Sector Number
 2185         008C      P8C     EQU  8CH          ;GIDE Cylinder Low
 2186         008D      P8D     EQU  8DH          ;GIDE Cylinder High
 2187         008E      P8E     EQU  8EH          ;GIDE Drive and Head
 2188         008F      P8F     EQU  8FH          ;GIDE Command/Status
 2189                   ;
 2190                           .DEPHASE
 2191                           END
 0 Error(s) Detected.
 6229 Absolute Bytes. 321 Symbols Detected.
TC 