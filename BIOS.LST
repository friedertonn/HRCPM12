Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   1
BIOS    ASM

    1                   ; ***********************************************************
    2                   ; *                                                         *
    3                   ; *  HRCPM12-BIOS fuer den AC1      Version vom 11.04.2024  *
    4                   ; *                                                         *
    5                   ; *                                                  V.143  *
    6                   ; *                                                         *
    7                   ; ***********************************************************
    8                   ;
    9                   ; Korrekturen/Fehlerbehebungen:
   10                   ; - alle nicht genutzten Programmteile (HRDOS12) entfernt
   11                   ; - (Turbo-)LOAD entfernt
   12                   ; - BWS (Farb-)Init geaendert
   13                   ; - ^G BEEP + PUNCH:=V24out + LIST:=V24out hinzugefuegt
   14                   ; - keine Pruefsumme, kein Vergleichslesen der RAM-Disk (entfernt)
   15                   ; - fehlerhafte Maskierung USER in WBOOT entfernt
   16                   ; - Kursorblinken im Texteditor
   17                   ; - Consolenkommandos Kursor-ON / Kursor-OFF
   18                   ; - RAM-Disk mit 64 REC/TRK, Systemspur auf 8K reduziert
   19                   ; - GIDE-Laufwerke (C:, D:, E:) auf 8MByte verkleinert
   20                   ; - Formatierung RAM-Disk: letzter Sektor wurde nicht formatiert
   21                   ; - ISR angepasst, damit HRCPM12 mit JKCEMU V0.9.8.3 funktioniert
   22                   ; - Fehlermeldung "Bdos Err On P: Select" in WBOOT behoben
   23                   ;
   24                   ; Neu hinzugekommen:
   25                   ; - EXIT loescht CCPPUFLEN (V.132)
   26                   ; - WBOOT loescht CCPPUFLEN, weil in Systemspur "aktiver Befehl" (V.133)
   27                   ; - Eintragen von NMI auf 066h in BOOT1 entfernt (CPM Page-Zero) (V.133)
   28                   ; - Tastaturpuffer von FFD0h -> FF00h, "d"-Befehl ueberschrieben (V.134)
   29                   ; - nicht benutzte RAM-Zellen am Ende auskommentiert (V.135)
   30                   ; - automatische Erkennung der RAM-Disk 256k/512k/1024k/2048k (V.140)
   31                   ; - Cnderungen an READ_CCP (V.142)
   32                   ;
   33                   ;
   34                           .CREF
   35                           .Z80
   36                   ;
   37                           .PHASE 0E600H
   38                   ;
   39                   ;
   40         07F1      OUTHL   EQU  07F1H
   41         01A5      RSA     EQU  01A5H        ;CPU-Register nach RSA - nicht Monitor 11 !
   42         05CE      REGIST  EQU  05CEH        ;Registeranzeige - nicht Monitor 11 !
   43         0DF9      MV24A   EQU  0DF9H        ;MO-UP V24-Out
   44                   ;
   45                   ;
   46         1800      CUPOS   EQU  1800H
   47         1818      BREAK   EQU  1818H        ;NMI Sprungziel
   48         181F      CBWSB   EQU  181FH        ;Merkzelle fuer das Farbbyte im AC1-Monitor 
   49                   ;                         ;0=kein Color-BWS, sonst der eingestellte Farbwert
   50         185B      ARG1    EQU  185BH
   51         185D      ARG2    EQU  185DH
   52                   ;
   53                   ;
   54         0000      WARMBT  EQU  0000H        ;WBOOT der Grundseite
   55         0005      BDOSF   EQU  0005H        ;BDOS-Aufruf + TPA-MAX
   56         0038      RST38   EQU  0038H        ;CP/M-Break
   57         0066      NMI     EQU  0066H
   58                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   2
BIOS    ASM

   59                   ;
   60         0003      IOBYTE  EQU  0003H
   61         0004      LWBYTE  EQU  0004H        ;LW (Bit0-3) + USER Nr.(Bit4-7)
   62                   ;
   63         FF00      ZEIPUF  EQU  0FF00H       ;1 + 32 Byte Puffer fuer Tastatur
   64                   ;                          --> war urspruenlich auf 0FFD0H
   65                   ;                          --> ueberschreibt den "d"-Befehl
   66                   ;
   67         D806      BDOS    EQU  0D806H       ;BDOS-EinsprungAdresse
   68         E603      WBOOTB  EQU  0E603H       ;BIOS-Eisprung WBOOT
   69                   ;
   70                   ;
   71         C000      HPRDSK  EQU  0C000H       ;Hilfsprogramm: Format RAM-Disk
   72         D000      CCP     EQU  0D000H       ;Start CCP
   73         D007      COMLEN  EQU  CCP+07       ;CCP-Kommandopuffer-Laenge
   74                   ;
   75         00E0      PE0     EQU  0E0H         ;Grundadresse der RAM-Disk
   76         00F0      PF0     EQU  0F0H         ;BWS-CPLD-(Steuer)Port
   77                   ;
   78         0040      CFDC    EQU  40H          ;Hauptstatusregister FDC
   79         0041      DFDC    EQU  41H          ;Datenport FDC
   80         0043      FLWAIT  EQU  43H          ;IO-Adr. /WAIT Monoflop
   81         0045      LATCH   EQU  45H          ;IO-Adr. Latch 74LS175
   82                   ;
   83         000F      CUZEI   EQU  0FH          ;KursorSymbol
   84                   ;
   85                   ;******************************   Sprungverteiler   ******************************
   86                   ;
   87 E600  C3 E878             JP   BOOT
   88 E603  C3 E944             JP   WBOOT
   89 E606  C3 EA70             JP   CONST
   90 E609  C3 EA78             JP   CONIN
   91 E60C  C3 EAF0             JP   CONOUT
   92 E60F  C3 EAC7             JP   LIST
   93 E612  C3 EAE3             JP   PUNCH
   94 E615  C3 EA78             JP   CONIN        ;eigentlich JP READER
   95 E618  C3 EE25             JP   HOME
   96 E61B  C3 EE06             JP   SELDSK
   97 E61E  C3 EE28             JP   SETTRK
   98 E621  C3 EE2D             JP   SETSEC
   99 E624  C3 EE32             JP   SETDMA
  100 E627  C3 EE43             JP   READ
  101 E62A  C3 EE48             JP   WRITE
  102 E62D  C3 EE03             JP   LISTST
  103 E630  C3 EE37             JP   SECTRN
  104                   ;
  105 E633  43 38 35 41         DEFM 'C85AC'      ;fuer PC/BC Progr.
  106 E638  C3 E9E1             JP   EXIT         ;User-Kommando EXIT
  107 E63B  C3 F016             JP   LOAD         ;User-Kommando LOAD
  108 E63E  C3 0000             JP   0000H
  109                   ;
  110 E641  07          NDISK:  DEFB 7            ;Anzahl der LW = 7
  111                   ;
  112 E642  E644        DPHX:   DEFW DPHY         ;Zeiger auf den 1. Block?
  113 E644  E652        DPHY:   DEFW DPH0         ;DPH von LW A:
  114 E646  E662                DEFW DPH1         ;DPH von LW B:
  115 E648  E672                DEFW DPH2         ;DPH von LW C:
  116 E64A  E682                DEFW DPH3         ;DPH von LW D:
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   3
BIOS    ASM

  117 E64C  E692                DEFW DPH4         ;DPH von LW E:
  118 E64E  E6A2                DEFW DPH5         ;DPH von LW F:
  119 E650  E6B2                DEFW DPH6         ;DPH von LW G:
  120                   ;
  121 E652  0000        DPH0:   DEFW 0            ;RAM-Disk A:
  122 E654  0000                DEFW 0
  123 E656  0000                DEFW 0
  124 E658  0000                DEFW 0
  125 E65A  F86F                DEFW DIRBF
  126 E65C  E6C4                DEFW DPB0
  127 E65E  0000                DEFW 0            ;weil nichtwechselbares Medium
  128 E660  F8EF                DEFW ALL00
  129                   ;
  130 E662  0000        DPH1:   DEFW 0            ;Floppy B:
  131 E664  0000                DEFW 0
  132 E666  0000                DEFW 0
  133 E668  0000                DEFW 0
  134 E66A  F86F                DEFW DIRBF
  135 E66C  E6D5                DEFW DPB1
  136 E66E  FDFD                DEFW CHK01
  137 E670  F96F                DEFW ALL01
  138                   ;
  139 E672  0000        DPH2:   DEFW 0            ;GIDE C:
  140 E674  0000                DEFW 0
  141 E676  0000                DEFW 0
  142 E678  0000                DEFW 0
  143 E67A  F86F                DEFW DIRBF
  144 E67C  E6F1                DEFW DPB2
  145 E67E  0000                DEFW 0            ;weil nichtwechselbares Medium
  146 E680  F9A1                DEFW ALL02
  147                   ;
  148 E682  0000        DPH3:   DEFW 0            ;GIDE D:
  149 E684  0000                DEFW 0
  150 E686  0000                DEFW 0
  151 E688  0000                DEFW 0
  152 E68A  F86F                DEFW DIRBF
  153 E68C  E70D                DEFW DPB3
  154 E68E  0000                DEFW 0            ;weil nichtwechselbares Medium
  155 E690  FB99                DEFW ALL03
  156                   ;
  157 E692  0000        DPH4:   DEFW 0            ;GIDE E:
  158 E694  0000                DEFW 0
  159 E696  0000                DEFW 0
  160 E698  0000                DEFW 0
  161 E69A  F86F                DEFW DIRBF
  162 E69C  E729                DEFW DPB4
  163 E69E  0000                DEFW 0            ;weil nichtwechselbares Medium
  164 E6A0  FC99                DEFW ALL04
  165                   ;
  166 E6A2  0000        DPH5:   DEFW 0            ;Floppy F:
  167 E6A4  0000                DEFW 0
  168 E6A6  0000                DEFW 0
  169 E6A8  0000                DEFW 0
  170 E6AA  F86F                DEFW DIRBF
  171 E6AC  E745                DEFW DPB5
  172 E6AE  FE1D                DEFW CHK05
  173 E6B0  FD99                DEFW ALL05
  174                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   4
BIOS    ASM

  175 E6B2  0000        DPH6:   DEFW 0            ;Floppy G:
  176 E6B4  0000                DEFW 0
  177 E6B6  0000                DEFW 0
  178 E6B8  0000                DEFW 0
  179 E6BA  F86F                DEFW DIRBF
  180 E6BC  E761                DEFW DPB6
  181 E6BE  FE3D                DEFW CHK06
  182 E6C0  FDCB                DEFW ALL06
  183                   ;
  184                   ; https://hc-ddr.hucki.net/wiki/doku.php/cpm/write_a_bios/teil_1
  185                   ;
  186                   ;RAM-Disk 256 KByte  LW A:
  187                   ;
  188 E6C2  EE6F                DEFW RWRDSK       ;Routine zum Lesen/Schreiben der RAM-Disk
  189                   ;
  190 E6C4  0040        DPB0:   DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  191 E6C6  03                  DEFB 3            ;Blockgroesse = 1 Kbyte
  192 E6C7  07                  DEFB 7
  193 E6C8  00                  DEFB 0            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  194 E6C9  00F7                DEFW 247          ;248 * 1 Kbyte-Bloecke  -> 256k-8k(System)=248k(CP/M) ( - 2k(DIR) -> 246k (NETTO f. Daten))
  195 E6CB  003F                DEFW 63           ;64 DIR - Eintaege
  196 E6CD  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  197 E6CF  0000                DEFW 0            ;weil nichtwechselbares Medium
  198 E6D1  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  199                   ;
  200                   ;Floppy 780 KByte  LW B:
  201                   ;
  202 E6D3  F036                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  203                   ;
  204 E6D5  0050        DPB1:   DEFW 80           ;80 Sectoren/Track
  205 E6D7  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  206 E6D8  0F                  DEFB 15
  207 E6D9  00                  DEFB 0
  208 E6DA  0185                DEFW 389          ;390 * 2 Kbyte - Bloecke
  209 E6DC  007F                DEFW 127          ;128 DIR - Eintraege
  210 E6DE  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  211 E6E0  0020                DEFW 32
  212 E6E2  0002                DEFW 2            ;20 Kbyte System
  213                   ;
  214 E6E4  03 07 05 25         DEFB 3,7,5,25H
  215 E6E8  50 00 43 FF         DEFB 50H,0,43H,0FFH
  216 E6EC  E1 33 FF            DEFB 0E1H,33H,0FFH
  217                   ;
  218                   ;GIDE 8 MByte  LW C:
  219                   ;
  220 E6EF  F032                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  221                   ;
  222 E6F1  0800        DPB2:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  223 E6F3  05                  DEFB 5
  224 E6F4  1F                  DEFB 31           ;4k Bloecke
  225 E6F5  01                  DEFB 1            ;16-Bit Blockadressen im FCB/DIR
  226 E6F6  07BF                DEFW 1983         ;1984 * 4k-Bloecke = 7936k
  227 E6F8  07FF                DEFW 2047         ;2048 DIR-Eintraege
  228 E6FA  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke = 64 k
  229 E6FC  0000                DEFW 0            ;weil nichtwechselbares Medium
  230 E6FE  0001                DEFW 1            ;1 Trk = 256k System
  231                   ;
  232 E700  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   5
BIOS    ASM

  233 E703  000A                DEFW 000AH        ;10 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  234 E705  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  235 E707  03D8                DEFW 03D8H        ;984 Zylinder HDD
  236 E709  10                  DEFB 10H          ;16 Koepfe HDD
  237 E70A  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  238                   ;
  239                   ;GIDE 8 MByte  LW D:
  240                   ;
  241 E70B  F032                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  242                   ;
  243 E70D  0800        DPB3:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  244 E70F  06                  DEFB 6
  245 E710  3F                  DEFB 63           ;8k Bloecke
  246 E711  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  247 E712  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  248 E714  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  249 E716  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  250 E718  0000                DEFW 0            ;weil nichtwechselbares Medium
  251 E71A  0000                DEFW 0            ;kein System-Track
  252                   ;
  253 E71C  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  254 E71F  0096                DEFW 0096H        ;150 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  255 E721  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  256 E723  03D8                DEFW 03D8H        ;984 Zylinder HDD
  257 E725  10                  DEFB 10H          ;16 Koepfe HDD
  258 E726  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  259                   ;
  260                   ;GIDE 8 MByte  LW E:
  261                   ;
  262 E727  F032                DEFW RWGIDE       ;Routine zum Lesen/Schreiben des GIDE-LW
  263                   ;
  264 E729  0800        DPB4:   DEFW 2048         ;2048 Records/Track = 256k/Trk
  265 E72B  06                  DEFB 6
  266 E72C  3F                  DEFB 63           ;8k Bloecke
  267 E72D  03                  DEFB 3            ;16Bit Blockadressen im FCB/DIR
  268 E72E  03FF                DEFW 1023         ;1024 * 8k-Bloecke = 8192k = 8M
  269 E730  0FFF                DEFW 4095         ;4096 DIR-Eintraege
  270 E732  FFFF                DEFW 0FFFFH       ;16 DIR-Bloecke
  271 E734  0000                DEFW 0            ;weil nichtwechselbares Medium
  272 E736  0000                DEFW 0            ;kein System-Track
  273                   ;
  274 E738  02 03 A0            DEFB 2,3,0A0H     ;?,?, add constant bits fuer Kopf-Register ?
  275 E73B  012C                DEFW 012CH        ;300 = 1. Zylinder-Nr. phys. LW, wo BDOS-LW beginnt
  276 E73D  0040                DEFW 0040H        ;64 Zyl. f. 16 MB LW-Groesse
  277 E73F  03D8                DEFW 03D8H        ;984 Zylinder HDD
  278 E741  10                  DEFB 10H          ;16 Koepfe HDD
  279 E742  20                  DEFB 20H          ;32 Sektoren/Spur HDD
  280                   ;
  281                   ;Floppy 640 KByte  LW F:
  282                   ;
  283 E743  F036                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  284                   ;
  285 E745  0040        DPB5:   DEFW 64           ;64 Sectoren/Track
  286 E747  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  287 E748  0F                  DEFB 15
  288 E749  00                  DEFB 0
  289 E74A  013F                DEFW 319          ;320 * 2 Kbyte - Bloecke
  290 E74C  007F                DEFW 127          ;128 DIR - Eintraege
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   6
BIOS    ASM

  291 E74E  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  292 E750  0020                DEFW 32
  293 E752  0000                DEFW 0            ;kein System-Track
  294                   ;
  295 E754  01 01 10 14         DEFB 1,1,10H,14H
  296 E758  50 00 43 FF         DEFB 50H,0,43H,0FFH
  297 E75C  E1 33 FF            DEFB 0E1H,33H,0FFH
  298                   ;
  299                   ;Floppy 800 KByte  LW G:
  300                   ;
  301 E75F  F036                DEFW RWFLO        ;Routine zum Lesen/Schreiben der Floppy-Disk
  302                   ;
  303 E761  0050        DPB6:   DEFW 80           ;80 Sectoren/Track
  304 E763  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  305 E764  0F                  DEFB 15
  306 E765  00                  DEFB 0
  307 E766  018F                DEFW 399          ;400 * 2 Kbyte - Bloecke
  308 E768  007F                DEFW 127          ;128 DIR - Eintraege
  309 E76A  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  310 E76C  0020                DEFW 32
  311 E76E  0000                DEFW 0            ;kein System-Track
  312                   ;
  313 E770  03 07 05 25         DEFB 3,7,5,25H
  314 E774  50 01 43 FF         DEFB 50H,1,43H,0FFH
  315 E778  E1 33 FF            DEFB 0E1H,33H,0FFH
  316                   ;
  317                   ;RAM-Disk 512 KByte  LW A:
  318 E77B  0040        DP512:  DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  319 E77D  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  320 E77E  0F                  DEFB 15
  321 E77F  01                  DEFB 1            ;8-Bit Blockadressen im FCB/DIR, da weniger als 255 Bloecke
  322 E780  00FB                DEFW 251          ;252 * 2 Kbyte-Bloecke  -> 512k-8k(System)=504k(CP/M) ( - 2k(DIR) -> 502k (NETTO f. Daten))
  323 E782  003F                DEFW 63           ;64 DIR - Eintaege
  324 E784  0080                DEFW 080H         ;1 DIR-Block
  325 E786  0000                DEFW 0            ;weil nichtwechselbares Medium
  326 E788  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  327                   ;
  328                   ;RAM-Disk 1024 KByte  LW A:
  329 E78A  0040        DP1024: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  330 E78C  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  331 E78D  0F                  DEFB 15
  332 E78E  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  333 E78F  01FB                DEFW 507          ;508 * 2 Kbyte-Bloecke  -> 1024k-8k(System)=1016k(CP/M) ( - 4k(DIR) -> 1012k (NETTO f. Daten))
  334 E791  007F                DEFW 127          ;128 DIR - Eintraege -> bei 64 DIR-Eintraegen bekommt man die RAM-Disk nicht voll
  335 E793  00C0                DEFW 0C0H         ;2 DIR-Bloecke
  336 E795  0000                DEFW 0            ;weil nichtwechselbares Medium
  337 E797  0001                DEFW 1            ;8 Kbyte System / Track-Offset
  338                   ;
  339                   ;RAM-Disk 2048 KByte  LW A:
  340 E799  0040        DP2048: DEFW 64           ;64 Sectoren/Track (Rec/Trk) = 8 Kbyte/Track
  341 E79B  04                  DEFB 4            ;Blockgroesse = 2 Kbyte
  342 E79C  0F                  DEFB 15
  343 E79D  00                  DEFB 0            ;16-Bit Blockadressen im FCB/DIR, da mehr als 255 Bloecke
  344 E79E  03FB                DEFW 1019         ;1020 * 2 Kbyte-Bloecke  -> 2048k-8k(System)=2040k(CP/M) ( - 8k(DIR) -> 2032k (NETTO f. Daten))
  345 E7A0  00FF                DEFW 255          ;256 DIR - Eintraege
  346 E7A2  00F0                DEFW 0F0H         ;4 DIR-Bloecke
  347 E7A4  0000                DEFW 0            ;weil nichtwechselbares Medium
  348 E7A6  0001                DEFW 1            ;8 Kbyte System / Track-Offset
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   7
BIOS    ASM

  349                   ;
  350 E7A8  0C          TXT01:  DEFB 0CH
  351 E7A9  48 52 43 50         DEFM "HRCPM AC1 V1.2 CPA "
  352 E7BC  31 31 2E 30         DEFM "11.01.89 FA-MODE "
  353 E7CD  76 6F 6D 20         DEFM "vom 11.04.2024 V.143"
  354 E7E1  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  355 E7E5  47 49 44 45         DEFM "GIDE(80H) C0:8MB,"
  356 E7F6  20 20 20 44         DEFM "   D0: 8MB   E0: 8MB"
  357 E80A  0D 0A               DEFB 0DH,0AH
  358 E80C  46 44 43 20         DEFM "FDC (45H) B0:5*1024"   ;B0 --> Floppy-Drive 0,
  359 E81F  20 46 30 3A         DEFM " F0:16*256 G1:5*1024"  ;F0 --> Floppy-Drive 0, G1 --> Floppy-Drive 1
  360 E833  0D 0A 0D 0A         DEFB 0DH,0AH,0DH,0AH
  361 E837  52 46 4C 20         DEFM "RFL Praeci.Port E0H"
  362 E84A  20 41 3A 20         DEFM " A: "
  363 E84E  00                  DEFB 0
  364 E84F  32 35 36 6B TXT01A: DEFM "256k"
  365 E853  00                  DEFB 0
  366 E854  35 31 32 6B TXT01B: DEFM "512k"
  367 E858  00                  DEFB 0
  368 E859  31 30 32 34 TXT01C: DEFM "1024k"
  369 E85E  00                  DEFB 0
  370 E85F  32 30 34 38 TXT01D: DEFM "2048k"
  371 E864  00                  DEFB 0
  372 E865  20 2D 2D 3E TXT02:  DEFM " --> Format A:(J)?"
  373 E877  00                  DEFB 0
  374                   ;
  375                   ;******************************   BOOT   ******************************
  376                   ;
  377 E878  F3          BOOT:   DI
  378 E879  31 F427             LD   SP,CPMSTK
  379 E87C  AF                  XOR  A
  380 E87D  D3 1E               OUT  (P1E),A      ;zwingend AC1-Mode !!
  381 E87F  32 F44A             LD   (LATPU),A    ;FDC-Latch zuruecksetzen
  382 E882  CD EDCD             CALL BWSINI
  383 E885  DB 05               IN   A,(P05)
  384 E887  CB 9F               RES  3,A          ;ACC-Zeichensatz ein (PIO1B, Bit3)
  385 E889  D3 05               OUT  (P05),A
  386 E88B  2A 1818             LD   HL,(BREAK)   ;Sprungtabelle NMI Monitor
  387 E88E  22 F436             LD   (OLDNMI),HL  ;sichern
  388 E891  21 E603             LD   HL,WBOOTB    ;CP/M-Warmstart-Einsprungadresse
  389 E894  22 1818             LD   (BREAK),HL
  390 E897  CD E9D6             CALL CPMMOD
  391 E89A  AF                  XOR  A
  392 E89B  32 F46A             LD   (DF51A),A
  393 E89E  32 0003             LD   (IOBYTE),A
  394 E8A1  32 0004             LD   (LWBYTE),A
  395 E8A4  32 FF00             LD   (ZEIPUF),A   ;Init. Tastaturpuffer
  396 E8A7  CD E9B2             CALL BOOT1        ;CP/M "Grundseite" INIT
  397                   ;
  398 E8AA  3E 03               LD   A,03H        ;CTC init. + Interrupt abgeschaltet
  399 E8AC  D3 00               OUT  (P00),A
  400 E8AE  D3 01               OUT  (P01),A
  401 E8B0  D3 02               OUT  (P02),A
  402 E8B2  D3 03               OUT  (P03),A
  403 E8B4  3E FF               LD   A,0FFH       ;HWT vom Interruptvektor 0FF80h ff.
  404 E8B6  ED 47               LD   I,A
  405 E8B8  ED 5E               IM   2            ;Interrupt freigeben
  406 E8BA  21 F322             LD   HL,INTEND    ;Adresse Einsprungpunkt fuer nicht verwendete Interrupts
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   8
BIOS    ASM

  407 E8BD  22 FF80             LD   (DFF80),HL   ;Prog. Einsprung IV fuer CTC-Kanal 0
  408 E8C0  22 FF82             LD   (DFF82),HL   ;Prog. Einsprung IV fuer CTC-Kanal 1
  409 E8C3  22 FF84             LD   (DFF84),HL   ;Prog. Einsprung IV fuer CTC-Kanal 2
  410 E8C6  21 F307             LD   HL,ISRCTC    ;Einsprungpunkt CTC-Interrupt - Steuerung Nachlauf Floppy-LW
  411 E8C9  22 FF86             LD   (DFF86),HL   ;Prog. Einsprung IV fuer CTC-Kanal 3
  412 E8CC  3E 80               LD   A,80H
  413 E8CE  D3 00               OUT  (P00),A      ;CTC-Interruptadresse NWT (= 80h) eintragen
  414 E8D0  3E FF               LD   A,0FFH
  415 E8D2  32 F449             LD   (CTCCNT),A   ;Init. CTC-Counter = 255 --> Zusatzzaehler fuer CTC-Interrupt
  416 E8D5  3E A7               LD   A,0A7H
  417 E8D7  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 als Zeitgeber mit Interrupt, Vorteiler 256
  418 E8D9  AF                  XOR  A
  419 E8DA  D3 03               OUT  (P03),A      ;Programmierung der CTC K3 - Hauptteiler = 256
  420                                             ;d.h. bei 2 MHz CPU-Takt wird alle 33ms ein CTC-Interrupt ausgeloest
  421                   ;
  422 E8DC  21 EA06             LD   HL,ISRTAS    ;1. Einsprungpunkt PIO-Interrupt --> Taste in Tastaturpuffer schreiben
  423 E8DF  22 FF88             LD   (DFF88),HL   ;auf 0FF88h eintragen
  424 E8E2  01 0506             LD   BC,0506H     ;5 Bytes auf Controlkanal PIO1 A
  425 E8E5  21 EA5B             LD   HL,PIOTAB
  426 E8E8  ED B3               OTIR              ;PIO1_A Init. fuer 1. Einsprungpunkt
  427                   ;
  428 E8EA  21 E7A8             LD   HL,TXT01     ;Begruessungstext
  429 E8ED  CD EA60             CALL OUTTXT
  430                   ;
  431 E8F0  CD EECA             CALL RDTEST       ;Kapazitaet der RAM-Disk bestimmen
  432 E8F3  21 EF2A             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
  433 E8F6  7E                  LD   A,(HL)
  434 E8F7  21 E799             LD   HL,DP2048    ;DPB 2048K RAM-Disk
  435 E8FA  FE 03               CP   3
  436 E8FC  28 10               JR   Z,BOOT2
  437 E8FE  21 E78A             LD   HL,DP1024    ;DPB 1024K RAM-Disk
  438 E901  FE 02               CP   2
  439 E903  28 09               JR   Z,BOOT2
  440 E905  21 E77B             LD   HL,DP512     ;DPB 512K RAM-Disk
  441 E908  FE 01               CP   1
  442 E90A  28 02               JR   Z,BOOT2
  443 E90C  18 08               JR   BOOT3        ;256K RAM-Disk, nichts kopieren
  444                   ;        
  445 E90E  11 E6C4     BOOT2:  LD   DE,DPB0
  446 E911  01 000F             LD   BC,15
  447 E914  ED B0               LDIR
  448 E916  21 E85F     BOOT3:  LD   HL,TXT01D    ;2048k
  449 E919  FE 03               CP   3
  450 E91B  28 11               JR   Z,BOOT4
  451 E91D  21 E859             LD   HL,TXT01C    ;1024k
  452 E920  FE 02               CP   2
  453 E922  28 0A               JR   Z,BOOT4
  454 E924  21 E854             LD   HL,TXT01B    ;512k
  455 E927  FE 01               CP   1
  456 E929  28 03               JR   Z,BOOT4
  457 E92B  21 E84F             LD   HL,TXT01A    ;256k
  458 E92E  CD EA60     BOOT4:  CALL OUTTXT
  459 E931  21 E865             LD   HL,TXT02     ;Formatieren? (J)
  460 E934  CD EA60             CALL OUTTXT
  461 E937  FB                  EI
  462 E938  CD EA78             CALL CONIN
  463 E93B  CB AF               RES  5,A          ;Upcase
  464 E93D  FE 4A               CP   4AH          ;J --> RAM-Disk formatieren
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page   9
BIOS    ASM

  465 E93F  CA EF2B             JP   Z,RDFORM
  466                   ;       LD   HL,6000H     ;FC64.COM von 6000h nach 100h kopieren
  467                   ;       LD   DE,0100H
  468                   ;       LD   BC,5880H     ;5880h Bytes
  469                   ;       LDIR
  470 E942  18 30               JR   WBOOT1       ;READCCP ueberspringen
  471                   ;
  472                   ;******************************   WBOOT   ******************************
  473                   ;
  474 E944  31 F427     WBOOT:  LD   SP,CPMSTK
  475 E947  CD E9D6             CALL CPMMOD
  476 E94A  3A F46B             LD   A,(DF51B)
  477 E94D  B7                  OR   A
  478 E94E  C4 F0EB             CALL NZ,LF0CE
  479 E951  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
  480 E953  21 EE43             LD   HL,READ
  481 E956  22 EFBE             LD   (WRCCP2),HL
  482 E959  CD EFA4             CALL WRCCP        ;hier READ_CCP!
  483 E95C  AF                  XOR  A
  484 E95D  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  485 E960  3A E641             LD   A,(NDISK)    ;Anzahl der LW
  486 E963  4F                  LD   C,A
  487 E964  3A 0004             LD   A,(LWBYTE)
  488 E967  E6 0F               AND  0FH          ;LW testen
  489 E969  B9                  CP   C
  490 E96A  38 08               JR   C,WBOOT1     ;akt. LW < NDISK
  491 E96C  3A 0004             LD   A,(LWBYTE)
  492 E96F  E6 F0               AND  0F0H         ;LW ruecksetzen
  493 E971  32 0004             LD   (LWBYTE),A
  494                   ;
  495 E974  CD E9B2     WBOOT1: CALL BOOT1        ;CP/M "Grundseite" INIT
  496 E977  3E 01               LD   A,01H        ;Kursor einschalten
  497 E979  32 F42D             LD   (CUFLAG),A
  498 E97C  3A F42A             LD   A,(COLO2)
  499 E97F  32 F428             LD   (COLOR),A    ;Arbeitszelle Farbbyte
  500 E982  E6 77               AND  77H          ;Intensivdarstellung maskieren
  501 E984  32 F429             LD   (COLO1),A    ;Arbeitszelle "Normaldarstellung"
  502 E987  3A 0004             LD   A,(LWBYTE)
  503 E98A  4F                  LD   C,A
  504 E98B  C3 D000             JP   CCP          ;hier beginnt die Party
  505                   ;
  506 E98E  F5          CPMERR: PUSH AF           ;CP/M-Fehler - zurueck z. Monitor
  507 E98F  E5                  PUSH HL
  508 E990  CD E9E5             CALL EXIT1
  509 E993  DF                  RST  18H
  510 E994  0D                  DEFB 0DH
  511 E995  43 50 2F 4D         DEFM "CP/M-Fehler:"
  512 E9A1  A0                  DEFB 20H+80H
  513 E9A2  E1                  POP  HL
  514 E9A3  F1                  POP  AF
  515 E9A4  CD 01A5             CALL RSA          ;CPU-Register nach RSA - nicht Monitor 11 !
  516 E9A7  E1                  POP  HL
  517 E9A8  2B                  DEC  HL
  518 E9A9  CD 07F1             CALL OUTHL
  519 E9AC  DF                  RST  18H
  520 E9AD  8D                  DEFB 0DH+80H
  521 E9AE  CD 05CE             CALL REGIST       ;Monitor - Registeranzeige - nicht Monitor 11 !
  522 E9B1  FF                  RST  38H          ;zurueck zum Monitor
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  10
BIOS    ASM

  523                   ;
  524 E9B2  3E C3       BOOT1:  LD   A,0C3H       ;CP/M "Grundseite" INIT
  525 E9B4  32 0000             LD   (WARMBT),A
  526 E9B7  32 0005             LD   (BDOSF),A
  527 E9BA  32 0038             LD   (RST38),A
  528 E9BD  21 E603             LD   HL,WBOOTB
  529 E9C0  22 0001             LD   (WARMBT+1),HL
  530 E9C3  21 D806             LD   HL,BDOS
  531 E9C6  22 0006             LD   (BDOSF+1),HL
  532 E9C9  21 E98E             LD   HL,CPMERR
  533 E9CC  22 0039             LD   (RST38+1),HL
  534 E9CF  21 0080             LD   HL,0080H
  535 E9D2  22 F451             LD   (DMA),HL
  536 E9D5  C9                  RET
  537                   ;
  538                   ;******************************   Ende BOOT / WBOOT   ******************************
  539                   ;
  540 E9D6  F5          CPMMOD: PUSH AF           ;CP/M EIN
  541 E9D7  3E 01               LD   A,01H
  542 E9D9  18 02               JR   MOD1
  543                   ;
  544 E9DB  F5          AC1MOD: PUSH AF           ;CP/M AUS (AC1-Mode)
  545 E9DC  AF                  XOR  A
  546 E9DD  D3 1E       MOD1:   OUT  (P1E),A
  547 E9DF  F1                  POP  AF
  548 E9E0  C9                  RET
  549                   ;
  550                   ;--------------------------------------------------------------------------
  551                   ;
  552                   ;EXIT - Routine
  553                   ;
  554 E9E1  21 0000     EXIT:   LD   HL,0000H     ;Ruecksprungadresse fuer RET
  555 E9E4  E5                  PUSH HL
  556 E9E5  AF          EXIT1:  XOR  A            ;Einsprung aus CPMERR
  557 E9E6  32 D007             LD   (COMLEN),A   ;auf Laenge=0 setzen
  558 E9E9  D3 1E               OUT  (P1E),A      ;AC1-Mode
  559 E9EB  2A F436             LD   HL,(OLDNMI)
  560 E9EE  22 1818             LD   (BREAK),HL   ;alten NMI wiederherstellen
  561 E9F1  3E 03               LD   A,03H
  562 E9F3  D3 00               OUT  (P00),A      ;CTC: Interrupts ausschalten
  563 E9F5  D3 01               OUT  (P01),A
  564 E9F7  D3 02               OUT  (P02),A
  565 E9F9  D3 03               OUT  (P03),A
  566 E9FB  D3 06               OUT  (P06),A      ;PIO1 A: Interrupt auschalten
  567 E9FD  3E CF               LD   A,0CFH
  568 E9FF  D3 06               OUT  (P06),A      ;PIO1 A: "Mode 3" + "Set Mode"
  569 EA01  3E FF               LD   A,0FFH
  570 EA03  D3 06               OUT  (P06),A      ;PIO1 A: PA0 bis PA7 sind Eingaenge
  571 EA05  C9                  RET               ;zurueck zum Monitor
  572                   ;
  573                   ;
  574                   ;Interrupt-Einsprung fuer die Tastatur
  575                   ;
  576 EA06  F3          ISRTAS: DI
  577 EA07  F5                  PUSH AF
  578 EA08  C5                  PUSH BC
  579 EA09  E5                  PUSH HL
  580 EA0A  DB 04               IN   A,(P04)      ;PIO_A abfragen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  11
BIOS    ASM

  581 EA0C  CB 7F               BIT  7,A          ;Taste gedrueckt?
  582 EA0E  28 45               JR   Z,ISREND     ;nein, ISR beenden
  583 EA10  4F                  LD   C,A
  584                   ;
  585 EA11  06 1E               LD   B,1EH        ;Tastaturentprellung
  586 EA13  DB 04       PRELL1: IN   A,(P04)
  587 EA15  B9                  CP   C
  588 EA16  20 3D               JR   NZ,ISREND
  589 EA18  10 F9               DJNZ PRELL1       ;30 Durchlaeufe
  590                   ;
  591 EA1A  FE 80               CP   80H
  592 EA1C  28 37               JR   Z,ISREND     ;das war eine NULL-Eingabe
  593                   ;
  594 EA1E  4F                  LD   C,A
  595 EA1F  21 FF00             LD   HL,ZEIPUF
  596 EA22  7E                  LD   A,(HL)       ;Fuellstand Zeichenpuffer
  597 EA23  3C                  INC  A
  598 EA24  FE 1F               CP   1FH          ;Puffer voll?
  599 EA26  28 2D               JR   Z,ISREND
  600 EA28  77                  LD   (HL),A       ;Anzahl der Zeichen rueckschreiben
  601 EA29  C5                  PUSH BC
  602 EA2A  06 00               LD   B,0
  603 EA2C  4F                  LD   C,A
  604 EA2D  09                  ADD  HL,BC        ;HL = Position im Zeichenpuffer
  605 EA2E  C1                  POP  BC
  606 EA2F  CB B9               RES  7,C          ;7. Bit loeschen und
  607 EA31  71                  LD   (HL),C       ;Taste in Zeichenpuffer eintragen
  608                   ;
  609                   ;       LD   BC,8034H     ;Initialisierung Tastenpiep --> 2 MHz
  610 EA32  01 8068             LD   BC,8068H     ;Initialisierung Tastenpiep --> 4 MHz
  611 EA35  79          BEEP1:  LD   A,C
  612 EA36  3D          BEEP2:  DEC  A
  613 EA37  20 FD               JR   NZ,BEEP2
  614 EA39  DB 05               IN   A,(P05)      ;PIO_B-Daten
  615 EA3B  EE 01               XOR  01H          ;Tastenpiep
  616 EA3D  D3 05               OUT  (P05),A
  617 EA3F  10 F4               DJNZ BEEP1
  618 EA41  E6 FE               AND  0FEH
  619 EA43  D3 05               OUT  (P05),A
  620                   ;
  621 EA45  01 0200             LD   BC,0200H     ;Tastaturentprellung
  622 EA48  0B          PRELL2: DEC  BC
  623 EA49  78                  LD   A,B
  624 EA4A  B1                  OR   C
  625 EA4B  20 FB               JR   NZ,PRELL2
  626                   ;
  627 EA4D  3E B7               LD   A,0B7H       ;weitere Interrupts loeschen
  628 EA4F  D3 06               OUT  (P06),A
  629 EA51  3E 7F               LD   A,7FH
  630 EA53  D3 06               OUT  (P06),A
  631                   ;
  632 EA55  E1          ISREND: POP  HL
  633 EA56  C1                  POP  BC
  634 EA57  F1                  POP  AF
  635 EA58  FB                  EI
  636 EA59  ED 4D               RETI
  637                   ;
  638 EA5B  88 CF FF B7 PIOTAB: DEFB 88H,0CFH,0FFH,0B7H,7FH  ;PIO 1A: Init.-Tabelle
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  12
BIOS    ASM

  639                   ;  88H --> NWT Interruptvektor --> 0FF88H
  640                   ; 0CFH --> "Mode 3" + "Set Mode" (kein Handshaking, next Byte = I/O-Zuordnung)
  641                   ; 0FFH --> PA0 bis PA7 sind Eingaenge
  642                   ; 0B7H --> Setting Interrupt Control Word --> mit nachfolgender Maskierung
  643                   ;  7FH --> Bit7=L --> nur PA7 erzeugt Interrupts
  644                   ;
  645 EA60  C5          OUTTXT: PUSH BC
  646 EA61  F5                  PUSH AF
  647 EA62  4E          TEXT1:  LD   C,(HL)
  648 EA63  79                  LD   A,C
  649 EA64  B7                  OR   A
  650 EA65  28 06               JR   Z,TEXT2
  651 EA67  CD EAF0             CALL CONOUT
  652 EA6A  23                  INC  HL
  653 EA6B  18 F5               JR   TEXT1
  654 EA6D  F1          TEXT2:  POP  AF
  655 EA6E  C1                  POP  BC
  656 EA6F  C9                  RET
  657                   ;
  658                   ;******************************   CONST   ******************************
  659                   ;
  660 EA70  3A FF00     CONST:  LD   A,(ZEIPUF)
  661 EA73  B7                  OR   A
  662 EA74  C8                  RET  Z
  663 EA75  3E FF               LD   A,0FFH
  664 EA77  C9                  RET
  665                   ;
  666                   ;******************************   CONIN   ******************************
  667                   ;
  668 EA78  F3          CONIN:  DI
  669 EA79  ED 73 F432          LD   (SPCIN),SP
  670 EA7D  31 F3D8             LD   SP,CINSP
  671 EA80  C5                  PUSH BC
  672 EA81  D5                  PUSH DE
  673 EA82  E5                  PUSH HL
  674 EA83  01 017F             LD   BC,017FH     ;Kursor-Blinker ruecksetzen
  675 EA86  AF          CONIN1: XOR  A
  676 EA87  F3                  DI
  677 EA88  2A FF00             LD   HL,(ZEIPUF)  ;L = Anz. der Zeichen, H = 1. Zeichen
  678 EA8B  B5                  OR   L
  679 EA8C  20 20               JR   NZ,CONIN3    ;Zeichen im Tastaturpuffer vorhanden
  680 EA8E  FB                  EI
  681 EA8F  10 F5               DJNZ CONIN1       ;256*LOOP: warte auf ein Zeichen
  682 EA91  3A F42D             LD   A,(CUFLAG)
  683 EA94  B7                  OR   A
  684 EA95  28 EF               JR   Z,CONIN1     ;kein "Kursor-Blinken"
  685 EA97  F3                  DI
  686 EA98  CD E9DB             CALL AC1MOD       ;AC1 Mode
  687 EA9B  2A 1800             LD   HL,(CUPOS)
  688 EA9E  0C                  INC  C
  689 EA9F  CB 79               BIT  7,C          ;hier wird die Cursor-Blinkfrequenz festgelegt
  690 EAA1  3A F431             LD   A,(CHAR)     ;bisheriges Zeichen auf der Kursorposition
  691 EAA4  28 02               JR   Z,CONIN2
  692 EAA6  3E 0F               LD   A,CUZEI      ;Kursor = 0FH
  693 EAA8  77          CONIN2: LD   (HL),A       ;"Kursor-Blinken" - Bildschirm-Ausgabe
  694 EAA9  CD E9D6             CALL CPMMOD       ;CP/M Mode
  695 EAAC  18 D8               JR   CONIN1
  696                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  13
BIOS    ASM

  697 EAAE  3D          CONIN3: DEC  A            ;DEC Anzahl_der_Zeichen_im_Tastaturpuffer
  698 EAAF  32 FF00             LD   (ZEIPUF),A
  699 EAB2  7C                  LD   A,H          ;1. Zeichen aus dem Tastaturpuffer --> A
  700 EAB3  21 FF02             LD   HL,ZEIPUF+2
  701 EAB6  11 FF01             LD   DE,ZEIPUF+1
  702 EAB9  01 001F             LD   BC,001FH
  703 EABC  ED B0               LDIR              ;alle Zeichen im Puffer ruecken 1 Pos. n. links
  704 EABE  E1                  POP  HL
  705 EABF  D1                  POP  DE
  706 EAC0  C1                  POP  BC
  707 EAC1  ED 7B F432          LD   SP,(SPCIN)
  708 EAC5  FB                  EI
  709 EAC6  C9                  RET
  710                   ;
  711                   ;******************************   LIST   ******************************
  712                   ;
  713 EAC7  F3          LIST:   DI
  714 EAC8  CD E9DB             CALL AC1MOD
  715 EACB  F5                  PUSH AF      
  716 EACC  79                  LD   A,C
  717 EACD  FE 0A               CP   0AH  
  718 EACF  28 0C               JR   Z,LIST1  
  719 EAD1  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  720 EAD4  FE 0D               CP   0DH     
  721 EAD6  20 05               JR   NZ,LIST1 
  722 EAD8  3E 0A               LD   A,0AH   
  723 EADA  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  724 EADD  F1          LIST1:  POP  AF      
  725 EADE  CD E9D6             CALL CPMMOD
  726 EAE1  FB                  EI
  727 EAE2  C9                  RET
  728                   ;
  729                   ;******************************   PUNCH   ******************************
  730                   ;
  731 EAE3  F3          PUNCH:  DI                ;Ausgabe C nach V24
  732 EAE4  79                  LD   A,C
  733 EAE5  CD E9DB             CALL AC1MOD
  734 EAE8  CD 0DF9             CALL MV24A        ;Monitor V24 Ausgabe Akku
  735 EAEB  CD E9D6             CALL CPMMOD
  736 EAEE  FB                  EI
  737 EAEF  C9                  RET
  738                   ;
  739                   ;******************************   CONOUT   ******************************
  740                   ;
  741                   ;       Ausgabe eines Zeichens,   IN: Zeichen in C
  742                   ;
  743 EAF0  F3          CONOUT: DI
  744 EAF1  ED 73 F434          LD   (SPCOUT),SP  ;Stack bei MON-Aufruf retten
  745 EAF5  31 F3FE             LD   SP,COUTSP
  746 EAF8  F5                  PUSH AF
  747 EAF9  C5                  PUSH BC
  748 EAFA  D5                  PUSH DE
  749 EAFB  E5                  PUSH HL
  750 EAFC  CD E9DB             CALL AC1MOD
  751 EAFF  E5                  PUSH HL
  752 EB00  2A 1800             LD   HL,(CUPOS)   ;Cursorposition
  753 EB03  3A F431             LD   A,(CHAR)
  754 EB06  77                  LD   (HL),A       ;altes Zeichen auf Position
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  14
BIOS    ASM

  755 EB07  3A F42E             LD   A,(STZ00)    ;Durchlauf bei Steuerzeichen?
  756 EB0A  A7                  AND  A
  757 EB0B  C2 ED3B             JP   NZ,KONV10    ;NZ= Steuerzeichen 2. oder 3. Durchlauf
  758 EB0E  79                  LD   A,C          ;Byte
  759 EB0F  FE 20               CP   20H          ;kleinstes Zeichen
  760 EB11  38 26               JR   C,KONVTB
  761 EB13  FE 7F               CP   7FH          ;groesstes Zeichen
  762 EB15  30 22               JR   NC,KONVTB
  763 EB17  2A 1800             LD   HL,(CUPOS)
  764 EB1A  C3 EC78             JP   CCHAR        ;Ausgabe einzelnes Zeichen
  765                   ;
  766 EB1D  2A 1800     KONVT9: LD   HL,(CUPOS)
  767 EB20  7E                  LD   A,(HL)
  768 EB21  32 F431             LD   (CHAR),A
  769 EB24  3A F42D             LD   A,(CUFLAG)
  770 EB27  B7                  OR   A
  771 EB28  28 02               JR   Z,COEN1      ;Kursor nicht darstellen
  772 EB2A  36 0F               LD   (HL),CUZEI
  773 EB2C  CD E9D6     COEN1:  CALL CPMMOD
  774 EB2F  E1                  POP  HL
  775 EB30  D1                  POP  DE
  776 EB31  C1                  POP  BC
  777 EB32  F1                  POP  AF
  778 EB33  ED 7B F434          LD   SP,(SPCOUT)
  779 EB37  FB                  EI
  780 EB38  C9                  RET
  781                   ;
  782                   ;Verzweigung bei Steuerzeichen
  783                   ;INPUT:  A=Zeichen
  784                   ;
  785 EB39  FE 1B       KONVTB: CP   1BH          ;ESC ?
  786 EB3B  20 07               JR   NZ,KONVT1
  787 EB3D  3E 02               LD   A,02H        ;wenn ja
  788 EB3F  32 F42E             LD   (STZ00),A    ;Zeiger auf 2
  789 EB42  18 D9               JR   KONVT9       ;nichts ausgeben
  790                   ;
  791 EB44  2A 1800     KONVT1: LD   HL,(CUPOS)
  792 EB47  FE 01               CP   01H          ;^A Cursor home                      
  793 EB49  28 5B               JR   Z,CHOME                                             
  794 EB4B  FE 07               CP   07H          ;^G akustisches Signal                                                 
  795 EB4D  CA ECCA             JP   Z,MBEEP                                              
  796 EB50  FE 08               CP   08H          ;^H Cursor links                     
  797 EB52  CA EBCE             JP   Z,CLEFT                                             
  798 EB55  FE 0A               CP   0AH          ;^J Zeilenvorschub                   
  799 EB57  CA EBD2             JP   Z,CLF                                               
  800 EB5A  FE 0C               CP   0CH          ;^L CLS                              
  801 EB5C  28 51               JR   Z,BCLS                                              
  802 EB5E  FE 0D               CP   0DH          ;^M Wagenruecklauf                   
  803 EB60  CA EBEA             JP   Z,CCRET                                             
  804 EB63  FE 14               CP   14H          ;^T BS ab Cursor loeschen            
  805 EB65  CA EBF1             JP   Z,CBLOE                                             
  806 EB68  FE 15               CP   15H          ;^U Cursor nach rechts               
  807 EB6A  CA EC14             JP   Z,CRIGH                                             
  808 EB6D  FE 16               CP   16H          ;^V Zeile ab Cursor loeschen         
  809 EB6F  CA EC18             JP   Z,CZLOE                                             
  810 EB72  FE 18               CP   18H          ;^X Zeile ab Cursor loeschen + CR    
  811 EB74  CA EC3F             JP   Z,CZLCR                                             
  812 EB77  FE 1A               CP   1AH          ;^Z Cursor hoch                      
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  15
BIOS    ASM

  813 EB79  CA EC68             JP   Z,CHOCH                                             
  814 EB7C  FE 82               CP   82H          ;Kursor ein
  815 EB7E  CA ED2C             JP   Z,CUON
  816 EB81  FE 83               CP   83H          ;Kursor aus
  817 EB83  CA ED34             JP   Z,CUOFF
  818                   ;
  819 EB86  47                  LD   B,A          ;Zeichen merken                      
  820 EB87  3A F428             LD   A,(COLOR)                                         
  821 EB8A  A7                  AND  A            ;Test auf Color-BWS                  
  822 EB8B  CA EB1D             JP   Z,KONVT9     ;Z = monochrom  
  823 EB8E  78                  LD   A,B                                                 
  824                   ;
  825 EB8F  FE 84               CP   84H          ;normale Darstellung
  826 EB91  CA ECF1             JP   Z,BNORM
  827 EB94  FE 85               CP   85H          ;invers
  828 EB96  CA ECFF             JP   Z,BINVN
  829 EB99  FE 86               CP   86H          ;intensiv - HihgLight
  830 EB9B  CA ED0E             JP   Z,BINTE
  831 EB9E  FE 87               CP   87H          ;intensiv + invers
  832 EBA0  CA ED1B             JP   Z,BIVIN
  833 EBA3  C3 EB1D             JP   KONVT9
  834                   ;
  835 EBA6  21 17FF     CHOME:  LD   HL,17FFH
  836 EBA9  22 1800             LD   (CUPOS),HL
  837 EBAC  C3 EB1D             JP   KONVT9
  838                   ;
  839 EBAF  3E 20       BCLS:   LD   A,20H        ;0Ch  Bildschirm loeschen
  840 EBB1  CD EBDB             CALL BCL1         ;Loeschroutine
  841 EBB4  22 1800             LD   (CUPOS),HL   ;Cursorposition
  842 EBB7  3A F428             LD   A,(COLOR)    ;Farbbyte
  843 EBBA  E6 77               AND  77H          ;Farb-BWS vorhanden?
  844 EBBC  CA EB1D             JP   Z,KONVT9     ;Z = nein, dann Ende
  845 EBBF  CD EDBE             CALL BWSCOL       ;Farbspeicher ein
  846 EBC2  3A F428             LD   A,(COLOR)
  847 EBC5  CD EBDB             CALL BCL1
  848 EBC8  CD EDC4             CALL BWSZEI       ;Farbspeicher aus
  849 EBCB  C3 EB1D             JP   KONVT9
  850                   ;
  851 EBCE  23          CLEFT:  INC  HL           ;08h  Cursor links
  852 EBCF  C3 EC6C             JP   CHOLI
  853                   ;
  854 EBD2  11 0040     CLF:    LD   DE,0040H     ;0Ah  Zeilenvorschub
  855 EBD5  A7                  AND  A
  856 EBD6  ED 52               SBC  HL,DE
  857 EBD8  C3 EC89             JP   SCROL
  858                   ;
  859 EBDB  21 1000     BCL1:   LD   HL,1000H     ;Anfang BWS
  860 EBDE  77                  LD   (HL),A
  861 EBDF  54                  LD   D,H
  862 EBE0  5D                  LD   E,L
  863 EBE1  1C                  INC  E
  864 EBE2  C5                  PUSH BC
  865 EBE3  01 07FF             LD   BC,07FFH     ;Laenge BWS
  866 EBE6  ED B0               LDIR
  867 EBE8  C1                  POP  BC
  868 EBE9  C9                  RET
  869                   ;
  870 EBEA  7D          CCRET:  LD   A,L          ;0Dh  Wagenruecklauf
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  16
BIOS    ASM

  871 EBEB  F6 3F               OR   3FH
  872 EBED  6F                  LD   L,A
  873 EBEE  C3 EC89             JP   SCROL
  874                   ;
  875 EBF1  E5          CBLOE:  PUSH HL
  876 EBF2  3E 0F               LD   A,CUZEI      ;14h  BS ab Cursor loeschen
  877 EBF4  36 20       CBLO1:  LD   (HL),20H
  878 EBF6  2B                  DEC  HL
  879 EBF7  BC                  CP   H
  880 EBF8  20 FA               JR   NZ,CBLO1
  881 EBFA  E1                  POP  HL
  882 EBFB  3A F428             LD   A,(COLOR)
  883 EBFE  47                  LD   B,A
  884 EBFF  E6 77               AND  77H
  885 EC01  CA EB1D             JP   Z,KONVT9
  886 EC04  CD EDBE             CALL BWSCOL       ;Farbspeicher ein
  887 EC07  3E 0F               LD   A,CUZEI
  888 EC09  70          CBLO2:  LD   (HL),B
  889 EC0A  2B                  DEC  HL
  890 EC0B  BC                  CP   H
  891 EC0C  20 FB               JR   NZ,CBLO2
  892 EC0E  CD EDC4             CALL BWSZEI       ;Farbspeicher aus
  893 EC11  C3 EB1D             JP   KONVT9
  894                   ;
  895 EC14  2B          CRIGH:  DEC  HL           ;15h  Cursor nach rechts
  896 EC15  C3 EC89             JP   SCROL
  897                   ;
  898 EC18  E5          CZLOE:  PUSH HL           ;16h  Zeile ab Cursor loeschen
  899 EC19  7D                  LD   A,L
  900 EC1A  E6 3F               AND  3FH
  901 EC1C  47                  LD   B,A
  902 EC1D  04                  INC  B
  903 EC1E  36 20       CZLO1:  LD   (HL),20H
  904 EC20  2B                  DEC  HL
  905 EC21  10 FB               DJNZ CZLO1
  906 EC23  E1                  POP  HL
  907 EC24  3A F428             LD   A,(COLOR)
  908 EC27  4F                  LD   C,A
  909 EC28  E6 77               AND  77H
  910 EC2A  CA EB1D             JP   Z,KONVT9
  911 EC2D  CD EDBE             CALL BWSCOL       ;Farbspeicher ein
  912 EC30  7D                  LD   A,L
  913 EC31  E6 3F               AND  3FH
  914 EC33  47                  LD   B,A
  915 EC34  04                  INC  B
  916 EC35  71          CZLO2:  LD   (HL),C
  917 EC36  2B                  DEC  HL
  918 EC37  10 FC               DJNZ CZLO2
  919 EC39  CD EDC4             CALL BWSZEI       ;Farbspeicher aus
  920 EC3C  C3 EB1D             JP   KONVT9
  921                   ;
  922 EC3F  E5          CZLCR:  PUSH HL           ;18h  Zeile ab Cursor loeschen + CR
  923 EC40  7D                  LD   A,L
  924 EC41  F6 3F               OR   3FH
  925 EC43  6F                  LD   L,A
  926 EC44  22 1800             LD   (CUPOS),HL
  927 EC47  E5                  PUSH HL
  928 EC48  06 40               LD   B,40H        ;Zeilenlaenge
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  17
BIOS    ASM

  929 EC4A  36 20       CZLC1:  LD   (HL),20H
  930 EC4C  2B                  DEC  HL
  931 EC4D  10 FB               DJNZ CZLC1
  932 EC4F  E1                  POP  HL
  933 EC50  3A F428             LD   A,(COLOR)
  934 EC53  4F                  LD   C,A
  935 EC54  E6 77               AND  77H
  936 EC56  CA EB1D             JP   Z,KONVT9
  937 EC59  CD EDBE             CALL BWSCOL       ;Farbspeicher ein
  938 EC5C  06 40               LD   B,40H
  939 EC5E  71          CZLC2:  LD   (HL),C
  940 EC5F  2B                  DEC  HL
  941 EC60  10 FC               DJNZ CZLC2
  942 EC62  CD EDC4             CALL BWSZEI       ;Farbspeicher aus
  943 EC65  C3 EB1D             JP   KONVT9
  944                   ;
  945 EC68  11 0040     CHOCH:  LD   DE,0040H     ;1Ah     Cursor hoch
  946 EC6B  19                  ADD  HL,DE
  947                   ;
  948 EC6C  3E 18       CHOLI:  LD   A,18H        ;Begrenzung Cursor hoch und links
  949 EC6E  BC                  CP   H
  950 EC6F  CA EB1D             JP   Z,KONVT9
  951 EC72  22 1800             LD   (CUPOS),HL
  952 EC75  C3 EB1D             JP   KONVT9
  953                   ;
  954 EC78  77          CCHAR:  LD   (HL),A
  955 EC79  3A F428             LD   A,(COLOR)
  956 EC7C  4F                  LD   C,A
  957 EC7D  E6 77               AND  77H
  958 EC7F  28 07               JR   Z,CCHA1
  959 EC81  CD EDBE             CALL BWSCOL       ;Farbspeicher ein
  960 EC84  71                  LD   (HL),C
  961 EC85  CD EDC4             CALL BWSZEI       ;Farbspeicher aus
  962 EC88  2B          CCHA1:  DEC  HL
  963                   ;
  964 EC89  22 1800     SCROL:  LD   (CUPOS),HL
  965 EC8C  EB                  EX   DE,HL        ;Test ob Scrollen noetig
  966 EC8D  21 0FFF             LD   HL,0FFFH
  967 EC90  A7                  AND  A
  968 EC91  ED 52               SBC  HL,DE        ;DE = akt. Cursorpos.
  969 EC93  EB                  EX   DE,HL
  970 EC94  DA EB1D             JP   C,KONVT9     ;CY = nicht scrollen
  971 EC97  3E 20               LD   A,20H        ;Leerzeichen
  972 EC99  CD ECB3             CALL SCR11        ;Scrollen
  973 EC9C  3A F428             LD   A,(COLOR)
  974 EC9F  E6 77               AND  77H
  975 ECA1  CA EB1D             JP   Z,KONVT9     ;Z = kein Farbspeicher
  976 ECA4  CD EDBE             CALL BWSCOL       ;Farbspeicher ein
  977 ECA7  3A F428             LD   A,(COLOR)    ;Farbbyte
  978 ECAA  CD ECB3             CALL SCR11
  979 ECAD  CD EDC4             CALL BWSZEI       ;Farbspeicher aus
  980 ECB0  C3 EB1D             JP   KONVT9
  981                   ;
  982 ECB3  21 17BF     SCR11:  LD   HL,17BFH     ;Umladeroutine Scrollen
  983 ECB6  11 17FF             LD   DE,17FFH
  984 ECB9  01 07C0             LD   BC,07C0H
  985 ECBC  ED B8               LDDR
  986 ECBE  EB                  EX   DE,HL
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  18
BIOS    ASM

  987 ECBF  22 1800             LD   (CUPOS),HL
  988 ECC2  23                  INC  HL
  989 ECC3  06 40               LD   B,40H        ;eine Zeilenlaenge
  990 ECC5  2D          SCR12:  DEC  L
  991 ECC6  77                  LD   (HL),A       ;Leerzeile schreiben
  992 ECC7  10 FC               DJNZ SCR12
  993 ECC9  C9                  RET
  994                   ;
  995                   ;
  996                   ;UP 'MBEEP' (Monitor-Beep)
  997                   ;
  998 ECCA  C5          MBEEP:  PUSH BC 
  999 ECCB  06 02               LD   B,02H        ;2 Wiederholungen
 1000 ECCD  C5          MBEEP1: PUSH BC 
 1001                   ;       LD   BC,0040H     ;--> fuer 2 MHz
 1002 ECCE  01 0080             LD   BC,0080H     ;--> fuer 4 MHz
 1003 ECD1  CD ECE1             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1004                   ;       LD   BC,0F032H    ;--> fuer 2 MHz
 1005 ECD4  01 F064             LD   BC,0F064H    ;--> fuer 4 MHz
 1006 ECD7  CD ECE1             CALL UPTON        ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1007 ECDA  C1                  POP  BC 
 1008 ECDB  10 F0               DJNZ MBEEP1 
 1009 ECDD  C1                  POP  BC 
 1010 ECDE  C3 EB2C             JP   COEN1 
 1011                   ;
 1012                   ;
 1013                   ;UP 'Ton', Reg, B = Tonlaenge, C = Tonhoehe
 1014                   ;
 1015 ECE1  F5          UPTON:  PUSH AF 
 1016 ECE2  DB 05       UPTON1: IN   A,(P05) 
 1017 ECE4  1F                  RRA 
 1018 ECE5  3F                  CCF 
 1019 ECE6  17                  RLA 
 1020 ECE7  D3 05               OUT  (P05),A 
 1021 ECE9  79                  LD   A,C 
 1022 ECEA  3D          UPTON2: DEC  A 
 1023 ECEB  20 FD               JR   NZ,UPTON2 
 1024 ECED  10 F3               DJNZ UPTON1 
 1025 ECEF  F1                  POP  AF 
 1026 ECF0  C9                  RET 
 1027                   ;
 1028                   ;
 1029 ECF1  3A F429     BNORM:  LD   A,(COLO1)    ;84h  normale Darstellung
 1030 ECF4  E6 77               AND  77H
 1031 ECF6  32 F428             LD   (COLOR),A
 1032 ECF9  32 F429             LD   (COLO1),A
 1033 ECFC  C3 EB1D             JP   KONVT9
 1034                   ;
 1035 ECFF  3A F429     BINVN:  LD   A,(COLO1)    ;85h  invers EIN
 1036 ED02  E6 77               AND  77H
 1037 ED04  0F                  RRCA
 1038 ED05  0F                  RRCA
 1039 ED06  0F                  RRCA
 1040 ED07  0F                  RRCA
 1041 ED08  32 F428             LD   (COLOR),A
 1042 ED0B  C3 EB1D             JP   KONVT9
 1043                   ;
 1044 ED0E  3A F429     BINTE:  LD   A,(COLO1)    ;86h  intensiv EIN
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  19
BIOS    ASM

 1045 ED11  E6 77               AND  77H
 1046 ED13  F6 08               OR   08H
 1047 ED15  32 F428             LD   (COLOR),A
 1048 ED18  C3 EB1D             JP   KONVT9
 1049                   ;
 1050 ED1B  3A F428     BIVIN:  LD   A,(COLOR)    ;87h  intensiv + invers
 1051 ED1E  E6 77               AND  77H
 1052 ED20  F6 08               OR   08H
 1053 ED22  0F                  RRCA
 1054 ED23  0F                  RRCA
 1055 ED24  0F                  RRCA
 1056 ED25  0F                  RRCA
 1057 ED26  32 F428             LD   (COLOR),A
 1058 ED29  C3 EB1D             JP   KONVT9
 1059                   ;
 1060 ED2C  3E 01       CUON:   LD   A,01H        ;82h Cursor EIN
 1061 ED2E  32 F42D             LD   (CUFLAG),A
 1062 ED31  C3 EB1D             JP   KONVT9
 1063                   ;
 1064 ED34  AF          CUOFF:  XOR  A            ;83h Cursor AUS
 1065 ED35  32 F42D             LD   (CUFLAG),A
 1066 ED38  C3 EB1D             JP   KONVT9
 1067                   ;
 1068                   ; Behandlung ESC-Sequenzen
 1069                   ;
 1070                   ; Input: ESC + 2 Steuerzeichen
 1071                   ; wenn 1. Zeichen > 80h dann Cursorposition
 1072                   ; sonst Auswertung Farbe / Grafikzeichen
 1073                   ; (stz00) = Zaehler fuer Zeichenanzahl
 1074                   ;
 1075 ED3B  3A F42E     KONV10: LD   A,(STZ00)
 1076 ED3E  FE 02               CP   02H          ;2 = 1. Steuerzeichen (Zeile)
 1077 ED40  20 0C               JR   NZ,KONV20    ;sonst 3. Durchlauf (Spalte)
 1078 ED42  79                  LD   A,C
 1079 ED43  32 F42F             LD   (STZ01),A    ;erstes Zeichen merken
 1080 ED46  3E 01               LD   A,01H        ;Zeiger fuer 3. Durchlauf
 1081 ED48  32 F42E             LD   (STZ00),A
 1082 ED4B  C3 EB1D             JP   KONVT9       ;nichts ausgeben
 1083                   ;
 1084                   ; Verzweigung Cursorposition / weitere Funktionen
 1085                   ;
 1086 ED4E  79          KONV20: LD   A,C
 1087 ED4F  32 F430             LD   (STZ02),A    ;zweites Zeichen merken
 1088 ED52  AF                  XOR  A
 1089 ED53  32 F42E             LD   (STZ00),A    ;Durchlaufzaehler ruecksetzen
 1090 ED56  21 F42F             LD   HL,STZ01
 1091 ED59  7E                  LD   A,(HL)
 1092 ED5A  CB 7F               BIT  7,A          ;welche Funktion? NZ = Cursor
 1093 ED5C  28 2F               JR   Z,KONV22     ;Z = weitere Funktionen
 1094                   
 1095                   ; Berechnung direkte Cursorposition
 1096                   ; OUT:    HL = BWS-Adresse
 1097                   ;
 1098 ED5E  F5                  PUSH AF
 1099 ED5F  79                  LD   A,C
 1100 ED60  E6 3F               AND  3FH          ;max. Spaltenzahl
 1101 ED62  6F                  LD   L,A
 1102 ED63  F1                  POP  AF
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  20
BIOS    ASM

 1103 ED64  E6 1F               AND  1FH          ;max. Zeilenzahl
 1104 ED66  16 00               LD   D,00H
 1105 ED68  62                  LD   H,D
 1106 ED69  5F                  LD   E,A
 1107 ED6A  06 06               LD   B,06H
 1108 ED6C  CB 23       KONV21: SLA  E
 1109 ED6E  CB 12               RL   D
 1110 ED70  10 FA               DJNZ KONV21
 1111 ED72  19                  ADD  HL,DE
 1112 ED73  EB                  EX   DE,HL
 1113 ED74  21 17FF             LD   HL,17FFH     ;Ende BWS-RAM
 1114 ED77  A7                  AND  A
 1115 ED78  ED 52               SBC  HL,DE
 1116                   ;
 1117                   ; Cursor direkt positionieren
 1118                   ; IN:    HL = Adresse Cursor
 1119                   ;
 1120 ED7A  E5                  PUSH HL
 1121 ED7B  2A 1800             LD   HL,(CUPOS)	  ;alte Position
 1122 ED7E  3A F431             LD   A,(CHAR)	  ;Zeichen holen
 1123 ED81  77                  LD   (HL),A	      ;auf BS schreiben
 1124 ED82  E1                  POP  HL
 1125 ED83  22 1800             LD   (CUPOS),HL   ;neue Position setzen
 1126 ED86  7E                  LD   A,(HL)       ;neues Zeichen holen
 1127 ED87  32 F431             LD   (CHAR),A     ;und merken
 1128 ED8A  C3 EB1D             JP   KONVT9
 1129                   ;
 1130                   ; Auswertung weiterer ESC-Funktionen
 1131                   ; IN:      A = 1. Steuerzeichen
 1132                   ;
 1133                   ; Ausgabe Grafikzeichen aus AC1-ZG ( > 80h )
 1134                   ;
 1135 ED8D  FE 5F       KONV22: CP   5FH          ;Grafikzeichen?
 1136 ED8F  20 08               JR   NZ,KONV24    ;NZ = nein
 1137 ED91  23                  INC  HL
 1138 ED92  7E                  LD   A,(HL)       ;2. Zeichen holen
 1139 ED93  2A 1800             LD   HL,(CUPOS)
 1140 ED96  C3 EC78             JP   CCHAR        ;Zeichen ausgeben
 1141                   ;
 1142                   ; Einstellen der Farbe (nur Color-BWS)
 1143                   ;
 1144 ED99  FE 5D       KONV24: CP   5DH          ;Farbe?
 1145 ED9B  C2 EB1D             JP   NZ,KONVT9    ;NZ = nein
 1146 ED9E  3A F428             LD   A,(COLOR)    ;Color-BWS?
 1147 EDA1  A7                  AND  A
 1148 EDA2  CA EB1D             JP   Z,KONVT9     ;Z = nein
 1149 EDA5  23                  INC  HL
 1150 EDA6  7E                  LD   A,(HL)       ;2. Zeichen holen
 1151 EDA7  E6 77               AND  77H          ;intensiv maskieren
 1152 EDA9  47                  LD   B,A
 1153 EDAA  0F                  RRCA
 1154 EDAB  0F                  RRCA
 1155 EDAC  0F                  RRCA
 1156 EDAD  0F                  RRCA
 1157 EDAE  B8                  CP   B            ;Zeichen- und HG-Farbe gleich?
 1158 EDAF  CA EB1D             JP   Z,KONVT9     ;Z = Ja, dann ignorieren
 1159 EDB2  78                  LD   A,B
 1160 EDB3  32 F428             LD   (COLOR),A    ;Farbe setzen
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  21
BIOS    ASM

 1161 EDB6  E6 77               AND  77H          ;intensiv maskieren
 1162 EDB8  32 F429             LD   (COLO1),A    ;Backup
 1163 EDBB  C3 EB1D             JP   KONVT9
 1164                   ;
 1165 EDBE  DB F0       BWSCOL: IN   A,(PF0)      ;bwsport
 1166 EDC0  CB D7               SET  2,A          ;Farbspeicher ein
 1167 EDC2  18 04               JR   BWSZ1
 1168                   ;
 1169 EDC4  DB F0       BWSZEI: IN   A,(PF0)      ;bwsport
 1170 EDC6  CB 97               RES  2,A          ;Farbspeicher aus
 1171 EDC8  E6 07       BWSZ1:  AND  07H
 1172 EDCA  D3 F0               OUT  (PF0),A
 1173 EDCC  C9                  RET
 1174                   ;
 1175 EDCD  AF          BWSINI: XOR  A            ;Farbbyte auf Monochrom setzen
 1176 EDCE  32 F428             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1177 EDD1  32 F42A             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1178 EDD4  0E F0               LD   C,0F0H       ;I/O-Adresse COLOR-BWS
 1179 EDD6  ED 40               IN   B,(C)        ;Konfigbyte COLOR-BWS lesen
 1180 EDD8  04                  INC  B            ;fuer COLOR-BWS muss B<255 sein
 1181 EDD9  C8                  RET  Z            ;kein COLOR-BWS vorhanden --> Ende
 1182                           ;hier wird die Routine verlassen, wenn kein CPLD vorh. ist
 1183 EDDA  05                  DEC  B            ;Konfigbyte COLOR-BWS: Farb-RAM aus
 1184 EDDB  50                  LD   D,B
 1185 EDDC  CB D2               SET  2,D          ;Konfigbyte COLOR-BWS: Farb-RAM ein
 1186 EDDE  21 1000             LD   HL,1000H
 1187 EDE1  5E                  LD   E,(HL)       ;Zeichen aus 1000h
 1188 EDE2  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1189 EDE4  3A 181F             LD   A,(CBWSB)    ;Farbbyte aus dem AC1-Monitor
 1190 EDE7  77                  LD   (HL),A       ;Farbe auf 1000h setzen
 1191 EDE8  BE                  CP   (HL)         ;ist Farb-RAM gesteckt?
 1192 EDE9  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1193 EDEB  73                  LD   (HL),E       ;Zeichen auf 1000h zurueckschreiben
 1194 EDEC  C0                  RET  NZ           ;Farbe hat nicht geklappt --> Ende
 1195                           ;hier wird die Routine verlassen, wenn kein Farb-RAM steckt
 1196 EDED  ED 51               OUT  (C),D        ;Farb-RAM einschalten
 1197 EDEF  C5                  PUSH BC
 1198 EDF0  11 1001             LD   DE,1001H
 1199 EDF3  01 07FF             LD   BC,07FFH
 1200 EDF6  ED B0               LDIR              ;Farb-RAM initialisieren
 1201 EDF8  7E                  LD   A,(HL)       ;Farbe aus 17FFh ruecklesen
 1202 EDF9  C1                  POP  BC
 1203 EDFA  ED 41               OUT  (C),B        ;Farb-RAM ausschalten
 1204 EDFC  32 F428             LD   (COLOR),A    ;Arbeitszelle Farbbyte im BIOS
 1205 EDFF  32 F42A             LD   (COLO2),A    ;Merkzelle fuer WBOOT im BIOS
 1206 EE02  C9                  RET
 1207                   ;
 1208                   ;******************************   LISTST   ******************************
 1209                   ;
 1210 EE03  AF          LISTST: XOR  A
 1211 EE04  3D                  DEC  A
 1212 EE05  C9                  RET
 1213                   ;
 1214                   ;******************************   SELDSK   ******************************
 1215                   ;
 1216 EE06  21 E641     SELDSK: LD   HL,NDISK     ;max. Anzahl der LW
 1217 EE09  79                  LD   A,C          ;C = akt. LW
 1218 EE0A  BE                  CP   (HL)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  22
BIOS    ASM

 1219 EE0B  21 0000             LD   HL,0000H     ;HL=0 --> kein LW
 1220 EE0E  D0                  RET  NC           ;akt. LW >= NDISK!!!
 1221 EE0F  2A E642             LD   HL,(DPHX)    ;AnfangsADR DPH(y)-Tabelle
 1222 EE12  06 00               LD   B,00H        ;BC = akt. LW
 1223 EE14  09                  ADD  HL,BC
 1224 EE15  09                  ADD  HL,BC        ;HL = DPHY + (2 * LW)
 1225 EE16  5E                  LD   E,(HL)
 1226 EE17  23                  INC  HL
 1227 EE18  56                  LD   D,(HL)       ;DE = (DPHY + (2 * LW))
 1228 EE19  EB                  EX   DE,HL        ;HL = DPH-ADR vom akt. LW
 1229 EE1A  7C                  LD   A,H
 1230 EE1B  B5                  OR   L
 1231 EE1C  C8                  RET  Z            ;HL=0 --> kein DPB
 1232 EE1D  79                  LD   A,C
 1233 EE1E  32 F44C             LD   (DRIVE),A    ;aktives LW --> A
 1234 EE21  22 F453             LD   (DPH),HL     ;zugeordneter DPH --> HL
 1235 EE24  C9                  RET
 1236                   ;
 1237                   ;******************************   HOME   ******************************
 1238                   ;
 1239 EE25  01 0000     HOME:   LD   BC,0000H
 1240 EE28  ED 43 F44D  SETTRK: LD   (TRACK),BC
 1241 EE2C  C9                  RET
 1242                   ;
 1243                   ;******************************   SETSEC   ******************************
 1244                   ;
 1245 EE2D  ED 43 F44F  SETSEC: LD   (SECTOR),BC
 1246 EE31  C9                  RET
 1247                   ;
 1248                   ;******************************   SETDMA   ******************************
 1249                   ;
 1250 EE32  ED 43 F451  SETDMA: LD   (DMA),BC
 1251 EE36  C9                  RET
 1252                   ;
 1253                   ;******************************   SECTRN   ******************************
 1254                   ;
 1255 EE37  60          SECTRN: LD   H,B
 1256 EE38  69                  LD   L,C
 1257 EE39  7A                  LD   A,D
 1258 EE3A  B3                  OR   E
 1259 EE3B  C8                  RET  Z
 1260 EE3C  EB                  EX   DE,HL
 1261 EE3D  06 00               LD   B,00H
 1262 EE3F  09                  ADD  HL,BC
 1263 EE40  6E                  LD   L,(HL)
 1264 EE41  62                  LD   H,D
 1265 EE42  C9                  RET
 1266                   ;
 1267                   ;******************************   READ + WRITE   ******************************
 1268                   ;
 1269 EE43  0E 02       READ:   LD   C,02H
 1270 EE45  3E 04               LD   A,04H
 1271 EE47  21                  DEFB 21H          ;LD HL,063EH mit nxt. Befehl!!!
 1272 EE48  3E 06       WRITE:  LD   A,06H        ;DUMMY fuer READ
 1273 EE4A  32 F44B             LD   (RWBYTE),A   ;RWBYTE: 04 = Lesen; 06 = Schreiben
 1274 EE4D  79                  LD   A,C
 1275 EE4E  32 F46E             LD   (DF51E),A
 1276 EE51  21 EE6A             LD   HL,RWEND
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  23
BIOS    ASM

 1277 EE54  E5                  PUSH HL
 1278 EE55  2A F453             LD   HL,(DPH)
 1279 EE58  11 000A             LD   DE,000AH
 1280 EE5B  19                  ADD  HL,DE
 1281 EE5C  7E                  LD   A,(HL)       ;NWT vom DPB
 1282 EE5D  23                  INC  HL
 1283 EE5E  66                  LD   H,(HL)       ;HWT vom DPB
 1284 EE5F  6F                  LD   L,A
 1285 EE60  2B                  DEC  HL
 1286 EE61  7E                  LD   A,(HL)       ;HWT der R/W-Funktion
 1287 EE62  2B                  DEC  HL
 1288 EE63  6E                  LD   L,(HL)       ;NWT der R/W-Funktion
 1289 EE64  67                  LD   H,A
 1290 EE65  E5                  PUSH HL           ;Adresse der R/W-Funktion
 1291 EE66  21 F44B             LD   HL,RWBYTE    ;HL -> R/W-Byte
 1292 EE69  C9                  RET               ;JP R/W-Funktion
 1293                   ;
 1294 EE6A  B7          RWEND:  OR   A
 1295 EE6B  C8                  RET  Z
 1296 EE6C  3E 01               LD   A,01H        ;Fehler
 1297 EE6E  C9                  RET
 1298                   ;
 1299                   ;******************************   RAM-Disk   ******************************
 1300                   ;
 1301 EE6F  4E          RWRDSK: LD   C,(HL)       ;RWBYTE: 04 = Lesen; 06 = Schreiben 
 1302 EE70  23                  INC  HL           ;DRIVE wird uebersprungen
 1303 EE71  23                  INC  HL
 1304 EE72  7E                  LD   A,(HL)       ;TRACK NWT
 1305 EE73  32 F42B             LD   (RAFTRK),A
 1306 EE76  23                  INC  HL
 1307 EE77  7E                  LD   A,(HL)       ;TRACK HWT
 1308 EE78  A7                  AND  A
 1309 EE79  20 32               JR   NZ,RDERR     ;muss 0 sein
 1310 EE7B  23                  INC  HL
 1311 EE7C  7E                  LD   A,(HL)       ;SEKTOR NWT
 1312 EE7D  32 F42C             LD   (RAFSEC),A
 1313 EE80  CB 7F               BIT  7,A
 1314 EE82  20 29               JR   NZ,RDERR     ;Bit 7 muss 0 sein
 1315 EE84  CB 77               BIT  6,A
 1316 EE86  20 25               JR   NZ,RDERR     ;Bit 6 muss 0 sein
 1317 EE88  23                  INC  HL
 1318 EE89  7E                  LD   A,(HL)       ;SEKTOR HWT
 1319 EE8A  A7                  AND  A
 1320 EE8B  20 20               JR   NZ,RDERR     ;muss 0 sein
 1321 EE8D  23                  INC  HL
 1322 EE8E  23                  INC  HL           ;DMA wird uebersprungen
 1323 EE8F  79                  LD   A,C
 1324 EE90  01 0080             LD   BC,0080H
 1325 EE93  FE 06               CP   06H
 1326 EE95  28 08               JR   Z,RDSKWR     ;C = 06 --> RDSK Schreiben
 1327 EE97  CD EFDC             CALL ADRRAF
 1328 EE9A  ED B2               INIR
 1329 EE9C  00                  NOP
 1330 EE9D  AF                  XOR  A            ;in Ordnung
 1331 EE9E  C9                  RET
 1332                   ;
 1333 EE9F  21 0080     RDSKWR: LD   HL,0080H     ;RAM-Disk schreiben 
 1334 EEA2  ED 5B F451          LD   DE,(DMA)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  24
BIOS    ASM

 1335 EEA6  CD EFDC             CALL ADRRAF
 1336 EEA9  ED B3               OTIR
 1337 EEAB  AF                  XOR  A            ;in Ordnung
 1338 EEAC  C9                  RET
 1339                   ;
 1340 EEAD  3E FF       RDERR:  LD   A,0FFH       ;Fehler
 1341 EEAF  C9                  RET
 1342                   ;
 1343 EEB0  20 3D 3E 49 TXTRDI: DEFM " =>INIT.."
 1344 EEB9  00                  DEFB 0
 1345                   ;
 1346 EEBA  4F 4B       TXTRDO: DEFM "OK"
 1347 EEBC  00                  DEFB 0
 1348                   ;
 1349 EEBD  52 46 4C 20 TXTRDE: DEFM "RFL ERROR!"
 1350 EEC7  0D 0A               DEFB 0DH,0AH
 1351 EEC9  00                  DEFB 0
 1352                   ;
 1353                   ; Test der RAM-Disk - GrC6Ce (256 / 512 / 1024 / 2048 KByte)
 1354                   ;
 1355 EECA  AF          RDTEST: XOR  A            ;Kapazitaet der RAM-Disk testen
 1356 EECB  D3 E6               OUT  (PE0+6),A    ;H-Adresse ruecksetzen
 1357 EECD  0E E0               LD   C,PE0        ;Test erfolgt in der 1. RAM-Bank
 1358                   ;
 1359                   ; Inhalte der 4 RAM-Testzellen sichern
 1360                   ;
 1361 EECF  21 EF26             LD   HL,RDMERK    ;Merkzellen im RAM
 1362 EED2  06 04               LD   B,4          ;4 Durchlaeufe
 1363 EED4  16 04               LD   D,4          ;Startwert Extended-Adresse
 1364 EED6  AF          RDTST1: XOR  A
 1365 EED7  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1366 EED9  7A                  LD   A,D
 1367 EEDA  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1368 EEDC  ED 78               IN   A,(C)
 1369 EEDE  77                  LD   (HL),A       ;Daten aus der RAM-Disk sichern
 1370 EEDF  23                  INC  HL           ;Merkzelle++
 1371 EEE0  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1372 EEE2  10 F2               DJNZ RDTST1
 1373                   ;
 1374                   ; 4 Testwerte in die RAM-Disk schreiben
 1375                   ;
 1376 EEE4  06 04               LD   B,4          ;4 Durchlaeufe
 1377 EEE6  16 04               LD   D,4          ;Startwert Extended-Adresse
 1378 EEE8  AF          RDTST2: XOR  A
 1379 EEE9  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1380 EEEB  7A                  LD   A,D
 1381 EEEC  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1382 EEEE  ED 79               OUT  (C),A        ;Testwert in die RAM-Disk schreiben
 1383 EEF0  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1384 EEF2  10 F4               DJNZ RDTST2
 1385                   ;
 1386                   ;Tabelle der Test-Werte (mit *...* sind die zu testenden Werte):
 1387                   ;
 1388                   ;           RAM-Disk-Size =   256K   512K  1024K  2048K
 1389                   ;Extended-Adresse=00000100B    0      0      0     *4*
 1390                   ;Extended-Adresse=00000010B    0      0     *2*     2
 1391                   ;Extended-Adresse=00000001B    0     *1*     1      1
 1392                   ;Extended-Adresse=00000000B   *0*     0      0      0
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  25
BIOS    ASM

 1393                   ;
 1394                   ; Groesse der RAM-Disk bestimmen
 1395                   ;
 1396 EEF4  06 04               LD   B,4          ;4 Durchlaeufe
 1397 EEF6  16 04               LD   D,4          ;Startwert Extended-Adresse
 1398 EEF8  AF          RDTST3: XOR  A
 1399 EEF9  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1400 EEFB  7A                  LD   A,D
 1401 EEFC  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1402 EEFE  ED 78               IN   A,(C)
 1403 EF00  BA                  CP   D
 1404 EF01  28 07               JR   Z,RDTST4     ;2048(B=4),1024(B=3),512(B=2),256(B=1)
 1405 EF03  CB 3A               SRL  D            ;0 --> D7 --> D0 --> CY
 1406 EF05  10 F1               DJNZ RDTST3
 1407 EF07  C3 EFD3             JP   RDERRO       ;Fehler: hier stimmt was nicht!
 1408                   ;
 1409 EF0A  21 EF2A     RDTST4: LD   HL,RDSIZE
 1410 EF0D  05                  DEC  B
 1411 EF0E  70                  LD   (HL),B       ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1412                   ;
 1413                   ; gesicherte Daten in die RAM-Disk zurueckschreiben
 1414                   ; 
 1415 EF0F  21 EF29             LD   HL,RDMERK+3  ;Merkzellen RAM (letzter Eintrag)
 1416 EF12  04                  INC  B            ;1 bis 4 Durchlaeufe, je nach RDSIZE
 1417 EF13  16 01               LD   D,1          ;Startwert Ext.-Adr. (1 Bit n. rechts)
 1418 EF15  AF          RDTST5: XOR  A
 1419 EF16  D3 E7               OUT  (PE0+7),A    ;L-Adresse ruecksetzen
 1420 EF18  7A                  LD   A,D
 1421 EF19  CB 3F               SRL  A            ;0 --> A7 --> A0 --> CY
 1422 EF1B  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse auswaehlen
 1423 EF1D  7E                  LD   A,(HL)
 1424 EF1E  ED 79               OUT  (C),A        ;urspruengliche Daten zurueckschreiben
 1425 EF20  2B                  DEC  HL
 1426 EF21  CB 22               SLA  D            ;CY <-- D7 <-- D0 <-- 0
 1427 EF23  10 F0               DJNZ RDTST5       ;WICHTIG: nicht mehr als notwendig
 1428 EF25  C9                  RET               ;in die RAM-Disk zurueckschreiben!
 1429                   ;
 1430 EF26  00 00 00 00 RDMERK: DEFS 4,0          ;4 Merkzellen fuer den RAM-Disk Test
 1431 EF2A  00          RDSIZE: DEFB 0            ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1432                   ;
 1433 EF2B  21 EEB0     RDFORM: LD   HL,TXTRDI    ;Formatierungstext...
 1434 EF2E  CD EA60             CALL OUTTXT
 1435 EF31  21 C002             LD   HL,0C002H    ;Hilfsprogramm von 0C000H bis 0C800H
 1436 EF34  54                  LD   D,H
 1437 EF35  5D                  LD   E,L
 1438 EF36  2B                  DEC  HL
 1439 EF37  36 E0               LD   (HL),PE0     ;0C001H = Grundadresse der RAM-Disk
 1440 EF39  2B                  DEC  HL
 1441 EF3A  36 D3               LD   (HL),0D3H    ;0C000H = 0D3H --> OUT n
 1442 EF3C  01 0200             LD   BC,0200H
 1443 EF3F  ED B0               LDIR              ;0D3H,0E0H von 0C000H bis 0C1FFH
 1444 EF41  23                  INC  HL
 1445 EF42  36 E1               LD   (HL),PE0+1
 1446 EF44  2B                  DEC  HL
 1447 EF45  01 0200             LD   BC,0200H
 1448 EF48  ED B0               LDIR              ;0D3H,0E1H von 0C200H bis 0C3FFH
 1449 EF4A  23                  INC  HL
 1450 EF4B  36 E2               LD   (HL),PE0+2
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  26
BIOS    ASM

 1451 EF4D  2B                  DEC  HL
 1452 EF4E  01 0200             LD   BC,0200H
 1453 EF51  ED B0               LDIR              ;0D3H,0E2H von 0C400H bis 0C5FFH
 1454 EF53  23                  INC  HL
 1455 EF54  36 E3               LD   (HL),PE0+3
 1456 EF56  2B                  DEC  HL
 1457 EF57  01 0200             LD   BC,0200H
 1458 EF5A  ED B0               LDIR              ;0D3H,0E3H von 0C600H bis 0C7FFH
 1459 EF5C  36 C9               LD   (HL),0C9H    ;RET auf 0C800H
 1460                   ;
 1461 EF5E  21 EF2A             LD   HL,RDSIZE    ;RD-Size: 0=256K 1=512K 2=1024K 3=2048K
 1462 EF61  7E                  LD   A,(HL)
 1463 EF62  FE 00               CP   0
 1464 EF64  28 0A               JR   Z,RDFOR1     ;RD 256K
 1465 EF66  FE 01               CP   1
 1466 EF68  28 06               JR   Z,RDFOR1     ;RD 512K
 1467 EF6A  3D                  DEC  A
 1468 EF6B  CB 27               SLA  A            ;A *= 2
 1469 EF6D  CB 27               SLA  A            ;A *= 2
 1470 EF6F  3D                  DEC  A
 1471 EF70  57          RDFOR1: LD   D,A
 1472 EF71  14                  INC  D            ;D ==> 1=256K 2=512K 4=1024K 8=2048K
 1473 EF72  AF                  XOR  A
 1474 EF73  D3 E7               OUT  (PE0+7),A    ;L-Adresse setzen
 1475 EF75  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1476 EF77  1E 00               LD   E,0          ;Merker fuer Extended-Adresse
 1477 EF79  06 00               LD   B,0          ;256 Durchlaeufe
 1478 EF7B  0E E6               LD   C,PE0+6
 1479 EF7D  ED 41       RDFOR2: OUT  (C),B        ;H-Adresse setzen
 1480 EF7F  3E E5               LD   A,0E5H       ;RD wird mit 0E5H formatiert
 1481 EF81  CD C000             CALL HPRDSK       ;Hilfsprog. Format RAM-Disk auf C000H
 1482 EF84  10 F7               DJNZ RDFOR2       ;fuer alle H-Adressen (256 Durchl.)
 1483 EF86  1C                  INC  E
 1484 EF87  7B                  LD   A,E
 1485 EF88  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1486 EF8A  15                  DEC  D
 1487 EF8B  20 F0               JR   NZ,RDFOR2        
 1488                   ;
 1489 EF8D  21 D000             LD   HL,CCP
 1490 EF90  22 F451             LD   (DMA),HL
 1491 EF93  06 2C               LD   B,2CH        ;44 Bloecke CCP+BDOS
 1492 EF95  CD EFA4             CALL WRCCP
 1493 EF98  C2 E98E             JP   NZ,CPMERR
 1494 EF9B  21 EEBA             LD   HL,TXTRDO    ;"OK"
 1495 EF9E  CD EA60             CALL OUTTXT
 1496 EFA1  C3 E974             JP   WBOOT1
 1497                   ;
 1498 EFA4  C5          WRCCP:  PUSH BC           ;CCP+BDOS in Systemtrack schreiben
 1499 EFA5  0E 00               LD   C,0          ;LW A:
 1500 EFA7  CD EE06             CALL SELDSK
 1501 EFAA  C1                  POP  BC
 1502 EFAB  21 0000             LD   HL,0000H
 1503 EFAE  22 F44D             LD   (TRACK),HL   ;Track 0
 1504 EFB1  EB                  EX   DE,HL
 1505 EFB2  21 D000             LD   HL,CCP
 1506 EFB5  ED 53 F44F  WRCCP1: LD   (SECTOR),DE  ;Sektor 0 ff.
 1507 EFB9  22 F451             LD   (DMA),HL
 1508 EFBC  C5                  PUSH BC
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  27
BIOS    ASM

 1509 EFBD  CD                  DEFB 0CDH         ;CALL WRITE -> CD ED CA
 1510 EFBE  EE48        WRCCP2: DEFW WRITE        ;kannn durch READ (EDC5) ersetzt werden
 1511 EFC0  C1                  POP  BC
 1512 EFC1  20 10               JR   NZ,RDERRO
 1513 EFC3  2A F451             LD   HL,(DMA)
 1514 EFC6  11 0080             LD   DE,0080H
 1515 EFC9  19                  ADD  HL,DE
 1516 EFCA  ED 5B F44F          LD   DE,(SECTOR)
 1517 EFCE  13                  INC  DE
 1518 EFCF  10 E4               DJNZ WRCCP1
 1519 EFD1  AF                  XOR  A
 1520 EFD2  C9                  RET
 1521                   ;
 1522 EFD3  21 EEBD     RDERRO: LD   HL,TXTRDE
 1523 EFD6  CD EA60             CALL OUTTXT
 1524 EFD9  AF                  XOR  A
 1525 EFDA  3D                  DEC  A
 1526 EFDB  C9                  RET
 1527                   ;
 1528                   ;Adressarithmetik RAF: L=RADR 0-7 , H=RADR 8-15 , A=RADR 16-19
 1529                   ;
 1530 EFDC  AF          ADRRAF: XOR  A            ;CY = 0
 1531 EFDD  6F                  LD   L,A 
 1532 EFDE  3A F42C             LD   A,(RAFSEC)   ;8 bit
 1533 EFE1  67                  LD   H,A          ;H=Sektor (max. 64 = Bit 0-5)
 1534 EFE2  CB 1C               RR   H
 1535 EFE4  CB 1D               RR   L            ;H0 -> L7 ...... H5 -> H4
 1536 EFE6  3A F42B             LD   A,(RAFTRK)   ;8 bit , A=Track (max. 128 bei 1M = Bit 0-6)
 1537 EFE9  CB 1F               RR   A            ;A0 -> CY
 1538 EFEB  30 02               JR   NC,ADRAF1
 1539 EFED  CB EC               SET  5,H          ;H5 = A0 (RADR13)
 1540 EFEF  CB 1F       ADRAF1: RR   A            ;A1 -> CY
 1541 EFF1  30 02               JR   NC,ADRAF2
 1542 EFF3  CB F4               SET  6,H          ;H6 = A1 (RADR14)
 1543 EFF5  CB 1F       ADRAF2: RR   A            ;A2 -> CY
 1544 EFF7  30 02               JR   NC,ADRAF3
 1545 EFF9  CB FC               SET  7,H          ;H7 = A2 (RADR15)
 1546 EFFB  F5          ADRAF3: PUSH AF
 1547 EFFC  E6 03               AND  03H
 1548 EFFE  F6 E0               OR   PE0          ;Grundadresse der RAM-Disk
 1549 F000  4F                  LD   C,A
 1550 F001  7D                  LD   A,L
 1551 F002  D3 E7               OUT  (PE0+7),A    ;L-Adresse
 1552 F004  7C                  LD   A,H
 1553 F005  D3 E6               OUT  (PE0+6),A    ;H-Adresse
 1554 F007  F1                  POP  AF
 1555 F008  CB 1F               RR   A            ;Rotiere A rechts durch Carry
 1556 F00A  CB 1F               RR   A
 1557 F00C  E6 07               AND  07H          ;max. 2048K RAM-Disk
 1558 F00E  D3 E5               OUT  (PE0+5),A    ;Extended-Adresse
 1559 F010  06 80               LD   B,80H
 1560 F012  2A F451             LD   HL,(DMA)
 1561 F015  C9                  RET
 1562                   ;
 1563                   ;******************************  LOAD  ******************************
 1564                   ;
 1565 F016  C9          LOAD:   RET
 1566                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  28
BIOS    ASM

 1567 F017  2A F453     LEFFA:  LD   HL,(DPH)     ;zugeordneter DPH --> HL
 1568 F01A  22 F465             LD   (DPH3M),HL   ;Merkzelle DPH
 1569 F01D  2E 0F       LF000:  LD   L,0FH
 1570 F01F  D5          LF002:  PUSH DE
 1571 F020  11 000A             LD   DE,000AH
 1572 F023  62                  LD   H,D
 1573 F024  E5                  PUSH HL
 1574 F025  2A F465             LD   HL,(DPH3M)   ;Merkzelle DPH
 1575 F028  19                  ADD  HL,DE
 1576 F029  5E                  LD   E,(HL)
 1577 F02A  23                  INC  HL
 1578 F02B  56                  LD   D,(HL)
 1579 F02C  E1                  POP  HL
 1580 F02D  19                  ADD  HL,DE
 1581 F02E  D1                  POP  DE
 1582 F02F  7E                  LD   A,(HL)
 1583 F030  B7                  OR   A
 1584 F031  C9                  RET
 1585                   ;
 1586                   ;
 1587                   ;       READ/WRITE Routinen GIDE + Floppy-Disk
 1588                   ;       --------------------------------------
 1589                   ;
 1590 F032  23          RWGIDE: INC  HL
 1591 F033  CB FE               SET  7,(HL)
 1592 F035  2B                  DEC  HL
 1593 F036  AF          RWFLO:  XOR  A
 1594 F037  32 F46C             LD   (DF51C),A
 1595 F03A  CD F041             CALL LF024
 1596 F03D  3A F46C             LD   A,(DF51C)
 1597 F040  C9                  RET
 1598                   ;
 1599 F041  4E          LF024:  LD   C,(HL)
 1600 F042  CD F017             CALL LEFFA
 1601 F045  CA F0FE             JP   Z,LF0E1
 1602 F048  79                  LD   A,C
 1603 F049  FE 06               CP   06H
 1604 F04B  3E 01               LD   A,01H
 1605 F04D  20 01               JR   NZ,LF033
 1606 F04F  AF                  XOR  A
 1607 F050  32 F46D     LF033:  LD   (DF51D),A
 1608 F053  CD F01D             CALL LF000
 1609 F056  47                  LD   B,A
 1610 F057  2A F44F             LD   HL,(SECTOR)
 1611 F05A  CB 3C       LF03D:  SRL  H
 1612 F05C  CB 1D               RR   L
 1613 F05E  10 FA               DJNZ LF03D
 1614 F060  22 F468             LD   (DF518),HL
 1615 F063  21 F46A             LD   HL,DF51A
 1616 F066  7E                  LD   A,(HL)
 1617 F067  36 01               LD   (HL),01H
 1618 F069  B7                  OR   A
 1619 F06A  28 26               JR   Z,LF075
 1620 F06C  3A F44C             LD   A,(DRIVE)
 1621 F06F  21 F455             LD   HL,DRV2
 1622 F072  BE                  CP   (HL)
 1623 F073  20 16               JR   NZ,LF06E
 1624 F075  2A F456             LD   HL,(TRK2)
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  29
BIOS    ASM

 1625 F078  ED 5B F44D          LD   DE,(TRACK)
 1626 F07C  ED 52               SBC  HL,DE
 1627 F07E  20 0B               JR   NZ,LF06E
 1628 F080  2A F458             LD   HL,(SEC2)
 1629 F083  ED 5B F468          LD   DE,(DF518)
 1630 F087  ED 52               SBC  HL,DE
 1631 F089  28 1F               JR   Z,LF08D
 1632 F08B  3A F46B     LF06E:  LD   A,(DF51B)
 1633 F08E  B7                  OR   A
 1634 F08F  C4 F0EB             CALL NZ,LF0CE
 1635 F092  21 F44C     LF075:  LD   HL,DRIVE
 1636 F095  11 F455             LD   DE,DRV2
 1637 F098  01 0009             LD   BC,9         ;9 Bytes kopieren
 1638 F09B  ED B0               LDIR
 1639 F09D  2A F468             LD   HL,(DF518)
 1640 F0A0  22 F458             LD   (SEC2),HL
 1641 F0A3  CD F0EE             CALL LF0D1
 1642 F0A6  AF                  XOR  A
 1643 F0A7  32 F46B             LD   (DF51B),A
 1644 F0AA  CD F01D     LF08D:  CALL LF000
 1645 F0AD  23                  INC  HL
 1646 F0AE  3A F44F             LD   A,(SECTOR)
 1647 F0B1  A6                  AND  (HL)
 1648 F0B2  1F                  RRA
 1649 F0B3  67                  LD   H,A
 1650 F0B4  3E 00               LD   A,00H
 1651 F0B6  1F                  RRA
 1652 F0B7  6F                  LD   L,A
 1653 F0B8  11 F46F             LD   DE,DISKP
 1654 F0BB  19                  ADD  HL,DE
 1655 F0BC  ED 5B F451          LD   DE,(DMA)
 1656 F0C0  3A F46D             LD   A,(DF51D)
 1657 F0C3  B7                  OR   A
 1658 F0C4  20 05               JR   NZ,LF0AE
 1659 F0C6  3C                  INC  A
 1660 F0C7  32 F46B             LD   (DF51B),A
 1661 F0CA  EB                  EX   DE,HL
 1662 F0CB  01 0080     LF0AE:  LD   BC,0080H
 1663 F0CE  ED B0               LDIR
 1664 F0D0  3A F46C             LD   A,(DF51C)
 1665 F0D3  B7                  OR   A
 1666 F0D4  20 10               JR   NZ,LF0C9
 1667 F0D6  3A F46E             LD   A,(DF51E)
 1668 F0D9  3D                  DEC  A
 1669 F0DA  C0                  RET  NZ
 1670 F0DB  32 F46B             LD   (DF51B),A
 1671 F0DE  CD F0EB             CALL LF0CE
 1672 F0E1  3A F46C             LD   A,(DF51C)
 1673 F0E4  B7                  OR   A
 1674 F0E5  C8                  RET  Z
 1675 F0E6  AF          LF0C9:  XOR  A
 1676 F0E7  32 F46A             LD   (DF51A),A
 1677 F0EA  C9                  RET
 1678                   ;
 1679 F0EB  3E 06       LF0CE:  LD   A,06H
 1680 F0ED  21                  DEFB 21H          ;LD HL,043EH -> 21 3E 04
 1681 F0EE  3E 04       LF0D1:  LD   A,04H  
 1682 F0F0  32 F467             LD   (MERKRW),A
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  30
BIOS    ASM

 1683 F0F3  21 F46F             LD   HL,DISKP
 1684 F0F6  22 F45A             LD   (DMA2),HL
 1685 F0F9  21 F455             LD   HL,DRV2
 1686 F0FC  18 09               JR   LF0EA
 1687                   ;
 1688 F0FE  3A F44B     LF0E1:  LD   A,(RWBYTE)
 1689 F101  32 F467             LD   (MERKRW),A
 1690 F104  21 F44C             LD   HL,DRIVE
 1691 F107  11 F45E     LF0EA:  LD   DE,DRV3
 1692 F10A  01 0009             LD   BC,9         ;9 Bytes kopieren
 1693 F10D  ED B0               LDIR
 1694 F10F  3A F45E             LD   A,(DRV3)
 1695 F112  17                  RLA
 1696 F113  DA F325             JP   C,GIDERW     ;GIDE
 1697 F116  3A F460             LD   A,(TRK3+1)
 1698 F119  21 F462             LD   HL,SEC3+1
 1699 F11C  B6                  OR   (HL)
 1700 F11D  C2 F1DE             JP   NZ,LF1C1
 1701 F120  CD F01D             CALL LF000
 1702 F123  32 F43E             LD   (DF4E8),A
 1703 F126  B7                  OR   A
 1704 F127  3E FF               LD   A,0FFH
 1705 F129  28 02               JR   Z,LF110
 1706 F12B  3E 80               LD   A,80H
 1707 F12D  32 F441     LF110:  LD   (DF4EB),A
 1708 F130  23                  INC  HL
 1709 F131  23                  INC  HL
 1710 F132  7E                  LD   A,(HL)
 1711 F133  32 F43F             LD   (DF4E9),A
 1712 F136  3A F461             LD   A,(SEC3)
 1713 F139  BE                  CP   (HL)
 1714 F13A  38 04               JR   C,LF123
 1715 F13C  96                  SUB  (HL)
 1716 F13D  01 0104             LD   BC,0104H
 1717 F140  3C          LF123:  INC  A
 1718 F141  32 F43D             LD   (DF4E7),A
 1719 F144  23                  INC  HL
 1720 F145  7E                  LD   A,(HL)
 1721 F146  32 F440             LD   (DF4EA),A
 1722 F149  23                  INC  HL
 1723 F14A  3A F45F             LD   A,(TRK3)
 1724 F14D  BE                  CP   (HL)
 1725 F14E  38 04               JR   C,LF137
 1726 F150  96                  SUB  (HL)
 1727 F151  01 0104             LD   BC,0104H
 1728 F154  32 F43B     LF137:  LD   (DF4E5),A
 1729 F157  23                  INC  HL
 1730 F158  7E                  LD   A,(HL)
 1731 F159  B1                  OR   C
 1732 F15A  32 F43A             LD   (DF4E4),A
 1733 F15D  78                  LD   A,B
 1734 F15E  32 F43C             LD   (DF4E6),A
 1735 F161  23                  INC  HL
 1736 F162  3A F467             LD   A,(MERKRW)
 1737 F165  16 05               LD   D,05H
 1738 F167  FE 06               CP   06H
 1739 F169  28 02               JR   Z,LF150
 1740 F16B  16 06               LD   D,06H
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  31
BIOS    ASM

 1741 F16D  7E          LF150:  LD   A,(HL)
 1742 F16E  E6 40               AND  40H
 1743 F170  B2                  OR   D
 1744 F171  32 F438             LD   (DF4E2),A
 1745 F174  11 F442             LD   DE,DF4EC
 1746 F177  01 0004             LD   BC,0004H
 1747 F17A  ED B0               LDIR
 1748 F17C  0E 02               LD   C,02H
 1749 F17E  06 02       LF161:  LD   B,02H
 1750 F180  C5          LF163:  PUSH BC
 1751 F181  CD F192             CALL LF175
 1752 F184  C1                  POP  BC
 1753 F185  B7                  OR   A
 1754 F186  C8                  RET  Z
 1755 F187  10 F7               DJNZ LF163
 1756 F189  0D                  DEC  C
 1757 F18A  C8                  RET  Z
 1758 F18B  C5                  PUSH BC
 1759 F18C  CD F1F2             CALL LF1D5
 1760 F18F  C1                  POP  BC
 1761 F190  18 EC               JR   LF161
 1762                   ;
 1763 F192  3E 03       LF175:  LD   A,03H
 1764 F194  06 02               LD   B,02H
 1765 F196  21 F444             LD   HL,CTAB      ;FDC Befehlsbyte
 1766 F199  D3 41               OUT  (DFDC),A     ;Datenport FDC
 1767 F19B  CD F24D             CALL LF230
 1768 F19E  CD F204             CALL LF1E7
 1769 F1A1  20 3B               JR   NZ,LF1C1
 1770 F1A3  21 0040             LD   HL,0040H
 1771 F1A6  3A F43E             LD   A,(DF4E8)
 1772 F1A9  3C                  INC  A
 1773 F1AA  29          LF18D:  ADD  HL,HL
 1774 F1AB  3D                  DEC  A
 1775 F1AC  20 FC               JR   NZ,LF18D
 1776 F1AE  2B                  DEC  HL
 1777 F1AF  24                  INC  H
 1778 F1B0  2C                  INC  L
 1779 F1B1  E5                  PUSH HL
 1780 F1B2  2A F463             LD   HL,(DMA3)
 1781 F1B5  E5                  PUSH HL
 1782 F1B6  3A F438             LD   A,(DF4E2)
 1783 F1B9  4F                  LD   C,A
 1784 F1BA  06 09               LD   B,09H
 1785 F1BC  0F                  RRCA
 1786 F1BD  3E 51               LD   A,51H
 1787 F1BF  8F                  ADC  A,A
 1788 F1C0  32 F28C             LD   (MODE0),A    ;A2 --> INI
 1789 F1C3  32 F292             LD   (MODE1),A    ;A3 --> OUTI
 1790 F1C6  F3                  DI
 1791 F1C7  CD F244             CALL LF227
 1792 F1CA  E1                  POP  HL
 1793 F1CB  D1                  POP  DE
 1794 F1CC  43                  LD   B,E
 1795 F1CD  0E 41               LD   C,DFDC       ;Datenport FDC
 1796 F1CF  CD F27F             CALL RW           ;FDC RW-Routine
 1797 F1D2  FB                  EI
 1798 F1D3  CD F1E5             CALL LF1C8
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  32
BIOS    ASM

 1799 F1D6  21 F446             LD   HL,DF4F0
 1800 F1D9  7E                  LD   A,(HL)
 1801 F1DA  E6 C0               AND  0C0H
 1802 F1DC  28 02               JR   Z,LF1C3
 1803 F1DE  3E FF       LF1C1:  LD   A,0FFH
 1804 F1E0  32 F46C     LF1C3:  LD   (DF51C),A
 1805 F1E3  B7                  OR   A
 1806 F1E4  C9                  RET
 1807                   ;
 1808 F1E5  06 07       LF1C8:  LD   B,07H
 1809 F1E7  21 F446             LD   HL,DF4F0
 1810 F1EA  CD F268     LF1CD:  CALL RBYTE
 1811 F1ED  77                  LD   (HL),A
 1812 F1EE  23                  INC  HL
 1813 F1EF  10 F9               DJNZ LF1CD
 1814 F1F1  C9                  RET
 1815                   ;
 1816 F1F2  01 0207     LF1D5:  LD   BC,0207H     ;Spur 0 einstellen
 1817 F1F5  CD F244             CALL LF227
 1818 F1F8  CD F224             CALL SENSE
 1819 F1FB  C8                  RET  Z
 1820 F1FC  01 0207             LD   BC,0207H
 1821 F1FF  CD F244             CALL LF227
 1822 F202  18 20               JR   SENSE
 1823                   ;
 1824 F204  3A F43B     LF1E7:  LD   A,(DF4E5)
 1825 F207  32 F447             LD   (DF4F7),A
 1826 F20A  B7                  OR   A
 1827 F20B  28 E5               JR   Z,LF1D5
 1828 F20D  01 030F             LD   BC,030FH
 1829 F210  21 F442             LD   HL,DF4EC
 1830 F213  CB 66               BIT  4,(HL)
 1831 F215  28 04               JR   Z,LF1FE
 1832 F217  87                  ADD  A,A
 1833 F218  32 F43B             LD   (DF4E5),A
 1834 F21B  CD F244     LF1FE:  CALL LF227
 1835 F21E  3A F447             LD   A,(DF4F7)
 1836 F221  32 F43B             LD   (DF4E5),A
 1837 F224  01 0108     SENSE:  LD   BC,0108H
 1838 F227  CD F244             CALL LF227
 1839 F22A  CD F268             CALL RBYTE
 1840 F22D  47                  LD   B,A
 1841 F22E  32 F446             LD   (DF4F0),A
 1842 F231  FE 80               CP   80H
 1843 F233  C4 F268             CALL NZ,RBYTE     ;PCN holen
 1844 F236  CB 68               BIT  5,B          ;SEEK Ende?
 1845 F238  28 EA               JR   Z,SENSE
 1846 F23A  78                  LD   A,B
 1847 F23B  E6 F0               AND  0F0H
 1848 F23D  FE C0               CP   0C0H
 1849 F23F  28 E3               JR   Z,SENSE
 1850 F241  EE 20               XOR  20H
 1851 F243  C9                  RET
 1852                   ;
 1853 F244  C5          LF227:  PUSH BC
 1854 F245  CD F2A2             CALL LF285
 1855 F248  C1                  POP  BC
 1856 F249  21 F439     LF22C:  LD   HL,DF4E3
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  33
BIOS    ASM

 1857 F24C  71                  LD   (HL),C
 1858 F24D  0E 41       LF230:  LD   C,41H
 1859 F24F  D5                  PUSH DE
 1860 F250  11 1FFF     LF233:  LD   DE,1FFFH
 1861 F253  7B          LF236:  LD   A,E
 1862 F254  B2                  OR   D
 1863 F255  28 0D               JR   Z,LF247      ;Abbruch nach 8192 Versuchen
 1864 F257  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1865 F259  E6 C0               AND  0C0H
 1866 F25B  FE 80               CP   80H          ;FDC bereit zum Schreiben?
 1867 F25D  1B                  DEC  DE
 1868 F25E  20 F3               JR   NZ,LF236     ;noch nicht bereit
 1869 F260  ED A3               OUTI              ;1 Byte --> FDC
 1870 F262  20 EC               JR   NZ,LF233     ;Wdhlg., bis B=0
 1871 F264  06 00       LF247:  LD   B,00H
 1872 F266  D1                  POP  DE
 1873 F267  C9                  RET
 1874                   ;
 1875 F268  E5          RBYTE:  PUSH HL           ;1 Byte lesen
 1876 F269  21 1FFF             LD   HL,1FFFH
 1877 F26C  7D          RBYTE1: LD   A,L
 1878 F26D  B4                  OR   H
 1879 F26E  3E C0               LD   A,0C0H
 1880 F270  28 0B               JR   Z,RBYTE2     ;Abbruch nach 8192 Versuchen
 1881 F272  DB 40               IN   A,(CFDC)     ;Lese Hauptstatusregister
 1882 F274  E6 C0               AND  0C0H
 1883 F276  FE C0               CP   0C0H         ;FDC bereit zum Lesen?
 1884 F278  2B                  DEC  HL
 1885 F279  20 F1               JR   NZ,RBYTE1    ;noch nicht bereit
 1886 F27B  DB 41               IN   A,(DFDC)     ;1 Byte vom FDC lesen --> A
 1887 F27D  E1          RBYTE2: POP  HL
 1888 F27E  C9                  RET
 1889                   ;
 1890                   ;
 1891                   ;       FDC READ/WRITE Routine
 1892                   ;       ----------------------
 1893                   ;
 1894 F27F  3A F44A     RW:     LD   A,(LATPU)
 1895 F282  CB CF               SET  1,A
 1896 F284  D3 45               OUT  (LATCH),A    ;WAIT-Freigabe
 1897 F286  DB 40       RW01:   IN   A,(CFDC)     ;Lese Hauptstatusregister
 1898 F288  07                  RLCA
 1899 F289  30 FB               JR   NC,RW01      ;FDC noch nicht bereit
 1900 F28B  ED                  DEFB 0EDH         ;ED A2 = INI
 1901 F28C  A2          MODE0:  DEFB 0A2H         ;ED A3 = OUTI
 1902 F28D  00                  NOP
 1903 F28E  D3 43       RW02:   OUT  (FLWAIT),A   ;WAIT bis Interrupt FDC
 1904 F290  00                  NOP
 1905 F291  ED                  DEFB 0EDH         ;ED A2 = INI
 1906 F292  A2          MODE1:  DEFB 0A2H         ;ED A3 = OUTI
 1907 F293  C2 F28E             JP   NZ,RW02
 1908 F296  15                  DEC  D
 1909 F297  C2 F28E             JP   NZ,RW02
 1910 F29A  3A F44A             LD   A,(LATPU)
 1911 F29D  CB E7               SET  4,A          ;Terminal Count
 1912 F29F  D3 45               OUT  (LATCH),A    ;TC + WAIT-Sperrung
 1913 F2A1  C9                  RET
 1914                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  34
BIOS    ASM

 1915 F2A2  21 F448     LF285:  LD   HL,DF4F8
 1916 F2A5  3A F43A             LD   A,(DF4E4)
 1917 F2A8  E6 03               AND  03H
 1918 F2AA  BE                  CP   (HL)
 1919 F2AB  77                  LD   (HL),A
 1920 F2AC  23                  INC  HL
 1921 F2AD  4E                  LD   C,(HL)
 1922 F2AE  36 48               LD   (HL),48H
 1923 F2B0  F5                  PUSH AF
 1924 F2B1  E5                  PUSH HL
 1925 F2B2  21 F44A             LD   HL,LATPU
 1926 F2B5  3A F43A             LD   A,(DF4E4)
 1927 F2B8  E6 03               AND  03H
 1928 F2BA  28 08               JR   Z,LF2A7
 1929 F2BC  FE 02               CP   02H
 1930 F2BE  28 04               JR   Z,LF2A7
 1931 F2C0  CB DE               SET  3,(HL)       ;Floppy-LW 1: Motor an
 1932 F2C2  18 02               JR   LF2A9
 1933                   ;
 1934 F2C4  CB C6       LF2A7:  SET  0,(HL)       ;Floppy-LW 0: Motor an
 1935 F2C6  7E          LF2A9:  LD   A,(HL)
 1936 F2C7  D3 45               OUT  (LATCH),A
 1937 F2C9  E1                  POP  HL
 1938 F2CA  F1                  POP  AF
 1939 F2CB  20 04               JR   NZ,LF2B4
 1940 F2CD  79                  LD   A,C
 1941 F2CE  A7                  AND  A
 1942 F2CF  20 09               JR   NZ,LF2BD
 1943 F2D1  3E 48       LF2B4:  LD   A,48H
 1944 F2D3  CB 3F               SRL  A
 1945 F2D5  CB 3F               SRL  A
 1946 F2D7  BE                  CP   (HL)
 1947 F2D8  38 F7               JR   C,LF2B4
 1948 F2DA  7E          LF2BD:  LD   A,(HL)
 1949 F2DB  A7                  AND  A
 1950 F2DC  20 08               JR   NZ,LF2C9
 1951 F2DE  E5                  PUSH HL
 1952 F2DF  21 F2FA             LD   HL,DISCTX
 1953 F2E2  CD EA60             CALL OUTTXT
 1954 F2E5  E1                  POP  HL
 1955 F2E6  C5          LF2C9:  PUSH BC
 1956 F2E7  E5                  PUSH HL
 1957 F2E8  01 0204             LD   BC,0204H
 1958 F2EB  CD F249             CALL LF22C
 1959 F2EE  CD F268             CALL RBYTE
 1960 F2F1  E1                  POP  HL
 1961 F2F2  C1                  POP  BC
 1962 F2F3  CB 6F               BIT  5,A
 1963 F2F5  28 E3               JR   Z,LF2BD
 1964 F2F7  36 90               LD   (HL),90H
 1965 F2F9  C9                  RET
 1966                   ;
 1967 F2FA  20 44 49 53 DISCTX: DEFM ' DISC?'
 1968 F300  08 08 08 08         DEFB 8,8,8,8,8,8
 1969 F306  00                  NOP
 1970                   ;
 1971                   ;
 1972                   ; Interrupteinsprung von CTC Kanal 3
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  35
BIOS    ASM

 1973                   ;
 1974 F307  F3          ISRCTC: DI                ;DI hat gefehlt, wurde ergaenzt
 1975 F308  F5                  PUSH AF
 1976 F309  3A F449             LD   A,(CTCCNT)   ;CTC-Zusatzzaehler lesen
 1977 F30C  A7                  AND  A
 1978 F30D  28 12               JR   Z,ISRCTE     ;bei "0", die Fkt. beenden
 1979                           ;Beim Start von HRCPM wird CNTCNT per Interrupt von 255 auf 0 heruntergezaehlt.
 1980                           ;--> verzoegerte Steuerung von LATPU und LATCH
 1981 F30F  3D                  DEC  A
 1982 F310  32 F449             LD   (CTCCNT),A
 1983 F313  20 0C               JR   NZ,ISRCTE
 1984 F315  E5                  PUSH HL           ;Bei 2 MHz CPU-Takt wird nach 8 Sekunden diese Stelle erreicht
 1985 F316  21 F44A             LD   HL,LATPU
 1986 F319  CB 86               RES  0,(HL)       ;Floppy-LW 0: Motor aus
 1987 F31B  CB 9E               RES  3,(HL)       ;Floppy-LW 1: Motor aus
 1988 F31D  7E                  LD   A,(HL)
 1989 F31E  D3 45               OUT  (LATCH),A    ;Latch auf dem Floppy-Controller ruecksetzen
 1990 F320  E1                  POP  HL
 1991 F321  F1          ISRCTE: POP  AF
 1992 F322  FB          INTEND: EI                ;ist zusaetzlich Einsprungpunkt fuer nicht genutzte Interrupts
 1993 F323  ED 4D               RETI
 1994                   ;
 1995                   ;-------------  R/W GIDE HW  -----------------------------------------------------------
 1996                   
 1997 F325  DB 8F       GIDERW: IN   A,(P8F)      ;Command / Status
 1998 F327  17                  RLA               ;Bit 0 = CY
 1999 F328  38 FB               JR   C,GIDERW     ;wait for hard disk ready (non-busy)
 2000 F32A  2E 19               LD   L,19H
 2001 F32C  CD F01F             CALL LF002
 2002 F32F  4F                  LD   C,A
 2003 F330  2A F461             LD   HL,(SEC3)
 2004 F333  23                  INC  HL
 2005 F334  AF                  XOR  A
 2006 F335  47                  LD   B,A
 2007 F336  3C          LF318:  INC  A
 2008 F337  ED 42               SBC  HL,BC
 2009 F339  28 02               JR   Z,LF31F
 2010 F33B  30 F9               JR   NC,LF318
 2011 F33D  09          LF31F:  ADD  HL,BC
 2012 F33E  3D                  DEC  A
 2013 F33F  57                  LD   D,A
 2014 F340  5D                  LD   E,L
 2015 F341  2E 11               LD   L,11H
 2016 F343  CD F01F             CALL LF002
 2017 F346  B2                  OR   D
 2018 F347  D3 8E               OUT  (P8E),A      ;Drive and Head
 2019 F349  7B                  LD   A,E
 2020 F34A  D3 8B               OUT  (P8B),A      ;Sector Number
 2021 F34C  23                  INC  HL
 2022 F34D  5E                  LD   E,(HL)
 2023 F34E  23                  INC  HL
 2024 F34F  56                  LD   D,(HL)
 2025 F350  2A F45F             LD   HL,(TRK3)
 2026 F353  19                  ADD  HL,DE
 2027 F354  7D                  LD   A,L
 2028 F355  D3 8C               OUT  (P8C),A      ;Cylinder Low
 2029 F357  7C                  LD   A,H
 2030 F358  D3 8D               OUT  (P8D),A      ;Cylinder High
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  36
BIOS    ASM

 2031 F35A  3E 01               LD   A,01H
 2032 F35C  D3 8A               OUT  (P8A),A      ;Sector Count
 2033 F35E  3A F467             LD   A,(MERKRW)
 2034 F361  FE 06               CP   06H
 2035 F363  28 16               JR   Z,LF35D      ;6 = schreiben
 2036                   ;
 2037                   ;  GIDE lesen 1 Sektor = 512 Bytes nach Puffer
 2038                   ;
 2039 F365  3E 20               LD   A,20H        ;Read Sector
 2040 F367  D3 8F               OUT  (P8F),A      ;Command / Status
 2041 F369  DB 8F       LF34B:  IN   A,(P8F)      ;Command / Status
 2042 F36B  CB 5F               BIT  3,A
 2043 F36D  28 FA               JR   Z,LF34B      ;wait resp. DRQ active.
 2044 F36F  2A F463             LD   HL,(DMA3)
 2045 F372  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2046 F375  ED B2               INIR
 2047 F377  ED B2               INIR              ;512 bytes gesamt lesen
 2048 F379  18 19               JR   LF376
 2049                   ;
 2050                   ;  GIDE schreiben 1 Sektor = 512 Bytes von Puffer
 2051                   ;
 2052 F37B  3E 30       LF35D:  LD   A,30H        ;Write Sector
 2053 F37D  D3 8F               OUT  (P8F),A      ;Command / Status
 2054 F37F  DB 8F       LF361:  IN   A,(P8F)      ;Command / Status
 2055 F381  17                  RLA               ;Bit 0 = CY
 2056 F382  38 FB               JR   C,LF361      ;wait for hard disk ready (non-busy)
 2057 F384  DB 8F       LF366:  IN   A,(P8F)      ;Command / Status
 2058 F386  CB 5F               BIT  3,A
 2059 F388  28 FA               JR   Z,LF366      ;wait resp. DRQ active.
 2060 F38A  2A F463             LD   HL,(DMA3)
 2061 F38D  01 0088             LD   BC,0088H     ;B = 0 (counter), C = I/O address (Data Register)
 2062 F390  ED B3               OTIR             
 2063 F392  ED B3               OTIR              ;512 bytes gesamt schreiben 
 2064                   ;        
 2065 F394  DB 8F       LF376:  IN   A,(P8F)      ;Command / Status
 2066 F396  17                  RLA               ;Bit 0 = CY
 2067 F397  38 FB               JR   C,LF376      ;wait for hard disk ready (non-busy)
 2068 F399  DB 8F               IN   A,(P8F)      ;Command / Status
 2069 F39B  E6 89               AND  89H          ;10001001b - busy, DRQ, or error?
 2070 F39D  C8                  RET  Z            ;no: all is fine, mit A=0
 2071 F39E  3E FF               LD   A,0FFH
 2072 F3A0  32 F46C             LD   (DF51C),A
 2073 F3A3  C9                  RET               ;on errors, return with A=FFh
 2074                   ;
 2075                   ;-----------------  ENDE GIDE HW  ------------------------------------------
 2076                   ;
 2077 F3A4  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2078 F3BE  43 4F 4E 49         DEFM "CONIN-ZBIOS-STACK==26BYTES"
 2079 F3D8  43 4F 4E 4F CINSP:  DEFM "CONOUT-STACK_CONOUT-STACK_CONOUT-STACK"
 2080 F3FE  5A 42 49 4F COUTSP: DEFM "ZBIOS(C)ML-SOFT 2003 & AC1-BIOS(C)HR 2011"
 2081 F427  00          CPMSTK: NOP
 2082                   ;
 2083                   ;******************************  Ende CP/M-Stack  ******************************
 2084                   ;
 2085 F428  00          COLOR:  DEFB 0            ;Merkzelle aktuelle BWS-Farbe (0=Monochrom)
 2086 F429  00          COLO1:  DEFB 0            ;aktuelle Farbe ohne invers und intensiv
 2087 F42A  00          COLO2:  DEFB 0            ;Farbe fuer Monitor und CP/M Warmstart
 2088                   ;
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  37
BIOS    ASM

 2089 F42B  00          RAFTRK: DEFB 0            ;RAFTRK EQU 0F4C2H
 2090 F42C  00          RAFSEC: DEFB 0
 2091                   ;
 2092 F42D  01          CUFLAG: DEFB 1            ;CUON/CUOFF  KursorFlag
 2093 F42E  00          STZ00:  DEFB 0            ;Merkzelle Anz. BS-Steuerzeichen
 2094 F42F  00          STZ01:  DEFB 0            ;Merkzelle fuer 1. ESC-Steuerzeichen
 2095 F430  00          STZ02:  DEFB 0            ;Merkzelle fuer 2. ESC-Steuerzeichen
 2096                   ;
 2097 F431  00          CHAR:   DEFB 0            ;Merkzelle Zeichen <> Cursor
 2098                   ;
 2099 F432  0000        SPCIN:  DEFW 0            ;Merkzelle Stackpointer waehrend CONIN
 2100 F434  0000        SPCOUT: DEFW 0            ;Merkzelle Stackpointer waehrend CONOUT
 2101 F436  0000        OLDNMI: DEFW 0            ;2 Bytes fuer alten NMI
 2102                   ;
 2103 F438  00          DF4E2:  NOP
 2104 F439  00          DF4E3:  NOP               ;Merkzelle
 2105 F43A  00          DF4E4:  NOP
 2106 F43B  00          DF4E5:  NOP
 2107 F43C  00          DF4E6:  NOP
 2108 F43D  00          DF4E7:  NOP
 2109 F43E  00          DF4E8:  NOP
 2110 F43F  00          DF4E9:  NOP
 2111 F440  00          DF4EA:  NOP
 2112 F441  00          DF4EB:  NOP
 2113                   ;
 2114 F442  00          DF4EC:  NOP               ;4 Merkzellen  
 2115 F443  00                  NOP
 2116 F444  00          CTAB:   NOP               ;FDC Befehlsbyte
 2117 F445  00                  NOP               ;4 Merkzellen Ende
 2118                   ;
 2119 F446  00          DF4F0:  NOP
 2120 F447  00          DF4F7:  NOP
 2121 F448  00          DF4F8:  NOP
 2122 F449  00          CTCCNT: DEFB 0            ;CTC-Counter - Zusatzzaehler fuer CTC-Interrupt
 2123 F44A  00          LATPU:  DEFB 0            ;Latch fuer den Floppy-Controler
 2124                   ;
 2125                   ;hier beginnt eine Bytefolge fuer Read/Write Operationen
 2126                   ;
 2127 F44B  04          RWBYTE: DEFB 4            ;4 = READ, 6 = WRITE
 2128 F44C  00          DRIVE:  DEFB 0            ;LW-Nr.
 2129 F44D  0000        TRACK:  DEFW 0            ;akt. Track
 2130 F44F  0000        SECTOR: DEFW 0            ;akt. Sektor
 2131 F451  0000        DMA:    DEFW 0            ;DMA-Adresse
 2132 F453  0000        DPH:    DEFW 0            ;akt. DPH
 2133                   ;
 2134 F455  00          DRV2:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2135 F456  0000        TRK2:   DEFW 0
 2136 F458  0000        SEC2:   DEFW 0
 2137 F45A  0000        DMA2:   DEFW 0            ;DMA-Adresse
 2138 F45C  0000                DEFW 0
 2139                   ;
 2140 F45E  00          DRV3:   DEFB 0            ;9 Bytes Kopie ab DRIVE:
 2141 F45F  0000        TRK3:   DEFW 0
 2142 F461  0000        SEC3:   DEFW 0
 2143 F463  0000        DMA3:   DEFW 0            ;DMA-Adresse
 2144 F465  0000        DPH3M:  DEFW 0            ;Merkzelle akt. DPH
 2145                   ;
 2146 F467  04          MERKRW: DEFB 4            ;Merkzelle: 4 = READ, 6 = WRITE
Z80ASM SuperFast Relocating Macro Assembler     	    Z80ASM 1.32 Page  38
BIOS    ASM

 2147 F468  0000        DF518:  DEFW 0
 2148 F46A  00          DF51A:  DEFB 0
 2149 F46B  00          DF51B:  DEFB 0
 2150 F46C  00          DF51C:  DEFB 0
 2151 F46D  00          DF51D:  DEFB 0
 2152 F46E  00          DF51E:  DEFB 0
 2153                   ;
 2154 F46F  00 00 00 00 DISKP:  DEFS 1024,0       ;HW-Sektor Puffer aller LW (1k max. fuer FDD)
 2155 F86F  00 00 00 00 DIRBF:  DEFS 128,0        ;1 REC Puffer fuer Direktory
 2156 F8EF  00 00 00 00 ALL00:  DEFS 128,0        ;2048k(max.) / 2k / 8 = 128
 2157 F96F  00 00 00 00 ALL01:  DEFS 50,0         ;0F99FH
 2158 F9A1  00 00 00 00 ALL02:  DEFS 504,0        ;0F9D1H
 2159 FB99  00 00 00 00 ALL03:  DEFS 256,0        ;0FBC9H
 2160 FC99  00 00 00 00 ALL04:  DEFS 256,0        ;0FCC9H
 2161 FD99  00 00 00 00 ALL05:  DEFS 50,0         ;0FDC9H
 2162 FDCB  00 00 00 00 ALL06:  DEFS 50,0         ;0FDFBH
 2163 FDFD  00 00 00 00 CHK01:  DEFS 32,0         ;0FE2DH
 2164 FE1D  00 00 00 00 CHK05:  DEFS 32,0         ;0FE4DH
 2165 FE3D  00 00 00 00 CHK06:  DEFS 32,0         ;0FE6DH
 2166                   ;
 2167 FE5D  42 49 4F 53         DEFM "BIOS-Ende"  ;nur fuer Frieder zur Info
 2168                   ;
 2169                   ;
 2170         FF80      DFF80   EQU  0FF80H       ;Interrupt-Einsprungpunkt CTC Kanal 0
 2171         FF82      DFF82   EQU  0FF82H       ;Interrupt-Einsprungpunkt CTC Kanal 1
 2172         FF84      DFF84   EQU  0FF84H       ;Interrupt-Einsprungpunkt CTC Kanal 2
 2173         FF86      DFF86   EQU  0FF86H       ;Interrupt-Einsprungpunkt CTC Kanal 3
 2174         FF88      DFF88   EQU  0FF88H       ;Interrupt-Einsprungpunkt Nr.1 PIO1A
 2175         FF8A      DFF8A   EQU  0FF8AH       ;Interrupt-Einsprungpunkt Nr.2 PIO1A
 2176                   ;
 2177                   ;******************************   PortAdressen   ******************************
 2178                   ;
 2179         0000      P00     EQU  00H          ;CTC Kanal 0
 2180         0001      P01     EQU  01H          ;CTC Kanal 1
 2181         0002      P02     EQU  02H          ;CTC Kanal 2
 2182         0003      P03     EQU  03H          ;CTC Kanal 3
 2183                   ;
 2184         0004      P04     EQU  04H          ;PIO_A-Daten
 2185         0005      P05     EQU  05H          ;PIO_B-Daten
 2186         0006      P06     EQU  06H          ;PIO_A-Control
 2187                   ;
 2188         001E      P1E     EQU  1EH          ;CP/M - Umschalter
 2189                   ;
 2190         008A      P8A     EQU  8AH          ;GIDE Sector Count
 2191         008B      P8B     EQU  8BH          ;GIDE Sector Number
 2192         008C      P8C     EQU  8CH          ;GIDE Cylinder Low
 2193         008D      P8D     EQU  8DH          ;GIDE Cylinder High
 2194         008E      P8E     EQU  8EH          ;GIDE Drive and Head
 2195         008F      P8F     EQU  8FH          ;GIDE Command/Status
 2196                   ;
 2197                           .DEPHASE
 2198                           END
 0 Error(s) Detected.
 6246 Absolute Bytes. 321 Symbols Detected.
TC Kanal 2
 2182         0003      P03     EQU  03H          ;CTC Kanal 3
 2183